<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="linux," />










<meta name="description" content="MariaDB 数据库的发展史 萌芽阶段：文件系统使用磁盘文件来存储数据 初级阶段：第一代数据库出现了网状模型、层次模型的数据库 中级阶段：第二代数据库关系型数据库和结构化查询语言 高级阶段：新一代数据库“关系-对象”型数据库  数据库系统的架构单机架构大型主机/终端架构主从式架构（C/S）分布式架构   关系型数据库 关系 ：关系就是二维表，其中：表中的行、列次序并不重要 行row：表中的每一行">
<meta name="keywords" content="linux">
<meta property="og:type" content="article">
<meta property="og:title" content="MariaDB">
<meta property="og:url" content="http://blog.nextx.tk/2018/12/10/mysql/index.html">
<meta property="og:site_name" content="nieW learn">
<meta property="og:description" content="MariaDB 数据库的发展史 萌芽阶段：文件系统使用磁盘文件来存储数据 初级阶段：第一代数据库出现了网状模型、层次模型的数据库 中级阶段：第二代数据库关系型数据库和结构化查询语言 高级阶段：新一代数据库“关系-对象”型数据库  数据库系统的架构单机架构大型主机/终端架构主从式架构（C/S）分布式架构   关系型数据库 关系 ：关系就是二维表，其中：表中的行、列次序并不重要 行row：表中的每一行">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1543505120590&di=f9e6320ab071fa2f524d22cbbf4702bb&imgtype=jpg&src=http%3A%2F%2Fimg4.imgtn.bdimg.com%2Fit%2Fu%3D3220053439%2C312874450%26fm%3D214%26gp%3D0.jpg">
<meta property="og:updated_time" content="2018-12-10T14:47:23.828Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MariaDB">
<meta name="twitter:description" content="MariaDB 数据库的发展史 萌芽阶段：文件系统使用磁盘文件来存储数据 初级阶段：第一代数据库出现了网状模型、层次模型的数据库 中级阶段：第二代数据库关系型数据库和结构化查询语言 高级阶段：新一代数据库“关系-对象”型数据库  数据库系统的架构单机架构大型主机/终端架构主从式架构（C/S）分布式架构   关系型数据库 关系 ：关系就是二维表，其中：表中的行、列次序并不重要 行row：表中的每一行">
<meta name="twitter:image" content="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1543505120590&di=f9e6320ab071fa2f524d22cbbf4702bb&imgtype=jpg&src=http%3A%2F%2Fimg4.imgtn.bdimg.com%2Fit%2Fu%3D3220053439%2C312874450%26fm%3D214%26gp%3D0.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.nextx.tk/2018/12/10/mysql/"/>





  <title>MariaDB | nieW learn</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">nieW learn</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.nextx.tk/2018/12/10/mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nieW">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nieW learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MariaDB</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-10T22:47:00+08:00">
                2018-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="MariaDB"><a href="#MariaDB" class="headerlink" title="MariaDB"></a>MariaDB</h1><hr>
<h1 id="数据库的发展史"><a href="#数据库的发展史" class="headerlink" title="数据库的发展史"></a>数据库的发展史</h1><ul>
<li>萌芽阶段：文件系统<br>使用磁盘文件来存储数据</li>
<li>初级阶段：第一代数据库<br>出现了网状模型、层次模型的数据库</li>
<li>中级阶段：第二代数据库<br>关系型数据库和结构化查询语言</li>
<li>高级阶段：新一代数据库<br>“关系-对象”型数据库</li>
</ul>
<h1 id="数据库系统的架构"><a href="#数据库系统的架构" class="headerlink" title="数据库系统的架构"></a>数据库系统的架构</h1><p>单机架构<br>大型主机/终端架构<br>主从式架构（C/S）<br>分布式架构  </p>
<h1 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h1><ul>
<li>关系 ：关系就是二维表，其中：表中的行、列次序并不重要</li>
<li>行row：表中的每一行，又称为一条记录</li>
<li>列column：表中的每一列，称为属性，字段</li>
<li>主键（Primary key）：用于惟一确定<strong>一个记录</strong>的字段（每张表只有一个主键）</li>
<li>域domain：属性的取值范围，如，性别只能是‘男’和‘女’两个值<blockquote>
<p>一张表只有一个主键，主键可以关联到多个字段（多字段组合必须唯一），称为复合主键</p>
</blockquote>
</li>
</ul>
<h4 id="RDBMS："><a href="#RDBMS：" class="headerlink" title="RDBMS："></a>RDBMS：</h4><p>MySQL: MySQL, MariaDB, Percona Server<br>PostgreSQL: 简称为pgsql，EnterpriseDB<br>Oracle<br>MSSQL<br>DB2  </p>
<blockquote>
<p>数据库排名：<br><a href="https://db-engines.com/en/ranking" target="_blank" rel="noopener">https://db-engines.com/en/ranking</a></p>
</blockquote>
<h1 id="实体-联系模型E-R"><a href="#实体-联系模型E-R" class="headerlink" title="实体-联系模型E-R"></a>实体-联系模型E-R</h1><ul>
<li>实体Entity：客观存在并可以相互区分的客观事物或抽象事件称为实体<br>• 在E-R图中用矩形框表示实体，把实体名写在框内   </li>
<li>属性：实体所具有的特征或性质  </li>
<li>联系：联系是数据之间的关联集合，是客观存在的应用语义链<br>• 实体内部的联系：指组成实体的各属性之间的联系。如职工实体中，职工号和部门经理号之间有一种关联关系<br>• 实体之间的联系：指不同实体之间联系。例：学生选课实体和学生基本信息实体之间<br>• 实体之间的联系用菱形框表示  </li>
</ul>
<h1 id="联系类型"><a href="#联系类型" class="headerlink" title="联系类型"></a>联系类型</h1><ul>
<li>联系的类型<br>一对一联系(1:1)<br>一对多联系(1:n)  #外键依赖主键表的主键<br>多对多联系(m:n)  #构建一张表整合前面所有表的关键字段</li>
<li>数据的操作：<br>数据提取：在数据集合中提取感兴趣的内容。SELECT<br>数据更新：变更数据库中的数据。INSERT、DELETE、UPDATE  </li>
<li>数据的约束条件 ：是一组完整性规则的集合<br>实体（行）完整性 Entity integrity  #每条记录都唯一 增加主键<br>域（列）完整性 Domain Integrity  #限定字段属性<br>参考完整性 Referential Integrity  #各个表关系  主外键  </li>
</ul>
<h1 id="简易数据规划流程"><a href="#简易数据规划流程" class="headerlink" title="简易数据规划流程"></a>简易数据规划流程</h1><ul>
<li>第一阶段：收集数据，得到字段<br>• 收集必要且完整的数据项<br>• 转换成数据表的字段  </li>
<li>第二阶段：把字段分类，归入表，建立表的关联<br>• 关联：表和表间的关系<br>• 分割数据表并建立关联的优点<br>• 节省空间<br>• 减少输入错误<br>• 方便数据修改  </li>
<li>第三阶段：<br>• 规范化数据库  #减少冗余</li>
</ul>
<h1 id="SQL概念"><a href="#SQL概念" class="headerlink" title="SQL概念"></a>SQL概念</h1><ul>
<li>SQL: Structure Query Language<br>结构化查询语言<br>SQL解释器：<br>数据存储协议：应用层协议，C/S  </li>
<li>S：server, 监听于socket套接字，接收并处理客户端的应用请求  </li>
<li>C：Client<br>客户端程序接口<br>CLI<br>GUI<br>应用编程接口<br>ODBC：Open Database Connectivity<br>JDBC：Java Data Base Connectivity  </li>
</ul>
<h2 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h2><p>约束：constraint，表中的数据要遵守的限制  </p>
<ul>
<li>主键(primary key)：一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行；<strong>必须提供数据，即NOT NULL</strong>，<strong>一个表只能有一个</strong></li>
<li>惟一键(uniq key)：一个或多个字段的组合，<strong>填入的数据必须能在本表中唯一标识本行</strong>；<strong>允许为NULL，</strong>一个表可以存在多个<em>**</em>  </li>
<li>外键(foreign key)：一个表中的某字段可填入的数据取决于另一个表的主键或唯一键已有的数据</li>
<li>检查：字段值在一定范围内</li>
</ul>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><ul>
<li>索引：将表中的一个或多个字段中的数据复制一份另存，并且按特定次序排序存储</li>
<li>关系运算：<br>选择：挑选出符合条件的行<br>投影：挑选出需要的字段<br>连接：表间字段的关联  <blockquote>
<p>适用于大量数据，按某种规定排列</p>
</blockquote>
</li>
</ul>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h2><ul>
<li>数据抽象：<br>物理层：数据存储格式，即RDBMS在磁盘上如何组织文件<br>逻辑层：DBA角度，描述存储什么数据，以及数据间存在什么样的关系<br>视图层：用户角度，描述DB中的部分数据  </li>
<li>关系模型的分类：<br>关系模型<br>基于对象的关系模型<br>半结构化的关系模型：XML数据（扩展的标记语言）  </li>
</ul>
<h1 id="MySQL历史"><a href="#MySQL历史" class="headerlink" title="MySQL历史"></a>MySQL历史</h1><p>1979年：TcX公司 Monty Widenius，Unireg<br>1996年：发布MySQL1.0，Solaris版本，Linux版本<br>1999年：MySQL AB公司，瑞典<br>2003年：MySQL 5.0版本，提供视图、存储过程等功能<br>2008年：Sun 收购<br>2009年：Oracle收购sun<br>2009年：Monty成立MariaDB  </p>
<h2 id="MYSQL的特性"><a href="#MYSQL的特性" class="headerlink" title="MYSQL的特性"></a>MYSQL的特性</h2><ul>
<li><strong>插件式存储引擎</strong>：也称为“表类型”，存储管理器有多种实现版本，功能和特性可能均略有差别；用户可根据需要灵活选择,Mysql5.5.5开始innoDB引擎是MYSQL默认引擎<br>MyISAM ==&gt; Aria<br>InnoDB ==&gt; XtraDB  </li>
<li>单进程，多线程</li>
<li>诸多扩展和新特性</li>
<li>提供了较多测试组件</li>
<li>开源</li>
</ul>
<p>官方文档<br><a href="https://dev.mysql.com/doc/" target="_blank" rel="noopener">https://dev.mysql.com/doc/</a><br><a href="https://mariadb.com/kb/en/" target="_blank" rel="noopener">https://mariadb.com/kb/en/</a><br><a href="https://www.percona.com/software/mysql-database/percona-server" target="_blank" rel="noopener">https://www.percona.com/software/mysql-database/percona-server</a> </p>
<h2 id="安装MYSQL"><a href="#安装MYSQL" class="headerlink" title="安装MYSQL"></a>安装MYSQL</h2><p>Mariadb安装方式：</p>
<ol>
<li>源代码：编译安装  </li>
<li>二进制格式的程序包：展开至特定路径，并经过简单配置后即可使用  </li>
<li>程序包管理器管理的程序包<br>CentOS 安装光盘<br>项目官方：<a href="https://downloads.mariadb.org/mariadb/repositories/" target="_blank" rel="noopener">https://downloads.mariadb.org/mariadb/repositories/</a><br>国内镜像：<a href="https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadbx.y.z/yum/centos/7/x86_64/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadbx.y.z/yum/centos/7/x86_64/</a>  </li>
</ol>
<blockquote>
<p>提高安全性:<br>m<strong>ysql_secure_installation</strong>（运行此脚本提高安全性）<br>设置数据库管理员root口令<br>禁止root远程登录<br>删除anonymous用户帐号<br>删除test数据库  </p>
</blockquote>
<h2 id="MariaDB程序"><a href="#MariaDB程序" class="headerlink" title="MariaDB程序"></a>MariaDB程序</h2><ul>
<li>客户端程序：<br><strong>mysql</strong>: 交互式的CLI工具<br><strong>mysqldump</strong>：备份工具，基于mysql协议向mysqld发起查询请求，并将查得的所有数据转换成insert等写操作语句保存文本文件中<br><strong>mysqladmin</strong>：基于mysql协议管理mysqld<br>mysqlimport：数据导入工具  </li>
<li>MyISAM存储引擎的管理工具：<br>myisamchk：检查MyISAM库<br>myisampack：打包MyISAM表，只读  </li>
<li>服务器端程序<br>mysqld_safe<br>mysqld<br>mysqld_multi 多实例 ，示例：mysqld_multi –example  #配合不同端口号</li>
</ul>
<h2 id="用户账号"><a href="#用户账号" class="headerlink" title="用户账号"></a>用户账号</h2><p>mysql用户账号由两部分组成：<br>‘USERNAME‘@’HOST’<br>说明：<br>HOST限制此用户可通过哪些远程主机连接mysql服务器<br>支持使用通配符：<br>% 匹配任意长度的任意字符<br>172.16.0.0/255.255.0.0 或 172.16.%.%<br>_ 匹配任意单个字符  </p>
<h2 id="Mysql-客户端"><a href="#Mysql-客户端" class="headerlink" title="Mysql 客户端"></a>Mysql 客户端</h2><ul>
<li>mysql使用模式：<br>交互式模式：<br>可运行命令有两类：<br>客户端命令：<br>\h, help<br>\u，use<br>\s，status<br>\!，system</li>
<li>服务器端命令：<br>SQL语句， <strong>需要语句结束符</strong>;  </li>
<li>脚本模式： #使用脚本文件重定向到mysql命令中执行<br>mysql –uUSERNAME -pPASSWORD &lt; /path/somefile.sql<br>mysql&gt; source /path/from/somefile.sql<br>mysql -e ‘show database’ #单独执行一次命令</li>
</ul>
<h3 id="常用选项"><a href="#常用选项" class="headerlink" title="常用选项"></a>常用选项</h3><p>mysql客户端可用选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-A, –no-auto-rehash</td>
<td>禁止补全</td>
</tr>
<tr>
<td>-u, –user=</td>
<td>用户名,默认为root</td>
</tr>
<tr>
<td>-h, –host=</td>
<td>服务器主机,默认为localhost</td>
</tr>
<tr>
<td>-p, –passowrd=</td>
<td>用户密码,建议使用-p,默认为空密码</td>
</tr>
<tr>
<td>-P, –port=</td>
<td>服务器端口</td>
</tr>
<tr>
<td>-S, –socket=</td>
<td>指定连接socket文件路径</td>
</tr>
<tr>
<td>-D, –database=</td>
<td>指定默认数据库</td>
</tr>
<tr>
<td>-C, –compress</td>
<td>启用压缩</td>
</tr>
<tr>
<td>-e “SQL”</td>
<td>执行SQL命令</td>
</tr>
<tr>
<td>-V, –version</td>
<td>显示详细信息</td>
</tr>
<tr>
<td>–print-defaults</td>
<td>获取程序默认使用的配置</td>
</tr>
</tbody>
</table>
<blockquote>
<p>mysql5.5之后的版本开始使用innodb作为默认引擎   </p>
</blockquote>
<p>可以考虑修改配置文件修改mysql提示符以区分生成和测试环境，避免出现误操作<br>centos6:/etc/my.cnf<br>centos7:/etc/my.cnf.d/mysql-clients.cnf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line">[mysql]   </span><br><span class="line">prompt=\u@[\D]test--&gt;  </span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">select user(); #显示当前用户  </span><br><span class="line">select version(); #显示当前版本  </span><br><span class="line">带括号的字符是mysql的函数字符  </span><br><span class="line"></span><br><span class="line">mysql 主机+用户名可以控制登录用户  </span><br><span class="line"></span><br><span class="line">## socket地址</span><br><span class="line">服务器监听的两种socket地址：  </span><br><span class="line">ip socket: 监听在tcp的3306端口，支持远程通信  </span><br><span class="line">unix sock: 监听在sock文件上，仅支持本机通信  </span><br><span class="line">如：/var/lib/mysql/mysql.sock)</span><br><span class="line">说明：host为localhost,127.0.0.1时自动使用unix sock</span><br><span class="line"></span><br><span class="line">## 执行命令</span><br><span class="line">运行mysql命令：默认空密码登录</span><br><span class="line">mysql&gt;use mysql</span><br><span class="line">mysql&gt;select user();查看当前用户</span><br><span class="line">mysql&gt;SELECT User,Host,Password FROM user;</span><br><span class="line">登录系统：mysql –uroot –p</span><br><span class="line">客户端命令：本地执行</span><br><span class="line">mysql&gt; help</span><br><span class="line">每个命令都完整形式和简写格式</span><br><span class="line">mysql&gt; status 或 \s</span><br><span class="line">服务端命令：通过mysql协议发往服务器执行并取回结果</span><br><span class="line">每个命令末尾都必须使用命令结束符号，默认为分号</span><br><span class="line">示例：SELECT VERSION();</span><br><span class="line"></span><br><span class="line">## 服务器端配置</span><br><span class="line">服务器端(mysqld)：工作特性有多种配置方式  </span><br><span class="line">1、命令行选项：  </span><br><span class="line">2、配置文件：类ini格式  </span><br><span class="line">集中式的配置，能够为mysql的各应用程序提供配置信息  </span><br><span class="line">[mysqld]  #mysql命令的选项  </span><br><span class="line">[mysqld_safe]    </span><br><span class="line">[mysqld_multi]  </span><br><span class="line">[mysql]  </span><br><span class="line">[mysqldump]  #备份选项  </span><br><span class="line">[server]  #服务端选项  </span><br><span class="line">[client]  #客户端选项  </span><br><span class="line">格式：parameter = value  </span><br><span class="line">说明：_和- 相同  </span><br><span class="line">1，ON，TRUE意义相同， 0，OFF，FALSE意义相同  </span><br><span class="line"></span><br><span class="line">## 配置文件</span><br><span class="line">配置文件：  </span><br><span class="line">**后面覆盖前面**的配置文件，顺序如下：#指定路径优先级高于配置文件  </span><br><span class="line">/etc/my.cnf Global选项  </span><br><span class="line">/etc/mysql/my.cnf Global选项  </span><br><span class="line">SYSCONFDIR/my.cnf Global选项  </span><br><span class="line">$MYSQL_HOME/my.cnf Server-specific 选项  </span><br><span class="line">--defaults-extra-file=path   </span><br><span class="line">~/.my.cnf User-specific 选项   </span><br><span class="line"></span><br><span class="line">## MairaDB配置</span><br><span class="line">侦听3306/tcp端口可以在绑定有一个或全部接口IP上  </span><br><span class="line">vim /etc/my.cnf   </span><br><span class="line">[mysqld]  </span><br><span class="line">skip-networking=1  #禁用网络连接，可在维护时添加      </span><br><span class="line">关闭网络连接，只侦听本地客户端，所有和服务器的交互都通过一个socket实现，socket的配置存放在/var/lib/mysql/mysql.sock）可在/etc/my.cnf修改</span><br><span class="line"></span><br><span class="line"># 通用二进制格式安装过程</span><br><span class="line">二进制格式安装过程  </span><br><span class="line">1. 准备用户  </span><br><span class="line">groupadd -r -g 306 mysql  </span><br><span class="line">useradd -r -g 306 -u 306 –d /data/mysql mysql  </span><br><span class="line">1. 准备数据目录，建议使用**逻辑卷**  </span><br><span class="line">mkdir /data/mysql  </span><br><span class="line">chown mysql:mysql /data/mysql  </span><br><span class="line">1. 准备二进制程序  </span><br><span class="line">tar xf mariadb-VERSION-linux-x86_64.tar.gz -C /usr/local  </span><br><span class="line">cd /usr/local  </span><br><span class="line">ln -sv mariadb-VERSION mysql  </span><br><span class="line">chown -R root:mysql /usr/local/mysql/   </span><br><span class="line">1. 准备配置文件  </span><br><span class="line">mkdir /etc/mysql/  </span><br><span class="line">cp support-files/my-large.cnf /etc/mysql/my.cnf  </span><br><span class="line">[mysqld]中添加三个选项：  </span><br><span class="line">datadir = /data/mysql  </span><br><span class="line">**innodb_file_per_table** = on  #新版本可不加，已默认启用  </span><br><span class="line">**skip_name_resolve** = on 禁止主机名解析，建议使用  </span><br><span class="line">1. 创建数据库文件  </span><br><span class="line">cd /usr/local/mysql/  </span><br><span class="line">./scripts/mysql_install_db --datadir=/data/mysql --user=mysql --basedir=/usr/local/nysql</span><br><span class="line">1. 准备服务脚本，并启动服务  </span><br><span class="line"> cp ./support-files/mysql.server /etc/rc.d/init.d/mysqld  </span><br><span class="line"> chkconfig --add mysqld  </span><br><span class="line"> service mysqld start  </span><br><span class="line">1. PATH路径  </span><br><span class="line">echo &apos;PATH=/user/local/mysql/bin:$PATH&apos; &gt; **/etc/profile.d**/mysql  </span><br><span class="line">1. 安全初始化  </span><br><span class="line">/user/local/mysql/bin/mysql_secure_installation   </span><br><span class="line"></span><br><span class="line"># 源码编译安装mariadb</span><br><span class="line">1. 安装包  </span><br><span class="line">`yum install bison bison-devel zlib-devel libcurl-devel libarchive-devel boostdevel gcc gcc-c++ cmake ncurses-devel gnutls-devel libxml2-devel openssldevel libevent-devel libaio-devel`</span><br><span class="line">2. 做准备用户和数据目录  </span><br><span class="line">`useradd –r –s /sbin/nologin –d /data/mysql/ mysql`  </span><br><span class="line">`mkdir /data/mysql`  </span><br><span class="line">`chown mysql.mysql /data/mysql`  </span><br><span class="line">`tar xvf mariadb-10.2.18.tar.gz`  </span><br><span class="line">3. cmake 编译安装  </span><br><span class="line">cmake的重要特性之一是其独立于源码(out-of-source)的编译功能，即编译工作可以在</span><br><span class="line">另一个指定的目录中而非源码目录中进行，这可以保证源码目录不受任何一次编译的影</span><br><span class="line">响，因此在同一个源码树上可以进行多次不同的编译，如针对于不同平台编译  </span><br><span class="line">编译选项:https://dev.mysql.com/doc/refman/5.7/en/source-configuration-options.html</span><br><span class="line">- cd mariadb-10.2.18/  </span><br><span class="line">cmake . \\  #\\长命令换行  </span><br><span class="line">-DCMAKE_INSTALL_PREFIX=/app/mysql \\  </span><br><span class="line">-DMYSQL_DATADIR=/data/mysql/ \\  </span><br><span class="line">-DSYSCONFDIR=/etc \\  </span><br><span class="line">-DMYSQL_USER=mysql \\  </span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \\  </span><br><span class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=1 \\  </span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \\  </span><br><span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \\  </span><br><span class="line">-DWITHOUT_MROONGA_STORAGE_ENGINE=1 \\  </span><br><span class="line">-DWITH_DEBUG=0 \\  </span><br><span class="line">-DWITH_READLINE=1 \\  </span><br><span class="line">-DWITH_SSL=system \\  </span><br><span class="line">-DWITH_ZLIB=system \\  </span><br><span class="line">-DWITH_LIBWRAP=0 \\  </span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \\  </span><br><span class="line">-DMYSQL_UNIX_ADDR=/data/mysql/mysql.sock \\  </span><br><span class="line">-DDEFAULT_CHARSET=utf8 \\  </span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">&gt; 提示：如果出错，执行rm -f CMakeCache.txt</span><br><span class="line">4. 准备环境变量  </span><br><span class="line">`echo &apos;PATH=/app/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh`  </span><br><span class="line">`. /etc/profile.d/mysql.sh`  </span><br><span class="line">5. 生成数据库文件  </span><br><span class="line">`cd /app/mysql/`  </span><br><span class="line">`scripts/mysql_install_db --datadir=/data/mysql/ --user=mysql`  </span><br><span class="line">6. 准备配置文件  </span><br><span class="line">`cp /app/mysql/support-files/my-huge.cnf /etc/my.cnf`  </span><br><span class="line">7. 准备启动脚本  </span><br><span class="line">`cp /app/mysql/support-files/mysql.server /etc/init.d/mysqld`  </span><br><span class="line">8. 启动服务  </span><br><span class="line">`chkconfig --add mysqld ;service mysqld start`  </span><br><span class="line"></span><br><span class="line"># 关系型数据库的常见组件</span><br><span class="line">- **数据库**：database</span><br><span class="line">- **表**：table   </span><br><span class="line">行：row  </span><br><span class="line">列：column</span><br><span class="line">- **索引**：index</span><br><span class="line">- **视图**：view</span><br><span class="line">- 用户：user</span><br><span class="line">- 权限：privilege</span><br><span class="line">- 存储过程：procedure</span><br><span class="line">- 存储函数：function</span><br><span class="line">- 触发器：trigger</span><br><span class="line">- 事件调度器：event scheduler，任务计划</span><br><span class="line"></span><br><span class="line"># SQL语言规范</span><br><span class="line">- 在数据库系统中，SQL语句不区分大小写(建议用大写)  </span><br><span class="line">- **SQL语句可单行或多行书写**，以“;”结尾  </span><br><span class="line">- 关键词不能跨多行或简写  </span><br><span class="line">- 用空格和缩进来提高语句的可读性  </span><br><span class="line">- 子句通常位于独立行，便于编辑，提高可读性  </span><br><span class="line">- 注释：  </span><br><span class="line">SQL标准：  </span><br><span class="line">\/*注释内容\*/  #多行注释  </span><br><span class="line">-- 注释内容  #单行注释，注意有空格  </span><br><span class="line">MySQL注释：\#  </span><br><span class="line"></span><br><span class="line"># 数据库对象</span><br><span class="line">- 数据库的组件(对象)：  </span><br><span class="line">数据库、表、索引、视图、用户、存储过程、函数、触发器、事件调度器等</span><br><span class="line">- 命名规则：  </span><br><span class="line">**必须以字母开头**  </span><br><span class="line">可包括数字和三个特殊字符（# _ $）  </span><br><span class="line">不要使用MySQL的保留字  </span><br><span class="line">同一database(Schema)下的对象不能同名  </span><br><span class="line"></span><br><span class="line"># SQL语句分类</span><br><span class="line">- DDL: Data Defination Language 数据定义语言  </span><br><span class="line">CREATE，**DROP**，ALTER  </span><br><span class="line">- DML: Data Manipulation Language 数据操纵语言  </span><br><span class="line">**INSERT**，**DELETE**，**UPDATE**  </span><br><span class="line">- DCL：Data Control Language 数据控制语言  </span><br><span class="line">GRANT，REVOKE，COMMIT，ROLLBACK  </span><br><span class="line">- DQL：Data Query Language 数据查询语言  </span><br><span class="line">**SELECT**</span><br><span class="line"></span><br><span class="line"># SQL语句构成</span><br><span class="line">Keyword组成clause  </span><br><span class="line">多条clause组成语句  </span><br><span class="line"></span><br><span class="line">示例：  </span><br><span class="line">SELECT *  #SELECT子句  </span><br><span class="line">FROM products #FROM子句  </span><br><span class="line">WHERE price&gt;400 #WHERE子句  </span><br><span class="line">说明：一组SQL语句，由三个子句构成，SELECT,FROM和WHERE是关键字  </span><br><span class="line"></span><br><span class="line"># 数据库操作</span><br><span class="line">- 创建数据库：  </span><br><span class="line">CREATE DATABASE|SCHEMA [IF NOT EXISTS] &apos;DB_NAME&apos;;  </span><br><span class="line">CHARACTER SET &apos;character set name&apos;  #设置默认字符集   </span><br><span class="line">例如：</span><br><span class="line">`create database db_utf8mb4 CHARACTER SET=utf8mb4;`  </span><br><span class="line">COLLATE &apos;collate name&apos;  #字符排序 </span><br><span class="line">- 删除数据库  </span><br><span class="line">DROP DATABASE|SCHEMA [IF EXISTS] &apos;DB_NAME&apos;;  </span><br><span class="line">例如:`drop database testdb;`</span><br><span class="line">- 查看支持所有字符集：SHOW CHARACTER SET;  </span><br><span class="line">- 查看支持所有排序规则：SHOW COLLATION; </span><br><span class="line">- 查看数据库创建的默认选项   </span><br><span class="line">show create database testdb;</span><br><span class="line">- 获取命令使用帮助：  </span><br><span class="line">mysql&gt; HELP KEYWORD;  </span><br><span class="line">- 查看数据库列表：  </span><br><span class="line">mysql&gt; SHOW DATABASES;</span><br></pre></td></tr></table></figure></p>
<p>创建数据库后建议修改配置文件：</p>
<p>1、建议创建数据时就定义好字符集：<br>vim /etc/my.cnf.d/server.cnf<br>[mysqld]<br>character-set-server=utf8mb4<br>客户端<br>vim /etc/my.cnf.d/mysql-clients.cnf<br>[mysql]<br>default-character-set=utf8mb4<br>重启服务<br>systemctl restart mariadb</p>
<p>2、将低版本的mysql数据分开存放<br>vim /etc/my.cnf.d/server.cnf<br>[mysqld]<br>innodb_file_per_table=ON<br>systemctl restart mariadb</p>
<p>3、安全的删除和更新数据<br>修改客户端配置文件<br>vim /etc/my.cnf.d/mysql-clients.cnf<br>[mysql]<br>safe-updates<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 数据表</span><br><span class="line">表：二维关系  </span><br><span class="line">设计表：遵循规范  </span><br><span class="line">定义：字段，索引  </span><br><span class="line">字段：字段名，字段数据类型，修饰符  </span><br><span class="line">约束，索引：应该创建在经常用作查询条件的字段上  </span><br><span class="line"></span><br><span class="line">## 创建表</span><br><span class="line">创建表：CREATE TABLE</span><br><span class="line">1. 直接创建</span><br><span class="line">1. 通过查询现存表创建；新表会被直接插入查询而来的数据   </span><br><span class="line">CREATE TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">[(create_definition,...)] [table_options]</span><br><span class="line">[partition_options] select_statement  </span><br><span class="line">`create table custom select * from student;`</span><br><span class="line">1. 通过复制现存的表的表结构创建，但不复制数据  </span><br><span class="line">CREATE TABLE [IF NOT EXISTS] tbl_name &#123; LIKE</span><br><span class="line">old_tbl_name | (LIKE old_tbl_name) &#125;   </span><br><span class="line">`create table custom like student;`</span><br><span class="line"></span><br><span class="line">&gt; 注意：</span><br><span class="line">Storage Engine是指表类型，也即在表创建时指明其使用的存储引擎，同一库中不同表可以使用不同的存储引擎</span><br><span class="line">同一个库中表建议要使用同一种存储引擎类型</span><br></pre></td></tr></table></figure></p>
<p>CREATE TABLE [IF NOT EXISTS] ‘tbl_name’ (col1 type1 修饰符, col2<br>type2 修饰符, …)  #col列名称<br>字段信息<br>• col type1<br>• PRIMARY KEY(col1,…) #主键<br>• INDEX(col1, …)<br>• UNIQUE KEY(col1, …)<br>表选项：<br>• ENGINE [=] engine_name  #存储引擎定义<br>SHOW ENGINES;查看支持的engine类型<br>• ROW_FORMAT [=]          #是否压缩存储<br>{DEFAULT|DYNAMIC|FIXED|COMPRESSED|REDUNDANT|COMPACT}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">创建表示例：</span><br><span class="line">CREATE TABLE students (id int UNSIGNED NOT NULL PRIMARY KEY,name VARCHAR（20）NOT NULL,age tinyint UNSIGNED);</span><br><span class="line">DESC students;  #查看表</span><br><span class="line"></span><br><span class="line">CREATE TABLE students2 (id int UNSIGNED NOT NULL ,name VARCHAR(20) NOT NULL,age tinyint UNSIGNED,PRIMARY KEY(id,name));</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>获取帮助：mysql&gt; HELP CREATE TABLE; </p>
</blockquote>
<h2 id="表操作"><a href="#表操作" class="headerlink" title="表操作"></a>表操作</h2><p>查看所有的引擎：<br><code>SHOW ENGINES</code><br><strong>查看表</strong>：<br><code>SHOW TABLES [FROM db_name]</code><br><strong>查看表结构</strong>：<br><code>DESC [db_name.]tb_name</code><br><code>SHOW COLUMNS FROM [db_name.]tb_name</code><br>删除表：<br><code>DROP TABLE [IF EXISTS] tb_name</code><br>查看表创建命令：<br><code>SHOW CREATE TABLE tbl_name</code><br><strong>查看表状态</strong>：<br><code>SHOW TABLE STATUS LIKE &#39;tbl_name&#39;</code><br>查看库中所有表状态：<br><code>SHOW TABLE STATUS FROM db_name</code><br>修改表<br><code>ALTER TABLE &#39;tbl_name&#39;</code><br>字段：<br>添加字段：add<br>ADD col1 data_type [FIRST|AFTER col_name]<br>删除字段：drop<br>修改字段：<br>alter（默认值）, change（字段名）,modify（字段属性）<br><code>alter table student CHARACTER SET=utf8mb4;</code><br>索引:<br>添加索引：add index<br>删除索引：drop index<br>查看表上的索引：SHOW INDEXES FROM    [db_name.]tbl_name;</p>
<blockquote>
<p>查看帮助：Help ALTER TABLE<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">ALTER TABLE students RENAME s1;</span><br><span class="line">ALTER TABLE s1 ADD phone varchar(11) AFTER name;</span><br><span class="line">ALTER TABLE s1 MODIFY phone int;</span><br><span class="line">ALTER TABLE s1 CHANGE COLUMN phone mobile char(11);</span><br><span class="line">ALTER TABLE s1 DROP COLUMN mobile;</span><br><span class="line">ALTER TABLE students ADD gender ENUM(&apos;m&apos;,&apos;f&apos;)</span><br><span class="line">ALETR TABLE students CHANGE id sid int UNSIGNED NOT NULL PRIMARY KEY;</span><br><span class="line">ALTER TABLE students ADD UNIQUE KEY(name);</span><br><span class="line">ALTER TABLE students ADD INDEX(age);</span><br><span class="line">DESC students;</span><br><span class="line">SHOW INDEXES FROM students;</span><br><span class="line">ALTER TABLE students DROP age;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><ul>
<li>数据类型：<br>数据长什么样<br>数据需要多少空间来存放</li>
<li>系统内置数据类型和用户定义数据类型</li>
<li>MySql支持多种列类型：</li>
</ul>
<ol>
<li>数值类型</li>
<li>日期/时间类型</li>
<li>字符串(字符)类型<blockquote>
<p><a href="https://dev.mysql.com/doc/refman/5.5/en/data-types.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.5/en/data-types.html</a></p>
</blockquote>
</li>
</ol>
<p><strong>选择正确的数据类型对于获得高性能至关重要</strong>，三大原则：</p>
<ol>
<li>更小的通常更好，尽量使用可正确存储数据的最小数据类型</li>
<li>简单就好，简单数据类型的操作通常需要更少的CPU周期</li>
<li>尽量避免NULL，包含为NULL的列，对MySQL更难优化<br><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1543505120590&amp;di=f9e6320ab071fa2f524d22cbbf4702bb&amp;imgtype=jpg&amp;src=http%3A%2F%2Fimg4.imgtn.bdimg.com%2Fit%2Fu%3D3220053439%2C312874450%26fm%3D214%26gp%3D0.jpg" alt="int"></li>
</ol>
<h2 id="整数型"><a href="#整数型" class="headerlink" title="整数型"></a>整数型</h2><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>tinyint(m)</td>
<td>1个字节 范围(-128~127)</td>
</tr>
<tr>
<td>smallint(m)</td>
<td>2个字节 范围(-32768~32767)</td>
</tr>
<tr>
<td>mediumint(m)</td>
<td>3个字节 范围(-8388608~8388607)</td>
</tr>
<tr>
<td>int(m)</td>
<td>4个字节 范围(-2147483648~2147483647)</td>
</tr>
<tr>
<td>bigint(m)</td>
<td>8个字节 范围(+-9.22*10的18次方)</td>
</tr>
<tr>
<td>BOOL，BOOLEAN</td>
<td>布尔型，是TINYINT(1)的同义词。zero值被视为假，非zero值视为真</td>
</tr>
</tbody>
</table>
<blockquote>
<p>1、加了unsigned，则最大值翻倍，如：tinyint unsigned的取值范围为(0~255)<br>2、int(m)里的m是表示SELECT查询结果集中的显示宽度，并不影响实际的取值范围，规定了MySQL的一些交互工具（例如MySQL命令行客户端）用来显示字符的个数。对于存储和计算来说，Int(1)和Int(20)是相同的</p>
</blockquote>
<h2 id="浮点型"><a href="#浮点型" class="headerlink" title="浮点型"></a>浮点型</h2><p>float(m,d) 单精度浮点型 8位精度(4字节) m总个数，d小数位<br>double(m,d) 双精度浮点型16位精度(8字节) m总个数，d小数位<br>设一个字段定义为float(6,3)，如果插入一个数123.45678,实际数据库里存的是123.457，但总个数还以实际为准，即6位</p>
<h2 id="定点数"><a href="#定点数" class="headerlink" title="定点数"></a>定点数</h2><ul>
<li>在数据库中存放的是精确值,存为十进制</li>
<li>decimal(m,d) 参数m&lt;65 是总个数，d&lt;30且 d&lt;m 是小数位</li>
<li>MySQL5.0和更高版本将数字打包保存到一个二进制字符串中（每4个字节存9个数字）。例如，decimal(18,9)小数点两边将各存储9个数字，一共使用9个字节：小数点前的数字用4个字节，小数点后的数字用4个字节，小数点本身占1个字节</li>
<li>浮点类型在存储同样范围的值时，通常比decimal使用更少的空间。float使用4个字节存储。double占用8个字节</li>
<li>因为需要额外的空间和计算开销，所以应该尽量只在对小数进行精确计算时才使用decimal——例如存储财务数据。但在数据量比较大的时候，可以考虑使用bigint代替decimal</li>
</ul>
<h2 id="字符串-char-varchar-text"><a href="#字符串-char-varchar-text" class="headerlink" title="字符串(char,varchar,_text)"></a>字符串(char,varchar,_text)</h2><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>char(n)</td>
<td>固定长度，最多255个字符</td>
</tr>
<tr>
<td>varchar(n)</td>
<td>可变长度，最多65535个字符</td>
</tr>
<tr>
<td>tinytext</td>
<td>可变长度，最多255个字符</td>
</tr>
<tr>
<td>text</td>
<td>可变长度，最多65535个字符</td>
</tr>
<tr>
<td>mediumtext</td>
<td>可变长度，最多2的24次方-1个字符</td>
</tr>
<tr>
<td>longtext</td>
<td>可变长度，最多2的32次方-1个字符</td>
</tr>
<tr>
<td>BINARY(M)</td>
<td>固定长度，可存二进制或字符，长度为0-M字节</td>
</tr>
<tr>
<td>VARBINARY(M)</td>
<td>可变长度，可存二进制或字符，允许长度为0-M字节</td>
</tr>
<tr>
<td>内建类型</td>
<td>ENUM枚举, SET集合</td>
</tr>
</tbody>
</table>
<p>char和varchar：  </p>
<ol>
<li>char(n) 若存入字符数小于n，则以空格补于其后，查询之时再将空格去掉，<br>所以char类型存储的字符串末尾不能有空格，varchar不限于此</li>
<li>char(n) 固定长度，char(4)不管是存入几个字符，都将占用4个字节，varchar<br>是存入的实际字符数+1个字节（n&lt; n&gt;255)，所以varchar(4),存入3个字符将<br>占用4个字节</li>
<li>char类型的字符串检索速度要比varchar类型的快</li>
</ol>
<p>varchar和text：</p>
<ol>
<li>varchar可指定n，text不能指定，内部存储varchar是存入的实际字符数+1个<br>字节（n&lt; n&gt;255)，text是实际字符数+2个字节。</li>
<li>text类型不能有默认值</li>
<li>varchar可直接创建索引，text创建索引要指定前多少个字符。varchar查询速<br>度快于text</li>
</ol>
<h2 id="二进制数据BLOB"><a href="#二进制数据BLOB" class="headerlink" title="二进制数据BLOB"></a>二进制数据BLOB</h2><p>BLOB和text存储方式不同，TEXT以文本方式存储，英文存储区分大小写，而Blob是以二进制方式存储，不分大小写<br>BLOB存储的数据只能整体读出<br>TEXT可以指定字符集，BLOB不用指定字符集  </p>
<h2 id="日期时间类型"><a href="#日期时间类型" class="headerlink" title="日期时间类型"></a>日期时间类型</h2><p>date 日期 ‘2008-12-2’<br>time 时间 ‘12:25:36’<br>datetime 日期时间 ‘2008-12-2 22:06:44’<br>timestamp 自动存储记录修改时间<br>YEAR(2), YEAR(4)：年份  </p>
<blockquote>
<p>timestamp字段里的时间数据会随其他字段修改的时候自动刷新，这个数据类型的字段可以存放这条记录最后被修改的时间</p>
</blockquote>
<h2 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h2><p>所有类型：<br>• NULL 数据列可包含NULL值<br>• NOT NULL 数据列不允许包含NULL值<br>• DEFAULT 默认值<br>• PRIMARY KEY 主键<br>• UNIQUE KEY 唯一键<br>• CHARACTER SET name 指定一个字符集<br>数值型<br>• AUTO_INCREMENT 自动递增，适用于整数类型<br>• UNSIGNED 无符号  </p>
<h2 id="DML语句"><a href="#DML语句" class="headerlink" title="DML语句"></a>DML语句</h2><p>DML: INSERT, DELETE, UPDATE  </p>
<h3 id="INSERT："><a href="#INSERT：" class="headerlink" title="INSERT："></a>INSERT：</h3><p>一次插入一行或多行数据<br>三种语法：  </p>
<ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [IGNORE] </span><br><span class="line">[INTO] tbl_name [(col_name,...)] </span><br><span class="line">&#123;VALUES | VALUE&#125; (&#123;expr | DEFAULT&#125;,...),(...),...</span><br><span class="line">[ON DUPLICATE KEY UPDATE 如果重复更新之col_name=expr [, col_name=expr] ... ]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>简化写法</strong>：<br><code>INSERT tbl_name [(col1,...)] VALUES (val1,...), (val21,...)</code>  </p>
<blockquote>
<p>后面的具体值必须和字段属性和顺序匹配</p>
<ol start="2">
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [IGNORE] </span><br><span class="line">[INTO] tbl_name</span><br><span class="line">SET col_name=&#123;expr | DEFAULT&#125;, ...</span><br><span class="line">[ ON DUPLICATE KEY UPDATE</span><br><span class="line">col_name=expr</span><br><span class="line">[, col_name=expr] ... ]</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<ol start="3">
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT [LOW_PRIORITY | HIGH_PRIORITY] [IGNORE]</span><br><span class="line">[INTO] tbl_name [(col_name,...)]</span><br><span class="line">SELECT ...</span><br><span class="line">[ ON DUPLICATE KEY UPDATE</span><br><span class="line">col_name=expr</span><br><span class="line">[, col_name=expr] ... ]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a>UPDATE</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UPDATE [LOW_PRIORITY] [IGNORE] table_reference</span><br><span class="line">SET col_name1=&#123;expr1|DEFAULT&#125; [, col_name2=&#123;expr2|DEFAULT&#125;] ...</span><br><span class="line">[WHERE where_condition]</span><br><span class="line">[ORDER BY ...]</span><br><span class="line">[LIMIT row_count]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：一定要有限制条件，否则将修改所有行的指定字段<br>限制条件：<br>WHERE<br>LIMIT  </p>
</blockquote>
<p><strong>建议使用安全更新语句以往误操作</strong><br>Mysql 选项：-U|–safe-updates| –i-am-a-dummy<br>或定义别名 alias mysql=’mysql -U’</p>
<h3 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a>DELETE</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELETE [LOW_PRIORITY] [QUICK] [IGNORE] FROM tbl_name</span><br><span class="line">[WHERE where_condition]</span><br><span class="line">[ORDER BY ...]</span><br><span class="line">[LIMIT row_count]</span><br><span class="line">可先排序再指定删除的行数</span><br><span class="line">示例：</span><br><span class="line">delete from student where id &gt;= 5;</span><br><span class="line">快速删除表中所有内容，但不记录日志：</span><br><span class="line">truncate table student;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：一定要有限制条件，否则将清空表中的所有数据<br>限制条件：<br>WHERE<br>LIMIT<br>TRUNCATE TABLE tbl_name; 清空表</p>
</blockquote>
<h1 id="DQL语句"><a href="#DQL语句" class="headerlink" title="DQL语句"></a>DQL语句</h1><h2 id="SELECT"><a href="#SELECT" class="headerlink" title="SELECT"></a>SELECT</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[ALL | DISTINCT | DISTINCTROW ]</span><br><span class="line">[SQL_CACHE | SQL_NO_CACHE]</span><br><span class="line">select_expr [, select_expr ...]</span><br><span class="line"> [FROM table_references</span><br><span class="line"> [WHERE where_condition]</span><br><span class="line"> [GROUP BY &#123;col_name | expr | position&#125;</span><br><span class="line"> [ASC | DESC], ... [WITH ROLLUP]]</span><br><span class="line"> [HAVING where_condition]</span><br><span class="line"> [ORDER BY &#123;col_name | expr | position&#125;</span><br><span class="line"> [ASC | DESC], ...]</span><br><span class="line"> [LIMIT &#123;[offset,] row_count | row_count OFFSET offset&#125;]</span><br><span class="line"> [FOR UPDATE | LOCK IN SHARE MODE]</span><br></pre></td></tr></table></figure>
<p><strong>字段显示可以使用别名</strong>：<br>col1 AS alias1, col2 AS alias2, …<br><strong>WHERE子句</strong>：指明过滤条件以实现“选择”的功能：<br><code>select name as 姓名,id,age as 年龄 from student;</code><br>过滤条件：</p>
<ul>
<li>布尔型表达式</li>
<li>算术操作符：+, -, *, /, %</li>
<li>比较操作符：=,&lt;=&gt;（相等或都为空）, &lt;&gt;, !=(非标准SQL), &gt;, &gt;=, &lt;, &lt;=</li>
<li>BETWEEN min_num AND max_num</li>
<li>IN (element1, element2, …)</li>
<li>IS NULL</li>
<li><p>IS NOT NULL</p>
<blockquote>
<p>查询命令定义别名后，不能再使用表名查询 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from student where age &gt; 25;  #查询年龄大于25</span><br><span class="line">select * from student where age between 25 and 28;  # 查询年龄在25到28之间</span><br><span class="line">select * from student where age in (20,30);  #查询年龄等于20和30的</span><br><span class="line">select * from student where mobile is null;  #查询手机号码为空</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>DISTINCT 去除重复列<br><code>SELECT DISTINCT gender FROM students;</code> </p>
</li>
<li><strong>LIKE</strong>:<br>% 任意长度的任意字符<br>_ 任意单个字符  </li>
<li>RLIKE：正则表达式，<strong>索引失效，不建议使用</strong><br>REGEXP：匹配字符串可用正则表达式书写模式，同上</li>
<li>逻辑操作符：<br>NOT<br>AND<br>OR<br>XOR  </li>
<li><p><strong>GROUP</strong>：根据指定的条件把查询结果进行“分组”以用于做“聚合”运算avg(), max(), min(), count(), sum()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">select gender as 性别,count(*) as 人数 from students group by gender;</span><br><span class="line"></span><br><span class="line">select gender as 性别,avg(age) as 平均年龄 from students group by gender;</span><br><span class="line"></span><br><span class="line">select classid,gender,max(age) from students group by classid,gender;</span><br><span class="line"></span><br><span class="line">分组前统计</span><br><span class="line">select classid,count(*) from students where age &gt; 30 group by classid;</span><br><span class="line"></span><br><span class="line">分组后再统计</span><br><span class="line">select classid,count(*) from students where age &gt; 30 group by classid having classid;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>HAVING</strong>: 对分组聚合运算后的结果指定过滤条件  </p>
</li>
<li><strong>ORDER BY</strong>: 根据指定的字段对查询结果进行排序<br>升序：ASC<br>降序：DESC<br><code>select * from students order by age desc;</code><br><code>select * from students order by age asc;</code><br>排除null值后按正序排列<br><code>select * from students order by -classid desc;</code></li>
<li>LIMIT [[offset,]row_count]：对查询的结果进行输出行数数量限制<br>对查询结果中的数据请求施加“锁”<br>FOR UPDATE: 写锁，独占或排它锁，只有一个读和写<br>LOCK IN SHARE MODE: 读锁，共享锁，同时多个读  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DESC students;</span><br><span class="line">INSERT INTO students VALUES(1,&apos;tom&apos;，&apos;m&apos;),(2,&apos;alice&apos;,&apos;f&apos;);</span><br><span class="line">INSERT INTO students(id,name) VALUES(3,&apos;jack&apos;),(4,&apos;allen&apos;);</span><br><span class="line">SELECT * FROM students WHERE id &lt; 3;</span><br><span class="line">SELECT * FROM students WHERE gender=&apos;m&apos;;</span><br><span class="line">SELECT * FROM students WHERE gender IS NULL;</span><br><span class="line">SELECT * FROM students WHERE gender IS NOT NULL;</span><br><span class="line">SELECT * FROM students ORDER BY name DESC LIMIT 2;</span><br><span class="line">SELECT * FROM students ORDER BY name DESC LIMIT 1,2;</span><br><span class="line">SELECT * FROM students WHERE id &gt;=2 and id &lt;=4</span><br><span class="line">SELECT * FROM students WHERE BETWEEN 2 AND 4</span><br><span class="line">SELECT * FROM students WHERE name LIKE ‘t%’</span><br><span class="line">SELECT * FROM students WHERE name RLIKE &apos;.*[lo].*&apos;;</span><br><span class="line">SELECT id stuid,name as stuname FROM students</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h1><p>交叉连接：笛卡尔乘积<br>内连接：<br>等值连接：让表之间的字段以“等值”建立连接关系；<br>不等值连接<br>自然连接:去掉重复列的等值连接<br>自连接<br>外连接：<br>左外连接：<br>FROM tb1 LEFT JOIN tb2 ON tb1.col=tb2.col<br>右外连接<br>FROM tb1 RIGHT JOIN tb2 ON tb1.col=tb2.col  </p>
<h1 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h1><p>视图：VIEW,虚表，保存有实表的查询结果<br>创建方法：<br><code>CREATE VIEW view_name [(column_list)] AS select_statement [WITH [CASCADED | LOCAL] CHECK OPTION]</code><br>查看视图定义：<br>SHOW CREATE VIEW view_name<br>删除视图：<br>DROP VIEW [IF EXISTS] view_name [, view_name] … [RESTRICT | CASCADE]<br><strong>视图中的数据事实上存储于“基表”中,视图本身不存放数据，因此，其修改操作也会针对基表实现</strong>；<br>其修改操作受基表限制</p>
<blockquote>
<p>视图一般适用于复杂多表查询，不适合修改数据</p>
</blockquote>
<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p>函数：系统函数和自定义函数<br> 系统函数:<a href="https://dev.mysql.com/doc/refman/5.7/en/func-op-summaryref.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/func-op-summaryref.html</a>  </p>
<ul>
<li>自定义函数 (user-defined function UDF)<br>保存在mysql.proc表中<br>创建UDF  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE [AGGREGATE] FUNCTION function_name(parameter_name</span><br><span class="line">type,[parameter_name type,...])</span><br><span class="line">RETURNS &#123;STRING|INTEGER|REAL&#125; #返回结果</span><br><span class="line">runtime_body   #函数定义体</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>说明：<br>参数可以有多个,也可以没有参数<br>必须有且只有一个返回值</p>
</blockquote>
<h2 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h2><ul>
<li>创建函数<br>示例：无参UDF<br><code>CREATE FUNCTION simpleFun() RETURNS VARCHAR(20) RETURN &quot;Hello World!&quot;;</code><br>select simpleFun();#查看函数<br>select hellod.simpleFun();#跨数据库查看  </li>
<li>查看函数列表：<br><code>SHOW FUNCTION STATUS;</code> </li>
<li>查看函数定义:<br><code>SHOW CREATE FUNCTION function_name</code></li>
<li>删除UDF:<br><code>DROP FUNCTION function_name;</code></li>
<li>调用自定义函数语法:<br><code>SELECT function_name(parameter_value,...)</code></li>
<li>示例：有参数UDF<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER // #避免;执行单条命令，将//定义为结束</span><br><span class="line">CREATE FUNCTION deleteById(uid SMALLINT UNSIGNED) RETURNS VARCHAR(20) #定义一个uid的参数</span><br><span class="line">BEGIN</span><br><span class="line">DELETE FROM students WHERE stuid = uid;  #删除stuid匹配uid参数</span><br><span class="line">RETURN (SELECT COUNT(stuid) FROM students);</span><br><span class="line">END//</span><br><span class="line"></span><br><span class="line">DELIMITER ;  #在写完整个函数后，重新使用;结束查询命令</span><br><span class="line">select deletebyid(27);  #删除stuid为27的数据</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="局部变量语法"><a href="#局部变量语法" class="headerlink" title="局部变量语法"></a>局部变量语法</h2><p>DECLARE 变量1[,变量2,… ]变量类型 [DEFAULT 默认值]<br>说明：局部变量的作用范围是在BEGIN…END程序中,而且定义局部变量语句必须在BEGIN…END的第一行定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">示例:</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE FUNCTION addTwoNumber(x SMALLINT UNSIGNED, Y SMALLINT</span><br><span class="line">UNSIGNED)</span><br><span class="line">RETURNS SMALLINT</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE a, b SMALLINT UNSIGNED;</span><br><span class="line">SET a = x, b = y;</span><br><span class="line">RETURN a+b;</span><br><span class="line">END//</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line">select addTwoNumber(1,45)</span><br></pre></td></tr></table></figure></p>
<h2 id="变量赋值语法"><a href="#变量赋值语法" class="headerlink" title="变量赋值语法"></a>变量赋值语法</h2><p>SET parameter_name = value[,parameter_name = value…]<br>SELECT INTO parameter_name<br>set @a=7   #会话变量，只存在此连接会话中<br>select a;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">示例:</span><br><span class="line">...</span><br><span class="line">DECLARE x int;</span><br><span class="line">SELECT COUNT(id) FROM tdb_name INTO x;  #将x赋值查询表中的记录数量  </span><br><span class="line">RETURN x;</span><br><span class="line">END//</span><br></pre></td></tr></table></figure></p>
<h1 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h1><ul>
<li>存储过程优势<br>存储过程把经常使用的SQL语句或业务逻辑封装起来,预编译保存在数据库中,当需要时从数据库中直接调用,省去了编译的过程<br>提高了运行速度<br>同时降低网络数据传输量  </li>
<li>存储过程与自定义函数的区别<br>存储过程实现的过程要复杂一些,而函数的针对性较强<br>存储过程可以有多个返回值,而自定义函数只有一个返回值<br>存储过程一般独立的来执行,而函数往往是作为其他SQL语句的一部分来使用  </li>
</ul>
<h2 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h2><ul>
<li><p>存储过程：存储过程保存在mysql.proc表中<br>`CREATE PROCEDURE sp_name ([ proc_parameter [,proc_parameter …]])<br>routime_body<br>proc_parameter : [IN|OUT|INOUT]   parameter_name type  </p>
<blockquote>
<p>其中IN表示输入参数，OUT表示输出参数，INOUT表示既可以输入也可以输出；<br>param_name表示参数名称；type表示参数的类型</p>
</blockquote>
</li>
<li><p>查看存储过程列表<br><code>SHOW PROCEDURE STATUS;</code></p>
</li>
<li>查看存储过程定义<br><code>SHOW CREATE PROCEDURE sp_name</code>   </li>
<li>调用存储过程<br><code>CALL sp_name ([ proc_parameter [,proc_parameter ...]])</code><br><code>CALL sp_name</code>  <blockquote>
<p>说明:当无参时,可以省略”()”,当有参数时,不可省略”()”   </p>
</blockquote>
</li>
<li>存储过程修改<br>ALTER语句修改存储过程只能修改存储过程的注释等无关紧要的东西,不能修改存储过程体,所以要修改存储过程,方法就是删除重建   </li>
<li>删除存储过程<br><code>DROP PROCEDURE [IF EXISTS] sp_name</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">存储过程示例</span><br><span class="line">1、创建无参存储过程</span><br><span class="line">delimiter //  #定义//为结束符</span><br><span class="line">CREATE PROCEDURE showTime()</span><br><span class="line">BEGIN</span><br><span class="line">SELECT now();</span><br><span class="line">END//</span><br><span class="line">delimiter ;  #重新使用；为结束符</span><br><span class="line">CALL showTime;   #调用存储过程</span><br><span class="line"></span><br><span class="line">2、创建含参存储过程：只有一个IN参数</span><br><span class="line">delimiter //</span><br><span class="line">CREATE PROCEDURE selectById(IN uid SMALLINT UNSIGNED)</span><br><span class="line">BEGIN</span><br><span class="line">SELECT * FROM students WHERE stuid = uid;</span><br><span class="line">END//</span><br><span class="line">delimiter ;</span><br><span class="line">call selectById(2);</span><br><span class="line"></span><br><span class="line">3、求和计算</span><br><span class="line">delimiter //</span><br><span class="line">CREATE PROCEDURE dorepeat(n INT)  #定义n的类型</span><br><span class="line">BEGIN</span><br><span class="line">SET @i = 0;</span><br><span class="line">SET @sum = 0;</span><br><span class="line">REPEAT SET @sum = @sum+@i; SET @i = @i + 1;</span><br><span class="line">UNTIL @i &gt; n END REPEAT;  #计算i自相加运算到n的值</span><br><span class="line">END//</span><br><span class="line">delimiter ;</span><br><span class="line">CALL dorepeat(100);  #计算从0到100</span><br><span class="line">SELECT @sum;         #取结果</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h1><p>存储过程和函数中可以使用流程控制来控制语句的执行<br>流程控制：</p>
<ul>
<li>IF：用来进行条件判断。根据是否满足条件，执行不同语句</li>
<li>CASE：用来进行条件判断，可实现比IF语句更复杂的条件判断</li>
<li>LOOP：重复执行特定的语句，实现一个简单的循环</li>
<li>LEAVE：用于跳出循环控制</li>
<li>ITERATE：跳出本次循环，然后直接进入下一次循环</li>
<li>REPEAT：有条件控制的循环语句。当满足特定条件时，就会跳出循环语句</li>
<li>WHILE：有条件控制的循环语句</li>
</ul>
<h1 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h1><p>触发器的执行不是由程序调用，也不是由手工启动，而是由事件来触发、激活从而实现<br>执行</p>
<ul>
<li>创建触发器<br>CREATE<br>[DEFINER = { user | CURRENT_USER }]<br>TRIGGER trigger_name<br>trigger_time trigger_event<br>ON tbl_name FOR EACH ROW<br>trigger_body    <blockquote>
<p>说明：<br>trigger_name：触发器的名称<br>trigger_time：{ BEFORE | AFTER }，<strong>表示在事件之前或之后触发</strong><br>trigger_event:：{ INSERT |UPDATE | DELETE }，触发的具体事件<br>tbl_name：该触发器作用在表名   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1、示例：创建触发器，在向学生表INSERT数据时，学生数增加，DELETE学生时，学生数减少</span><br><span class="line">CREATE TRIGGER trigger_student_count_insert</span><br><span class="line">AFTER INSERT</span><br><span class="line">ON student_info FOR EACH ROW</span><br><span class="line">UPDATE student_count SET student_count=student_count+1;</span><br><span class="line">CREATE TRIGGER trigger_student_count_delete</span><br><span class="line">AFTER DELETE</span><br><span class="line">ON student_info FOR EACH ROW</span><br><span class="line">UPDATE student_count SET student_count=student_count-1;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<p>查看触发器<br><code>SHOW TRIGGERS</code><br>查询系统表information_schema.triggers的方式指定查询条件，查看指定的触发器信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; USE information_schema;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; SELECT * FROM triggers WHERE</span><br><span class="line">trigger_name=&apos;trigger_student_count_insert&apos;;</span><br></pre></td></tr></table></figure></p>
<p>删除触发器<br><code>DROP TRIGGER trigger_name;</code></p>
<h1 id="MySQL用户和权限管理"><a href="#MySQL用户和权限管理" class="headerlink" title="MySQL用户和权限管理"></a>MySQL用户和权限管理</h1><ul>
<li>元数据数据库：mysql<br>系统授权表：<br>db, host, user<br>columns_priv, tables_priv, procs_priv, proxies_priv   </li>
<li>用户账号：<br>‘USERNAME‘@’HOST’<br>@’HOST’:  #允许登录的主机IP<br>主机名<br>IP地址或Network<br>通配符： % _<br>示例：172.16.%.%   #允许使用内网IP地址登录    <h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h2></li>
<li>创建用户：CREATE USER<br><code>CREATE USER &#39;USERNAME&#39;@&#39;HOST&#39; [IDENTIFIED BY &#39;password&#39;]；</code>    #不常用，创建用户权限较小，不方便使用<br>默认权限：USAGE  </li>
<li>用户重命名：RENAME USER<br><code>RENAME USER old_user_name TO new_user_name;</code></li>
<li>删除用户：<br><code>DROP USER &#39;USERNAME&#39;@&#39;HOST&#39;</code><br>示例：删除默认的空用户<br><code>DROP USER &#39;&#39;@&#39;localhost&#39;;</code>   #删除空密码’’  </li>
<li>修改密码：<br><code>mysql&gt;SET PASSWORD FOR &#39;user&#39;@&#39;host&#39; = PASSWORD(‘password&#39;);</code><br><code>mysql&gt;UPDATE mysql.user SET password=PASSWORD(&#39;password&#39;) WHERE clause;</code><br>此方法需要执行下面指令才能生效：<br><code>mysql&gt; FLUSH PRIVILEGES;</code><br><code>mysqladmin -u root -poldpass password &#39;newpass&#39;</code></li>
</ul>
<h2 id="忘记管理员密码的解决办法："><a href="#忘记管理员密码的解决办法：" class="headerlink" title="忘记管理员密码的解决办法："></a>忘记管理员密码的解决办法：</h2><ol>
<li>启动mysqld进程时，为其使用如下选项：<br>–skip-grant-tables –skip-networking   </li>
<li>使用UPDATE命令修改管理员密码<br><code>update mysql.user set password=password(&#39;centos&#39;) where user=&#39;root&#39;</code>  #重新设置root账户密码为centos</li>
<li>关闭mysqld进程，移除上述两个选项，重启mysqld   </li>
</ol>
<h2 id="MySQL权限管理"><a href="#MySQL权限管理" class="headerlink" title="MySQL权限管理"></a>MySQL权限管理</h2><p>权限类别：<br>管理类<br>程序类<br>数据库级别<br>表级别<br>字段级别   </p>
<h1 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">授权tom用户只能查看和修改表</span><br><span class="line">grant select,insert on testdb.* to &apos;tom&apos;@&apos;172.18.%.%&apos;;</span><br><span class="line"></span><br><span class="line">授权tom用户所有的权限</span><br><span class="line">grant all on testdb.* to &apos;tom&apos;@172.18.%.%;</span><br><span class="line"></span><br><span class="line">*.*: 所有库的所表</span><br><span class="line">db_name.*: 指定库的所有表</span><br><span class="line">db_name.tb_name: 指定库的指定表</span><br><span class="line">db_name.routine_name：指定库的存储过程和函数</span><br><span class="line">revoke insert on testdb.* from &apos;tom&apos;@&apos;172.18.%.%&apos;;   #收回授权</span><br><span class="line">grant all on testdb.* to &apos;wang&apos;@&apos;172.18.0.106&apos; identified by &quot;magedu&quot;;    #授权的同时创建账号</span><br><span class="line">show grants for wang@&apos;172.18.0.106&apos;;   #查看用户获得的授权</span><br><span class="line">grant update(name) on testdb.students to test@&apos;172.18.%.%&apos; identified by &apos;centos&apos;;   #只授权修改某个字段</span><br><span class="line">Help SHOW GRANTS   #查看帮助。怎么查用户的获得的授权</span><br><span class="line">对于不能够或不能及时重读授权表的命令，可手动让MariaDB的服务进程重读授权表：mysql&gt; FLUSH PRIVILEGES</span><br></pre></td></tr></table></figure>
<h1 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h1><ul>
<li>查看mysql支持的存储引擎<br><code>show engines;</code></li>
<li>查看当前默认的存储引擎<br><code>show variables like &#39;%storage_engine%&#39;;</code>  </li>
<li><p>设置默认的存储引擎</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.conf</span><br><span class="line">[mysqld]</span><br><span class="line">default_storage_engine= InnoDB</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看库中所有表使用的存储引擎<br><code>how table status from db_name;</code>  </p>
</li>
<li>查看库中指定表的存储引擎<br><code>show table status like &#39; tb_name &#39;;</code><br><code>show create table tb_name;</code>   </li>
<li>设置表的存储引擎：<br><code>CREATE TABLE tb_name(... ) ENGINE=InnoDB;</code><br><code>ALTER TABLE tb_name ENGINE=InnoDB;</code></li>
</ul>
<h2 id="MyISAM引擎特点："><a href="#MyISAM引擎特点：" class="headerlink" title="MyISAM引擎特点："></a>MyISAM引擎特点：</h2><ul>
<li><strong>不支持事务</strong></li>
<li><strong>表级锁定</strong></li>
<li>读写相互阻塞，写入不能读，读时不能写</li>
<li>只缓存索引</li>
<li><strong>不支持外键约束</strong></li>
<li>不支持聚簇索引</li>
<li>读取数据较快，占用资源较少</li>
<li><strong>不支持MVCC</strong>（多版本并发控制机制）高并发</li>
<li>崩溃恢复性较差  </li>
<li>MySQL5.5.5前默认的数据库引擎</li>
</ul>
<p>MyISAM存储引擎适用场景<br>只读（或者写较少）、表较小（可以接受长时间进行修复操作）<br>MyISAM引擎文件<br>tbl_name.frm 表格式定义<br>tbl_name.MYD 数据文件<br>tbl_name.MYI 索引文件   </p>
<h2 id="InnoDB引擎特点"><a href="#InnoDB引擎特点" class="headerlink" title="InnoDB引擎特点"></a>InnoDB引擎特点</h2><ul>
<li><strong>行级锁</strong></li>
<li><strong>支持事务</strong>，适合处理大量短期事务</li>
<li>读写阻塞与事务隔离级别相关</li>
<li>可缓存数据和索引</li>
<li>支持聚簇索引</li>
<li>崩溃恢复性更好</li>
<li><strong>支持MVCC高并发</strong></li>
<li>从MySQL5.5后支持全文索引</li>
<li>从MySQL5.5.5开始为默认的数据库引擎</li>
</ul>
<p>InnoDB数据库文件   </p>
<ul>
<li>所有InnoDB表的数据和索引放置于同一个表空间中<br>表空间文件：datadir定义的目录下<br>数据文件：ibddata1, ibddata2, …   </li>
<li>每个表单独使用一个表空间存储表的数据和索引<br>启用：<strong>innodb_file_per_table=ON</strong><br>参看：<a href="https://mariadb.com/kb/en/library/xtradbinnodb-serversystem-variables/#innodb_file_per_table" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/xtradbinnodb-serversystem-variables/#innodb_file_per_table</a><br>ON (&gt;= MariaDB 5.5)默认在5.5以后都已经是开启状态<br>两类文件放在数据库独立目录中<br><strong>数据文件</strong>(存储数据和索引)：tb_name.ibd<br><strong>表格式定义</strong>：tb_name.frm    <blockquote>
<p>数据表都存放在一个表中，删除后空间不会缩减<br>推荐单独存放，便于管理  </p>
</blockquote>
</li>
</ul>
<h2 id="MySQL中的系统数据库"><a href="#MySQL中的系统数据库" class="headerlink" title="MySQL中的系统数据库"></a>MySQL中的系统数据库</h2><ul>
<li>mysql数据库<br>是mysql的核心数据库，类似于Sql Server中的master库，主要负责存储数据库的用户、权限设置、关键字等mysql自己需要使用的控制和管理信息   </li>
<li>performance_schema数据库<br>MySQL 5.5开始新增的数据库，主要用于收集数据库服务器性能参数,库里表的存储引擎均为PERFORMANCE_SCHEMA，用户不能创建存储引擎为PERFORMANCE_SCHEMA的表   </li>
<li>information_schema数据库<br>MySQL 5.0之后产生的，一个虚拟数据库，物理上并不存在。<br>information_schema数据库类似与“数据字典”，提供了访问数据库元数据的方式，即数据的数据。比如数据库名或表名，列类型，访问权限（更加细化的访问方式）</li>
</ul>
<h1 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h1><p>mysqld选项，服务器系统变量和服务器状态变量<br><a href="https://dev.mysql.com/doc/refman/5.7/en/mysqld-optiontables.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/mysqld-optiontables.html</a><br><a href="https://mariadb.com/kb/en/library/full-list-of-mariadb-optionssystem-and-status-variables/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/full-list-of-mariadb-optionssystem-and-status-variables/</a>   </p>
<blockquote>
<p>注意：其中有些参数支持运行时修改，会立即生效；<br>有些参数不支持，且只能通过修改配置文件，并重启服务器程序生效；<br>有些参数作用域是全局的，且不可改变；有些可以为每个用户提供单独（会话）的设置<br>配置文件中建议“-”链接参数，系统变量建议“_”<br><strong>写到配置文件中的必须是msql选项</strong><br>有的变量不一定是选项，写配置文件要注意</p>
</blockquote>
<h2 id="服务器系统变量"><a href="#服务器系统变量" class="headerlink" title="服务器系统变量"></a>服务器系统变量</h2><p>分全局和会话两种  </p>
<ul>
<li><p>获取系统变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW GLOBAL VARIABLES;    #查看全局变量</span><br><span class="line">mysql&gt; SHOW [SESSION] VARIABLES; #查看会员变量</span><br><span class="line">mysql&gt; SELECT @@VARIABLES;       #查看具体变量的参数</span><br><span class="line">mysql&gt; SELECT @@sort_buffer_size;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改服务器变量的值：<br><code>mysql&gt; help SET</code></p>
</li>
<li>修改全局变量：仅对修改后新创建的会话有效；对已经建立的会话无效<br><code>mysql&gt; SET GLOBAL system_var_name=value;</code><br><code>mysql&gt; SET @@global.system_var_name=value;</code></li>
<li>修改会话变量：<br><code>mysql&gt; SET [SESSION] system_var_name=value;</code><br><code>mysql&gt; SET @@[session.]system_var_name=value;</code></li>
<li>状态变量（只读）：用于保存mysqld运行中的统计数据的变量，不可更改<br><code>mysql&gt; SHOW GLOBAL STATUS;</code><br><code>mysql&gt; SHOW [SESSION] STATUS;</code></li>
</ul>
<h1 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h1><p>使用hash计算命令整体，匹配是否与新指令是否一致。<br>为了更准确的利用缓存，要注意大小写，空格多少。<br>读的多写的少，适合查询缓存<br>写多读少，不适合利用查询缓存</p>
<h2 id="查询缓存相关的服务器变量"><a href="#查询缓存相关的服务器变量" class="headerlink" title="查询缓存相关的服务器变量"></a>查询缓存相关的服务器变量</h2><ul>
<li>query_cache_min_res_unit：查询缓存中内存块的最小分配单位，默认4k，较小值会减少浪费，但会导致更频繁的内存分配操作，较大值会带来浪费，会导致碎片过多，内存不足   </li>
<li>query_cache_limit：单个查询结果能缓存的最大值，默认为1M，对于查询结果过大而无法缓存的语句，建议使用SQL_NO_CACHE   </li>
<li>query_cache_size：查询缓存总共可用的内存空间；单位字节，必须是1024的整数倍，最小值40KB，低于此值有警报  </li>
<li>query_cache_wlock_invalidate：如果某表被其它的会话锁定，是否仍然可以<br>从查询缓存中返回结果，默认值为OFF，表示可以在表被其它会话锁定的场景中继续从缓存返回数据；ON则表示不允许   </li>
<li>query_cache_type：是否开启缓存功能，取值为ON, OFF, DEMAND   </li>
<li>SELECT语句的缓存控制<br>SQL_CACHE：显式指定存储查询结果于缓存之中<br>SQL_NO_CACHE：显式查询结果不予缓存  </li>
<li>query_cache_type参数变量<br>query_cache_type的值为OFF或0时，查询缓存功能关闭<br>query_cache_type的值为ON或1时，查询缓存功能打开，SELECT的结果符合缓存条件即会缓存，否则，不予缓存，显式指定SQL_NO_CACHE，不予缓存，此为默认值  </li>
<li>query_cache_type的值为DEMAND或2时，查询缓存功能按需进行，显式指定SQL_CACHE的SELECT语句才会缓存；其它均不予缓存  </li>
</ul>
<h2 id="缓存系统变量"><a href="#缓存系统变量" class="headerlink" title="缓存系统变量"></a>缓存系统变量</h2><p>查询缓存相关的状态变量：SHOW GLOBAL STATUS LIKE ‘Qcache%’;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+---------+</span><br><span class="line">| Variable_name           | Value   |</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">| Qcache_free_blocks      | 1       |</span><br><span class="line">| Qcache_free_memory      | 1031320 |</span><br><span class="line">| Qcache_hits             | 0       |</span><br><span class="line">| Qcache_inserts          | 0       |</span><br><span class="line">| Qcache_lowmem_prunes    | 0       |</span><br><span class="line">| Qcache_not_cached       | 0       |</span><br><span class="line">| Qcache_queries_in_cache | 0       |</span><br><span class="line">| Qcache_total_blocks     | 1       |</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">Qcache_free_blocks：处于空闲状态 Query Cache中内存 Block 数</span><br><span class="line">Qcache_total_blocks：Query Cache 中总Block ，当Qcache_free_blocks相对此值较大时，可能用内存碎片，执行FLUSH QUERY CACHE清理碎片</span><br><span class="line">Qcache_free_memory：处于空闲状态的Query Cache内存总量</span><br><span class="line">Qcache_hits：Query Cache 命中次数</span><br><span class="line">Qcache_inserts：向 Query Cache 中插入新的Query Cache的次数，即没有命中的次数</span><br><span class="line">Qcache_lowmem_prunes：记录因为内存不足而被移除出查询缓存的查询数</span><br><span class="line">Qcache_not_cached：没有被Cache的SQL数，包括无法被Cache的SQL以及由于query_cache_type设置的不会被Cache的SQL语句</span><br><span class="line">Qcache_queries_in_cache：在Query Cache中的SQL数量</span><br><span class="line"></span><br><span class="line">查询缓存命中率 ：Qcache_hits / ( Qcache_hits + Qcache_inserts ) * 100%</span><br><span class="line">查询缓存内存使用率：(query_cache_size – qcache_free_memory) /</span><br><span class="line">query_cache_size * 100%</span><br></pre></td></tr></table></figure></p>
<h1 id="聚簇和非聚簇索引"><a href="#聚簇和非聚簇索引" class="headerlink" title="聚簇和非聚簇索引"></a>聚簇和非聚簇索引</h1><p>非聚集索引：数据和索引不在一起<br>聚集索引：数据和索引在一起<br>主键索引：索引和数据都放在叶子节点，速度快<br>二级索引：主键和索引存放在叶子节点，需要查询两次，还要利用主键索引才能有结果  </p>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><p>索引：是特殊数据结构，定义在查找时作为查找条件的字段，在MySQL又称为键key，索引通过存储引擎实现</p>
<ul>
<li>优点：<br>索引可以降低服务需要扫描的数据量，减少了IO次数<br>索引可以帮助服务器避免排序和使用临时表<br>索引可以帮助将随机I/O转为顺序I/O  </li>
<li>缺点：<br>占用额外空间，影响插入速度</li>
</ul>
<h2 id="索引类型："><a href="#索引类型：" class="headerlink" title="索引类型："></a>索引类型：</h2><ul>
<li>B+ TREE、HASH、R TREE</li>
<li>聚簇（集）索引、非聚簇索引：数据和索引是否存储在一起</li>
<li>主键索引、二级（辅助）索引</li>
<li>稠密索引、稀疏索引：是否索引了每一个数据项</li>
<li>简单索引、组合索引<br><strong>左前缀索引</strong>：取前面的字符做索引<br>覆盖索引：从索引中即可取出要查询的数据，性能高<br>简单索引：对单独字段建立索引<br>复合索引：对多个字段建立索引<br>左前缀索引：利用后面的数据查询，不能利用到索引</li>
<li>二叉树：按树状排列，但可能会出现分支不全  </li>
<li>红黑树：平衡的二叉树，有可能分支太多，树太高，效率差</li>
<li>B-TREE索引：平衡树，多叉树，叶子节点到根的节点数都一致，每节点存放数据，效率差，不便管理    </li>
<li>B+TREE索引：每节点不存放数据，只在叶子节点存放数据，通过链表指向下一数据块，效率高，区域查询速度快</li>
</ul>
<blockquote>
<p>每张表可以创建多条索引<br>读多写少，适合索引  </p>
</blockquote>
<h2 id="索引优化建议"><a href="#索引优化建议" class="headerlink" title="索引优化建议"></a>索引优化建议</h2><ul>
<li>只要列中含有NULL值，就最好不要在此例设置索引，复合索引如果有NULL值，此列在使用时也不会使用索引   </li>
<li>尽量使用短索引，如果可以，应该制定一个前缀长度   </li>
<li>对于经常在where子句使用的列，最好设置索引   </li>
<li>对于有多个列where或者order by子句，应该建立复合索引  </li>
<li>对于like语句，以%或者‘-’开头的不会使用索引，以%结尾会使用索引   </li>
<li>尽量不要在列上进行运算（函数操作和表达式操作）   </li>
<li>尽量不要使用not in和&lt;&gt;操作   </li>
</ul>
<h2 id="SQL语句性能优化"><a href="#SQL语句性能优化" class="headerlink" title="SQL语句性能优化"></a>SQL语句性能优化</h2><ul>
<li>查询时，能不要<em>就不用</em>，尽量写全字段名</li>
<li>大部分情况连接效率远大于子查询</li>
<li>多表连接时，尽量小表驱动大表，即小表 join 大表</li>
<li>在有大量记录的表分页时使用limit</li>
<li>对于经常使用的查询，可以开启缓存</li>
<li>多使用explain和profile分析查询语句</li>
<li>查看慢查询日志，找出执行时间长的sql语句优化</li>
</ul>
<h2 id="管理索引"><a href="#管理索引" class="headerlink" title="管理索引"></a>管理索引</h2><ul>
<li>创建索引：<br>CREATE INDEX index_name ON tbl_name    (index_col_name[(length)],…);<br>help CREATE INDEX;<br><code>create index idx_name_age on testlog(name,age);</code></li>
<li>删除索引：<br>DROP INDEX index_name ON tbl_name;</li>
<li>查看索引：<br>SHOW INDEXES FROM [db_name.]tbl_name;</li>
<li>优化表空间：<br>OPTIMIZE TABLE tb_name;</li>
<li>查看索引的使用<br>SET GLOBAL userstat=1;<br>SHOW INDEX_STATISTICS;  </li>
</ul>
<h2 id="EXPLAIN"><a href="#EXPLAIN" class="headerlink" title="EXPLAIN"></a>EXPLAIN</h2><p>通过EXPLAIN来分析索引的有效性<br><code>explain select * from testlog where name like &#39;wang1111&#39;;</code><br>输出信息说明：  </p>
<ul>
<li>id: 当前查询语句中，每个SELECT语句的编号   </li>
<li>select_type：<br>简单查询为SIMPLE   </li>
<li>table：SELECT语句关联到的表</li>
<li>type：关联类型或访问类型，即MySQL决定的如何去查询表中的行的方式，以下顺序，性能从低到高</li>
<li>possible_keys：查询可能会用到的索引</li>
<li>key: 查询中使用到的索引</li>
<li>key_len: 在索引使用的字节数</li>
<li>ref: 在利用key字段所表示的索引完成查询时所用的列或某常量值</li>
<li>rows：MySQL估计为找所有的目标行而需要读取的行数</li>
</ul>
<h1 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h1><ul>
<li>锁粒度：<br>表级锁<br>行级锁  </li>
<li>锁：<br>读锁：共享锁，只读不可写，多个读互不阻塞<br>写锁：独占锁,排它锁，一个写锁会阻塞其它读和它锁   </li>
<li>实现<br>存储引擎：自行实现其锁策略和锁粒度<br>服务器级：实现了锁，表级锁；用户可显式请求   </li>
<li>分类：<br>隐式锁：由存储引擎自动施加锁<br>显式锁：用户手动请求   </li>
<li>锁策略：在锁粒度及数据安全性寻求的平衡机制<br>显式使用锁   </li>
<li>LOCK TABLES 加锁<br><code>lock tables students read;</code><br><code>lock tables students write;</code></li>
<li>UNLOCK TABLES 解锁</li>
<li>FLUSH TABLES [tb_name[,…]] [WITH READ LOCK]<br>关闭正在打开的表（清除查询缓存），通常在备份前加全局读锁<br><code>flush tables with read lock;</code></li>
<li>SELECT clause [FOR UPDATE | LOCK IN SHARE MODE]<br>查询时加写或读锁</li>
</ul>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>事务Transactions：<strong>一组原子性的SQL语句</strong>，或一个独立工作单元<br>事务日志：记录事务信息，实现undo,redo等故障恢复功能<br>事务日志文件： ib_logfile0， ib_logfile1  </p>
<ul>
<li>ACID特性：<br>A：<strong>atomicity原子性</strong>；整个事务中的所有操作要么全部成功执行，要么全部失败后回滚<br>C：<strong>consistency一致性</strong>；数据库总是从一个一致性状态转换为另一个一致性状态（保证完整性）<br>I：<strong>Isolation隔离性</strong>；一个事务所做出的操作在提交之前，是不能为其它事务所见；隔离有多种隔离级别，实现并发<br>D：<strong>durability持久性</strong>；一旦事务提交，其所做的修改会永久保存于数据库中   </li>
</ul>
<h2 id="事务应用"><a href="#事务应用" class="headerlink" title="事务应用"></a>事务应用</h2><ul>
<li>启动事务：<br><strong>BEGIN</strong><br>BEGIN WORK<br>START TRANSACTION   </li>
<li>结束事务：<br><strong>COMMIT</strong>：提交<br><strong>ROLLBACK</strong>: 回滚   <blockquote>
<p>注意：只有事务型存储引擎中的DML（INSERT, DELETE, UPDATE）语句方能支持此类操作</p>
</blockquote>
</li>
<li>自动提交：set <strong>autocommit</strong>={1|0}    #默认为1，为0时设为非自动提交   <blockquote>
<p>建议：显式请求和提交事务，而不要使用“自动提交”功能</p>
</blockquote>
</li>
<li>事务支持保存点：savepoint<br>SAVEPOINT identifier<br>ROLLBACK [WORK] TO [SAVEPOINT] identifier<br>RELEASE SAVEPOINT identifier  </li>
</ul>
<h2 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h2><p>事务隔离级别：从上至下更加严格</p>
<ul>
<li>READ UNCOMMITTED 可读取到未提交数据，产生<strong>脏读</strong></li>
<li>READ COMMITTED 可读取到提交数据，但未提交数据不可读，产生不可重复读，即可读取到多个提交数据，导致每次读取数据不一致</li>
<li>REPEATABLE READ 可重复读，多次读取数据都一致，产生<strong>幻读</strong>，即读取过程中，即使有其它提交的事务修改数据，仍只能读取到未修改前的旧数据。<strong>此为MySQL默认设置</strong></li>
<li>SERIALIZABILE 可串行化，未提交的读事务阻塞修改事务，或者未提交的修改事务阻塞读事务。<strong>导致并发性能差</strong>  <blockquote>
<p>MVCC: 多版本并发控制，和事务级别相关</p>
</blockquote>
</li>
</ul>
<h3 id="指定事务隔离级别"><a href="#指定事务隔离级别" class="headerlink" title="指定事务隔离级别"></a>指定事务隔离级别</h3><ul>
<li>服务器变量tx_isolation指定，默认为REPEATABLE-READ，可在GLOBAL和SESSION级进行设置<br>SET tx_isolation=’’<br>READ-UNCOMMITTED<br>READ-COMMITTED<br>REPEATABLE-READ<br>SERIALIZABLE  </li>
<li>服务器选项中指定  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf  </span><br><span class="line">[mysqld]</span><br><span class="line">transaction-isolation=REPEATABLE-READ</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h2><p>事务日志 transaction log<br>错误日志 error log<br>通用日志 general log<br>慢查询日志 slow query log<br>二进制日志 binary log<br>中继日志 reley log  </p>
<h3 id="事务日志transaction-log"><a href="#事务日志transaction-log" class="headerlink" title="事务日志transaction log"></a>事务日志transaction log</h3><ul>
<li>事务型存储引擎自行管理和使用，<strong>建议和数据文件分开存放</strong><br>redo log<br>undo log   </li>
<li>Innodb事务日志相关配置：  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; show variables like &apos;%innodb_log%&apos;;</span><br><span class="line">+-----------------------------+----------+</span><br><span class="line">| Variable_name               | Value    |</span><br><span class="line">+-----------------------------+----------+</span><br><span class="line">| innodb_log_buffer_size      | 16777216 |</span><br><span class="line">| innodb_log_checksums        | ON       |</span><br><span class="line">| innodb_log_compressed_pages | ON       |</span><br><span class="line">| innodb_log_file_size        | 50331648 |  #每个日志文件大小</span><br><span class="line">| innodb_log_files_in_group   | 2        |  #日志组成员个数</span><br><span class="line">| innodb_log_group_home_dir   | ./       |  #事务文件路径</span><br><span class="line">| innodb_log_optimize_ddl     | ON       |</span><br><span class="line">| innodb_log_write_ahead_size | 8192     |</span><br><span class="line">+-----------------------------+----------+</span><br><span class="line"></span><br><span class="line">修改配置文件来配合实际需求</span><br><span class="line">1、创建日志存放的文件夹</span><br><span class="line">mkdir /data/mysql/logs -pv</span><br><span class="line">2、修改所有者和所属组</span><br><span class="line">chown mysql.mysql /data/mysql/logs/</span><br><span class="line">3、修改配置文件</span><br><span class="line">vim  /etc/my.cnf.d/server.cnf</span><br><span class="line">innodb_log_file_size=20M</span><br><span class="line">innodb_log_files_in_group=5</span><br><span class="line">innodb_log_group_home_dir=/data/mysql/logs</span><br><span class="line">4、重启服务</span><br><span class="line">systemctl restart mariadb</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="innodb-flush-log-at-trx-commit-默认为1"><a href="#innodb-flush-log-at-trx-commit-默认为1" class="headerlink" title="innodb_flush_log_at_trx_commit 默认为1"></a>innodb_flush_log_at_trx_commit 默认为1</h4><p>说明：设置为1，同时sync_binlog = 1表示最高级别的容错<br>innodb_use_global_flush_log_at_trx_commit的值确定是否可以使用SET语句重置此变量   </p>
<ul>
<li>1默认情况下，日志缓冲区将写入日志文件，并在每次事务后执行刷新到磁盘。这是完全遵守ACID特性   </li>
<li>0提交时没有任何操作;而是每秒执行一次日志缓冲区写入和刷新。 这样可以提供更好的性能，但服务器崩溃可以清除最后一秒的事务   </li>
<li>2每次提交后都会写入日志缓冲区，但每秒都会进行一次刷新。 性能比0略好一些，但操作系统或停电可能导致最后一秒的交易丢失    </li>
<li>3模拟MariaDB 5.5组提交（每组提交3个同步），此项MariaDB 10.0支持    </li>
</ul>
<h3 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h3><p>mysqld启动和关闭过程中输出的事件信息<br>mysqld运行中产生的错误信息<br>event scheduler运行一个event时产生的日志信息<br>在主从复制架构中的从服务器上启动从服务器线程时产生的信息  </p>
<p>错误日志相关配置<br>SHOW GLOBAL VARIABLES LIKE ‘log_error’<br>错误文件路径<br>log_error=/PATH/TO/LOG_ERROR_FILE  #注意路径的权限<br>是否记录警告信息至错误日志文件<br>log_warnings=1|0 默认值1   </p>
<h3 id="通用日志general-log"><a href="#通用日志general-log" class="headerlink" title="通用日志general log"></a>通用日志general log</h3><p>通用日志：记录对数据库的通用操作，包括错误的SQL语句<br>文件：file，默认值<br>表：table<br>通用日志相关设置<br>general_log=ON|OFF<br>general_log_file=HOSTNAME.log<br>log_output=TABLE|FILE|NONE<br><code>set global log_output=&#39;table&#39;;</code><br>修改输出日志到表，table在mysql数据库中</p>
<blockquote>
<p>排错和优化性能启用</p>
</blockquote>
<h3 id="慢查询日志slow-query-log"><a href="#慢查询日志slow-query-log" class="headerlink" title="慢查询日志slow query log"></a>慢查询日志slow query log</h3><p>慢查询日志：记录执行查询时长超出指定时长的操作</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>slow_query_log</strong></td>
<td>默认off，可以考虑开启，监控数据库性能</td>
</tr>
<tr>
<td><strong>long_query_time</strong></td>
<td>慢查询的阀值，单位秒。考虑实际情况设定合适的值</td>
</tr>
<tr>
<td>slow_query_log_file</td>
<td>HOSTNAME-slow.log慢查询日志文件</td>
</tr>
<tr>
<td>log_slow_filter</td>
<td>admin,filesort,filesort_on_disk,full_join,full_scan,query_cache,query_cache_miss,tmp_table,tmp_table_on_disk上述查询类型且查询时长超过long_query_time，则记录日志</td>
</tr>
<tr>
<td><strong>log_queries_not_using_indexes</strong></td>
<td>建议启用。不使用索引或使用全索引扫描，不论是否达到慢查询阀值的语句是否记录日志，默认OFF，即不记录</td>
</tr>
<tr>
<td>log_slow_rate_limit</td>
<td>多少次查询才记录，mariadb特有</td>
</tr>
<tr>
<td>log_slow_verbosity</td>
<td>记录内容</td>
</tr>
</tbody>
</table>
<h4 id="通过profiling分析sql语句"><a href="#通过profiling分析sql语句" class="headerlink" title="通过profiling分析sql语句"></a>通过profiling分析sql语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">1、默认不启用</span><br><span class="line">select @@profiling;</span><br><span class="line">+-------------+</span><br><span class="line">| @@profiling |</span><br><span class="line">+-------------+</span><br><span class="line">|           0 |</span><br><span class="line">+-------------+</span><br><span class="line">2、开启profiling功能</span><br><span class="line">set profiling=on;</span><br><span class="line">3、执行sql语句</span><br><span class="line">select * from testlog  where age=19999;</span><br><span class="line">4、查询profiles记录</span><br><span class="line">show profiles;</span><br><span class="line">+----------+------------+-----------------------------------------+</span><br><span class="line">| Query_ID | Duration   | Query                                   |</span><br><span class="line">+----------+------------+-----------------------------------------+</span><br><span class="line">|        1 | 0.00012183 | select @@profiling                      |</span><br><span class="line">|        2 | 0.10885141 | select count(*) from testlog            |</span><br><span class="line">|        3 | 0.00077224 | show index from students                | |</span><br><span class="line">|        4 | 0.10812236 | select * from testlog  where age=19999  |</span><br><span class="line">|        5 | 0.00014221 | show profiling                          |</span><br><span class="line">+----------+------------+-----------------------------------------+</span><br><span class="line">5、通过编号查询详细的时间过程</span><br><span class="line">show profile for query 5;</span><br><span class="line">+------------------------+----------+</span><br><span class="line">| Status                 | Duration |</span><br><span class="line">+------------------------+----------+</span><br><span class="line">| Starting               | 0.000190 |</span><br><span class="line">| Checking permissions   | 0.000009 |</span><br><span class="line">| Opening tables         | 0.000026 |</span><br><span class="line">| After opening tables   | 0.000005 |</span><br><span class="line">| System lock            | 0.000004 |</span><br><span class="line">| Table lock             | 0.000005 |</span><br><span class="line">| Init                   | 0.000021 |</span><br><span class="line">| Optimizing             | 0.000013 |</span><br><span class="line">| Statistics             | 0.000016 |</span><br><span class="line">| Preparing              | 0.000018 |</span><br><span class="line">| Executing              | 0.000003 |</span><br><span class="line">| Sending data           | 0.107752 |</span><br><span class="line">| End of update loop     | 0.000014 |</span><br><span class="line">| Query end              | 0.000003 |</span><br><span class="line">| Commit                 | 0.000004 |</span><br><span class="line">| Closing tables         | 0.000003 |</span><br><span class="line">| Unlocking tables       | 0.000002 |</span><br><span class="line">| Closing tables         | 0.000008 |</span><br><span class="line">| Starting cleanup       | 0.000002 |</span><br><span class="line">| Freeing items          | 0.000006 |</span><br><span class="line">| Updating status        | 0.000017 |</span><br><span class="line">| Reset for next command | 0.000002 |</span><br><span class="line">+------------------------+----------+</span><br></pre></td></tr></table></figure>
<h3 id="二进制日志binary-log"><a href="#二进制日志binary-log" class="headerlink" title="二进制日志binary log"></a>二进制日志binary log</h3><ul>
<li>二进制日志：<br>记录导致数据改变或潜在导致数据改变的SQL语句<br>记录已提交的日志<br>不依赖于存储引擎类型<br>功能：通过“重放”日志文件中的事件来生成数据副本 </li>
<li>中继日志：<strong>relay log</strong><br>主从复制架构中，从服务器用于保存从主服务器的二进制日志中读取的事件<blockquote>
<p>注意：强烈建议开启，建议二进制日志和数据文件分开存放</p>
</blockquote>
</li>
</ul>
<h4 id="二进制日志记录格式"><a href="#二进制日志记录格式" class="headerlink" title="二进制日志记录格式"></a>二进制日志记录格式</h4><ul>
<li>二进制日志记录三种格式</li>
</ul>
<ol>
<li>基于“语句”记录：statement，记录语句</li>
<li>基于“行”记录：row，记录数据，日志量较大，<strong>建议使用此格式</strong> </li>
<li>混合模式：mixed, 让系统自行判定该基于哪种方式进行  <blockquote>
<p>格式配置<br>show variables like ‘binlog_format’;</p>
</blockquote>
</li>
</ol>
<ul>
<li>二进制日志文件的构成<br>有两类文件<br><strong>日志文件</strong>：mysql|mariadb-bin.文件名后缀，二进制格式<br>如： mariadb-bin.000001<br><strong>索引文件</strong>：mysql|mariadb-bin.index，文本格式  </li>
</ul>
<h4 id="二进制日志相关的服务器变量："><a href="#二进制日志相关的服务器变量：" class="headerlink" title="二进制日志相关的服务器变量："></a>二进制日志相关的服务器变量：</h4><p><strong>建议启用并将二进制日志和数据库文件分开存放</strong><br><strong>指定日志记录格式为row行记录</strong>  </p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>sql_log_bin</strong></td>
<td>是否记录二进制日志，默认ON</td>
</tr>
<tr>
<td><strong>log_bin</strong></td>
<td>指定文件位置；默认OFF，表示不启用二进制日志功能，上述两项都开启才可以启用</td>
</tr>
<tr>
<td><strong>binlog_format</strong></td>
<td>STATEMENT\</td>
<td>ROW\</td>
<td>MIXED，二进制日志记录的格式</td>
</tr>
<tr>
<td>max_binlog_size</td>
<td>单个二进制日志文件的最大体积，到达最大值会自动滚动，默认为1G</td>
</tr>
<tr>
<td>sync_binlog</td>
<td>设定是否启动二进制日志即时同步磁盘功能，默认0，由操作系统负责同步日志到磁盘</td>
</tr>
<tr>
<td>expire_logs_days</td>
<td>二进制日志可以自动删除的天数。默认为0，即不自动删除</td>
</tr>
</tbody>
</table>
<blockquote>
<p>set sql_log_bin=off;<br>可以在导入大量数据或者还原数据时临时禁用，以免产生大量日志内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件启用二进制并指定记录格式</span><br><span class="line">1、创建单独的文件夹存放二进制日志</span><br><span class="line">mkdir /data/mysql/binlog</span><br><span class="line">2、注意修改文件夹的权限</span><br><span class="line">chown mysql.mysql /data/mysql/binlog/</span><br><span class="line">3、修改配置文件</span><br><span class="line">[mysqld]</span><br><span class="line">log_bin=/data/mysql/binlog/mysql  #=后面要填写路径并且写明二进制文件的前缀为mysql或mariadb</span><br><span class="line">binlog_format=row  #指定记录格式为row</span><br><span class="line">4、重启服务</span><br><span class="line">systemctl restart mariadb</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="二进制日志相关配置"><a href="#二进制日志相关配置" class="headerlink" title="二进制日志相关配置"></a>二进制日志相关配置</h4><p>查看mariadb自行管理使用中的二进制日志文件列表，及大小<br><code>SHOW {BINARY | MASTER} LOGS;</code><br>查看使用中的二进制日志文件<br><code>SHOW MASTER STATUS;</code><br>查看二进制文件中的指定内容<br>SHOW BINLOG EVENTS [IN ‘log_name’] [FROM pos] [LIMIT [offset,] row_count]<br>查看日志从POS 6516开始跳过后面2个查看下面的3个记录<br><code>show binlog events in &#39;mysql-bin.000001&#39; from 6516 limit 2,3;</code></p>
<h4 id="mysqlbinlog：二进制日志的客户端命令工具"><a href="#mysqlbinlog：二进制日志的客户端命令工具" class="headerlink" title="mysqlbinlog：二进制日志的客户端命令工具"></a>mysqlbinlog：二进制日志的客户端命令工具</h4><p>命令格式：<br>mysqlbinlog [OPTIONS] log_file…<br>–start-position=# 指定开始位置<br>–stop-position=#<br>–start-datetime=<br>–stop-datetime=<br>时间格式：<br>YYYY-MM-DD hh:mm:ss<br>详细输出格式：<br>–base64-output[=name]<br>-v -vvv<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">#规定起始点和结束点的查询</span><br><span class="line">mysqlbinlog --start-position=6787 --stop-position=7527 /var/lib/mysql/mariadb-bin.000003 -v</span><br><span class="line">#按照时间短查看</span><br><span class="line">mysqlbinlog --start-datetime=&quot;2018-12-7 11:10:10&quot; --stop-datetime=&quot;2018-12-7 11:35:22&quot;  /data/mysql/binlog/mysql.000002  -vvv</span><br></pre></td></tr></table></figure></p>
<h4 id="管理日志"><a href="#管理日志" class="headerlink" title="管理日志"></a>管理日志</h4><ul>
<li><p>清除指定二进制日志：<br>PURGE { BINARY | MASTER } LOGS { TO ‘log_name’ | BEFORE datetime_expr }    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">PURGE BINARY LOGS TO &apos;-bin.000003&apos;; #删除编号3之前的日志</span><br><span class="line">PURGE BINARY LOGS BEFORE &apos;2017-01-23&apos;; #删除指定日期之前的日志</span><br><span class="line">PURGE BINARY LOGS BEFORE &apos;2017-03-22 09:25:30&apos;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除所有二进制日志，index文件重新记数<br><code>RESET MASTER [TO #];</code><br>删除所有二进制日志文件，并重新生成日志文件，文件名从#开始记数，默认从1开始，一般是master主机第一次启动时执行，MariaDB10.1.6开始支持TO #   </p>
</li>
<li>切换日志文件：<br><code>FLUSH LOGS;</code></li>
</ul>
<h1 id="备份还原"><a href="#备份还原" class="headerlink" title="备份还原"></a>备份还原</h1><p>完全备份：整个数据集<br>增量备份：仅备份最近一次完全备份或增量备份（如果存在增量）以来变化的数据，备份较快，还原复杂<br>差异备份：仅备份<strong>最近一次完全备份</strong>以来变化的数据，备份较慢，还原简单   </p>
<blockquote>
<p>注意：二进制日志文件不应该与数据文件放在同一磁盘</p>
</blockquote>
<p>冷、温、热备份<br>冷备：读写操作均不可进行<br>温备：读操作可执行；但写操作不可执行 #通过读锁实现<br>热备：读写操作均可执行<br>MyISAM：温备，不支持热备<br>InnoDB：都支持   </p>
<h2 id="mysqldump工具"><a href="#mysqldump工具" class="headerlink" title="mysqldump工具"></a>mysqldump工具</h2><p>Schema和数据存储在一起、巨大的SQL语句、单个巨大的备份文件<br>mysqldump工具：客户端命令，通过mysql协议连接至mysql服务器进行备份<br><code>mysqldump [OPTIONS] database [tables]</code>  #每次单独备份一个<br><code>mysqldump [OPTIONS] –B DB1 [DB2 DB3...]</code><br><code>mysqldump [OPTIONS] –A [OPTIONS]</code>  #完整备份所有数据库 -A=–all-databases<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">第一种方式：不推荐使用</span><br><span class="line">mysqldump heloodb &gt; hellodb_bak.sql #利用重定向备份所有的sql语句，不包含数据库只包含表内容</span><br><span class="line">mysql -e &apos;create database hellodb&apos;  #创建相同结构的数据</span><br><span class="line">mysql hellodb &lt; hellodb_bak.sql     #指定要还原到哪个数据库</span><br><span class="line"></span><br><span class="line">第二种方式：备份指定的数据文件</span><br><span class="line">mysqldump -B hellodb &gt; hello_bak_B.sql   #包含数据库结构和数据表内容</span><br><span class="line">mysql &lt; hellodb_bak_B.sql                #直接还原数据库及内容</span><br><span class="line"></span><br><span class="line">mysqldump -B hellodb | xz &gt; hellodb_bak.sql.xz  #直接备份压缩数据</span><br><span class="line"></span><br><span class="line">第三种方式： 生产环境常用方式</span><br><span class="line">mysqldump -A &gt; hellodb_bak.sql   #备份所有数据库及内容（包含存储过程，触发器等）</span><br><span class="line"></span><br><span class="line">使用主从复制使用--master-data=1</span><br><span class="line">mysqldump -A --master-data=1 &gt; hellodb_bak.sql  #标记备份时间点的二进制文件起始点</span><br><span class="line">不使用主从复制使用--master-data=2</span><br><span class="line">mysqldump -A --master-data=2 &gt; hellodb_bak.sql  #标记备份时间点的二进制文件起始点，但加上注释，默认不启用</span><br><span class="line"></span><br><span class="line">mysqldump -A --master-data=1 -F &gt; hellodb_bak.sql   #刷新二进制文件，保持二进制和备份数据的同步分离，可以很方便的找到备份日期之后的二进制文件，以便还原和查询</span><br></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>-A</strong>， –all-databases</td>
<td>备份所有数据库，含create database</td>
</tr>
<tr>
<td><strong>-B</strong> , –databases db_name</td>
<td>指定备份的数据库，包括create database语句</td>
</tr>
<tr>
<td>-E, –events</td>
<td>备份相关的所有event scheduler</td>
</tr>
<tr>
<td>-R, –routines</td>
<td>备份所有存储过程和自定义函数</td>
</tr>
<tr>
<td>–triggers</td>
<td>备份表相关触发器，默认启用,用–skip-triggers，不备份触发</td>
</tr>
<tr>
<td><strong>–default-character-set=utf8</strong></td>
<td>指定字符集，备份前注意确认字符集</td>
</tr>
<tr>
<td><strong>–master-data[=#]</strong></td>
<td>此选项须启用二进制日志，1：所备份的数据之前加一条记录为CHANGE MASTER TO语句，非注释，不指定#，默认为1；2：记录为注释的CHANGE MASTER TO语句</td>
</tr>
<tr>
<td><strong>-F</strong>, –flush-logs</td>
<td>备份前滚动日志，锁定表完成后，执行flush logs命令,生成新的二进制日志文件，配合-A 或 -B 选项时，会导致刷新多次数据库。建议在同一时刻执行转储和日志刷新，可通过和–single-transaction或-x，–master-data 一起使用实现，此时只刷新一次日志</td>
</tr>
<tr>
<td>–compact</td>
<td>去掉注释，适合调试，生产不使用</td>
</tr>
<tr>
<td>-d, –no-data</td>
<td>只备份表结构</td>
</tr>
<tr>
<td>-t, –no-create-info</td>
<td>只备份数据,不备份create table</td>
</tr>
<tr>
<td>-n,–no-create-db</td>
<td>不备份create database，可被-A或-B覆盖</td>
</tr>
<tr>
<td>–flush-privileges</td>
<td>备份mysql或相关时需要使用</td>
</tr>
<tr>
<td>-f, –force</td>
<td>忽略SQL错误，继续执行</td>
</tr>
<tr>
<td>–hex-blob</td>
<td>使用十六进制符号转储二进制列，当有包括BINARY，VARBINARY，BLOB，BIT的数据类型的列时使用，避免乱码</td>
</tr>
<tr>
<td>-q, –quick</td>
<td>不缓存查询，直接输出，加快备份速度</td>
</tr>
</tbody>
</table>
<blockquote>
<p>备份时要指定默认字符集，mysqldump默认为utf8<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">利用for循环实现分库备份</span><br><span class="line">for db in `mysql -e &apos;show databases&apos; | grep -Ev &apos;^(Database|information_schema|performance_schema)$&apos;`;do mysqldump -B $db | gzip &gt; $db`date +%F`.sql.gz;done</span><br><span class="line"></span><br><span class="line">利用管道实现分库备份</span><br><span class="line">mysql -e &apos;show databases&apos; | grep -Ev &apos;^(Database|information_schema|performance_schema)$&apos; | sed -r &apos;s@(.*)@mysqldump -B \1 | gzip &gt; \/data\/\1`date +%F`.sql.gz@&apos; | bash</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="MyISAM备份"><a href="#MyISAM备份" class="headerlink" title="MyISAM备份"></a>MyISAM备份</h2><p>支持温备；不支持热备，所以必须先锁定要备份的库，而后启动备份操作<br>锁定方法如下：<br>-x,–lock-all-tables：<strong>加全局读锁</strong>，锁定所有库的所有表，同时加–singletransaction或–lock-tables选项会关闭此选项功能<br>注意：数据量大时，可能会导致长时间无法并发访问数据库<br>-l,–lock-tables：对于需要备份的每个数据库，在启动备份之前<strong>分别锁定</strong>其所有表，默认为on,–skip-lock-tables选项可禁用,对备份MyISAM的多个库,可能会造成数据不一致</p>
<blockquote>
<p> myisam 推荐使用-x  -A</p>
</blockquote>
<h2 id="InnoDB备份"><a href="#InnoDB备份" class="headerlink" title="InnoDB备份"></a>InnoDB备份</h2><p>支持热备，可用温备但不建议用<br><strong>–single-transaction</strong><br>此选项Innodb中推荐使用，不适用MyISAM，此选项会开始备份前，先执行START TRANSACTION指令开启事务  </p>
<p>此选项通过在单个事务中转储所有表来创建一致的快照。 仅适用于存储在支持多版本控制的存储引擎中的表（目前只有InnoDB可以）; 转储不保证与其他存储引擎保持一致。<br>在进行单事务转储时，要确保有效的转储文件（正确的<br>表内容和二进制日志位置），没有其他连接应该使用以下语句：<code>ALTER TABLE，DROP TABLE，RENAME TABLE，TRUNCATE TABLE</code><br>此选项和–lock-tables（此选项隐含提交挂起的事务）选项是相互排斥    </p>
<blockquote>
<p>备份大型表时，建议将–single-transaction选项和–quick结合一起使用</p>
</blockquote>
<h1 id="生产环境实战备份策略"><a href="#生产环境实战备份策略" class="headerlink" title="生产环境实战备份策略"></a>生产环境实战备份策略</h1><h3 id="InnoDB建议备份策略"><a href="#InnoDB建议备份策略" class="headerlink" title="InnoDB建议备份策略"></a>InnoDB建议备份策略</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump –uroot –A –F --single-transaction --master-data=2 --default-character-set=utf8 --hex-blob &gt; $BACKUP/fullbak_$BACKUP_`data +%F`.sql</span><br></pre></td></tr></table></figure>
<h3 id="MyISAM建议备份策略"><a href="#MyISAM建议备份策略" class="headerlink" title="MyISAM建议备份策略"></a>MyISAM建议备份策略</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump –uroot –A –F –x --master-data=2 --default-character-set=utf8 --hex-blob &gt; $BACKUP/fullbak_$BACKUP_`data +%F`.sql</span><br></pre></td></tr></table></figure>
<h3 id="恢复数据库示例："><a href="#恢复数据库示例：" class="headerlink" title="恢复数据库示例："></a>恢复数据库示例：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">保证数据库文件和二进制日志文件分开存放</span><br><span class="line">确认数据库字符集和存储引擎</span><br><span class="line">mysql -plinux -e &apos;show create database hellodb&apos;</span><br><span class="line">mysql -plinux -e &quot;show variables like &apos;character%&apos;&quot;</span><br><span class="line">mysql -plinux -e &apos;show table status from hellodb&apos;</span><br><span class="line"></span><br><span class="line">1、备份原有数据库</span><br><span class="line">mysqldump -plinux -A --single-transaction -F --master-data=2 | gzip &gt; /data/all_bak_`date +%F`.sql.gz</span><br><span class="line">2、模拟误删除</span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line">3、使用防火墙禁止用户连接数据库</span><br><span class="line">4、重启数据库</span><br><span class="line">5、临时禁用二进制日志</span><br><span class="line">set sql_log_bin=off;</span><br><span class="line">show variables like &apos;sql_log_bin&apos;;</span><br><span class="line">6、保持当前mysql会话，导入完整备份</span><br><span class="line">source /data/all_bak2018-12-08.sql</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers;</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line">| TID | Name         | Age | Gender |</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line">|   4 | Lin Chaoying |  93 | F      |</span><br><span class="line">|   7 | aaav         | 223 | NULL   |</span><br><span class="line">|   8 | aadv         | 223 | NULL   |</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line"></span><br><span class="line">7、另开一SSH窗口，查看完整备份，查找二进制日志起始点还原</span><br><span class="line">cat /data/all_bak2018-12-08.sql |less</span><br><span class="line">--CHANGE MASTER TO MASTER_LOG_FILE=&apos;mysql.000013&apos;, MASTER_LOG_POS=377;</span><br><span class="line">8、另开一SSH窗口，确认二进制日志的位置，并且将后续所有日志导入到增量sql文件</span><br><span class="line">mysqlbinlog /data/mysql/binlog/mysql.000013 --start-position=377 &gt; incr.sql</span><br><span class="line">mysqlbinlog /data/mysql/binlog/mysql.000014 &gt;&gt; incr.sql</span><br><span class="line">9、回到保持打开的mysql会员，还原二进制日志</span><br><span class="line">MariaDB [hellodb]&gt; source /root/incr.sql;</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers;</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line">| TID | Name         | Age | Gender |</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line">|   4 | Lin Chaoying |  93 | F      |</span><br><span class="line">|   7 | aaav         | 223 | NULL   |</span><br><span class="line">|   8 | aadv         | 223 | NULL   |</span><br><span class="line">|   9 | aagq         |  67 | NULL   |</span><br><span class="line">|  10 | jk           |  67 | NULL   |</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line">10、开启二进制日志，还原防火墙，允许用户访问</span><br><span class="line">set sql_log_bin=on;</span><br></pre></td></tr></table></figure>
<h1 id="xtrabackup"><a href="#xtrabackup" class="headerlink" title="xtrabackup"></a>xtrabackup</h1><p>percona提供的mysql数据库备份工具，惟一开源的能够对innodb和xtradb数据库进行热备的工具<br>特点：<br>备份还原过程快速、可靠<br>备份过程不会打断正在执行的事务<br>能够基于压缩等功能节约磁盘空间和流量<br>自动实现备份检验<br>开源，免费   </p>
<p>xtrabackup安装：<br>yum install percona-xtrabackup 在EPEL源中<br>最新版本下载安装：<br><a href="https://www.percona.com/downloads/XtraBackup/LATEST/" target="_blank" rel="noopener">https://www.percona.com/downloads/XtraBackup/LATEST/</a></p>
<h2 id="xtrabackup用法"><a href="#xtrabackup用法" class="headerlink" title="xtrabackup用法"></a>xtrabackup用法</h2><h3 id="备份：innobackupex-option-BACKUP-ROOT-DIR"><a href="#备份：innobackupex-option-BACKUP-ROOT-DIR" class="headerlink" title="备份：innobackupex [option] BACKUP-ROOT-DIR"></a>备份：innobackupex [option] BACKUP-ROOT-DIR</h3><p>选项说明：<a href="https://www.percona.com/doc/percona-xtrabackup/LATEST/genindex.html" target="_blank" rel="noopener">https://www.percona.com/doc/percona-xtrabackup/LATEST/genindex.html</a></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>–user</td>
<td>备份账号</td>
</tr>
<tr>
<td>–password</td>
<td>备份的密码</td>
</tr>
<tr>
<td>–host</td>
<td>数据库的地址</td>
</tr>
<tr>
<td>–databases</td>
<td>数据库名，如果要指定多个数据库，彼此间需要以<strong>空格隔开</strong>；如：”xtra_test dba_test”，同时，在指定某数据库时，也可以只指定其中的某张表。如：”mydatabase.mytable”。该选项对innodb引擎表无效，还是会备份所有innodb表</td>
</tr>
<tr>
<td>–defaults-file</td>
<td>从哪个文件读取MySQL配置，必须放在命令行第一个选项位置</td>
</tr>
<tr>
<td>–incremental</td>
<td>创建一个增量备份，需要指定–incremental-basedir</td>
</tr>
<tr>
<td>–incremental-basedir</td>
<td><strong>指定为前一次全备份或增量备份的目录</strong>，与–incremental同时使用</td>
</tr>
<tr>
<td>–incremental-dir</td>
<td>还原时增量备份的目录</td>
</tr>
<tr>
<td>–include=name</td>
<td>表名，格式：databasename.tablename</td>
</tr>
</tbody>
</table>
<h3 id="整理Prepare：innobackupex-–apply-log-option-BACKUP-DIR"><a href="#整理Prepare：innobackupex-–apply-log-option-BACKUP-DIR" class="headerlink" title="整理Prepare：innobackupex –apply-log [option] BACKUP-DIR"></a>整理Prepare：innobackupex –apply-log [option] BACKUP-DIR</h3><table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>–apply-log</strong></td>
<td>一般情况下,在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处理不一致状态。此选项作用是<strong>通过回滚未提交的事务及同步已经提交的事务至数据文件使数据文件处于一致性状态</strong></td>
</tr>
<tr>
<td>–use-memory</td>
<td>和–apply-log选项一起使用，当prepare 备份时，做crash recovery分配的内存大小，单位字节，也可1MB,1M,1G,1GB等，推荐1G</td>
</tr>
<tr>
<td>–export</td>
<td>表示开启可导出单独的表之后再导入其他Mysql中</td>
</tr>
<tr>
<td><strong>–redo-only</strong></td>
<td>一般写在增量文件还原中， 写在非最后一个备份文件的选项，<strong>不回滚未完成的事务或查询操作</strong>，避免出现数据破坏 </td>
</tr>
</tbody>
</table>
<h3 id="还原：innobackupex-–copy-back-选项-BACKUP-DIR"><a href="#还原：innobackupex-–copy-back-选项-BACKUP-DIR" class="headerlink" title="还原：innobackupex –copy-back [选项] BACKUP-DIR"></a>还原：innobackupex –copy-back [选项] BACKUP-DIR</h3><p>innobackupex –move-back [选项] [–defaults-group=GROUP-NAME]<br>BACKUP-DIR<br>选项 | 说明<br>—|—<br>–copy-back | 做数据恢复时将备份数据文件拷贝到MySQL服务器的datadir<br>–move-back | 这个选项与–copy-back相似，唯一的区别是它不拷贝文件，而是移动文件到目的地。这个选项移除backup文件，用时候必须小心。使用场景：没有足够的磁盘空间同事保留数据文件和Backup副本</p>
<h4 id="还原注意事项"><a href="#还原注意事项" class="headerlink" title="还原注意事项"></a>还原注意事项</h4><ol>
<li>datadir <strong>目录必须为空</strong>。除非指定innobackupex –force-non-emptydirectorires选项指定，否则–copy-backup选项不会覆盖</li>
<li>在restore之前,<strong>必须shutdown MySQL实例</strong>，不能将一个运行中的实例<br>restore到datadir目录中</li>
<li>由于文件属性会被保留，大部分情况下需要在启动实例之前将文件的<strong>属主改为mysql</strong>，这些文件将属于创建备份的用户<br><code>chown -R mysql:mysql /data/mysql</code><br>以上需要在用户调用innobackupex之前完成<br>–force-non-empty-directories：指定该参数时候，使得innobackupex –copy-back或–move-back选项转移文件到非空目录，已存在的文件不会被覆盖。<br>如果–copy-back和–move-back文件需要从备份目录拷贝一个在datadir已经存在的文件，会报错失败</li>
</ol>
<h2 id="备份生成的相关文件"><a href="#备份生成的相关文件" class="headerlink" title="备份生成的相关文件"></a>备份生成的相关文件</h2><ol>
<li>xtrabackup_info：innobackupex工具执行时的相关信息，包括版本，备份选项，备份时长，备份LSN(log sequence number日志序列号)，BINLOG的位置</li>
<li>xtrabackup_checkpoints：备份类型（如完全或增量）、备份状态（如是否已经为prepared状态）和LSN范围信息,每个InnoDB页(通常为16k大小)都会包含一个日志序列号LSN。<strong>LSN是整个数据库系统的系统版本号，每个页面相关的LSN能够表明此页面最近是如何发生改变的</strong></li>
<li>xtrabackup_binlog_info：MySQL服务器当前正在使用的二进制日志文件及至备份这一刻为止二进制日志事件的位置，可利用实现基于binlog的恢复</li>
<li>backup-my.cnf：备份命令用到的配置选项信息</li>
<li>xtrabackup_logfile：备份生成的日志文件</li>
</ol>
<h2 id="备份还原示例"><a href="#备份还原示例" class="headerlink" title="备份还原示例"></a>备份还原示例</h2><h4 id="新版xtrabackup完整备份还原"><a href="#新版xtrabackup完整备份还原" class="headerlink" title="新版xtrabackup完整备份还原"></a>新版xtrabackup完整备份还原</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1、在数据库服务器完整备份</span><br><span class="line">xtrabackup --backup --target-dir=/data/db_backup</span><br><span class="line">2、将备份下来的目录拷贝到需要还原的主机</span><br><span class="line">scp -r /data/db_backup/ 192.168.34.7:/data</span><br><span class="line">3、预准备：确保数据一致，提交完成的事务，回滚未完成的事务</span><br><span class="line">xtrabackup --prepare --target-dir=/data/db_backup</span><br><span class="line">4、复制到数据库目录</span><br><span class="line"> 注意：数据库目录必须为空，MySQL服务不能启动</span><br><span class="line"> xtrabackup --copy-back --target-dir=/data/db_backup</span><br><span class="line">5、确保备份文件属性</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql</span><br><span class="line">6、启动服务验证</span><br><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure>
<h4 id="新版xtrabackup完全，增量备份及还原"><a href="#新版xtrabackup完全，增量备份及还原" class="headerlink" title="新版xtrabackup完全，增量备份及还原"></a>新版xtrabackup完全，增量备份及还原</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1 备份过程</span><br><span class="line"> 1）完全备份：xtrabackup --backup --target-dir=/data/db_backup/base/</span><br><span class="line"> 2）第一次修改数据</span><br><span class="line"> 3）第一次增量备份到完整备份目录</span><br><span class="line"> xtrabackup --backup --target-dir=/data/db_backup/inc1/ --incremental-basedir=/data/db_backup/base</span><br><span class="line"> 4）第二次修改数据</span><br><span class="line"> 5）第二次增量备份到第一次增量备份目录</span><br><span class="line"> xtrabackup --backup --target-dir=/data/db_backup/inc2/ --incremental-basedir=/data/db_backup/inc1</span><br><span class="line"> 6）scp -r /data/db_backup/ 192.168.34.7:/data/</span><br><span class="line">2还原过程</span><br><span class="line">1）预准备完成备份，此选项--apply-log-only 阻止回滚未完成的事务</span><br><span class="line">xtrabackup --prepare --apply-log-only --target-dir=/data/db_backup/base</span><br><span class="line">2）合并第1次增量备份到完全备份</span><br><span class="line">xtrabackup --prepare --apply-log-only --target-dir=/data/db_backup/base --incremental-dir=/data/db_backup/inc1</span><br><span class="line">3）合并第2次增量备份到完全备份：最后一次还原不需要加选项--apply-log-only</span><br><span class="line">xtrabackup --prepare --target-dir=/data/db_backup/base --incremental-dir=/data/db_backup/inc2</span><br><span class="line">4）复制到数据库目录，注意数据库目录必须为空，MySQL服务不能启动</span><br><span class="line">xtrabackup --copy-back --target-dir=/data/db_backup/base</span><br><span class="line">5）还原属性：chown -R mysql.mysql /var/lib/mysql</span><br><span class="line">6）启动服务：systemctl start mariadb</span><br></pre></td></tr></table></figure>
<h4 id="旧版xtrabackup完全，增量备份及还原"><a href="#旧版xtrabackup完全，增量备份及还原" class="headerlink" title="旧版xtrabackup完全，增量备份及还原"></a>旧版xtrabackup完全，增量备份及还原</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1 在原主机</span><br><span class="line">innobackupex /backups</span><br><span class="line">mkdir /backups/inc&#123;1,2&#125;</span><br><span class="line">修改数据库内容</span><br><span class="line">innobackupex --incremental /backups/inc1 --incrementalbasedir=/backups/2018-02-23_14-21-42（完全备份生成的路径）</span><br><span class="line">再次修改数据库内容</span><br><span class="line">innobackupex --incremental /backups/inc2 --incrementalbasedir=/backups/inc1/2018-02-23_14-26-17</span><br><span class="line">（上次增量备份生成的路径）</span><br><span class="line">scp -r /backups/* 目标主机:/data/</span><br><span class="line">2 在目标主机</span><br><span class="line">不启动mariadb</span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line">innobackupex --apply-log --redo-only   /data/2018-02-23_14-21-42/  #--redo-only阻止回滚事务</span><br><span class="line">innobackupex --apply-log --redo-only /data/2018-02-23_14-21-42/ --incremental-dir=/data/inc1/2018-02-23_14-26-17</span><br><span class="line">innobackupex --apply-log /data/2018-02-23_14-21-42/ --incrementaldir=/data/inc2/2018-02-23_14-28-29/</span><br><span class="line">ls /var/lib/mysql/  #最后一次不需加--redo-only</span><br><span class="line">innobackupex --copy-back /data/2018-02-23_14-21-42/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql/</span><br><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure>
<h1 id="MySQL复制"><a href="#MySQL复制" class="headerlink" title="MySQL复制"></a>MySQL复制</h1><p>扩展方式： Scale Up（纵向扩展） ，Scale Out（横向扩展）   </p>
<ul>
<li>MySQL的扩展<br>读写分离<br>复制：每个节点都有相同的数据集<br>向外扩展<br><strong>二进制日志</strong><br>单向   </li>
<li>复制的功用：<br>数据分布<br>负载均衡读<br>备份<br>高可用和故障切换<br>MySQL升级测试   </li>
</ul>
<h1 id="MySQL复制-1"><a href="#MySQL复制-1" class="headerlink" title="MySQL复制"></a>MySQL复制</h1><p>主从复制线程：      </p>
<ul>
<li>主节点：<br>dump Thread：为每个Slave的I/O<br>Thread启动一个dump线程，用于向其发送binary log events  </li>
<li>从节点：<br>I/O Thread：向Master请求二进制日志事件，并保存于中继日志中<br>SQL Thread：从中继日志中读取日志事件，在本地完成重放</li>
<li>跟复制功能相关的文件：<br>master.info：用于保存slave连接至master时的相关信息，例如账号、密码、服务器地址等<br>relay-log.info：保存在当前slave节点上已经复制的当前二进制日志和本地replay log日志的对应关系      <blockquote>
<p>主从配置过程：参看官网<br><a href="https://mariadb.com/kb/en/library/setting-up-replication/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/setting-up-replication/</a><br><a href="https://dev.mysql.com/doc/refman/5.5/en/replication-configuration.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.5/en/replication-configuration.html</a>   </p>
</blockquote>
</li>
</ul>
<h2 id="主从复制配置"><a href="#主从复制配置" class="headerlink" title="主从复制配置"></a>主从复制配置</h2><h3 id="主节点"><a href="#主节点" class="headerlink" title="主节点"></a>主节点</h3><p>主节点配置：   </p>
<ol>
<li>启用二进制日志<br>[mysqld]<br><code>log_bin</code>   </li>
<li>为当前节点设置一个全局惟一的ID号<br>[mysqld]<br><code>server_id=#</code>   </li>
<li>创建有复制权限的用户账号<br><code>GRANT REPLICATION SLAVE ON *.* TO &#39;repluser&#39;@&#39;HOST&#39; IDENTIFIED BY
&#39;replpass&#39;;</code><h3 id="从节点"><a href="#从节点" class="headerlink" title="从节点"></a>从节点</h3>从节点配置：   </li>
<li><p>启动中继日志 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]     </span><br><span class="line">server_id=#  #为当前节点设置一个全局惟的ID号   </span><br><span class="line">read_only=ON #设置数据库只读</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用有复制权限的用户账号连接至主服务器，并启动复制线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO MASTER_HOST=&apos;host&apos;,                       #主节点IP</span><br><span class="line">       MASTER_USER=&apos;repluser&apos;, </span><br><span class="line">       MASTER_PASSWORD=&apos;replpass&apos;,                                #连接主节点用户和密码</span><br><span class="line">       MASTER_LOG_FILE=&apos; mariadb-bin.xxxxxx&apos;, </span><br><span class="line">       MASTER_LOG_POS=#;                                          #指定要同步的二进制文件和起始点</span><br><span class="line">mysql&gt; START SLAVE [IO_THREAD|SQL_THREAD];                        #开启从服务线程</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="一主一从示例："><a href="#一主一从示例：" class="headerlink" title="一主一从示例："></a>一主一从示例：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">主节点:</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=/data/binlog/mysql</span><br><span class="line">binlog_format=row</span><br><span class="line">创建授权用户</span><br><span class="line">MariaDB [(none)]&gt; grant replication slave on *.* to repuser@&apos;192.168.34.%&apos; identified by &apos;linux&apos;;</span><br><span class="line"></span><br><span class="line">从节点：</span><br><span class="line">修改配置文件:</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">read-only=on</span><br><span class="line">设置mysql slave服务</span><br><span class="line">help change master to; #通过帮助查看slave系统命令</span><br><span class="line">  CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=&apos;192.168.34.8&apos;,      #主服务IP</span><br><span class="line">  MASTER_USER=&apos;repuser&apos;,           #同步授权账户</span><br><span class="line">  MASTER_PASSWORD=&apos;linux&apos;,         #账户密码</span><br><span class="line">  MASTER_PORT=3306,                #mariadb端口</span><br><span class="line">  MASTER_LOG_FILE=&apos;mysql.000001&apos;,  #想使用的二进制文件</span><br><span class="line">  MASTER_LOG_POS=245;              #此二进制文件同步的起始点</span><br><span class="line"></span><br><span class="line">启动slave进程</span><br><span class="line">start slave</span><br><span class="line">查看slave进程状态</span><br><span class="line">show slave status\G</span><br></pre></td></tr></table></figure>
<h4 id="扩展已有的主节点，到新增的从节点"><a href="#扩展已有的主节点，到新增的从节点" class="headerlink" title="扩展已有的主节点，到新增的从节点"></a>扩展已有的主节点，到新增的从节点</h4><p>如果主节点已经运行了一段时间，且有大量数据时，如何配置并启动slave节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1、通过备份主节点的数据还原到新增的从节点主机</span><br><span class="line">mysqldump -A -F --single-transaction --master-data=1 &gt; /data/all_bak`date +%F`.sql</span><br><span class="line">2、将备份文件拷贝到新从节点</span><br><span class="line">scp /data/all_bak2018-12-09.sql 192.168.34.9:/data/</span><br><span class="line">3、修改编辑备份文件，将主从配置写入</span><br><span class="line">利用原有--master-data生成的内容，添加以下内容</span><br><span class="line">vim /data/all_bak2018-12-09.sql</span><br><span class="line">  CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=&apos;192.168.34.8&apos;,</span><br><span class="line">  MASTER_USER=&apos;repuser&apos;,</span><br><span class="line">  MASTER_PASSWORD=&apos;linux&apos;,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=&apos;mysql.000002&apos;, MASTER_LOG_POS=245;  </span><br><span class="line">4、导入数据库文件</span><br><span class="line">mysql &lt; /data/all_bak2018-12-09.sql</span><br><span class="line">5、开启slave进程，验证同步</span><br><span class="line">MariaDB [(none)]&gt; start slave;</span><br></pre></td></tr></table></figure></p>
<h4 id="手动提升从节点，切换主从复制"><a href="#手动提升从节点，切换主从复制" class="headerlink" title="手动提升从节点，切换主从复制"></a>手动提升从节点，切换主从复制</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">当主节点服务器发生故障，需要临时切换一个从节点为主节点</span><br><span class="line">1、清楚原有的从节点信息</span><br><span class="line">MariaDB [(none)]&gt; stop slave;         #需要先停止slave进程</span><br><span class="line">MariaDB [(none)]&gt; reset slave all;    #清楚原有slave信息</span><br><span class="line">2、修改要提升的从服务器mysql配置文件</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">#read-only=on          #禁用只读</span><br><span class="line">binlog_format=row      #采用行存储二进制 </span><br><span class="line">log-bin                #启用二进制日志</span><br><span class="line">重启服务</span><br><span class="line">systemctl restart mariadb</span><br><span class="line">3、在其它从节点上配置新的主节点信息</span><br><span class="line">1）清理原有的slave信息</span><br><span class="line">MariaDB [(none)]&gt; stop slave;         #需要先停止slave进程</span><br><span class="line">MariaDB [(none)]&gt; reset slave all;    #清楚原有slave信息</span><br><span class="line">2）在新的主节点上查看二进制日志信息，确定要同步的起始点</span><br><span class="line">MariaDB [(none)]&gt; show master logs;</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| Log_name           | File_size |</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| mariadb-bin.000001 |       264 |</span><br><span class="line">| mariadb-bin.000002 |       245 |</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">3）添加主节点配置信息</span><br><span class="line">CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=&apos;192.168.34.7&apos;,</span><br><span class="line">  MASTER_USER=&apos;repuser&apos;,</span><br><span class="line">  MASTER_PASSWORD=&apos;linux&apos;,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=&apos;mariadb-bin.000002&apos;,</span><br><span class="line">  MASTER_LOG_POS=245;</span><br><span class="line">4）启动slave进程</span><br><span class="line">MariaDB [(none)]&gt; start slave;</span><br><span class="line">4、验证同步情况</span><br><span class="line">注意新主节点的防火墙配置</span><br></pre></td></tr></table></figure>
<h4 id="启用级联复制节点"><a href="#启用级联复制节点" class="headerlink" title="启用级联复制节点"></a>启用级联复制节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1、主节点配置不需更改</span><br><span class="line">2、修改中间节点配置</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">log-bin            #启用二进制</span><br><span class="line">read-only          #从节点建议启用                                                          </span><br><span class="line">log-slave-updates  #中间节点必须启动此选项</span><br><span class="line">3、次级联节点配置</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=3</span><br><span class="line">read-only</span><br><span class="line">需要将主节点信息指向中间节点</span><br><span class="line">CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=&apos;192.168.34.9&apos;,            #中间节点IP</span><br><span class="line">  MASTER_USER=&apos;repuser&apos;,</span><br><span class="line">  MASTER_PASSWORD=&apos;linux&apos;,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=&apos;mariadb-bin.000001&apos;,  #中间节点的二进制日志</span><br><span class="line">  MASTER_LOG_POS=245;                    #中间节点的二进制起始点</span><br><span class="line">start slave;</span><br><span class="line">4、验证同步情况</span><br></pre></td></tr></table></figure>
<h4 id="主从复制中的错误排查"><a href="#主从复制中的错误排查" class="headerlink" title="主从复制中的错误排查"></a>主从复制中的错误排查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.34.7</span><br><span class="line">                  Master_User: repuser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mariadb-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 488                          #查看已读到的主节点二进制日志信息</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000007</span><br><span class="line">                Relay_Log_Pos: 531</span><br><span class="line">        Relay_Master_Log_File: mariadb-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 407                          #目前执行的二进制信息</span><br><span class="line">              Relay_Log_Space: 908</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 4462                         #与主节点同步的时间间隔</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 2</span><br><span class="line"></span><br><span class="line">以上3点是查看同步情况是否成功的主要信息</span><br><span class="line">如遇到错误，可以使用</span><br><span class="line">sql_slave_skip_counter = N #N代表想要跳过的错误数量</span><br></pre></td></tr></table></figure>
<h3 id="复制架构中应该注意的问题："><a href="#复制架构中应该注意的问题：" class="headerlink" title="复制架构中应该注意的问题："></a>复制架构中应该注意的问题：</h3><ol>
<li><strong>限制从服务器为只读</strong><br>在从服务器上设置read_only=ON<blockquote>
<p>注意：此限制对拥有SUPER权限的用户均无效</p>
</blockquote>
</li>
<li>RESET SLAVE<br>在从服务器清除master.info ，relay-log.info, relay log ，开始新的relaylog <blockquote>
<p>注意：需要先STOP SLAVE</p>
</blockquote>
</li>
<li><strong>RESET SLAVE ALL</strong> 清除所有从服务器上设置的主服务器同步信息如：<br>PORT, HOST, USER和 PASSWORD 等</li>
<li><strong>sql_slave_skip_counter = N</strong> 从服务器忽略几个主服务器的复制事件，<br>global变量<blockquote>
<p>修改中间节点的数据与主服务器冲突会影响后续的同步，启用此选项可以忽略某几项冲突</p>
</blockquote>
</li>
<li>如何保证主从复制的事务安全<br>参看<a href="https://mariadb.com/kb/en/library/server-system-variables/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/server-system-variables/</a>   </li>
</ol>
<ul>
<li>在master节点启用参数：<br><code>sync_binlog=1</code> 每次写后立即同步二进制日志到磁盘，性能差<br>如果用到的为InnoDB存储引擎：<br><code>innodb_flush_log_at_trx_commit=1</code> 每次事务提交立即同步日志写磁盘<br><code>innodb_support_xa=ON</code> 默认值，分布式事务MariaDB10.3.0废除<br><code>sync_master_info=#</code> #次事件后master.info同步到磁盘  #启用之后可以集中同步推送</li>
<li>在slave节点启用服务器选项：<br><code>skip_slave_start=ON</code> #不自动启动slave   #默认为false  除第一次手动启动外，后续自动启动</li>
<li>在slave节点启用参数：<br><code>sync_relay_log=#</code> #次写后同步relay log到磁盘<br><code>sync_relay_log_info=#</code> #次事务后同步relay-log.info到磁盘   </li>
</ul>
<h2 id="主主复制"><a href="#主主复制" class="headerlink" title="主主复制"></a>主主复制</h2><p>主主复制：互为主从<br>考虑要点：自动增长id  </p>
<ul>
<li>配置一个节点使用奇数id<br>auto_increment_offset=1   #开始点<br>auto_increment_increment=2 #增长幅度  </li>
<li>另一个节点使用偶数id<br>auto_increment_offset=2<br>auto_increment_increment=2  <blockquote>
<p>容易产生的问题：数据不一致；因此慎用 </p>
</blockquote>
</li>
<li>主主复制的配置步骤：<br>(1) 各节点使用一个惟一server_id<br>(2) 都启动binary log和relay log<br>(3) 创建拥有复制权限的用户账号<br>(4) 定义自动增长id字段的数值范围各为奇偶<br>(5) 均把对方指定为主节点，并启动复制线程  </li>
</ul>
<h2 id="半同步复制"><a href="#半同步复制" class="headerlink" title="半同步复制"></a>半同步复制</h2><p>半同步复制实现：<br>默认情况下，MySQL的复制功能是异步的，异步复制可以提供最佳的性能，主库把binlog日志发送给从库即结束，并不验证从库是否接收完毕。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">主节点：</span><br><span class="line">1、安装半同步插件</span><br><span class="line">INSTALL PLUGIN rpl_semi_sync_master SONAME &apos;semisync_master.so&apos;;</span><br><span class="line">2、修改配置文件启用插件</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=/data/binlog/mysql</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl_semi_sync_master_enabled</span><br><span class="line">rpl_semi_sync_master_timeout = 2000  #超时时长2s</span><br><span class="line">3、验证插件开启情况</span><br><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL VARIABLES LIKE &apos;%semi%&apos;;</span><br><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE &apos;%semi%&apos;;</span><br><span class="line"></span><br><span class="line">从节点：</span><br><span class="line">1、安装插件</span><br><span class="line">INSTALL PLUGIN rpl_semi_sync_slave SONAME &apos;semisync_slave.so&apos;;</span><br><span class="line">2、修改配置文件，启用插件</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">read-only=on</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl_semi_sync_slave_enabled </span><br><span class="line">3、验证插件开启情况</span><br><span class="line">MariaDB [(none)]&gt; select @@rpl_semi_sync_slave_enabled;</span><br><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL VARIABLES LIKE &apos;%semi%&apos;;</span><br><span class="line">4、重启slave线程</span><br><span class="line">MariaDB [(none)]&gt; stop slave;</span><br><span class="line">MariaDB [(none)]&gt; start slave;</span><br><span class="line"></span><br><span class="line">验证同步</span><br><span class="line">只要有一个从节点同步成功，就返回成功</span><br><span class="line">如果所有从节点都出现故障，会利用rpl_semi_sync_master_timeout来判断超时。</span><br></pre></td></tr></table></figure></p>
<h2 id="复制过滤器"><a href="#复制过滤器" class="headerlink" title="复制过滤器"></a>复制过滤器</h2><p>从服务器SQL_THREAD在replay中继日志中的事件时，仅读取与特定数据库(特定表)相关的事件并应用于本地  </p>
<blockquote>
<p>问题：会造成网络及磁盘IO浪费   </p>
</blockquote>
<p>从服务器上的复制过滤器相关变量<br>replicate_do_db= 指定复制库的白名单<br>replicate_ignore_db= 指定复制库黑名单<br>replicate_do_table= 指定复制表的白名单<br>replicate_ignore_table= 指定复制表的黑名单<br>replicate_wild_do_table= foo%.bar% 支持通配符<br>replicate_wild_ignore_table=<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">利用过滤器来指定数据库同步</span><br><span class="line">修改从节点配置文件</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">read-only=on</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl-semi-sync-slave-enabled</span><br><span class="line">replicate_do_db=hellodb   #指定要同步的数据库白名单</span><br><span class="line">重启服务</span><br><span class="line">systemctl restart mariadb</span><br><span class="line"></span><br><span class="line">验证只有hellodb内容可以同步，其它数据库不同步</span><br></pre></td></tr></table></figure></p>
<h1 id="MySQL复制加密"><a href="#MySQL复制加密" class="headerlink" title="MySQL复制加密"></a>MySQL复制加密</h1><p>基于SSL复制：<br>在默认的主从复制过程或远程连接到MySQL/MariaDB所有的链接通信中的数据都是明文的，外网里访问数据或则复制，存在安全隐患。通过SSL/TLS加密的<br>方式进行复制的方法，来进一步提高数据的安全性</p>
<ul>
<li>配置实现：<br>参看：<a href="https://mariadb.com/kb/en/library/replication-with-secureconnections/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/replication-with-secureconnections/</a></li>
</ul>
<ol>
<li>主服务器开启SSL：[mysqld] 加一行ssl<br>主服务器配置证书和私钥；并且创建一个要求必须使用SSL连接的复制账号</li>
<li>从服务器使用CHANGER MASTER TO 命令时指明ssl相关选项<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">创建必要证书文件</span><br><span class="line">1、创建ssl相关文件存放的文件夹</span><br><span class="line">mkdir /etc/my.cnf.d/ssl</span><br><span class="line">2、生成主节点的私钥</span><br><span class="line">(umask 066;openssl genrsa 2048 &gt; cakey.pem)</span><br><span class="line">3、利用私钥生成CA证书</span><br><span class="line">openssl req -new -x509 -key cakey.pem -out cacert.pem -days 3650</span><br><span class="line">4、利用CA证书申请主节点私钥及证书申请文件 </span><br><span class="line">openssl req -newkey rsa:2048 -days 365 -nodes -keyout master.key &gt; master.csr  #nodes生成私钥不加密</span><br><span class="line">5、利用CA证书申请从节点私钥及证书申请文件</span><br><span class="line">openssl req -newkey rsa:2048 -days 365 -nodes -keyout slave.key &gt; slave.csr</span><br><span class="line">6、利用CA证书签名主节点证书</span><br><span class="line">openssl x509 -req -in master.csr -CA cacert.pem -CAkey cakey.pem -set_serial 01 &gt; master.crt  #-set_serial指定序列号</span><br><span class="line">利用CA证书签名从节点证书</span><br><span class="line">openssl x509 -req -in slave.csr -CA cacert.pem -CAkey cakey.pem -set_serial 02 &gt; slave.crt</span><br><span class="line">7、将CA证书、从节点私钥及证书拷贝到从节点主机</span><br><span class="line">scp cacert.pem slave.crt slave.key 192.168.34.7:/etc/my.cnf.d/ssl/</span><br><span class="line">scp cacert.pem slave.crt slave.key 192.168.34.9:/etc/my.cnf.d/ssl/</span><br><span class="line"></span><br><span class="line">配置主从节点加密</span><br><span class="line">1、修改主节点配置文件</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=/data/binlog/mysql</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl_semi_sync_master_enabled</span><br><span class="line">rpl_semi_sync_master_timeout = 2000</span><br><span class="line">ssl-ca=/etc/my.cnf.d/ssl/cacert.pem     #指向CA证书</span><br><span class="line">ssl-cert=/etc/my.cnf.d/ssl/master.crt   #指向主节点证书</span><br><span class="line">ssl-key=/etc/my.cnf.d/ssl/master.key    #指向主节点私钥</span><br><span class="line">验证ssl启用状态</span><br><span class="line">MariaDB [test]&gt; show variables like &apos;%ssl%&apos;;</span><br><span class="line">2、授权只能用于ssl登录的账户</span><br><span class="line">grant replication slave on *.* to rplssl@&apos;192.168.34.%&apos; identified by &apos;linux&apos; require ssl;</span><br><span class="line">3、修改从节点slave配置信息</span><br><span class="line">清楚原有slave配置信息</span><br><span class="line">MariaDB [(none)]&gt; stop slave;</span><br><span class="line">MariaDB [(none)]&gt; start slave;</span><br><span class="line">CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=&apos;192.168.34.8&apos;,</span><br><span class="line">  MASTER_USER=&apos;repuser&apos;,</span><br><span class="line">  MASTER_PASSWORD=&apos;linux&apos;,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=&apos;mysql.000008&apos;,                   #需要在主节点确认最新的二进制文件</span><br><span class="line">  MASTER_LOG_POS=501,                               #在主节点二进制文件的起始点</span><br><span class="line">  MASTER_SSL=1,                                     #启用ssl</span><br><span class="line">  MASTER_SSL_CA = &apos;/etc/my.cnf.d/ssl/cacert.pem&apos;,   #指定本地的CA证书</span><br><span class="line">  MASTER_SSL_CERT = &apos;/etc/my.cnf.d/ssl/slave.crt&apos;,  #指定本地slave节点证书</span><br><span class="line">  MASTER_SSL_KEY = &apos;/etc/my.cnf.d/ssl/slave.key&apos;;   #指定本地slave私钥</span><br><span class="line">4、启动slave线程</span><br><span class="line">start slave；</span><br><span class="line"></span><br><span class="line">验证主从同步</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="主从同步的监控和维护"><a href="#主从同步的监控和维护" class="headerlink" title="主从同步的监控和维护"></a>主从同步的监控和维护</h2><ol>
<li>日志文件<br>清理到5之前的日志文件<br><code>purge master logs to &#39;mysql.000005&#39;;</code><br>清理所有二进制文件，重头开始<br><code>reset master;</code><br>清理slave线程的状态，重新开始同步<br><code>reset slave;</code></li>
<li>复制监控<br>查看二进制日志的最近一个使用情况<br><code>SHOW MASTER STATUS;</code><br>查看二进制日志的详细内容<br><code>SHOW BINLOG EVENTS;</code><br>查看所有二进制文件<br><code>SHOW MASTER LOGS;</code><br>查看从节点同步状态<br><code>SHOW SLAVE STATUS\G</code><br>查看mysql进程信息<br><code>SHOW PROCESSLIST;</code></li>
<li>从服务器是否落后于主服务<br><code>Seconds_Behind_Master: 0</code></li>
<li>如何确定主从节点数据是否一致<br>percona-tools   </li>
<li>数据不一致如何修复<br>删除从数据库，重新复制 </li>
</ol>
<h1 id="MySQL读写分离"><a href="#MySQL读写分离" class="headerlink" title="MySQL读写分离"></a>MySQL读写分离</h1><p>读写分离应用：<br>mysql-proxy：Oracle，<a href="https://downloads.mysql.com/archives/proxy/" target="_blank" rel="noopener">https://downloads.mysql.com/archives/proxy/</a><br>Atlas：Qihoo，<a href="https://github.com/Qihoo360/Atlas/blob/master/README_ZH.md" target="_blank" rel="noopener">https://github.com/Qihoo360/Atlas/blob/master/README_ZH.md</a><br>dbproxy：美团，<a href="https://github.com/Meituan-Dianping/DBProxy" target="_blank" rel="noopener">https://github.com/Meituan-Dianping/DBProxy</a><br>Cetus：网易乐得，<a href="https://github.com/Lede-Inc/cetus" target="_blank" rel="noopener">https://github.com/Lede-Inc/cetus</a><br>Amoeba：<a href="https://sourceforge.net/projects/amoeba/" target="_blank" rel="noopener">https://sourceforge.net/projects/amoeba/</a><br>Cobar：阿里巴巴，Amoeba的升级版<br>Mycat：基于Cobar， <a href="http://www.mycat.io/" target="_blank" rel="noopener">http://www.mycat.io/</a><br>ProxySQL：<a href="https://proxysql.com/" target="_blank" rel="noopener">https://proxysql.com/</a>   </p>
<h2 id="ProxySQL"><a href="#ProxySQL" class="headerlink" title="ProxySQL"></a>ProxySQL</h2><p>ProxySQL组成<br>服务脚本：/etc/init.d/proxysql<br>配置文件：/etc/proxysql.cnf<br>主程序：/usr/bin/proxysql<br><strong>准备：实现读写分离前，先实现主从复制</strong>   </p>
<blockquote>
<p>注意：slave节点需要设置read_only=1</p>
</blockquote>
<h3 id="安装proxysql服务器"><a href="#安装proxysql服务器" class="headerlink" title="安装proxysql服务器"></a>安装proxysql服务器</h3><ol>
<li><p>基于YUM仓库安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | tee /etc/yum.repos.d/proxysql.repo</span><br><span class="line">[proxysql_repo]</span><br><span class="line">name= ProxySQL YUM repository</span><br><span class="line">baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/\$releasever</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key</span><br><span class="line">EOF</span><br><span class="line">重新生成仓库列表中的内容</span><br><span class="line">yum repolist</span><br><span class="line">利用yum安装</span><br><span class="line">yum install proxysql</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务<br>启动ProxySQL：systemctl proxysql start<br>启动后会监听两个默认端口<br>6032：ProxySQL的管理端口<br>6033：ProxySQL对外提供服务的端口   </p>
<h3 id="配置proxysql"><a href="#配置proxysql" class="headerlink" title="配置proxysql"></a>配置proxysql</h3><p>使用管理端口连接<br>使用mysql客户端连接到ProxySQL的管理接口6032，默认管理员用户和密码都是admin：<br><code>mysql -uadmin -padmin -P6032 -h127.0.0.1</code></p>
<blockquote>
<p>说明：在main和monitor数据库中的表， runtime_开头的是运行时的配置，不能修改，只能修改非runtime_表，修改后必须执行LOAD … TO RUNTIME才能加载到RUNTIME生效，执行save … to disk将配置持久化保存到磁盘</p>
</blockquote>
<h4 id="添加主从mysql节点"><a href="#添加主从mysql节点" class="headerlink" title="添加主从mysql节点"></a>添加主从mysql节点</h4></li>
<li><p>添加现有mysql服务器到mysql_servers表中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main]&gt; insert into mysql_servers(hostgroup_id,hostname,port) values(10,&apos;192.168.34.8&apos;,3306);</span><br><span class="line">MySQL [main]&gt; insert into mysql_servers(hostgroup_id,hostname,port) values(10,&apos;192.168.34.7&apos;,3306);</span><br><span class="line">MySQL [main]&gt; insert into mysql_servers(hostgroup_id,hostname,port) values(10,&apos;192.168.34.9&apos;,3306);</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看表中添加的状态<br><code>MySQL [main]&gt; select * from main.mysql_servers;</code>  </p>
</li>
<li>将mysql_servers表中的内容添加到runtime表中<br><code>MySQL [main]&gt; load mysql servers to runtime;</code>   </li>
<li>将mysql_servers表中的内容写入到磁盘<br><code>MySQL [main]&gt; save mysql servers to disk;</code><h4 id="配置监控账户"><a href="#配置监控账户" class="headerlink" title="配置监控账户"></a>配置监控账户</h4></li>
<li>在mysql主节点上授权创建监控账户<br><code>grant replication client on *.* to monitor@&#39;192.168.34.%&#39; identified by &#39;linux&#39;;</code>  </li>
<li>回到proxysql服务器中添加账户到系统中<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main]&gt; set mysql-monitor_username=&apos;monitor&apos;;</span><br><span class="line">MySQL [main]&gt; set mysql-monitor_password=&apos;linux&apos;;</span><br><span class="line">MySQL [main]&gt; load mysql variables to runtime;</span><br><span class="line">MySQL [main]&gt; save mysql variables to disk;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="查看已配置的节点是否正常"><a href="#查看已配置的节点是否正常" class="headerlink" title="查看已配置的节点是否正常"></a>查看已配置的节点是否正常</h4><p>监控模块的指标保存在monitor库的log表中   </p>
<ol>
<li>查看监控连接是否正常的(对connect指标的监控)：(如果connect_error的结果为NULL则表示正常)<br><code>MySQL [main]&gt; select * from mysql_server_connect_log;</code>  </li>
<li>查看监控心跳信息 (对ping指标的监控)：<br><code>MySQL [main]&gt; select * from mysql_server_ping_log;</code>  </li>
<li>查看read_only和replication_lag的监控日志<br><code>MySQL [main]&gt; select * from mysql_server_read_only_log;</code><br><code>MySQL [main]&gt; select * from mysql_server_replication_lag_log;</code><h4 id="设置proxysql分组信息"><a href="#设置proxysql分组信息" class="headerlink" title="设置proxysql分组信息"></a>设置proxysql分组信息</h4>需要修改的是main库中的mysql_replication_hostgroups表，该表有3个字段：<br>writer_hostgroup，reader_hostgroup，comment<br>指定写组的id为10，读组的id为20   </li>
<li><p>创建新的分组信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main]&gt; insert into mysql_replication_hostgroups values(10,20,&apos;web_mysql&apos;);</span><br><span class="line"></span><br><span class="line">MySQL [main]&gt; select * from mysql_replication_hostgroups;</span><br><span class="line">+------------------+------------------+-----------+</span><br><span class="line">| writer_hostgroup | reader_hostgroup | comment   |</span><br><span class="line">+------------------+------------------+-----------+</span><br><span class="line">| 10               | 20               | web_mysql |</span><br><span class="line">+------------------+------------------+-----------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>将分组信息写入RUNTIME生效<br><code>load mysql servers to runtime;</code>   </p>
</li>
<li>将分组信息表中的写入到磁盘<br><code>save mysql servers to disk;</code>   </li>
<li>Monitor模块监控后端的read_only值，按照read_only的值将节点自动移动到读/写组<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main]&gt; select hostgroup_id,hostname,port,status,weight from mysql_servers; </span><br><span class="line">+--------------+--------------+------+--------+--------+</span><br><span class="line">| hostgroup_id | hostname     | port | status | weight |</span><br><span class="line">+--------------+--------------+------+--------+--------+</span><br><span class="line">| 10           | 192.168.34.8 | 3306 | ONLINE | 1      |</span><br><span class="line">| 20           | 192.168.34.9 | 3306 | ONLINE | 1      |</span><br><span class="line">| 20           | 192.168.34.7 | 3306 | ONLINE | 1      |</span><br><span class="line">+--------------+--------------+------+--------+--------+</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="创建在集群中发送SQL语句的用户"><a href="#创建在集群中发送SQL语句的用户" class="headerlink" title="创建在集群中发送SQL语句的用户"></a>创建在集群中发送SQL语句的用户</h4><ol>
<li>在主节点上创建访问用户<br><code>grant all on *.* to sqluser@&#39;192.168.34.%&#39; identified by &#39;linux&#39;;</code></li>
<li>返回proxysql服务器将此用户加入到mysql_users表中<br><code>insert into mysql_users(username,password,default_hostgroup) values(&#39;sqluser&#39;,&#39;linux&#39;,10);</code></li>
<li>将用户表的修改写入RUNTIME生效<br><code>load mysql users to runtime;</code>  </li>
<li>将用户表中的内容写入到磁盘<br><code>save mysql users to disk;</code></li>
<li>验证用户是否可以读写  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;select @@server_id&apos;</span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           1 |</span><br><span class="line">+-------------+</span><br><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;create database db7&apos;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="配置proxysql路由规则，实现读写分离"><a href="#配置proxysql路由规则，实现读写分离" class="headerlink" title="配置proxysql路由规则，实现读写分离"></a>配置proxysql路由规则，实现读写分离</h4><p>与规则有关的表：mysql_query_rules和mysql_query_rules_fast_routing，后者是前者的扩展表，1.4.7之后支持   </p>
<ol>
<li>插入路由规则：将select语句分离到20的读组，select语句中有一个特殊语句SELECT…FOR UPDATE它会申请写锁，应路由到10的写组<br><code>insert into mysql_query_rules (rule_id,active,match_digest,destination_hostgroup,apply) VALUES(1,1,&#39;^SELECT.*FOR UPDATE$&#39;,10,1),(2,1,&#39;^SELECT&#39;,20,1);</code><blockquote>
<p>注意：因ProxySQL根据rule_id顺序进行规则匹配，select … for update规则的<br>rule_id必须要小于普通的select规则的rule_id,此处规则ID为1</p>
</blockquote>
</li>
<li>将规则表的修改写入RUNTIME生效<br><code>load mysql query rules to runtime;</code>   </li>
<li>将规则表中的内容写入到磁盘<br><code>save mysql query rules to disk;</code>   <h3 id="测试读写分离"><a href="#测试读写分离" class="headerlink" title="测试读写分离"></a>测试读写分离</h3>在proxysql服务器执行测试<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">测试查询是否分离并负载均衡</span><br><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;select @@server_id&apos;</span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           2 |</span><br><span class="line">+-------------+</span><br><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;select @@server_id&apos;</span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           3 |</span><br><span class="line">+-------------+</span><br><span class="line"></span><br><span class="line">测试写入数据库</span><br><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;create table db7.t1(id int,name char(10))&apos;</span><br><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;insert db7.t1 (id,name)values(1,&quot;one&quot;)&apos;</span><br><span class="line">路由的信息：查询stats库中的stats_mysql_query_digest表</span><br><span class="line">MySQL [main]&gt; SELECT hostgroup hg,sum_time, count_star, digest_text FROM</span><br><span class="line">    -&gt; stats_mysql_query_digest ORDER BY sum_time DESC;  #利用查询时间来降序排列</span><br><span class="line">+----+----------+------------+------------------------------------------+</span><br><span class="line">| hg | sum_time | count_star | digest_text                              |</span><br><span class="line">+----+----------+------------+------------------------------------------+</span><br><span class="line">| 20 | 10005    | 11         | select @@server_id                       |</span><br><span class="line">| 10 | 7630     | 1          | create table db7.t1(id int,name char(?)) |</span><br><span class="line">| 10 | 4661     | 8          | select @@server_id                       |</span><br><span class="line">| 10 | 3388     | 5          | begin                                    |</span><br><span class="line">| 10 | 2520     | 1          | insert db7.t1 (id,name)values(?,?)       |</span><br><span class="line">| 10 | 1696     | 5          | commit                                   |</span><br><span class="line">| 10 | 1096     | 1          | create database db7                      |</span><br><span class="line">| 10 | 911      | 1          | show databases                           |</span><br><span class="line">| 10 | 856      | 1          | insert db7.t1 (id,name)values(?,one)     |</span><br><span class="line">| 10 | 831      | 1          | show tables                              |</span><br><span class="line">+----+----------+------------+------------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="MySQL高可用MHA"><a href="#MySQL高可用MHA" class="headerlink" title="MySQL高可用MHA"></a>MySQL高可用MHA</h1><p>MHA工作原理</p>
<ol>
<li>从宕机崩溃的master保存二进制日志事件（binlog events）</li>
<li>识别含有最新更新的slave</li>
<li>应用差异的中继日志（relay log）到其他的slave</li>
<li>应用从master保存的二进制日志事件（binlog events）</li>
<li>提升一个slave为新的master</li>
<li>使其他的slave连接新的master进行复制</li>
</ol>
<p>MHA软件由两部分组成，Manager工具包和Node工具包<br>Manager工具包主要包括以下几个工具：   </p>
<ul>
<li>masterha_check_ssh 检查MHA的SSH配置状况</li>
<li>masterha_check_repl 检查MySQL复制状况</li>
<li>masterha_manger 启动MHA</li>
<li>masterha_check_status 检测当前MHA运行状态</li>
<li>masterha_master_monitor 检测master是否宕机</li>
<li>masterha_master_switch 故障转移（自动或手动）</li>
<li>masterha_conf_host 添加或删除配置的server信息<blockquote>
<p>注意：为了尽可能的减少主库硬件损坏宕机造成的数据丢失，因此在配置MHA的同时建议MYSQL配置半同步复制</p>
</blockquote>
</li>
</ul>
<h2 id="配置MHA"><a href="#配置MHA" class="headerlink" title="配置MHA"></a>配置MHA</h2><h3 id="安装MHA相关软件包"><a href="#安装MHA相关软件包" class="headerlink" title="安装MHA相关软件包"></a>安装MHA相关软件包</h3><ol>
<li>在MHA管理服务器上安装Manager工具包和Node工具包<br>下载需要的安装包<br><code>wget https://github.com/linyue515/mysql-master-ha/raw/master/mha4mysql-manager-0.57-0.el7.noarch.rpm</code><br><code>wget https://github.com/linyue515/mysql-master-ha/raw/master/mha4mysql-node-0.57-0.el7.noarch.rpm</code><br>检查epel源的安装，安装manager包需要解决依赖关系<br><code>yum install epel-release</code><br>安装两个软件包<br><code>yum install -y mha4mysql*</code></li>
<li>在从节点上安装Node工具包<br>下载需要的安装包<br>wget <a href="https://github.com/linyue515/mysql-master-ha/raw/master/mha4mysql-node-0.57-0.el7.noarch.rpm" target="_blank" rel="noopener">https://github.com/linyue515/mysql-master-ha/raw/master/mha4mysql-node-0.57-0.el7.noarch.rpm</a><br>安装node包<br>yum install mha4mysql-node-0.57-0.el7.noarch.rpm   <h3 id="修改mysql主从节点的配置文件"><a href="#修改mysql主从节点的配置文件" class="headerlink" title="修改mysql主从节点的配置文件"></a>修改mysql主从节点的配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">主节点：</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=/data/binlog/mysql</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl_semi_sync_master_enabled</span><br><span class="line">rpl_semi_sync_master_timeout = 2000</span><br><span class="line">ssl-ca=/etc/my.cnf.d/ssl/cacert.pem</span><br><span class="line">ssl-cert=/etc/my.cnf.d/ssl/master.crt</span><br><span class="line">ssl-key=/etc/my.cnf.d/ssl/master.key</span><br><span class="line">skip-name-resolve   #添加禁止名称解析</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">从节点：</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">read-only=on</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl-semi-sync-slave-enabled</span><br><span class="line">skip-name-resolve      #禁止名称解析</span><br><span class="line">relay-log-purge=off    #关闭中继日志清理</span><br></pre></td></tr></table></figure>
<h3 id="在主节点创建mha管理用户"><a href="#在主节点创建mha管理用户" class="headerlink" title="在主节点创建mha管理用户"></a>在主节点创建mha管理用户</h3><ol>
<li>确保mysql主从复制的账户存在，如果没有可以创建<br><code>grant replication slave on *.* to repuser@&#39;192.168.34.%&#39; identified by &#39;magedu&#39;;</code>  </li>
<li>创建mha管理账户<br><code>grant all on *.* to mhauser@&#39;192.168.34.%&#39; identified by &#39;linux&#39;;</code><h3 id="实现基于key认证的SSH连接"><a href="#实现基于key认证的SSH连接" class="headerlink" title="实现基于key认证的SSH连接"></a>实现基于key认证的SSH连接</h3>将所有节点实现基于key的SSH认证连接  </li>
<li>生成SSHkey<br><code>ssh-keygen</code>  </li>
<li>将生成的公钥拷贝到本机<br><code>ssh-copy-id 192.168.34.10</code></li>
<li>将本地的公私钥拷贝到所有的节点主机上<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp -rp /root/.ssh/ 192.168.34.8:/root/</span><br><span class="line">scp -rp /root/.ssh/ 192.168.34.7:/root/</span><br><span class="line">scp -rp /root/.ssh/ 192.168.34.9:/root/</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="在MHA管理服务器创建MHA配置文件"><a href="#在MHA管理服务器创建MHA配置文件" class="headerlink" title="在MHA管理服务器创建MHA配置文件"></a>在MHA管理服务器创建MHA配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[server default]</span><br><span class="line">user=mhauser                                    #mha管理账户    </span><br><span class="line">password=linux                                  #管理账户密码</span><br><span class="line">manager_workdir=/data/mastermha/DB1/            #本地自动创建的管理文件夹</span><br><span class="line">manager_log=/data/mastermha/DB1/manager.log     #本地自动创建的日志</span><br><span class="line">remote_workdir=/data/mastermha/DB1/             #在远程节点自动创建的目录</span><br><span class="line">master_binlog_dir=/data/binlog/                 #修改过mysql主节点二进制路径后需要指定</span><br><span class="line">ssh_user=root                                   #ssh用户</span><br><span class="line">repl_user=repuser                               #mysql主从复制用户</span><br><span class="line">repl_password=linux                             #mysql主从复制用户密码</span><br><span class="line">ping_interval=1                                 #测试间隔</span><br><span class="line">[server1]                                       #管理的主机组</span><br><span class="line">hostname=192.168.34.8</span><br><span class="line">candidate_master=1                              #允许成功主节点</span><br><span class="line">[server2]</span><br><span class="line">hostname=192.168.34.7</span><br><span class="line">candidate_master=1</span><br><span class="line">[server3]</span><br><span class="line">hostname=192.168.34.9</span><br><span class="line">candidate_master=1</span><br></pre></td></tr></table></figure>
<h3 id="检测配置文件是否正确"><a href="#检测配置文件是否正确" class="headerlink" title="检测配置文件是否正确"></a>检测配置文件是否正确</h3><ol>
<li>检测各个节点之间SSH通信<br><code>masterha_check_ssh --conf=/etc/mha/DB1.cnf</code></li>
<li>检测各个节点之间二进制拷贝通信<br><code>masterha_check_repl --conf=/etc/mha/DB1.cnf</code><h3 id="启动MHA监控程序"><a href="#启动MHA监控程序" class="headerlink" title="启动MHA监控程序"></a>启动MHA监控程序</h3>在实际生产环境建议在后台执行，利用screen或nohup<br><code>masterha_manager --conf=/etc/mastermha/app1.cnf</code><h3 id="测试MHA效果"><a href="#测试MHA效果" class="headerlink" title="测试MHA效果"></a>测试MHA效果</h3>故意在主节点拷贝大量数据时，关闭主机<br>查看MHA的manager日志来查看新的主节点切换过程  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat /data/mastermha/DB1/manager.log</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">The latest slave 192.168.34.7(192.168.34.7:3306) has all relay logs for recovery.</span><br><span class="line">Selected 192.168.34.7(192.168.34.7:3306) as a new master.</span><br><span class="line">192.168.34.7(192.168.34.7:3306): OK: Applying all logs succeeded.</span><br><span class="line">192.168.34.9(192.168.34.9:3306): This host has the latest relay log events.</span><br><span class="line">Generating relay diff files from the latest slave succeeded.</span><br><span class="line">192.168.34.9(192.168.34.9:3306): OK: Applying all logs succeeded. Slave started, replicating from 192.168.34.7(192.168.34.7:3306)</span><br><span class="line">192.168.34.7(192.168.34.7:3306): Resetting slave info succeeded.</span><br><span class="line">Master failover to 192.168.34.7(192.168.34.7:3306) completed successfully.</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="Galera-Cluster"><a href="#Galera-Cluster" class="headerlink" title="Galera Cluster"></a>Galera Cluster</h1><p>Galera Cluster：集成了Galera插件的MySQL集群，是一种新型的，数据不共享的，高度冗余的高可用方案，目前Galera Cluster有两个版本，分别是Percona Xtradb Cluster及MariaDB Cluster，Galera本身是具有多主特性的，即采用multi-master的集群架构，是一个既稳健，又在数据一致性、完整性及高性能方面有出色表现的高可用解决方案。</p>
<h2 id="Galera-Cluster特点"><a href="#Galera-Cluster特点" class="headerlink" title="Galera Cluster特点"></a>Galera Cluster特点</h2><ul>
<li>多主架构：真正的多点读写的集群，在任何时候读写数据，都是最新的</li>
<li>同步复制：集群不同节点之间数据同步，没有延迟，在数据库挂掉之后，数据不会丢失</li>
<li>并发复制：从节点APPLY数据时，支持并行执行，更好的性能</li>
<li>故障切换：在出现数据库故障时，因支持多点写入，切换容易</li>
<li>热插拔：在服务期间，如果数据库挂了，只要监控程序发现的够快，不可服务时间就会非常少。在节点故障期间，节点本身对集群的影响非常小</li>
<li>自动节点克隆：在新增节点，或者停机维护时，增量数据或者基础数据不需要人工手动备份提供，GaleraCluster会自动拉取在线节点数据，最终集群会变为一致</li>
<li>对应用透明：集群的维护，对应用程序是透明的</li>
</ul>
<h2 id="MariaDB-Galera-Cluster"><a href="#MariaDB-Galera-Cluster" class="headerlink" title="MariaDB Galera Cluster"></a>MariaDB Galera Cluster</h2><p>参考仓库：<a href="https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-5.5.62/yum/centos7-amd64/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-5.5.62/yum/centos7-amd64/</a></p>
<blockquote>
<p>注意：都至少需要三个节点，不能安装mariadb-server</p>
<ol>
<li>创建yum仓库安装<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/galera.repo</span><br><span class="line">[galera]</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-5.5.62/yum/centos7-amd64/</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<ol start="2">
<li><p>将repo文件拷贝给其他mysql服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/yum.repos.d/galera.repo 192.168.34.10:/etc/yum.repos.d/</span><br><span class="line">scp /etc/yum.repos.d/galera.repo 192.168.34.7:/etc/yum.repos.d/</span><br><span class="line">scp /etc/yum.repos.d/galera.repo 192.168.34.9:/etc/yum.repos.d/</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装MariaDB-Galera-server<br><code>yum install MariaDB-Galera-server</code></p>
</li>
<li><p>修改其中一台的服务器配置文件  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[galera]</span><br><span class="line"># Mandatory settings</span><br><span class="line">wsrep_provider=/usr/lib64/galera/libgalera_smm.so                  #Galera库文件路径           </span><br><span class="line">wsrep_cluster_address=&quot;gcomm://192.168.34.7,192.168.34.8,192.168.34.9,192.168.34.10&quot;   #集群的主机列表</span><br><span class="line">binlog_format=row                                                  #二进制格式基于行</span><br><span class="line">default_storage_engine=InnoDB                                      #存储引擎innodb</span><br><span class="line">innodb_autoinc_lock_mode=2                                         </span><br><span class="line">bind-address=0.0.0.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>将server.cnf配置文件拷贝到所有节点上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/my.cnf.d/server.cnf 192.168.34.10:/etc/my.cnf.d/server.cnf</span><br><span class="line">scp /etc/my.cnf.d/server.cnf 192.168.34.7:/etc/my.cnf.d/server.cnf</span><br><span class="line">scp /etc/my.cnf.d/server.cnf 192.168.34.9:/etc/my.cnf.d/server.cnf</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化集群<br><code>/etc/init.d/mysql start --wsrep-new-cluster</code></p>
</li>
<li>启动其它所有节点<br><code>service mysql start</code></li>
<li>查看集群的变量参数，验证同步<br><code>SHOW VARIABLES LIKE &#39;wsrep_c%&#39;;</code><br><code>SHOW STATUS LIKE &#39;wsrep_%&#39;;</code>   </li>
</ol>
<h1 id="复制的问题和解决方案"><a href="#复制的问题和解决方案" class="headerlink" title="复制的问题和解决方案"></a>复制的问题和解决方案</h1><ol>
<li>数据损坏或丢失<br>Master： MHA + semi repl半同步<br>Slave： 重新复制   </li>
<li>混合使用存储引擎<br>MyISAM：不支持事务<br>InnoDB： 支持事务   </li>
<li>不惟一的server id<br>重新复制   </li>
<li>复制延迟<br>需要额外的监控工具的辅助<br>一从多主:mariadb10版后支持<br>多线程复制：对多个数据库复制   </li>
</ol>
<h1 id="生产环境my-cnf配置示例"><a href="#生产环境my-cnf配置示例" class="headerlink" title="生产环境my.cnf配置示例"></a>生产环境my.cnf配置示例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">硬件：内存32G</span><br><span class="line">innodb_file_per_table = 1      #打开独立表空间</span><br><span class="line">max_connections = 8000         #MySQL 服务所允许的同时会话数的上限，经常出现Too Many Connections的错误提示，则需要增大此值</span><br><span class="line">back_log = 300                 #back_log 是操作系统在监听队列中所能保持的连接数</span><br><span class="line">max_connect_errors = 1000      #每个客户端连接最大的错误允许数量，当超过该次数，MYSQL服务器将禁止此主机的连接请求，直到MYSQL服务器重启或通过flush hosts命令清空此主机的相关信息</span><br><span class="line">open_files_limit = 10240       #所有线程所打开表的数量</span><br><span class="line">max_allowed_packet = 32M       #每个连接传输数据大小.最大1G，须是1024的倍数，一般设为最大的BLOB的值</span><br><span class="line">wait_timeout = 10              #指定一个请求的最大连接时间</span><br><span class="line">sort_buffer_size = 16M         #排序缓冲被用来处理类似ORDER BY以及GROUP BY队列所引起的排序</span><br><span class="line">join_buffer_size = 16M         #不带索引的全表扫描.使用的buffer的最小值</span><br><span class="line">query_cache_size = 128M        #查询缓冲大小</span><br><span class="line">query_cache_limit = 4M         #指定单个查询能够使用的缓冲区大小，缺省为1M</span><br><span class="line">transaction_isolation = REPEATABLE-READ  # 设定默认的事务隔离级别</span><br><span class="line">thread_stack = 512K            #线程使用的堆大小. 此值限制内存中能处理的存储过程的递归深度和SQL语句复杂性，此容量的内存在每次连接时被预留.</span><br><span class="line">log-bin                        #二进制日志功能</span><br><span class="line">binlog_format=row              #二进制日志格式</span><br><span class="line">innodb_buffer_pool_size = 24G #InnoDB使用一个缓冲池来保存索引和原始数据,可设置这个变量到服务器物理内存大小的80%</span><br><span class="line">innodb_file_io_threads = 4     #用来同步IO操作的IO线程的数量</span><br><span class="line">innodb_thread_concurrency = 16  #在InnoDb核心内的允许线程数量，建议的设置是CPU数量加上磁盘数量的两倍</span><br><span class="line">innodb_log_buffer_size = 16M    # 用来缓冲日志数据的缓冲区的大小</span><br><span class="line">innodb_log_file_size = 512M     #在日志组中每个日志文件的大小</span><br><span class="line">innodb_log_files_in_group = 3   # 在日志组中的文件总数</span><br><span class="line">innodb_lock_wait_timeout = 120  # SQL语句在被回滚前,InnoDB事务等待InnoDB行锁的时间</span><br><span class="line">long_query_time = 2             #慢查询时长</span><br><span class="line">log-queries-not-using-indexes   #将没有使用索引的查询也记录下来</span><br></pre></td></tr></table></figure>
<h1 id="MYSQL配置最佳实践"><a href="#MYSQL配置最佳实践" class="headerlink" title="MYSQL配置最佳实践"></a>MYSQL配置最佳实践</h1><p>高并发大数据的互联网业务，架构设计思路是“解放数据库CPU，将计算转移到服务层”，并发量大的情况下，这些功能很可能将数据库拖死，业务逻辑放到服务层具备更好的扩展性，能够轻易实现“增机器就加性能”<br>参考：<br>阿里巴巴Java开发手册<br>58到家数据库30条军规解读<br><a href="http://zhuanlan.51cto.com/art/201702/531364.htm" target="_blank" rel="noopener">http://zhuanlan.51cto.com/art/201702/531364.htm</a>  </p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag"># linux</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/11/文本处理三剑客之AWK/" rel="next" title="文本处理三剑客之AWK">
                <i class="fa fa-chevron-left"></i> 文本处理三剑客之AWK
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">nieW</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MariaDB"><span class="nav-number">1.</span> <span class="nav-text">MariaDB</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据库的发展史"><span class="nav-number">2.</span> <span class="nav-text">数据库的发展史</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据库系统的架构"><span class="nav-number">3.</span> <span class="nav-text">数据库系统的架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关系型数据库"><span class="nav-number">4.</span> <span class="nav-text">关系型数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RDBMS："><span class="nav-number">4.0.0.1.</span> <span class="nav-text">RDBMS：</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实体-联系模型E-R"><span class="nav-number">5.</span> <span class="nav-text">实体-联系模型E-R</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#联系类型"><span class="nav-number">6.</span> <span class="nav-text">联系类型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#简易数据规划流程"><span class="nav-number">7.</span> <span class="nav-text">简易数据规划流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL概念"><span class="nav-number">8.</span> <span class="nav-text">SQL概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#约束"><span class="nav-number">8.1.</span> <span class="nav-text">约束</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基本概念"><span class="nav-number">8.2.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据模型"><span class="nav-number">8.3.</span> <span class="nav-text">数据模型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL历史"><span class="nav-number">9.</span> <span class="nav-text">MySQL历史</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MYSQL的特性"><span class="nav-number">9.1.</span> <span class="nav-text">MYSQL的特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装MYSQL"><span class="nav-number">9.2.</span> <span class="nav-text">安装MYSQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MariaDB程序"><span class="nav-number">9.3.</span> <span class="nav-text">MariaDB程序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用户账号"><span class="nav-number">9.4.</span> <span class="nav-text">用户账号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mysql-客户端"><span class="nav-number">9.5.</span> <span class="nav-text">Mysql 客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#常用选项"><span class="nav-number">9.5.1.</span> <span class="nav-text">常用选项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表操作"><span class="nav-number">9.6.</span> <span class="nav-text">表操作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据类型"><span class="nav-number">10.</span> <span class="nav-text">数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#整数型"><span class="nav-number">10.1.</span> <span class="nav-text">整数型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#浮点型"><span class="nav-number">10.2.</span> <span class="nav-text">浮点型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定点数"><span class="nav-number">10.3.</span> <span class="nav-text">定点数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#字符串-char-varchar-text"><span class="nav-number">10.4.</span> <span class="nav-text">字符串(char,varchar,_text)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二进制数据BLOB"><span class="nav-number">10.5.</span> <span class="nav-text">二进制数据BLOB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日期时间类型"><span class="nav-number">10.6.</span> <span class="nav-text">日期时间类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修饰符"><span class="nav-number">10.7.</span> <span class="nav-text">修饰符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DML语句"><span class="nav-number">10.8.</span> <span class="nav-text">DML语句</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#INSERT："><span class="nav-number">10.8.1.</span> <span class="nav-text">INSERT：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UPDATE"><span class="nav-number">10.8.2.</span> <span class="nav-text">UPDATE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DELETE"><span class="nav-number">10.8.3.</span> <span class="nav-text">DELETE</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#DQL语句"><span class="nav-number">11.</span> <span class="nav-text">DQL语句</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SELECT"><span class="nav-number">11.1.</span> <span class="nav-text">SELECT</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#多表查询"><span class="nav-number">12.</span> <span class="nav-text">多表查询</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#视图"><span class="nav-number">13.</span> <span class="nav-text">视图</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#函数"><span class="nav-number">14.</span> <span class="nav-text">函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义函数"><span class="nav-number">14.1.</span> <span class="nav-text">自定义函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#局部变量语法"><span class="nav-number">14.2.</span> <span class="nav-text">局部变量语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#变量赋值语法"><span class="nav-number">14.3.</span> <span class="nav-text">变量赋值语法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#存储过程"><span class="nav-number">15.</span> <span class="nav-text">存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建存储过程"><span class="nav-number">15.1.</span> <span class="nav-text">创建存储过程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#流程控制"><span class="nav-number">16.</span> <span class="nav-text">流程控制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#触发器"><span class="nav-number">17.</span> <span class="nav-text">触发器</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL用户和权限管理"><span class="nav-number">18.</span> <span class="nav-text">MySQL用户和权限管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#用户管理"><span class="nav-number">18.1.</span> <span class="nav-text">用户管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#忘记管理员密码的解决办法："><span class="nav-number">18.2.</span> <span class="nav-text">忘记管理员密码的解决办法：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL权限管理"><span class="nav-number">18.3.</span> <span class="nav-text">MySQL权限管理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#授权"><span class="nav-number">19.</span> <span class="nav-text">授权</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#存储引擎"><span class="nav-number">20.</span> <span class="nav-text">存储引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MyISAM引擎特点："><span class="nav-number">20.1.</span> <span class="nav-text">MyISAM引擎特点：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#InnoDB引擎特点"><span class="nav-number">20.2.</span> <span class="nav-text">InnoDB引擎特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL中的系统数据库"><span class="nav-number">20.3.</span> <span class="nav-text">MySQL中的系统数据库</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#服务器配置"><span class="nav-number">21.</span> <span class="nav-text">服务器配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#服务器系统变量"><span class="nav-number">21.1.</span> <span class="nav-text">服务器系统变量</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查询缓存"><span class="nav-number">22.</span> <span class="nav-text">查询缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#查询缓存相关的服务器变量"><span class="nav-number">22.1.</span> <span class="nav-text">查询缓存相关的服务器变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缓存系统变量"><span class="nav-number">22.2.</span> <span class="nav-text">缓存系统变量</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#聚簇和非聚簇索引"><span class="nav-number">23.</span> <span class="nav-text">聚簇和非聚簇索引</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#索引"><span class="nav-number">24.</span> <span class="nav-text">索引</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#索引类型："><span class="nav-number">24.1.</span> <span class="nav-text">索引类型：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#索引优化建议"><span class="nav-number">24.2.</span> <span class="nav-text">索引优化建议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL语句性能优化"><span class="nav-number">24.3.</span> <span class="nav-text">SQL语句性能优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理索引"><span class="nav-number">24.4.</span> <span class="nav-text">管理索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXPLAIN"><span class="nav-number">24.5.</span> <span class="nav-text">EXPLAIN</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#并发控制"><span class="nav-number">25.</span> <span class="nav-text">并发控制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#事务"><span class="nav-number">26.</span> <span class="nav-text">事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#事务应用"><span class="nav-number">26.1.</span> <span class="nav-text">事务应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务隔离级别"><span class="nav-number">26.2.</span> <span class="nav-text">事务隔离级别</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#指定事务隔离级别"><span class="nav-number">26.2.1.</span> <span class="nav-text">指定事务隔离级别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务日志"><span class="nav-number">26.3.</span> <span class="nav-text">事务日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#事务日志transaction-log"><span class="nav-number">26.3.1.</span> <span class="nav-text">事务日志transaction log</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#innodb-flush-log-at-trx-commit-默认为1"><span class="nav-number">26.3.1.1.</span> <span class="nav-text">innodb_flush_log_at_trx_commit 默认为1</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#错误日志"><span class="nav-number">26.3.2.</span> <span class="nav-text">错误日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通用日志general-log"><span class="nav-number">26.3.3.</span> <span class="nav-text">通用日志general log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#慢查询日志slow-query-log"><span class="nav-number">26.3.4.</span> <span class="nav-text">慢查询日志slow query log</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通过profiling分析sql语句"><span class="nav-number">26.3.4.1.</span> <span class="nav-text">通过profiling分析sql语句</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二进制日志binary-log"><span class="nav-number">26.3.5.</span> <span class="nav-text">二进制日志binary log</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#二进制日志记录格式"><span class="nav-number">26.3.5.1.</span> <span class="nav-text">二进制日志记录格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二进制日志相关的服务器变量："><span class="nav-number">26.3.5.2.</span> <span class="nav-text">二进制日志相关的服务器变量：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二进制日志相关配置"><span class="nav-number">26.3.5.3.</span> <span class="nav-text">二进制日志相关配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mysqlbinlog：二进制日志的客户端命令工具"><span class="nav-number">26.3.5.4.</span> <span class="nav-text">mysqlbinlog：二进制日志的客户端命令工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#管理日志"><span class="nav-number">26.3.5.5.</span> <span class="nav-text">管理日志</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#备份还原"><span class="nav-number">27.</span> <span class="nav-text">备份还原</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#mysqldump工具"><span class="nav-number">27.1.</span> <span class="nav-text">mysqldump工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyISAM备份"><span class="nav-number">27.2.</span> <span class="nav-text">MyISAM备份</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#InnoDB备份"><span class="nav-number">27.3.</span> <span class="nav-text">InnoDB备份</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#生产环境实战备份策略"><span class="nav-number">28.</span> <span class="nav-text">生产环境实战备份策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB建议备份策略"><span class="nav-number">28.0.1.</span> <span class="nav-text">InnoDB建议备份策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MyISAM建议备份策略"><span class="nav-number">28.0.2.</span> <span class="nav-text">MyISAM建议备份策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#恢复数据库示例："><span class="nav-number">28.0.3.</span> <span class="nav-text">恢复数据库示例：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#xtrabackup"><span class="nav-number">29.</span> <span class="nav-text">xtrabackup</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#xtrabackup用法"><span class="nav-number">29.1.</span> <span class="nav-text">xtrabackup用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#备份：innobackupex-option-BACKUP-ROOT-DIR"><span class="nav-number">29.1.1.</span> <span class="nav-text">备份：innobackupex [option] BACKUP-ROOT-DIR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#整理Prepare：innobackupex-–apply-log-option-BACKUP-DIR"><span class="nav-number">29.1.2.</span> <span class="nav-text">整理Prepare：innobackupex –apply-log [option] BACKUP-DIR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#还原：innobackupex-–copy-back-选项-BACKUP-DIR"><span class="nav-number">29.1.3.</span> <span class="nav-text">还原：innobackupex –copy-back [选项] BACKUP-DIR</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#还原注意事项"><span class="nav-number">29.1.3.1.</span> <span class="nav-text">还原注意事项</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#备份生成的相关文件"><span class="nav-number">29.2.</span> <span class="nav-text">备份生成的相关文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#备份还原示例"><span class="nav-number">29.3.</span> <span class="nav-text">备份还原示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#新版xtrabackup完整备份还原"><span class="nav-number">29.3.0.1.</span> <span class="nav-text">新版xtrabackup完整备份还原</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新版xtrabackup完全，增量备份及还原"><span class="nav-number">29.3.0.2.</span> <span class="nav-text">新版xtrabackup完全，增量备份及还原</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#旧版xtrabackup完全，增量备份及还原"><span class="nav-number">29.3.0.3.</span> <span class="nav-text">旧版xtrabackup完全，增量备份及还原</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL复制"><span class="nav-number">30.</span> <span class="nav-text">MySQL复制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL复制-1"><span class="nav-number">31.</span> <span class="nav-text">MySQL复制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#主从复制配置"><span class="nav-number">31.1.</span> <span class="nav-text">主从复制配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主节点"><span class="nav-number">31.1.1.</span> <span class="nav-text">主节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从节点"><span class="nav-number">31.1.2.</span> <span class="nav-text">从节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一主一从示例："><span class="nav-number">31.1.2.1.</span> <span class="nav-text">一主一从示例：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#扩展已有的主节点，到新增的从节点"><span class="nav-number">31.1.2.2.</span> <span class="nav-text">扩展已有的主节点，到新增的从节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#手动提升从节点，切换主从复制"><span class="nav-number">31.1.2.3.</span> <span class="nav-text">手动提升从节点，切换主从复制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启用级联复制节点"><span class="nav-number">31.1.2.4.</span> <span class="nav-text">启用级联复制节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#主从复制中的错误排查"><span class="nav-number">31.1.2.5.</span> <span class="nav-text">主从复制中的错误排查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制架构中应该注意的问题："><span class="nav-number">31.1.3.</span> <span class="nav-text">复制架构中应该注意的问题：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主主复制"><span class="nav-number">31.2.</span> <span class="nav-text">主主复制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#半同步复制"><span class="nav-number">31.3.</span> <span class="nav-text">半同步复制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#复制过滤器"><span class="nav-number">31.4.</span> <span class="nav-text">复制过滤器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL复制加密"><span class="nav-number">32.</span> <span class="nav-text">MySQL复制加密</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#主从同步的监控和维护"><span class="nav-number">32.1.</span> <span class="nav-text">主从同步的监控和维护</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL读写分离"><span class="nav-number">33.</span> <span class="nav-text">MySQL读写分离</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ProxySQL"><span class="nav-number">33.1.</span> <span class="nav-text">ProxySQL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装proxysql服务器"><span class="nav-number">33.1.1.</span> <span class="nav-text">安装proxysql服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置proxysql"><span class="nav-number">33.1.2.</span> <span class="nav-text">配置proxysql</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#添加主从mysql节点"><span class="nav-number">33.1.2.1.</span> <span class="nav-text">添加主从mysql节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置监控账户"><span class="nav-number">33.1.2.2.</span> <span class="nav-text">配置监控账户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看已配置的节点是否正常"><span class="nav-number">33.1.2.3.</span> <span class="nav-text">查看已配置的节点是否正常</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置proxysql分组信息"><span class="nav-number">33.1.2.4.</span> <span class="nav-text">设置proxysql分组信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建在集群中发送SQL语句的用户"><span class="nav-number">33.1.2.5.</span> <span class="nav-text">创建在集群中发送SQL语句的用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置proxysql路由规则，实现读写分离"><span class="nav-number">33.1.2.6.</span> <span class="nav-text">配置proxysql路由规则，实现读写分离</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试读写分离"><span class="nav-number">33.1.3.</span> <span class="nav-text">测试读写分离</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL高可用MHA"><span class="nav-number">34.</span> <span class="nav-text">MySQL高可用MHA</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置MHA"><span class="nav-number">34.1.</span> <span class="nav-text">配置MHA</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装MHA相关软件包"><span class="nav-number">34.1.1.</span> <span class="nav-text">安装MHA相关软件包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改mysql主从节点的配置文件"><span class="nav-number">34.1.2.</span> <span class="nav-text">修改mysql主从节点的配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在主节点创建mha管理用户"><span class="nav-number">34.1.3.</span> <span class="nav-text">在主节点创建mha管理用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现基于key认证的SSH连接"><span class="nav-number">34.1.4.</span> <span class="nav-text">实现基于key认证的SSH连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在MHA管理服务器创建MHA配置文件"><span class="nav-number">34.1.5.</span> <span class="nav-text">在MHA管理服务器创建MHA配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检测配置文件是否正确"><span class="nav-number">34.1.6.</span> <span class="nav-text">检测配置文件是否正确</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动MHA监控程序"><span class="nav-number">34.1.7.</span> <span class="nav-text">启动MHA监控程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试MHA效果"><span class="nav-number">34.1.8.</span> <span class="nav-text">测试MHA效果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Galera-Cluster"><span class="nav-number">35.</span> <span class="nav-text">Galera Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Galera-Cluster特点"><span class="nav-number">35.1.</span> <span class="nav-text">Galera Cluster特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MariaDB-Galera-Cluster"><span class="nav-number">35.2.</span> <span class="nav-text">MariaDB Galera Cluster</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#复制的问题和解决方案"><span class="nav-number">36.</span> <span class="nav-text">复制的问题和解决方案</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#生产环境my-cnf配置示例"><span class="nav-number">37.</span> <span class="nav-text">生产环境my.cnf配置示例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MYSQL配置最佳实践"><span class="nav-number">38.</span> <span class="nav-text">MYSQL配置最佳实践</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nieW</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
