<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="nieW learn">
<meta property="og:url" content="http://blog.nextx.tk/index.html">
<meta property="og:site_name" content="nieW learn">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="nieW learn">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.nextx.tk/"/>





  <title>nieW learn</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">nieW learn</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.nextx.tk/2018/12/10/mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nieW">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nieW learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/10/mysql/" itemprop="url">MariaDB</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-10T22:47:00+08:00">
                2018-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MariaDB"><a href="#MariaDB" class="headerlink" title="MariaDB"></a>MariaDB</h1><hr>
<h1 id="数据库的发展史"><a href="#数据库的发展史" class="headerlink" title="数据库的发展史"></a>数据库的发展史</h1><ul>
<li>萌芽阶段：文件系统<br>使用磁盘文件来存储数据</li>
<li>初级阶段：第一代数据库<br>出现了网状模型、层次模型的数据库</li>
<li>中级阶段：第二代数据库<br>关系型数据库和结构化查询语言</li>
<li>高级阶段：新一代数据库<br>“关系-对象”型数据库</li>
</ul>
<h1 id="数据库系统的架构"><a href="#数据库系统的架构" class="headerlink" title="数据库系统的架构"></a>数据库系统的架构</h1><p>单机架构<br>大型主机/终端架构<br>主从式架构（C/S）<br>分布式架构  </p>
<h1 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h1><ul>
<li>关系 ：关系就是二维表，其中：表中的行、列次序并不重要</li>
<li>行row：表中的每一行，又称为一条记录</li>
<li>列column：表中的每一列，称为属性，字段</li>
<li>主键（Primary key）：用于惟一确定<strong>一个记录</strong>的字段（每张表只有一个主键）</li>
<li>域domain：属性的取值范围，如，性别只能是‘男’和‘女’两个值<blockquote>
<p>一张表只有一个主键，主键可以关联到多个字段（多字段组合必须唯一），称为复合主键</p>
</blockquote>
</li>
</ul>
<h4 id="RDBMS："><a href="#RDBMS：" class="headerlink" title="RDBMS："></a>RDBMS：</h4><p>MySQL: MySQL, MariaDB, Percona Server<br>PostgreSQL: 简称为pgsql，EnterpriseDB<br>Oracle<br>MSSQL<br>DB2  </p>
<blockquote>
<p>数据库排名：<br><a href="https://db-engines.com/en/ranking" target="_blank" rel="noopener">https://db-engines.com/en/ranking</a></p>
</blockquote>
<h1 id="实体-联系模型E-R"><a href="#实体-联系模型E-R" class="headerlink" title="实体-联系模型E-R"></a>实体-联系模型E-R</h1><ul>
<li>实体Entity：客观存在并可以相互区分的客观事物或抽象事件称为实体<br>• 在E-R图中用矩形框表示实体，把实体名写在框内   </li>
<li>属性：实体所具有的特征或性质  </li>
<li>联系：联系是数据之间的关联集合，是客观存在的应用语义链<br>• 实体内部的联系：指组成实体的各属性之间的联系。如职工实体中，职工号和部门经理号之间有一种关联关系<br>• 实体之间的联系：指不同实体之间联系。例：学生选课实体和学生基本信息实体之间<br>• 实体之间的联系用菱形框表示  </li>
</ul>
<h1 id="联系类型"><a href="#联系类型" class="headerlink" title="联系类型"></a>联系类型</h1><ul>
<li>联系的类型<br>一对一联系(1:1)<br>一对多联系(1:n)  #外键依赖主键表的主键<br>多对多联系(m:n)  #构建一张表整合前面所有表的关键字段</li>
<li>数据的操作：<br>数据提取：在数据集合中提取感兴趣的内容。SELECT<br>数据更新：变更数据库中的数据。INSERT、DELETE、UPDATE  </li>
<li>数据的约束条件 ：是一组完整性规则的集合<br>实体（行）完整性 Entity integrity  #每条记录都唯一 增加主键<br>域（列）完整性 Domain Integrity  #限定字段属性<br>参考完整性 Referential Integrity  #各个表关系  主外键  </li>
</ul>
<h1 id="简易数据规划流程"><a href="#简易数据规划流程" class="headerlink" title="简易数据规划流程"></a>简易数据规划流程</h1><ul>
<li>第一阶段：收集数据，得到字段<br>• 收集必要且完整的数据项<br>• 转换成数据表的字段  </li>
<li>第二阶段：把字段分类，归入表，建立表的关联<br>• 关联：表和表间的关系<br>• 分割数据表并建立关联的优点<br>• 节省空间<br>• 减少输入错误<br>• 方便数据修改  </li>
<li>第三阶段：<br>• 规范化数据库  #减少冗余</li>
</ul>
<h1 id="SQL概念"><a href="#SQL概念" class="headerlink" title="SQL概念"></a>SQL概念</h1><ul>
<li>SQL: Structure Query Language<br>结构化查询语言<br>SQL解释器：<br>数据存储协议：应用层协议，C/S  </li>
<li>S：server, 监听于socket套接字，接收并处理客户端的应用请求  </li>
<li>C：Client<br>客户端程序接口<br>CLI<br>GUI<br>应用编程接口<br>ODBC：Open Database Connectivity<br>JDBC：Java Data Base Connectivity  </li>
</ul>
<h2 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h2><p>约束：constraint，表中的数据要遵守的限制  </p>
<ul>
<li>主键(primary key)：一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行；<strong>必须提供数据，即NOT NULL</strong>，<strong>一个表只能有一个</strong></li>
<li>惟一键(uniq key)：一个或多个字段的组合，<strong>填入的数据必须能在本表中唯一标识本行</strong>；<strong>允许为NULL，</strong>一个表可以存在多个<em>**</em>  </li>
<li>外键(foreign key)：一个表中的某字段可填入的数据取决于另一个表的主键或唯一键已有的数据</li>
<li>检查：字段值在一定范围内</li>
</ul>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><ul>
<li>索引：将表中的一个或多个字段中的数据复制一份另存，并且按特定次序排序存储</li>
<li>关系运算：<br>选择：挑选出符合条件的行<br>投影：挑选出需要的字段<br>连接：表间字段的关联  <blockquote>
<p>适用于大量数据，按某种规定排列</p>
</blockquote>
</li>
</ul>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h2><ul>
<li>数据抽象：<br>物理层：数据存储格式，即RDBMS在磁盘上如何组织文件<br>逻辑层：DBA角度，描述存储什么数据，以及数据间存在什么样的关系<br>视图层：用户角度，描述DB中的部分数据  </li>
<li>关系模型的分类：<br>关系模型<br>基于对象的关系模型<br>半结构化的关系模型：XML数据（扩展的标记语言）  </li>
</ul>
<h1 id="MySQL历史"><a href="#MySQL历史" class="headerlink" title="MySQL历史"></a>MySQL历史</h1><p>1979年：TcX公司 Monty Widenius，Unireg<br>1996年：发布MySQL1.0，Solaris版本，Linux版本<br>1999年：MySQL AB公司，瑞典<br>2003年：MySQL 5.0版本，提供视图、存储过程等功能<br>2008年：Sun 收购<br>2009年：Oracle收购sun<br>2009年：Monty成立MariaDB  </p>
<h2 id="MYSQL的特性"><a href="#MYSQL的特性" class="headerlink" title="MYSQL的特性"></a>MYSQL的特性</h2><ul>
<li><strong>插件式存储引擎</strong>：也称为“表类型”，存储管理器有多种实现版本，功能和特性可能均略有差别；用户可根据需要灵活选择,Mysql5.5.5开始innoDB引擎是MYSQL默认引擎<br>MyISAM ==&gt; Aria<br>InnoDB ==&gt; XtraDB  </li>
<li>单进程，多线程</li>
<li>诸多扩展和新特性</li>
<li>提供了较多测试组件</li>
<li>开源</li>
</ul>
<p>官方文档<br><a href="https://dev.mysql.com/doc/" target="_blank" rel="noopener">https://dev.mysql.com/doc/</a><br><a href="https://mariadb.com/kb/en/" target="_blank" rel="noopener">https://mariadb.com/kb/en/</a><br><a href="https://www.percona.com/software/mysql-database/percona-server" target="_blank" rel="noopener">https://www.percona.com/software/mysql-database/percona-server</a> </p>
<h2 id="安装MYSQL"><a href="#安装MYSQL" class="headerlink" title="安装MYSQL"></a>安装MYSQL</h2><p>Mariadb安装方式：</p>
<ol>
<li>源代码：编译安装  </li>
<li>二进制格式的程序包：展开至特定路径，并经过简单配置后即可使用  </li>
<li>程序包管理器管理的程序包<br>CentOS 安装光盘<br>项目官方：<a href="https://downloads.mariadb.org/mariadb/repositories/" target="_blank" rel="noopener">https://downloads.mariadb.org/mariadb/repositories/</a><br>国内镜像：<a href="https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadbx.y.z/yum/centos/7/x86_64/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadbx.y.z/yum/centos/7/x86_64/</a>  </li>
</ol>
<blockquote>
<p>提高安全性:<br>m<strong>ysql_secure_installation</strong>（运行此脚本提高安全性）<br>设置数据库管理员root口令<br>禁止root远程登录<br>删除anonymous用户帐号<br>删除test数据库  </p>
</blockquote>
<h2 id="MariaDB程序"><a href="#MariaDB程序" class="headerlink" title="MariaDB程序"></a>MariaDB程序</h2><ul>
<li>客户端程序：<br><strong>mysql</strong>: 交互式的CLI工具<br><strong>mysqldump</strong>：备份工具，基于mysql协议向mysqld发起查询请求，并将查得的所有数据转换成insert等写操作语句保存文本文件中<br><strong>mysqladmin</strong>：基于mysql协议管理mysqld<br>mysqlimport：数据导入工具  </li>
<li>MyISAM存储引擎的管理工具：<br>myisamchk：检查MyISAM库<br>myisampack：打包MyISAM表，只读  </li>
<li>服务器端程序<br>mysqld_safe<br>mysqld<br>mysqld_multi 多实例 ，示例：mysqld_multi –example  #配合不同端口号</li>
</ul>
<h2 id="用户账号"><a href="#用户账号" class="headerlink" title="用户账号"></a>用户账号</h2><p>mysql用户账号由两部分组成：<br>‘USERNAME‘@’HOST’<br>说明：<br>HOST限制此用户可通过哪些远程主机连接mysql服务器<br>支持使用通配符：<br>% 匹配任意长度的任意字符<br>172.16.0.0/255.255.0.0 或 172.16.%.%<br>_ 匹配任意单个字符  </p>
<h2 id="Mysql-客户端"><a href="#Mysql-客户端" class="headerlink" title="Mysql 客户端"></a>Mysql 客户端</h2><ul>
<li>mysql使用模式：<br>交互式模式：<br>可运行命令有两类：<br>客户端命令：<br>\h, help<br>\u，use<br>\s，status<br>\!，system</li>
<li>服务器端命令：<br>SQL语句， <strong>需要语句结束符</strong>;  </li>
<li>脚本模式： #使用脚本文件重定向到mysql命令中执行<br>mysql –uUSERNAME -pPASSWORD &lt; /path/somefile.sql<br>mysql&gt; source /path/from/somefile.sql<br>mysql -e ‘show database’ #单独执行一次命令</li>
</ul>
<h3 id="常用选项"><a href="#常用选项" class="headerlink" title="常用选项"></a>常用选项</h3><p>mysql客户端可用选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-A, –no-auto-rehash</td>
<td>禁止补全</td>
</tr>
<tr>
<td>-u, –user=</td>
<td>用户名,默认为root</td>
</tr>
<tr>
<td>-h, –host=</td>
<td>服务器主机,默认为localhost</td>
</tr>
<tr>
<td>-p, –passowrd=</td>
<td>用户密码,建议使用-p,默认为空密码</td>
</tr>
<tr>
<td>-P, –port=</td>
<td>服务器端口</td>
</tr>
<tr>
<td>-S, –socket=</td>
<td>指定连接socket文件路径</td>
</tr>
<tr>
<td>-D, –database=</td>
<td>指定默认数据库</td>
</tr>
<tr>
<td>-C, –compress</td>
<td>启用压缩</td>
</tr>
<tr>
<td>-e “SQL”</td>
<td>执行SQL命令</td>
</tr>
<tr>
<td>-V, –version</td>
<td>显示详细信息</td>
</tr>
<tr>
<td>–print-defaults</td>
<td>获取程序默认使用的配置</td>
</tr>
</tbody>
</table>
<blockquote>
<p>mysql5.5之后的版本开始使用innodb作为默认引擎   </p>
</blockquote>
<p>可以考虑修改配置文件修改mysql提示符以区分生成和测试环境，避免出现误操作<br>centos6:/etc/my.cnf<br>centos7:/etc/my.cnf.d/mysql-clients.cnf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line">[mysql]   </span><br><span class="line">prompt=\u@[\D]test--&gt;  </span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">select user(); #显示当前用户  </span><br><span class="line">select version(); #显示当前版本  </span><br><span class="line">带括号的字符是mysql的函数字符  </span><br><span class="line"></span><br><span class="line">mysql 主机+用户名可以控制登录用户  </span><br><span class="line"></span><br><span class="line">## socket地址</span><br><span class="line">服务器监听的两种socket地址：  </span><br><span class="line">ip socket: 监听在tcp的3306端口，支持远程通信  </span><br><span class="line">unix sock: 监听在sock文件上，仅支持本机通信  </span><br><span class="line">如：/var/lib/mysql/mysql.sock)</span><br><span class="line">说明：host为localhost,127.0.0.1时自动使用unix sock</span><br><span class="line"></span><br><span class="line">## 执行命令</span><br><span class="line">运行mysql命令：默认空密码登录</span><br><span class="line">mysql&gt;use mysql</span><br><span class="line">mysql&gt;select user();查看当前用户</span><br><span class="line">mysql&gt;SELECT User,Host,Password FROM user;</span><br><span class="line">登录系统：mysql –uroot –p</span><br><span class="line">客户端命令：本地执行</span><br><span class="line">mysql&gt; help</span><br><span class="line">每个命令都完整形式和简写格式</span><br><span class="line">mysql&gt; status 或 \s</span><br><span class="line">服务端命令：通过mysql协议发往服务器执行并取回结果</span><br><span class="line">每个命令末尾都必须使用命令结束符号，默认为分号</span><br><span class="line">示例：SELECT VERSION();</span><br><span class="line"></span><br><span class="line">## 服务器端配置</span><br><span class="line">服务器端(mysqld)：工作特性有多种配置方式  </span><br><span class="line">1、命令行选项：  </span><br><span class="line">2、配置文件：类ini格式  </span><br><span class="line">集中式的配置，能够为mysql的各应用程序提供配置信息  </span><br><span class="line">[mysqld]  #mysql命令的选项  </span><br><span class="line">[mysqld_safe]    </span><br><span class="line">[mysqld_multi]  </span><br><span class="line">[mysql]  </span><br><span class="line">[mysqldump]  #备份选项  </span><br><span class="line">[server]  #服务端选项  </span><br><span class="line">[client]  #客户端选项  </span><br><span class="line">格式：parameter = value  </span><br><span class="line">说明：_和- 相同  </span><br><span class="line">1，ON，TRUE意义相同， 0，OFF，FALSE意义相同  </span><br><span class="line"></span><br><span class="line">## 配置文件</span><br><span class="line">配置文件：  </span><br><span class="line">**后面覆盖前面**的配置文件，顺序如下：#指定路径优先级高于配置文件  </span><br><span class="line">/etc/my.cnf Global选项  </span><br><span class="line">/etc/mysql/my.cnf Global选项  </span><br><span class="line">SYSCONFDIR/my.cnf Global选项  </span><br><span class="line">$MYSQL_HOME/my.cnf Server-specific 选项  </span><br><span class="line">--defaults-extra-file=path   </span><br><span class="line">~/.my.cnf User-specific 选项   </span><br><span class="line"></span><br><span class="line">## MairaDB配置</span><br><span class="line">侦听3306/tcp端口可以在绑定有一个或全部接口IP上  </span><br><span class="line">vim /etc/my.cnf   </span><br><span class="line">[mysqld]  </span><br><span class="line">skip-networking=1  #禁用网络连接，可在维护时添加      </span><br><span class="line">关闭网络连接，只侦听本地客户端，所有和服务器的交互都通过一个socket实现，socket的配置存放在/var/lib/mysql/mysql.sock）可在/etc/my.cnf修改</span><br><span class="line"></span><br><span class="line"># 通用二进制格式安装过程</span><br><span class="line">二进制格式安装过程  </span><br><span class="line">1. 准备用户  </span><br><span class="line">groupadd -r -g 306 mysql  </span><br><span class="line">useradd -r -g 306 -u 306 –d /data/mysql mysql  </span><br><span class="line">1. 准备数据目录，建议使用**逻辑卷**  </span><br><span class="line">mkdir /data/mysql  </span><br><span class="line">chown mysql:mysql /data/mysql  </span><br><span class="line">1. 准备二进制程序  </span><br><span class="line">tar xf mariadb-VERSION-linux-x86_64.tar.gz -C /usr/local  </span><br><span class="line">cd /usr/local  </span><br><span class="line">ln -sv mariadb-VERSION mysql  </span><br><span class="line">chown -R root:mysql /usr/local/mysql/   </span><br><span class="line">1. 准备配置文件  </span><br><span class="line">mkdir /etc/mysql/  </span><br><span class="line">cp support-files/my-large.cnf /etc/mysql/my.cnf  </span><br><span class="line">[mysqld]中添加三个选项：  </span><br><span class="line">datadir = /data/mysql  </span><br><span class="line">**innodb_file_per_table** = on  #新版本可不加，已默认启用  </span><br><span class="line">**skip_name_resolve** = on 禁止主机名解析，建议使用  </span><br><span class="line">1. 创建数据库文件  </span><br><span class="line">cd /usr/local/mysql/  </span><br><span class="line">./scripts/mysql_install_db --datadir=/data/mysql --user=mysql --basedir=/usr/local/nysql</span><br><span class="line">1. 准备服务脚本，并启动服务  </span><br><span class="line"> cp ./support-files/mysql.server /etc/rc.d/init.d/mysqld  </span><br><span class="line"> chkconfig --add mysqld  </span><br><span class="line"> service mysqld start  </span><br><span class="line">1. PATH路径  </span><br><span class="line">echo &apos;PATH=/user/local/mysql/bin:$PATH&apos; &gt; **/etc/profile.d**/mysql  </span><br><span class="line">1. 安全初始化  </span><br><span class="line">/user/local/mysql/bin/mysql_secure_installation   </span><br><span class="line"></span><br><span class="line"># 源码编译安装mariadb</span><br><span class="line">1. 安装包  </span><br><span class="line">`yum install bison bison-devel zlib-devel libcurl-devel libarchive-devel boostdevel gcc gcc-c++ cmake ncurses-devel gnutls-devel libxml2-devel openssldevel libevent-devel libaio-devel`</span><br><span class="line">2. 做准备用户和数据目录  </span><br><span class="line">`useradd –r –s /sbin/nologin –d /data/mysql/ mysql`  </span><br><span class="line">`mkdir /data/mysql`  </span><br><span class="line">`chown mysql.mysql /data/mysql`  </span><br><span class="line">`tar xvf mariadb-10.2.18.tar.gz`  </span><br><span class="line">3. cmake 编译安装  </span><br><span class="line">cmake的重要特性之一是其独立于源码(out-of-source)的编译功能，即编译工作可以在</span><br><span class="line">另一个指定的目录中而非源码目录中进行，这可以保证源码目录不受任何一次编译的影</span><br><span class="line">响，因此在同一个源码树上可以进行多次不同的编译，如针对于不同平台编译  </span><br><span class="line">编译选项:https://dev.mysql.com/doc/refman/5.7/en/source-configuration-options.html</span><br><span class="line">- cd mariadb-10.2.18/  </span><br><span class="line">cmake . \\  #\\长命令换行  </span><br><span class="line">-DCMAKE_INSTALL_PREFIX=/app/mysql \\  </span><br><span class="line">-DMYSQL_DATADIR=/data/mysql/ \\  </span><br><span class="line">-DSYSCONFDIR=/etc \\  </span><br><span class="line">-DMYSQL_USER=mysql \\  </span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \\  </span><br><span class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=1 \\  </span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \\  </span><br><span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \\  </span><br><span class="line">-DWITHOUT_MROONGA_STORAGE_ENGINE=1 \\  </span><br><span class="line">-DWITH_DEBUG=0 \\  </span><br><span class="line">-DWITH_READLINE=1 \\  </span><br><span class="line">-DWITH_SSL=system \\  </span><br><span class="line">-DWITH_ZLIB=system \\  </span><br><span class="line">-DWITH_LIBWRAP=0 \\  </span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \\  </span><br><span class="line">-DMYSQL_UNIX_ADDR=/data/mysql/mysql.sock \\  </span><br><span class="line">-DDEFAULT_CHARSET=utf8 \\  </span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">&gt; 提示：如果出错，执行rm -f CMakeCache.txt</span><br><span class="line">4. 准备环境变量  </span><br><span class="line">`echo &apos;PATH=/app/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh`  </span><br><span class="line">`. /etc/profile.d/mysql.sh`  </span><br><span class="line">5. 生成数据库文件  </span><br><span class="line">`cd /app/mysql/`  </span><br><span class="line">`scripts/mysql_install_db --datadir=/data/mysql/ --user=mysql`  </span><br><span class="line">6. 准备配置文件  </span><br><span class="line">`cp /app/mysql/support-files/my-huge.cnf /etc/my.cnf`  </span><br><span class="line">7. 准备启动脚本  </span><br><span class="line">`cp /app/mysql/support-files/mysql.server /etc/init.d/mysqld`  </span><br><span class="line">8. 启动服务  </span><br><span class="line">`chkconfig --add mysqld ;service mysqld start`  </span><br><span class="line"></span><br><span class="line"># 关系型数据库的常见组件</span><br><span class="line">- **数据库**：database</span><br><span class="line">- **表**：table   </span><br><span class="line">行：row  </span><br><span class="line">列：column</span><br><span class="line">- **索引**：index</span><br><span class="line">- **视图**：view</span><br><span class="line">- 用户：user</span><br><span class="line">- 权限：privilege</span><br><span class="line">- 存储过程：procedure</span><br><span class="line">- 存储函数：function</span><br><span class="line">- 触发器：trigger</span><br><span class="line">- 事件调度器：event scheduler，任务计划</span><br><span class="line"></span><br><span class="line"># SQL语言规范</span><br><span class="line">- 在数据库系统中，SQL语句不区分大小写(建议用大写)  </span><br><span class="line">- **SQL语句可单行或多行书写**，以“;”结尾  </span><br><span class="line">- 关键词不能跨多行或简写  </span><br><span class="line">- 用空格和缩进来提高语句的可读性  </span><br><span class="line">- 子句通常位于独立行，便于编辑，提高可读性  </span><br><span class="line">- 注释：  </span><br><span class="line">SQL标准：  </span><br><span class="line">\/*注释内容\*/  #多行注释  </span><br><span class="line">-- 注释内容  #单行注释，注意有空格  </span><br><span class="line">MySQL注释：\#  </span><br><span class="line"></span><br><span class="line"># 数据库对象</span><br><span class="line">- 数据库的组件(对象)：  </span><br><span class="line">数据库、表、索引、视图、用户、存储过程、函数、触发器、事件调度器等</span><br><span class="line">- 命名规则：  </span><br><span class="line">**必须以字母开头**  </span><br><span class="line">可包括数字和三个特殊字符（# _ $）  </span><br><span class="line">不要使用MySQL的保留字  </span><br><span class="line">同一database(Schema)下的对象不能同名  </span><br><span class="line"></span><br><span class="line"># SQL语句分类</span><br><span class="line">- DDL: Data Defination Language 数据定义语言  </span><br><span class="line">CREATE，**DROP**，ALTER  </span><br><span class="line">- DML: Data Manipulation Language 数据操纵语言  </span><br><span class="line">**INSERT**，**DELETE**，**UPDATE**  </span><br><span class="line">- DCL：Data Control Language 数据控制语言  </span><br><span class="line">GRANT，REVOKE，COMMIT，ROLLBACK  </span><br><span class="line">- DQL：Data Query Language 数据查询语言  </span><br><span class="line">**SELECT**</span><br><span class="line"></span><br><span class="line"># SQL语句构成</span><br><span class="line">Keyword组成clause  </span><br><span class="line">多条clause组成语句  </span><br><span class="line"></span><br><span class="line">示例：  </span><br><span class="line">SELECT *  #SELECT子句  </span><br><span class="line">FROM products #FROM子句  </span><br><span class="line">WHERE price&gt;400 #WHERE子句  </span><br><span class="line">说明：一组SQL语句，由三个子句构成，SELECT,FROM和WHERE是关键字  </span><br><span class="line"></span><br><span class="line"># 数据库操作</span><br><span class="line">- 创建数据库：  </span><br><span class="line">CREATE DATABASE|SCHEMA [IF NOT EXISTS] &apos;DB_NAME&apos;;  </span><br><span class="line">CHARACTER SET &apos;character set name&apos;  #设置默认字符集   </span><br><span class="line">例如：</span><br><span class="line">`create database db_utf8mb4 CHARACTER SET=utf8mb4;`  </span><br><span class="line">COLLATE &apos;collate name&apos;  #字符排序 </span><br><span class="line">- 删除数据库  </span><br><span class="line">DROP DATABASE|SCHEMA [IF EXISTS] &apos;DB_NAME&apos;;  </span><br><span class="line">例如:`drop database testdb;`</span><br><span class="line">- 查看支持所有字符集：SHOW CHARACTER SET;  </span><br><span class="line">- 查看支持所有排序规则：SHOW COLLATION; </span><br><span class="line">- 查看数据库创建的默认选项   </span><br><span class="line">show create database testdb;</span><br><span class="line">- 获取命令使用帮助：  </span><br><span class="line">mysql&gt; HELP KEYWORD;  </span><br><span class="line">- 查看数据库列表：  </span><br><span class="line">mysql&gt; SHOW DATABASES;</span><br></pre></td></tr></table></figure></p>
<p>创建数据库后建议修改配置文件：</p>
<p>1、建议创建数据时就定义好字符集：<br>vim /etc/my.cnf.d/server.cnf<br>[mysqld]<br>character-set-server=utf8mb4<br>客户端<br>vim /etc/my.cnf.d/mysql-clients.cnf<br>[mysql]<br>default-character-set=utf8mb4<br>重启服务<br>systemctl restart mariadb</p>
<p>2、将低版本的mysql数据分开存放<br>vim /etc/my.cnf.d/server.cnf<br>[mysqld]<br>innodb_file_per_table=ON<br>systemctl restart mariadb</p>
<p>3、安全的删除和更新数据<br>修改客户端配置文件<br>vim /etc/my.cnf.d/mysql-clients.cnf<br>[mysql]<br>safe-updates<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 数据表</span><br><span class="line">表：二维关系  </span><br><span class="line">设计表：遵循规范  </span><br><span class="line">定义：字段，索引  </span><br><span class="line">字段：字段名，字段数据类型，修饰符  </span><br><span class="line">约束，索引：应该创建在经常用作查询条件的字段上  </span><br><span class="line"></span><br><span class="line">## 创建表</span><br><span class="line">创建表：CREATE TABLE</span><br><span class="line">1. 直接创建</span><br><span class="line">1. 通过查询现存表创建；新表会被直接插入查询而来的数据   </span><br><span class="line">CREATE TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">[(create_definition,...)] [table_options]</span><br><span class="line">[partition_options] select_statement  </span><br><span class="line">`create table custom select * from student;`</span><br><span class="line">1. 通过复制现存的表的表结构创建，但不复制数据  </span><br><span class="line">CREATE TABLE [IF NOT EXISTS] tbl_name &#123; LIKE</span><br><span class="line">old_tbl_name | (LIKE old_tbl_name) &#125;   </span><br><span class="line">`create table custom like student;`</span><br><span class="line"></span><br><span class="line">&gt; 注意：</span><br><span class="line">Storage Engine是指表类型，也即在表创建时指明其使用的存储引擎，同一库中不同表可以使用不同的存储引擎</span><br><span class="line">同一个库中表建议要使用同一种存储引擎类型</span><br></pre></td></tr></table></figure></p>
<p>CREATE TABLE [IF NOT EXISTS] ‘tbl_name’ (col1 type1 修饰符, col2<br>type2 修饰符, …)  #col列名称<br>字段信息<br>• col type1<br>• PRIMARY KEY(col1,…) #主键<br>• INDEX(col1, …)<br>• UNIQUE KEY(col1, …)<br>表选项：<br>• ENGINE [=] engine_name  #存储引擎定义<br>SHOW ENGINES;查看支持的engine类型<br>• ROW_FORMAT [=]          #是否压缩存储<br>{DEFAULT|DYNAMIC|FIXED|COMPRESSED|REDUNDANT|COMPACT}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">创建表示例：</span><br><span class="line">CREATE TABLE students (id int UNSIGNED NOT NULL PRIMARY KEY,name VARCHAR（20）NOT NULL,age tinyint UNSIGNED);</span><br><span class="line">DESC students;  #查看表</span><br><span class="line"></span><br><span class="line">CREATE TABLE students2 (id int UNSIGNED NOT NULL ,name VARCHAR(20) NOT NULL,age tinyint UNSIGNED,PRIMARY KEY(id,name));</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>获取帮助：mysql&gt; HELP CREATE TABLE; </p>
</blockquote>
<h2 id="表操作"><a href="#表操作" class="headerlink" title="表操作"></a>表操作</h2><p>查看所有的引擎：<br><code>SHOW ENGINES</code><br><strong>查看表</strong>：<br><code>SHOW TABLES [FROM db_name]</code><br><strong>查看表结构</strong>：<br><code>DESC [db_name.]tb_name</code><br><code>SHOW COLUMNS FROM [db_name.]tb_name</code><br>删除表：<br><code>DROP TABLE [IF EXISTS] tb_name</code><br>查看表创建命令：<br><code>SHOW CREATE TABLE tbl_name</code><br><strong>查看表状态</strong>：<br><code>SHOW TABLE STATUS LIKE &#39;tbl_name&#39;</code><br>查看库中所有表状态：<br><code>SHOW TABLE STATUS FROM db_name</code><br>修改表<br><code>ALTER TABLE &#39;tbl_name&#39;</code><br>字段：<br>添加字段：add<br>ADD col1 data_type [FIRST|AFTER col_name]<br>删除字段：drop<br>修改字段：<br>alter（默认值）, change（字段名）,modify（字段属性）<br><code>alter table student CHARACTER SET=utf8mb4;</code><br>索引:<br>添加索引：add index<br>删除索引：drop index<br>查看表上的索引：SHOW INDEXES FROM    [db_name.]tbl_name;</p>
<blockquote>
<p>查看帮助：Help ALTER TABLE<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">ALTER TABLE students RENAME s1;</span><br><span class="line">ALTER TABLE s1 ADD phone varchar(11) AFTER name;</span><br><span class="line">ALTER TABLE s1 MODIFY phone int;</span><br><span class="line">ALTER TABLE s1 CHANGE COLUMN phone mobile char(11);</span><br><span class="line">ALTER TABLE s1 DROP COLUMN mobile;</span><br><span class="line">ALTER TABLE students ADD gender ENUM(&apos;m&apos;,&apos;f&apos;)</span><br><span class="line">ALETR TABLE students CHANGE id sid int UNSIGNED NOT NULL PRIMARY KEY;</span><br><span class="line">ALTER TABLE students ADD UNIQUE KEY(name);</span><br><span class="line">ALTER TABLE students ADD INDEX(age);</span><br><span class="line">DESC students;</span><br><span class="line">SHOW INDEXES FROM students;</span><br><span class="line">ALTER TABLE students DROP age;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><ul>
<li>数据类型：<br>数据长什么样<br>数据需要多少空间来存放</li>
<li>系统内置数据类型和用户定义数据类型</li>
<li>MySql支持多种列类型：</li>
</ul>
<ol>
<li>数值类型</li>
<li>日期/时间类型</li>
<li>字符串(字符)类型<blockquote>
<p><a href="https://dev.mysql.com/doc/refman/5.5/en/data-types.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.5/en/data-types.html</a></p>
</blockquote>
</li>
</ol>
<p><strong>选择正确的数据类型对于获得高性能至关重要</strong>，三大原则：</p>
<ol>
<li>更小的通常更好，尽量使用可正确存储数据的最小数据类型</li>
<li>简单就好，简单数据类型的操作通常需要更少的CPU周期</li>
<li>尽量避免NULL，包含为NULL的列，对MySQL更难优化<br><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1543505120590&amp;di=f9e6320ab071fa2f524d22cbbf4702bb&amp;imgtype=jpg&amp;src=http%3A%2F%2Fimg4.imgtn.bdimg.com%2Fit%2Fu%3D3220053439%2C312874450%26fm%3D214%26gp%3D0.jpg" alt="int"></li>
</ol>
<h2 id="整数型"><a href="#整数型" class="headerlink" title="整数型"></a>整数型</h2><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>tinyint(m)</td>
<td>1个字节 范围(-128~127)</td>
</tr>
<tr>
<td>smallint(m)</td>
<td>2个字节 范围(-32768~32767)</td>
</tr>
<tr>
<td>mediumint(m)</td>
<td>3个字节 范围(-8388608~8388607)</td>
</tr>
<tr>
<td>int(m)</td>
<td>4个字节 范围(-2147483648~2147483647)</td>
</tr>
<tr>
<td>bigint(m)</td>
<td>8个字节 范围(+-9.22*10的18次方)</td>
</tr>
<tr>
<td>BOOL，BOOLEAN</td>
<td>布尔型，是TINYINT(1)的同义词。zero值被视为假，非zero值视为真</td>
</tr>
</tbody>
</table>
<blockquote>
<p>1、加了unsigned，则最大值翻倍，如：tinyint unsigned的取值范围为(0~255)<br>2、int(m)里的m是表示SELECT查询结果集中的显示宽度，并不影响实际的取值范围，规定了MySQL的一些交互工具（例如MySQL命令行客户端）用来显示字符的个数。对于存储和计算来说，Int(1)和Int(20)是相同的</p>
</blockquote>
<h2 id="浮点型"><a href="#浮点型" class="headerlink" title="浮点型"></a>浮点型</h2><p>float(m,d) 单精度浮点型 8位精度(4字节) m总个数，d小数位<br>double(m,d) 双精度浮点型16位精度(8字节) m总个数，d小数位<br>设一个字段定义为float(6,3)，如果插入一个数123.45678,实际数据库里存的是123.457，但总个数还以实际为准，即6位</p>
<h2 id="定点数"><a href="#定点数" class="headerlink" title="定点数"></a>定点数</h2><ul>
<li>在数据库中存放的是精确值,存为十进制</li>
<li>decimal(m,d) 参数m&lt;65 是总个数，d&lt;30且 d&lt;m 是小数位</li>
<li>MySQL5.0和更高版本将数字打包保存到一个二进制字符串中（每4个字节存9个数字）。例如，decimal(18,9)小数点两边将各存储9个数字，一共使用9个字节：小数点前的数字用4个字节，小数点后的数字用4个字节，小数点本身占1个字节</li>
<li>浮点类型在存储同样范围的值时，通常比decimal使用更少的空间。float使用4个字节存储。double占用8个字节</li>
<li>因为需要额外的空间和计算开销，所以应该尽量只在对小数进行精确计算时才使用decimal——例如存储财务数据。但在数据量比较大的时候，可以考虑使用bigint代替decimal</li>
</ul>
<h2 id="字符串-char-varchar-text"><a href="#字符串-char-varchar-text" class="headerlink" title="字符串(char,varchar,_text)"></a>字符串(char,varchar,_text)</h2><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>char(n)</td>
<td>固定长度，最多255个字符</td>
</tr>
<tr>
<td>varchar(n)</td>
<td>可变长度，最多65535个字符</td>
</tr>
<tr>
<td>tinytext</td>
<td>可变长度，最多255个字符</td>
</tr>
<tr>
<td>text</td>
<td>可变长度，最多65535个字符</td>
</tr>
<tr>
<td>mediumtext</td>
<td>可变长度，最多2的24次方-1个字符</td>
</tr>
<tr>
<td>longtext</td>
<td>可变长度，最多2的32次方-1个字符</td>
</tr>
<tr>
<td>BINARY(M)</td>
<td>固定长度，可存二进制或字符，长度为0-M字节</td>
</tr>
<tr>
<td>VARBINARY(M)</td>
<td>可变长度，可存二进制或字符，允许长度为0-M字节</td>
</tr>
<tr>
<td>内建类型</td>
<td>ENUM枚举, SET集合</td>
</tr>
</tbody>
</table>
<p>char和varchar：  </p>
<ol>
<li>char(n) 若存入字符数小于n，则以空格补于其后，查询之时再将空格去掉，<br>所以char类型存储的字符串末尾不能有空格，varchar不限于此</li>
<li>char(n) 固定长度，char(4)不管是存入几个字符，都将占用4个字节，varchar<br>是存入的实际字符数+1个字节（n&lt; n&gt;255)，所以varchar(4),存入3个字符将<br>占用4个字节</li>
<li>char类型的字符串检索速度要比varchar类型的快</li>
</ol>
<p>varchar和text：</p>
<ol>
<li>varchar可指定n，text不能指定，内部存储varchar是存入的实际字符数+1个<br>字节（n&lt; n&gt;255)，text是实际字符数+2个字节。</li>
<li>text类型不能有默认值</li>
<li>varchar可直接创建索引，text创建索引要指定前多少个字符。varchar查询速<br>度快于text</li>
</ol>
<h2 id="二进制数据BLOB"><a href="#二进制数据BLOB" class="headerlink" title="二进制数据BLOB"></a>二进制数据BLOB</h2><p>BLOB和text存储方式不同，TEXT以文本方式存储，英文存储区分大小写，而Blob是以二进制方式存储，不分大小写<br>BLOB存储的数据只能整体读出<br>TEXT可以指定字符集，BLOB不用指定字符集  </p>
<h2 id="日期时间类型"><a href="#日期时间类型" class="headerlink" title="日期时间类型"></a>日期时间类型</h2><p>date 日期 ‘2008-12-2’<br>time 时间 ‘12:25:36’<br>datetime 日期时间 ‘2008-12-2 22:06:44’<br>timestamp 自动存储记录修改时间<br>YEAR(2), YEAR(4)：年份  </p>
<blockquote>
<p>timestamp字段里的时间数据会随其他字段修改的时候自动刷新，这个数据类型的字段可以存放这条记录最后被修改的时间</p>
</blockquote>
<h2 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h2><p>所有类型：<br>• NULL 数据列可包含NULL值<br>• NOT NULL 数据列不允许包含NULL值<br>• DEFAULT 默认值<br>• PRIMARY KEY 主键<br>• UNIQUE KEY 唯一键<br>• CHARACTER SET name 指定一个字符集<br>数值型<br>• AUTO_INCREMENT 自动递增，适用于整数类型<br>• UNSIGNED 无符号  </p>
<h2 id="DML语句"><a href="#DML语句" class="headerlink" title="DML语句"></a>DML语句</h2><p>DML: INSERT, DELETE, UPDATE  </p>
<h3 id="INSERT："><a href="#INSERT：" class="headerlink" title="INSERT："></a>INSERT：</h3><p>一次插入一行或多行数据<br>三种语法：  </p>
<ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [IGNORE] </span><br><span class="line">[INTO] tbl_name [(col_name,...)] </span><br><span class="line">&#123;VALUES | VALUE&#125; (&#123;expr | DEFAULT&#125;,...),(...),...</span><br><span class="line">[ON DUPLICATE KEY UPDATE 如果重复更新之col_name=expr [, col_name=expr] ... ]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>简化写法</strong>：<br><code>INSERT tbl_name [(col1,...)] VALUES (val1,...), (val21,...)</code>  </p>
<blockquote>
<p>后面的具体值必须和字段属性和顺序匹配</p>
<ol start="2">
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [IGNORE] </span><br><span class="line">[INTO] tbl_name</span><br><span class="line">SET col_name=&#123;expr | DEFAULT&#125;, ...</span><br><span class="line">[ ON DUPLICATE KEY UPDATE</span><br><span class="line">col_name=expr</span><br><span class="line">[, col_name=expr] ... ]</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<ol start="3">
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT [LOW_PRIORITY | HIGH_PRIORITY] [IGNORE]</span><br><span class="line">[INTO] tbl_name [(col_name,...)]</span><br><span class="line">SELECT ...</span><br><span class="line">[ ON DUPLICATE KEY UPDATE</span><br><span class="line">col_name=expr</span><br><span class="line">[, col_name=expr] ... ]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a>UPDATE</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UPDATE [LOW_PRIORITY] [IGNORE] table_reference</span><br><span class="line">SET col_name1=&#123;expr1|DEFAULT&#125; [, col_name2=&#123;expr2|DEFAULT&#125;] ...</span><br><span class="line">[WHERE where_condition]</span><br><span class="line">[ORDER BY ...]</span><br><span class="line">[LIMIT row_count]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：一定要有限制条件，否则将修改所有行的指定字段<br>限制条件：<br>WHERE<br>LIMIT  </p>
</blockquote>
<p><strong>建议使用安全更新语句以往误操作</strong><br>Mysql 选项：-U|–safe-updates| –i-am-a-dummy<br>或定义别名 alias mysql=’mysql -U’</p>
<h3 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a>DELETE</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELETE [LOW_PRIORITY] [QUICK] [IGNORE] FROM tbl_name</span><br><span class="line">[WHERE where_condition]</span><br><span class="line">[ORDER BY ...]</span><br><span class="line">[LIMIT row_count]</span><br><span class="line">可先排序再指定删除的行数</span><br><span class="line">示例：</span><br><span class="line">delete from student where id &gt;= 5;</span><br><span class="line">快速删除表中所有内容，但不记录日志：</span><br><span class="line">truncate table student;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：一定要有限制条件，否则将清空表中的所有数据<br>限制条件：<br>WHERE<br>LIMIT<br>TRUNCATE TABLE tbl_name; 清空表</p>
</blockquote>
<h1 id="DQL语句"><a href="#DQL语句" class="headerlink" title="DQL语句"></a>DQL语句</h1><h2 id="SELECT"><a href="#SELECT" class="headerlink" title="SELECT"></a>SELECT</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[ALL | DISTINCT | DISTINCTROW ]</span><br><span class="line">[SQL_CACHE | SQL_NO_CACHE]</span><br><span class="line">select_expr [, select_expr ...]</span><br><span class="line"> [FROM table_references</span><br><span class="line"> [WHERE where_condition]</span><br><span class="line"> [GROUP BY &#123;col_name | expr | position&#125;</span><br><span class="line"> [ASC | DESC], ... [WITH ROLLUP]]</span><br><span class="line"> [HAVING where_condition]</span><br><span class="line"> [ORDER BY &#123;col_name | expr | position&#125;</span><br><span class="line"> [ASC | DESC], ...]</span><br><span class="line"> [LIMIT &#123;[offset,] row_count | row_count OFFSET offset&#125;]</span><br><span class="line"> [FOR UPDATE | LOCK IN SHARE MODE]</span><br></pre></td></tr></table></figure>
<p><strong>字段显示可以使用别名</strong>：<br>col1 AS alias1, col2 AS alias2, …<br><strong>WHERE子句</strong>：指明过滤条件以实现“选择”的功能：<br><code>select name as 姓名,id,age as 年龄 from student;</code><br>过滤条件：</p>
<ul>
<li>布尔型表达式</li>
<li>算术操作符：+, -, *, /, %</li>
<li>比较操作符：=,&lt;=&gt;（相等或都为空）, &lt;&gt;, !=(非标准SQL), &gt;, &gt;=, &lt;, &lt;=</li>
<li>BETWEEN min_num AND max_num</li>
<li>IN (element1, element2, …)</li>
<li>IS NULL</li>
<li><p>IS NOT NULL</p>
<blockquote>
<p>查询命令定义别名后，不能再使用表名查询 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from student where age &gt; 25;  #查询年龄大于25</span><br><span class="line">select * from student where age between 25 and 28;  # 查询年龄在25到28之间</span><br><span class="line">select * from student where age in (20,30);  #查询年龄等于20和30的</span><br><span class="line">select * from student where mobile is null;  #查询手机号码为空</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>DISTINCT 去除重复列<br><code>SELECT DISTINCT gender FROM students;</code> </p>
</li>
<li><strong>LIKE</strong>:<br>% 任意长度的任意字符<br>_ 任意单个字符  </li>
<li>RLIKE：正则表达式，<strong>索引失效，不建议使用</strong><br>REGEXP：匹配字符串可用正则表达式书写模式，同上</li>
<li>逻辑操作符：<br>NOT<br>AND<br>OR<br>XOR  </li>
<li><p><strong>GROUP</strong>：根据指定的条件把查询结果进行“分组”以用于做“聚合”运算avg(), max(), min(), count(), sum()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">select gender as 性别,count(*) as 人数 from students group by gender;</span><br><span class="line"></span><br><span class="line">select gender as 性别,avg(age) as 平均年龄 from students group by gender;</span><br><span class="line"></span><br><span class="line">select classid,gender,max(age) from students group by classid,gender;</span><br><span class="line"></span><br><span class="line">分组前统计</span><br><span class="line">select classid,count(*) from students where age &gt; 30 group by classid;</span><br><span class="line"></span><br><span class="line">分组后再统计</span><br><span class="line">select classid,count(*) from students where age &gt; 30 group by classid having classid;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>HAVING</strong>: 对分组聚合运算后的结果指定过滤条件  </p>
</li>
<li><strong>ORDER BY</strong>: 根据指定的字段对查询结果进行排序<br>升序：ASC<br>降序：DESC<br><code>select * from students order by age desc;</code><br><code>select * from students order by age asc;</code><br>排除null值后按正序排列<br><code>select * from students order by -classid desc;</code></li>
<li>LIMIT [[offset,]row_count]：对查询的结果进行输出行数数量限制<br>对查询结果中的数据请求施加“锁”<br>FOR UPDATE: 写锁，独占或排它锁，只有一个读和写<br>LOCK IN SHARE MODE: 读锁，共享锁，同时多个读  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DESC students;</span><br><span class="line">INSERT INTO students VALUES(1,&apos;tom&apos;，&apos;m&apos;),(2,&apos;alice&apos;,&apos;f&apos;);</span><br><span class="line">INSERT INTO students(id,name) VALUES(3,&apos;jack&apos;),(4,&apos;allen&apos;);</span><br><span class="line">SELECT * FROM students WHERE id &lt; 3;</span><br><span class="line">SELECT * FROM students WHERE gender=&apos;m&apos;;</span><br><span class="line">SELECT * FROM students WHERE gender IS NULL;</span><br><span class="line">SELECT * FROM students WHERE gender IS NOT NULL;</span><br><span class="line">SELECT * FROM students ORDER BY name DESC LIMIT 2;</span><br><span class="line">SELECT * FROM students ORDER BY name DESC LIMIT 1,2;</span><br><span class="line">SELECT * FROM students WHERE id &gt;=2 and id &lt;=4</span><br><span class="line">SELECT * FROM students WHERE BETWEEN 2 AND 4</span><br><span class="line">SELECT * FROM students WHERE name LIKE ‘t%’</span><br><span class="line">SELECT * FROM students WHERE name RLIKE &apos;.*[lo].*&apos;;</span><br><span class="line">SELECT id stuid,name as stuname FROM students</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h1><p>交叉连接：笛卡尔乘积<br>内连接：<br>等值连接：让表之间的字段以“等值”建立连接关系；<br>不等值连接<br>自然连接:去掉重复列的等值连接<br>自连接<br>外连接：<br>左外连接：<br>FROM tb1 LEFT JOIN tb2 ON tb1.col=tb2.col<br>右外连接<br>FROM tb1 RIGHT JOIN tb2 ON tb1.col=tb2.col  </p>
<h1 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h1><p>视图：VIEW,虚表，保存有实表的查询结果<br>创建方法：<br><code>CREATE VIEW view_name [(column_list)] AS select_statement [WITH [CASCADED | LOCAL] CHECK OPTION]</code><br>查看视图定义：<br>SHOW CREATE VIEW view_name<br>删除视图：<br>DROP VIEW [IF EXISTS] view_name [, view_name] … [RESTRICT | CASCADE]<br><strong>视图中的数据事实上存储于“基表”中,视图本身不存放数据，因此，其修改操作也会针对基表实现</strong>；<br>其修改操作受基表限制</p>
<blockquote>
<p>视图一般适用于复杂多表查询，不适合修改数据</p>
</blockquote>
<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p>函数：系统函数和自定义函数<br> 系统函数:<a href="https://dev.mysql.com/doc/refman/5.7/en/func-op-summaryref.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/func-op-summaryref.html</a>  </p>
<ul>
<li>自定义函数 (user-defined function UDF)<br>保存在mysql.proc表中<br>创建UDF  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE [AGGREGATE] FUNCTION function_name(parameter_name</span><br><span class="line">type,[parameter_name type,...])</span><br><span class="line">RETURNS &#123;STRING|INTEGER|REAL&#125; #返回结果</span><br><span class="line">runtime_body   #函数定义体</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>说明：<br>参数可以有多个,也可以没有参数<br>必须有且只有一个返回值</p>
</blockquote>
<h2 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h2><ul>
<li>创建函数<br>示例：无参UDF<br><code>CREATE FUNCTION simpleFun() RETURNS VARCHAR(20) RETURN &quot;Hello World!&quot;;</code><br>select simpleFun();#查看函数<br>select hellod.simpleFun();#跨数据库查看  </li>
<li>查看函数列表：<br><code>SHOW FUNCTION STATUS;</code> </li>
<li>查看函数定义:<br><code>SHOW CREATE FUNCTION function_name</code></li>
<li>删除UDF:<br><code>DROP FUNCTION function_name;</code></li>
<li>调用自定义函数语法:<br><code>SELECT function_name(parameter_value,...)</code></li>
<li>示例：有参数UDF<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER // #避免;执行单条命令，将//定义为结束</span><br><span class="line">CREATE FUNCTION deleteById(uid SMALLINT UNSIGNED) RETURNS VARCHAR(20) #定义一个uid的参数</span><br><span class="line">BEGIN</span><br><span class="line">DELETE FROM students WHERE stuid = uid;  #删除stuid匹配uid参数</span><br><span class="line">RETURN (SELECT COUNT(stuid) FROM students);</span><br><span class="line">END//</span><br><span class="line"></span><br><span class="line">DELIMITER ;  #在写完整个函数后，重新使用;结束查询命令</span><br><span class="line">select deletebyid(27);  #删除stuid为27的数据</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="局部变量语法"><a href="#局部变量语法" class="headerlink" title="局部变量语法"></a>局部变量语法</h2><p>DECLARE 变量1[,变量2,… ]变量类型 [DEFAULT 默认值]<br>说明：局部变量的作用范围是在BEGIN…END程序中,而且定义局部变量语句必须在BEGIN…END的第一行定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">示例:</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE FUNCTION addTwoNumber(x SMALLINT UNSIGNED, Y SMALLINT</span><br><span class="line">UNSIGNED)</span><br><span class="line">RETURNS SMALLINT</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE a, b SMALLINT UNSIGNED;</span><br><span class="line">SET a = x, b = y;</span><br><span class="line">RETURN a+b;</span><br><span class="line">END//</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line">select addTwoNumber(1,45)</span><br></pre></td></tr></table></figure></p>
<h2 id="变量赋值语法"><a href="#变量赋值语法" class="headerlink" title="变量赋值语法"></a>变量赋值语法</h2><p>SET parameter_name = value[,parameter_name = value…]<br>SELECT INTO parameter_name<br>set @a=7   #会话变量，只存在此连接会话中<br>select a;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">示例:</span><br><span class="line">...</span><br><span class="line">DECLARE x int;</span><br><span class="line">SELECT COUNT(id) FROM tdb_name INTO x;  #将x赋值查询表中的记录数量  </span><br><span class="line">RETURN x;</span><br><span class="line">END//</span><br></pre></td></tr></table></figure></p>
<h1 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h1><ul>
<li>存储过程优势<br>存储过程把经常使用的SQL语句或业务逻辑封装起来,预编译保存在数据库中,当需要时从数据库中直接调用,省去了编译的过程<br>提高了运行速度<br>同时降低网络数据传输量  </li>
<li>存储过程与自定义函数的区别<br>存储过程实现的过程要复杂一些,而函数的针对性较强<br>存储过程可以有多个返回值,而自定义函数只有一个返回值<br>存储过程一般独立的来执行,而函数往往是作为其他SQL语句的一部分来使用  </li>
</ul>
<h2 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h2><ul>
<li><p>存储过程：存储过程保存在mysql.proc表中<br>`CREATE PROCEDURE sp_name ([ proc_parameter [,proc_parameter …]])<br>routime_body<br>proc_parameter : [IN|OUT|INOUT]   parameter_name type  </p>
<blockquote>
<p>其中IN表示输入参数，OUT表示输出参数，INOUT表示既可以输入也可以输出；<br>param_name表示参数名称；type表示参数的类型</p>
</blockquote>
</li>
<li><p>查看存储过程列表<br><code>SHOW PROCEDURE STATUS;</code></p>
</li>
<li>查看存储过程定义<br><code>SHOW CREATE PROCEDURE sp_name</code>   </li>
<li>调用存储过程<br><code>CALL sp_name ([ proc_parameter [,proc_parameter ...]])</code><br><code>CALL sp_name</code>  <blockquote>
<p>说明:当无参时,可以省略”()”,当有参数时,不可省略”()”   </p>
</blockquote>
</li>
<li>存储过程修改<br>ALTER语句修改存储过程只能修改存储过程的注释等无关紧要的东西,不能修改存储过程体,所以要修改存储过程,方法就是删除重建   </li>
<li>删除存储过程<br><code>DROP PROCEDURE [IF EXISTS] sp_name</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">存储过程示例</span><br><span class="line">1、创建无参存储过程</span><br><span class="line">delimiter //  #定义//为结束符</span><br><span class="line">CREATE PROCEDURE showTime()</span><br><span class="line">BEGIN</span><br><span class="line">SELECT now();</span><br><span class="line">END//</span><br><span class="line">delimiter ;  #重新使用；为结束符</span><br><span class="line">CALL showTime;   #调用存储过程</span><br><span class="line"></span><br><span class="line">2、创建含参存储过程：只有一个IN参数</span><br><span class="line">delimiter //</span><br><span class="line">CREATE PROCEDURE selectById(IN uid SMALLINT UNSIGNED)</span><br><span class="line">BEGIN</span><br><span class="line">SELECT * FROM students WHERE stuid = uid;</span><br><span class="line">END//</span><br><span class="line">delimiter ;</span><br><span class="line">call selectById(2);</span><br><span class="line"></span><br><span class="line">3、求和计算</span><br><span class="line">delimiter //</span><br><span class="line">CREATE PROCEDURE dorepeat(n INT)  #定义n的类型</span><br><span class="line">BEGIN</span><br><span class="line">SET @i = 0;</span><br><span class="line">SET @sum = 0;</span><br><span class="line">REPEAT SET @sum = @sum+@i; SET @i = @i + 1;</span><br><span class="line">UNTIL @i &gt; n END REPEAT;  #计算i自相加运算到n的值</span><br><span class="line">END//</span><br><span class="line">delimiter ;</span><br><span class="line">CALL dorepeat(100);  #计算从0到100</span><br><span class="line">SELECT @sum;         #取结果</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h1><p>存储过程和函数中可以使用流程控制来控制语句的执行<br>流程控制：</p>
<ul>
<li>IF：用来进行条件判断。根据是否满足条件，执行不同语句</li>
<li>CASE：用来进行条件判断，可实现比IF语句更复杂的条件判断</li>
<li>LOOP：重复执行特定的语句，实现一个简单的循环</li>
<li>LEAVE：用于跳出循环控制</li>
<li>ITERATE：跳出本次循环，然后直接进入下一次循环</li>
<li>REPEAT：有条件控制的循环语句。当满足特定条件时，就会跳出循环语句</li>
<li>WHILE：有条件控制的循环语句</li>
</ul>
<h1 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h1><p>触发器的执行不是由程序调用，也不是由手工启动，而是由事件来触发、激活从而实现<br>执行</p>
<ul>
<li>创建触发器<br>CREATE<br>[DEFINER = { user | CURRENT_USER }]<br>TRIGGER trigger_name<br>trigger_time trigger_event<br>ON tbl_name FOR EACH ROW<br>trigger_body    <blockquote>
<p>说明：<br>trigger_name：触发器的名称<br>trigger_time：{ BEFORE | AFTER }，<strong>表示在事件之前或之后触发</strong><br>trigger_event:：{ INSERT |UPDATE | DELETE }，触发的具体事件<br>tbl_name：该触发器作用在表名   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1、示例：创建触发器，在向学生表INSERT数据时，学生数增加，DELETE学生时，学生数减少</span><br><span class="line">CREATE TRIGGER trigger_student_count_insert</span><br><span class="line">AFTER INSERT</span><br><span class="line">ON student_info FOR EACH ROW</span><br><span class="line">UPDATE student_count SET student_count=student_count+1;</span><br><span class="line">CREATE TRIGGER trigger_student_count_delete</span><br><span class="line">AFTER DELETE</span><br><span class="line">ON student_info FOR EACH ROW</span><br><span class="line">UPDATE student_count SET student_count=student_count-1;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<p>查看触发器<br><code>SHOW TRIGGERS</code><br>查询系统表information_schema.triggers的方式指定查询条件，查看指定的触发器信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; USE information_schema;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; SELECT * FROM triggers WHERE</span><br><span class="line">trigger_name=&apos;trigger_student_count_insert&apos;;</span><br></pre></td></tr></table></figure></p>
<p>删除触发器<br><code>DROP TRIGGER trigger_name;</code></p>
<h1 id="MySQL用户和权限管理"><a href="#MySQL用户和权限管理" class="headerlink" title="MySQL用户和权限管理"></a>MySQL用户和权限管理</h1><ul>
<li>元数据数据库：mysql<br>系统授权表：<br>db, host, user<br>columns_priv, tables_priv, procs_priv, proxies_priv   </li>
<li>用户账号：<br>‘USERNAME‘@’HOST’<br>@’HOST’:  #允许登录的主机IP<br>主机名<br>IP地址或Network<br>通配符： % _<br>示例：172.16.%.%   #允许使用内网IP地址登录    <h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h2></li>
<li>创建用户：CREATE USER<br><code>CREATE USER &#39;USERNAME&#39;@&#39;HOST&#39; [IDENTIFIED BY &#39;password&#39;]；</code>    #不常用，创建用户权限较小，不方便使用<br>默认权限：USAGE  </li>
<li>用户重命名：RENAME USER<br><code>RENAME USER old_user_name TO new_user_name;</code></li>
<li>删除用户：<br><code>DROP USER &#39;USERNAME&#39;@&#39;HOST&#39;</code><br>示例：删除默认的空用户<br><code>DROP USER &#39;&#39;@&#39;localhost&#39;;</code>   #删除空密码’’  </li>
<li>修改密码：<br><code>mysql&gt;SET PASSWORD FOR &#39;user&#39;@&#39;host&#39; = PASSWORD(‘password&#39;);</code><br><code>mysql&gt;UPDATE mysql.user SET password=PASSWORD(&#39;password&#39;) WHERE clause;</code><br>此方法需要执行下面指令才能生效：<br><code>mysql&gt; FLUSH PRIVILEGES;</code><br><code>mysqladmin -u root -poldpass password &#39;newpass&#39;</code></li>
</ul>
<h2 id="忘记管理员密码的解决办法："><a href="#忘记管理员密码的解决办法：" class="headerlink" title="忘记管理员密码的解决办法："></a>忘记管理员密码的解决办法：</h2><ol>
<li>启动mysqld进程时，为其使用如下选项：<br>–skip-grant-tables –skip-networking   </li>
<li>使用UPDATE命令修改管理员密码<br><code>update mysql.user set password=password(&#39;centos&#39;) where user=&#39;root&#39;</code>  #重新设置root账户密码为centos</li>
<li>关闭mysqld进程，移除上述两个选项，重启mysqld   </li>
</ol>
<h2 id="MySQL权限管理"><a href="#MySQL权限管理" class="headerlink" title="MySQL权限管理"></a>MySQL权限管理</h2><p>权限类别：<br>管理类<br>程序类<br>数据库级别<br>表级别<br>字段级别   </p>
<h1 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">授权tom用户只能查看和修改表</span><br><span class="line">grant select,insert on testdb.* to &apos;tom&apos;@&apos;172.18.%.%&apos;;</span><br><span class="line"></span><br><span class="line">授权tom用户所有的权限</span><br><span class="line">grant all on testdb.* to &apos;tom&apos;@172.18.%.%;</span><br><span class="line"></span><br><span class="line">*.*: 所有库的所表</span><br><span class="line">db_name.*: 指定库的所有表</span><br><span class="line">db_name.tb_name: 指定库的指定表</span><br><span class="line">db_name.routine_name：指定库的存储过程和函数</span><br><span class="line">revoke insert on testdb.* from &apos;tom&apos;@&apos;172.18.%.%&apos;;   #收回授权</span><br><span class="line">grant all on testdb.* to &apos;wang&apos;@&apos;172.18.0.106&apos; identified by &quot;magedu&quot;;    #授权的同时创建账号</span><br><span class="line">show grants for wang@&apos;172.18.0.106&apos;;   #查看用户获得的授权</span><br><span class="line">grant update(name) on testdb.students to test@&apos;172.18.%.%&apos; identified by &apos;centos&apos;;   #只授权修改某个字段</span><br><span class="line">Help SHOW GRANTS   #查看帮助。怎么查用户的获得的授权</span><br><span class="line">对于不能够或不能及时重读授权表的命令，可手动让MariaDB的服务进程重读授权表：mysql&gt; FLUSH PRIVILEGES</span><br></pre></td></tr></table></figure>
<h1 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h1><ul>
<li>查看mysql支持的存储引擎<br><code>show engines;</code></li>
<li>查看当前默认的存储引擎<br><code>show variables like &#39;%storage_engine%&#39;;</code>  </li>
<li><p>设置默认的存储引擎</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.conf</span><br><span class="line">[mysqld]</span><br><span class="line">default_storage_engine= InnoDB</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看库中所有表使用的存储引擎<br><code>how table status from db_name;</code>  </p>
</li>
<li>查看库中指定表的存储引擎<br><code>show table status like &#39; tb_name &#39;;</code><br><code>show create table tb_name;</code>   </li>
<li>设置表的存储引擎：<br><code>CREATE TABLE tb_name(... ) ENGINE=InnoDB;</code><br><code>ALTER TABLE tb_name ENGINE=InnoDB;</code></li>
</ul>
<h2 id="MyISAM引擎特点："><a href="#MyISAM引擎特点：" class="headerlink" title="MyISAM引擎特点："></a>MyISAM引擎特点：</h2><ul>
<li><strong>不支持事务</strong></li>
<li><strong>表级锁定</strong></li>
<li>读写相互阻塞，写入不能读，读时不能写</li>
<li>只缓存索引</li>
<li><strong>不支持外键约束</strong></li>
<li>不支持聚簇索引</li>
<li>读取数据较快，占用资源较少</li>
<li><strong>不支持MVCC</strong>（多版本并发控制机制）高并发</li>
<li>崩溃恢复性较差  </li>
<li>MySQL5.5.5前默认的数据库引擎</li>
</ul>
<p>MyISAM存储引擎适用场景<br>只读（或者写较少）、表较小（可以接受长时间进行修复操作）<br>MyISAM引擎文件<br>tbl_name.frm 表格式定义<br>tbl_name.MYD 数据文件<br>tbl_name.MYI 索引文件   </p>
<h2 id="InnoDB引擎特点"><a href="#InnoDB引擎特点" class="headerlink" title="InnoDB引擎特点"></a>InnoDB引擎特点</h2><ul>
<li><strong>行级锁</strong></li>
<li><strong>支持事务</strong>，适合处理大量短期事务</li>
<li>读写阻塞与事务隔离级别相关</li>
<li>可缓存数据和索引</li>
<li>支持聚簇索引</li>
<li>崩溃恢复性更好</li>
<li><strong>支持MVCC高并发</strong></li>
<li>从MySQL5.5后支持全文索引</li>
<li>从MySQL5.5.5开始为默认的数据库引擎</li>
</ul>
<p>InnoDB数据库文件   </p>
<ul>
<li>所有InnoDB表的数据和索引放置于同一个表空间中<br>表空间文件：datadir定义的目录下<br>数据文件：ibddata1, ibddata2, …   </li>
<li>每个表单独使用一个表空间存储表的数据和索引<br>启用：<strong>innodb_file_per_table=ON</strong><br>参看：<a href="https://mariadb.com/kb/en/library/xtradbinnodb-serversystem-variables/#innodb_file_per_table" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/xtradbinnodb-serversystem-variables/#innodb_file_per_table</a><br>ON (&gt;= MariaDB 5.5)默认在5.5以后都已经是开启状态<br>两类文件放在数据库独立目录中<br><strong>数据文件</strong>(存储数据和索引)：tb_name.ibd<br><strong>表格式定义</strong>：tb_name.frm    <blockquote>
<p>数据表都存放在一个表中，删除后空间不会缩减<br>推荐单独存放，便于管理  </p>
</blockquote>
</li>
</ul>
<h2 id="MySQL中的系统数据库"><a href="#MySQL中的系统数据库" class="headerlink" title="MySQL中的系统数据库"></a>MySQL中的系统数据库</h2><ul>
<li>mysql数据库<br>是mysql的核心数据库，类似于Sql Server中的master库，主要负责存储数据库的用户、权限设置、关键字等mysql自己需要使用的控制和管理信息   </li>
<li>performance_schema数据库<br>MySQL 5.5开始新增的数据库，主要用于收集数据库服务器性能参数,库里表的存储引擎均为PERFORMANCE_SCHEMA，用户不能创建存储引擎为PERFORMANCE_SCHEMA的表   </li>
<li>information_schema数据库<br>MySQL 5.0之后产生的，一个虚拟数据库，物理上并不存在。<br>information_schema数据库类似与“数据字典”，提供了访问数据库元数据的方式，即数据的数据。比如数据库名或表名，列类型，访问权限（更加细化的访问方式）</li>
</ul>
<h1 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h1><p>mysqld选项，服务器系统变量和服务器状态变量<br><a href="https://dev.mysql.com/doc/refman/5.7/en/mysqld-optiontables.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/mysqld-optiontables.html</a><br><a href="https://mariadb.com/kb/en/library/full-list-of-mariadb-optionssystem-and-status-variables/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/full-list-of-mariadb-optionssystem-and-status-variables/</a>   </p>
<blockquote>
<p>注意：其中有些参数支持运行时修改，会立即生效；<br>有些参数不支持，且只能通过修改配置文件，并重启服务器程序生效；<br>有些参数作用域是全局的，且不可改变；有些可以为每个用户提供单独（会话）的设置<br>配置文件中建议“-”链接参数，系统变量建议“_”<br><strong>写到配置文件中的必须是msql选项</strong><br>有的变量不一定是选项，写配置文件要注意</p>
</blockquote>
<h2 id="服务器系统变量"><a href="#服务器系统变量" class="headerlink" title="服务器系统变量"></a>服务器系统变量</h2><p>分全局和会话两种  </p>
<ul>
<li><p>获取系统变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW GLOBAL VARIABLES;    #查看全局变量</span><br><span class="line">mysql&gt; SHOW [SESSION] VARIABLES; #查看会员变量</span><br><span class="line">mysql&gt; SELECT @@VARIABLES;       #查看具体变量的参数</span><br><span class="line">mysql&gt; SELECT @@sort_buffer_size;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改服务器变量的值：<br><code>mysql&gt; help SET</code></p>
</li>
<li>修改全局变量：仅对修改后新创建的会话有效；对已经建立的会话无效<br><code>mysql&gt; SET GLOBAL system_var_name=value;</code><br><code>mysql&gt; SET @@global.system_var_name=value;</code></li>
<li>修改会话变量：<br><code>mysql&gt; SET [SESSION] system_var_name=value;</code><br><code>mysql&gt; SET @@[session.]system_var_name=value;</code></li>
<li>状态变量（只读）：用于保存mysqld运行中的统计数据的变量，不可更改<br><code>mysql&gt; SHOW GLOBAL STATUS;</code><br><code>mysql&gt; SHOW [SESSION] STATUS;</code></li>
</ul>
<h1 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h1><p>使用hash计算命令整体，匹配是否与新指令是否一致。<br>为了更准确的利用缓存，要注意大小写，空格多少。<br>读的多写的少，适合查询缓存<br>写多读少，不适合利用查询缓存</p>
<h2 id="查询缓存相关的服务器变量"><a href="#查询缓存相关的服务器变量" class="headerlink" title="查询缓存相关的服务器变量"></a>查询缓存相关的服务器变量</h2><ul>
<li>query_cache_min_res_unit：查询缓存中内存块的最小分配单位，默认4k，较小值会减少浪费，但会导致更频繁的内存分配操作，较大值会带来浪费，会导致碎片过多，内存不足   </li>
<li>query_cache_limit：单个查询结果能缓存的最大值，默认为1M，对于查询结果过大而无法缓存的语句，建议使用SQL_NO_CACHE   </li>
<li>query_cache_size：查询缓存总共可用的内存空间；单位字节，必须是1024的整数倍，最小值40KB，低于此值有警报  </li>
<li>query_cache_wlock_invalidate：如果某表被其它的会话锁定，是否仍然可以<br>从查询缓存中返回结果，默认值为OFF，表示可以在表被其它会话锁定的场景中继续从缓存返回数据；ON则表示不允许   </li>
<li>query_cache_type：是否开启缓存功能，取值为ON, OFF, DEMAND   </li>
<li>SELECT语句的缓存控制<br>SQL_CACHE：显式指定存储查询结果于缓存之中<br>SQL_NO_CACHE：显式查询结果不予缓存  </li>
<li>query_cache_type参数变量<br>query_cache_type的值为OFF或0时，查询缓存功能关闭<br>query_cache_type的值为ON或1时，查询缓存功能打开，SELECT的结果符合缓存条件即会缓存，否则，不予缓存，显式指定SQL_NO_CACHE，不予缓存，此为默认值  </li>
<li>query_cache_type的值为DEMAND或2时，查询缓存功能按需进行，显式指定SQL_CACHE的SELECT语句才会缓存；其它均不予缓存  </li>
</ul>
<h2 id="缓存系统变量"><a href="#缓存系统变量" class="headerlink" title="缓存系统变量"></a>缓存系统变量</h2><p>查询缓存相关的状态变量：SHOW GLOBAL STATUS LIKE ‘Qcache%’;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+---------+</span><br><span class="line">| Variable_name           | Value   |</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">| Qcache_free_blocks      | 1       |</span><br><span class="line">| Qcache_free_memory      | 1031320 |</span><br><span class="line">| Qcache_hits             | 0       |</span><br><span class="line">| Qcache_inserts          | 0       |</span><br><span class="line">| Qcache_lowmem_prunes    | 0       |</span><br><span class="line">| Qcache_not_cached       | 0       |</span><br><span class="line">| Qcache_queries_in_cache | 0       |</span><br><span class="line">| Qcache_total_blocks     | 1       |</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">Qcache_free_blocks：处于空闲状态 Query Cache中内存 Block 数</span><br><span class="line">Qcache_total_blocks：Query Cache 中总Block ，当Qcache_free_blocks相对此值较大时，可能用内存碎片，执行FLUSH QUERY CACHE清理碎片</span><br><span class="line">Qcache_free_memory：处于空闲状态的Query Cache内存总量</span><br><span class="line">Qcache_hits：Query Cache 命中次数</span><br><span class="line">Qcache_inserts：向 Query Cache 中插入新的Query Cache的次数，即没有命中的次数</span><br><span class="line">Qcache_lowmem_prunes：记录因为内存不足而被移除出查询缓存的查询数</span><br><span class="line">Qcache_not_cached：没有被Cache的SQL数，包括无法被Cache的SQL以及由于query_cache_type设置的不会被Cache的SQL语句</span><br><span class="line">Qcache_queries_in_cache：在Query Cache中的SQL数量</span><br><span class="line"></span><br><span class="line">查询缓存命中率 ：Qcache_hits / ( Qcache_hits + Qcache_inserts ) * 100%</span><br><span class="line">查询缓存内存使用率：(query_cache_size – qcache_free_memory) /</span><br><span class="line">query_cache_size * 100%</span><br></pre></td></tr></table></figure></p>
<h1 id="聚簇和非聚簇索引"><a href="#聚簇和非聚簇索引" class="headerlink" title="聚簇和非聚簇索引"></a>聚簇和非聚簇索引</h1><p>非聚集索引：数据和索引不在一起<br>聚集索引：数据和索引在一起<br>主键索引：索引和数据都放在叶子节点，速度快<br>二级索引：主键和索引存放在叶子节点，需要查询两次，还要利用主键索引才能有结果  </p>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><p>索引：是特殊数据结构，定义在查找时作为查找条件的字段，在MySQL又称为键key，索引通过存储引擎实现</p>
<ul>
<li>优点：<br>索引可以降低服务需要扫描的数据量，减少了IO次数<br>索引可以帮助服务器避免排序和使用临时表<br>索引可以帮助将随机I/O转为顺序I/O  </li>
<li>缺点：<br>占用额外空间，影响插入速度</li>
</ul>
<h2 id="索引类型："><a href="#索引类型：" class="headerlink" title="索引类型："></a>索引类型：</h2><ul>
<li>B+ TREE、HASH、R TREE</li>
<li>聚簇（集）索引、非聚簇索引：数据和索引是否存储在一起</li>
<li>主键索引、二级（辅助）索引</li>
<li>稠密索引、稀疏索引：是否索引了每一个数据项</li>
<li>简单索引、组合索引<br><strong>左前缀索引</strong>：取前面的字符做索引<br>覆盖索引：从索引中即可取出要查询的数据，性能高<br>简单索引：对单独字段建立索引<br>复合索引：对多个字段建立索引<br>左前缀索引：利用后面的数据查询，不能利用到索引</li>
<li>二叉树：按树状排列，但可能会出现分支不全  </li>
<li>红黑树：平衡的二叉树，有可能分支太多，树太高，效率差</li>
<li>B-TREE索引：平衡树，多叉树，叶子节点到根的节点数都一致，每节点存放数据，效率差，不便管理    </li>
<li>B+TREE索引：每节点不存放数据，只在叶子节点存放数据，通过链表指向下一数据块，效率高，区域查询速度快</li>
</ul>
<blockquote>
<p>每张表可以创建多条索引<br>读多写少，适合索引  </p>
</blockquote>
<h2 id="索引优化建议"><a href="#索引优化建议" class="headerlink" title="索引优化建议"></a>索引优化建议</h2><ul>
<li>只要列中含有NULL值，就最好不要在此例设置索引，复合索引如果有NULL值，此列在使用时也不会使用索引   </li>
<li>尽量使用短索引，如果可以，应该制定一个前缀长度   </li>
<li>对于经常在where子句使用的列，最好设置索引   </li>
<li>对于有多个列where或者order by子句，应该建立复合索引  </li>
<li>对于like语句，以%或者‘-’开头的不会使用索引，以%结尾会使用索引   </li>
<li>尽量不要在列上进行运算（函数操作和表达式操作）   </li>
<li>尽量不要使用not in和&lt;&gt;操作   </li>
</ul>
<h2 id="SQL语句性能优化"><a href="#SQL语句性能优化" class="headerlink" title="SQL语句性能优化"></a>SQL语句性能优化</h2><ul>
<li>查询时，能不要<em>就不用</em>，尽量写全字段名</li>
<li>大部分情况连接效率远大于子查询</li>
<li>多表连接时，尽量小表驱动大表，即小表 join 大表</li>
<li>在有大量记录的表分页时使用limit</li>
<li>对于经常使用的查询，可以开启缓存</li>
<li>多使用explain和profile分析查询语句</li>
<li>查看慢查询日志，找出执行时间长的sql语句优化</li>
</ul>
<h2 id="管理索引"><a href="#管理索引" class="headerlink" title="管理索引"></a>管理索引</h2><ul>
<li>创建索引：<br>CREATE INDEX index_name ON tbl_name    (index_col_name[(length)],…);<br>help CREATE INDEX;<br><code>create index idx_name_age on testlog(name,age);</code></li>
<li>删除索引：<br>DROP INDEX index_name ON tbl_name;</li>
<li>查看索引：<br>SHOW INDEXES FROM [db_name.]tbl_name;</li>
<li>优化表空间：<br>OPTIMIZE TABLE tb_name;</li>
<li>查看索引的使用<br>SET GLOBAL userstat=1;<br>SHOW INDEX_STATISTICS;  </li>
</ul>
<h2 id="EXPLAIN"><a href="#EXPLAIN" class="headerlink" title="EXPLAIN"></a>EXPLAIN</h2><p>通过EXPLAIN来分析索引的有效性<br><code>explain select * from testlog where name like &#39;wang1111&#39;;</code><br>输出信息说明：  </p>
<ul>
<li>id: 当前查询语句中，每个SELECT语句的编号   </li>
<li>select_type：<br>简单查询为SIMPLE   </li>
<li>table：SELECT语句关联到的表</li>
<li>type：关联类型或访问类型，即MySQL决定的如何去查询表中的行的方式，以下顺序，性能从低到高</li>
<li>possible_keys：查询可能会用到的索引</li>
<li>key: 查询中使用到的索引</li>
<li>key_len: 在索引使用的字节数</li>
<li>ref: 在利用key字段所表示的索引完成查询时所用的列或某常量值</li>
<li>rows：MySQL估计为找所有的目标行而需要读取的行数</li>
</ul>
<h1 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h1><ul>
<li>锁粒度：<br>表级锁<br>行级锁  </li>
<li>锁：<br>读锁：共享锁，只读不可写，多个读互不阻塞<br>写锁：独占锁,排它锁，一个写锁会阻塞其它读和它锁   </li>
<li>实现<br>存储引擎：自行实现其锁策略和锁粒度<br>服务器级：实现了锁，表级锁；用户可显式请求   </li>
<li>分类：<br>隐式锁：由存储引擎自动施加锁<br>显式锁：用户手动请求   </li>
<li>锁策略：在锁粒度及数据安全性寻求的平衡机制<br>显式使用锁   </li>
<li>LOCK TABLES 加锁<br><code>lock tables students read;</code><br><code>lock tables students write;</code></li>
<li>UNLOCK TABLES 解锁</li>
<li>FLUSH TABLES [tb_name[,…]] [WITH READ LOCK]<br>关闭正在打开的表（清除查询缓存），通常在备份前加全局读锁<br><code>flush tables with read lock;</code></li>
<li>SELECT clause [FOR UPDATE | LOCK IN SHARE MODE]<br>查询时加写或读锁</li>
</ul>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>事务Transactions：<strong>一组原子性的SQL语句</strong>，或一个独立工作单元<br>事务日志：记录事务信息，实现undo,redo等故障恢复功能<br>事务日志文件： ib_logfile0， ib_logfile1  </p>
<ul>
<li>ACID特性：<br>A：<strong>atomicity原子性</strong>；整个事务中的所有操作要么全部成功执行，要么全部失败后回滚<br>C：<strong>consistency一致性</strong>；数据库总是从一个一致性状态转换为另一个一致性状态（保证完整性）<br>I：<strong>Isolation隔离性</strong>；一个事务所做出的操作在提交之前，是不能为其它事务所见；隔离有多种隔离级别，实现并发<br>D：<strong>durability持久性</strong>；一旦事务提交，其所做的修改会永久保存于数据库中   </li>
</ul>
<h2 id="事务应用"><a href="#事务应用" class="headerlink" title="事务应用"></a>事务应用</h2><ul>
<li>启动事务：<br><strong>BEGIN</strong><br>BEGIN WORK<br>START TRANSACTION   </li>
<li>结束事务：<br><strong>COMMIT</strong>：提交<br><strong>ROLLBACK</strong>: 回滚   <blockquote>
<p>注意：只有事务型存储引擎中的DML（INSERT, DELETE, UPDATE）语句方能支持此类操作</p>
</blockquote>
</li>
<li>自动提交：set <strong>autocommit</strong>={1|0}    #默认为1，为0时设为非自动提交   <blockquote>
<p>建议：显式请求和提交事务，而不要使用“自动提交”功能</p>
</blockquote>
</li>
<li>事务支持保存点：savepoint<br>SAVEPOINT identifier<br>ROLLBACK [WORK] TO [SAVEPOINT] identifier<br>RELEASE SAVEPOINT identifier  </li>
</ul>
<h2 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h2><p>事务隔离级别：从上至下更加严格</p>
<ul>
<li>READ UNCOMMITTED 可读取到未提交数据，产生<strong>脏读</strong></li>
<li>READ COMMITTED 可读取到提交数据，但未提交数据不可读，产生不可重复读，即可读取到多个提交数据，导致每次读取数据不一致</li>
<li>REPEATABLE READ 可重复读，多次读取数据都一致，产生<strong>幻读</strong>，即读取过程中，即使有其它提交的事务修改数据，仍只能读取到未修改前的旧数据。<strong>此为MySQL默认设置</strong></li>
<li>SERIALIZABILE 可串行化，未提交的读事务阻塞修改事务，或者未提交的修改事务阻塞读事务。<strong>导致并发性能差</strong>  <blockquote>
<p>MVCC: 多版本并发控制，和事务级别相关</p>
</blockquote>
</li>
</ul>
<h3 id="指定事务隔离级别"><a href="#指定事务隔离级别" class="headerlink" title="指定事务隔离级别"></a>指定事务隔离级别</h3><ul>
<li>服务器变量tx_isolation指定，默认为REPEATABLE-READ，可在GLOBAL和SESSION级进行设置<br>SET tx_isolation=’’<br>READ-UNCOMMITTED<br>READ-COMMITTED<br>REPEATABLE-READ<br>SERIALIZABLE  </li>
<li>服务器选项中指定  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf  </span><br><span class="line">[mysqld]</span><br><span class="line">transaction-isolation=REPEATABLE-READ</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h2><p>事务日志 transaction log<br>错误日志 error log<br>通用日志 general log<br>慢查询日志 slow query log<br>二进制日志 binary log<br>中继日志 reley log  </p>
<h3 id="事务日志transaction-log"><a href="#事务日志transaction-log" class="headerlink" title="事务日志transaction log"></a>事务日志transaction log</h3><ul>
<li>事务型存储引擎自行管理和使用，<strong>建议和数据文件分开存放</strong><br>redo log<br>undo log   </li>
<li>Innodb事务日志相关配置：  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; show variables like &apos;%innodb_log%&apos;;</span><br><span class="line">+-----------------------------+----------+</span><br><span class="line">| Variable_name               | Value    |</span><br><span class="line">+-----------------------------+----------+</span><br><span class="line">| innodb_log_buffer_size      | 16777216 |</span><br><span class="line">| innodb_log_checksums        | ON       |</span><br><span class="line">| innodb_log_compressed_pages | ON       |</span><br><span class="line">| innodb_log_file_size        | 50331648 |  #每个日志文件大小</span><br><span class="line">| innodb_log_files_in_group   | 2        |  #日志组成员个数</span><br><span class="line">| innodb_log_group_home_dir   | ./       |  #事务文件路径</span><br><span class="line">| innodb_log_optimize_ddl     | ON       |</span><br><span class="line">| innodb_log_write_ahead_size | 8192     |</span><br><span class="line">+-----------------------------+----------+</span><br><span class="line"></span><br><span class="line">修改配置文件来配合实际需求</span><br><span class="line">1、创建日志存放的文件夹</span><br><span class="line">mkdir /data/mysql/logs -pv</span><br><span class="line">2、修改所有者和所属组</span><br><span class="line">chown mysql.mysql /data/mysql/logs/</span><br><span class="line">3、修改配置文件</span><br><span class="line">vim  /etc/my.cnf.d/server.cnf</span><br><span class="line">innodb_log_file_size=20M</span><br><span class="line">innodb_log_files_in_group=5</span><br><span class="line">innodb_log_group_home_dir=/data/mysql/logs</span><br><span class="line">4、重启服务</span><br><span class="line">systemctl restart mariadb</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="innodb-flush-log-at-trx-commit-默认为1"><a href="#innodb-flush-log-at-trx-commit-默认为1" class="headerlink" title="innodb_flush_log_at_trx_commit 默认为1"></a>innodb_flush_log_at_trx_commit 默认为1</h4><p>说明：设置为1，同时sync_binlog = 1表示最高级别的容错<br>innodb_use_global_flush_log_at_trx_commit的值确定是否可以使用SET语句重置此变量   </p>
<ul>
<li>1默认情况下，日志缓冲区将写入日志文件，并在每次事务后执行刷新到磁盘。这是完全遵守ACID特性   </li>
<li>0提交时没有任何操作;而是每秒执行一次日志缓冲区写入和刷新。 这样可以提供更好的性能，但服务器崩溃可以清除最后一秒的事务   </li>
<li>2每次提交后都会写入日志缓冲区，但每秒都会进行一次刷新。 性能比0略好一些，但操作系统或停电可能导致最后一秒的交易丢失    </li>
<li>3模拟MariaDB 5.5组提交（每组提交3个同步），此项MariaDB 10.0支持    </li>
</ul>
<h3 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h3><p>mysqld启动和关闭过程中输出的事件信息<br>mysqld运行中产生的错误信息<br>event scheduler运行一个event时产生的日志信息<br>在主从复制架构中的从服务器上启动从服务器线程时产生的信息  </p>
<p>错误日志相关配置<br>SHOW GLOBAL VARIABLES LIKE ‘log_error’<br>错误文件路径<br>log_error=/PATH/TO/LOG_ERROR_FILE  #注意路径的权限<br>是否记录警告信息至错误日志文件<br>log_warnings=1|0 默认值1   </p>
<h3 id="通用日志general-log"><a href="#通用日志general-log" class="headerlink" title="通用日志general log"></a>通用日志general log</h3><p>通用日志：记录对数据库的通用操作，包括错误的SQL语句<br>文件：file，默认值<br>表：table<br>通用日志相关设置<br>general_log=ON|OFF<br>general_log_file=HOSTNAME.log<br>log_output=TABLE|FILE|NONE<br><code>set global log_output=&#39;table&#39;;</code><br>修改输出日志到表，table在mysql数据库中</p>
<blockquote>
<p>排错和优化性能启用</p>
</blockquote>
<h3 id="慢查询日志slow-query-log"><a href="#慢查询日志slow-query-log" class="headerlink" title="慢查询日志slow query log"></a>慢查询日志slow query log</h3><p>慢查询日志：记录执行查询时长超出指定时长的操作</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>slow_query_log</strong></td>
<td>默认off，可以考虑开启，监控数据库性能</td>
</tr>
<tr>
<td><strong>long_query_time</strong></td>
<td>慢查询的阀值，单位秒。考虑实际情况设定合适的值</td>
</tr>
<tr>
<td>slow_query_log_file</td>
<td>HOSTNAME-slow.log慢查询日志文件</td>
</tr>
<tr>
<td>log_slow_filter</td>
<td>admin,filesort,filesort_on_disk,full_join,full_scan,query_cache,query_cache_miss,tmp_table,tmp_table_on_disk上述查询类型且查询时长超过long_query_time，则记录日志</td>
</tr>
<tr>
<td><strong>log_queries_not_using_indexes</strong></td>
<td>建议启用。不使用索引或使用全索引扫描，不论是否达到慢查询阀值的语句是否记录日志，默认OFF，即不记录</td>
</tr>
<tr>
<td>log_slow_rate_limit</td>
<td>多少次查询才记录，mariadb特有</td>
</tr>
<tr>
<td>log_slow_verbosity</td>
<td>记录内容</td>
</tr>
</tbody>
</table>
<h4 id="通过profiling分析sql语句"><a href="#通过profiling分析sql语句" class="headerlink" title="通过profiling分析sql语句"></a>通过profiling分析sql语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">1、默认不启用</span><br><span class="line">select @@profiling;</span><br><span class="line">+-------------+</span><br><span class="line">| @@profiling |</span><br><span class="line">+-------------+</span><br><span class="line">|           0 |</span><br><span class="line">+-------------+</span><br><span class="line">2、开启profiling功能</span><br><span class="line">set profiling=on;</span><br><span class="line">3、执行sql语句</span><br><span class="line">select * from testlog  where age=19999;</span><br><span class="line">4、查询profiles记录</span><br><span class="line">show profiles;</span><br><span class="line">+----------+------------+-----------------------------------------+</span><br><span class="line">| Query_ID | Duration   | Query                                   |</span><br><span class="line">+----------+------------+-----------------------------------------+</span><br><span class="line">|        1 | 0.00012183 | select @@profiling                      |</span><br><span class="line">|        2 | 0.10885141 | select count(*) from testlog            |</span><br><span class="line">|        3 | 0.00077224 | show index from students                | |</span><br><span class="line">|        4 | 0.10812236 | select * from testlog  where age=19999  |</span><br><span class="line">|        5 | 0.00014221 | show profiling                          |</span><br><span class="line">+----------+------------+-----------------------------------------+</span><br><span class="line">5、通过编号查询详细的时间过程</span><br><span class="line">show profile for query 5;</span><br><span class="line">+------------------------+----------+</span><br><span class="line">| Status                 | Duration |</span><br><span class="line">+------------------------+----------+</span><br><span class="line">| Starting               | 0.000190 |</span><br><span class="line">| Checking permissions   | 0.000009 |</span><br><span class="line">| Opening tables         | 0.000026 |</span><br><span class="line">| After opening tables   | 0.000005 |</span><br><span class="line">| System lock            | 0.000004 |</span><br><span class="line">| Table lock             | 0.000005 |</span><br><span class="line">| Init                   | 0.000021 |</span><br><span class="line">| Optimizing             | 0.000013 |</span><br><span class="line">| Statistics             | 0.000016 |</span><br><span class="line">| Preparing              | 0.000018 |</span><br><span class="line">| Executing              | 0.000003 |</span><br><span class="line">| Sending data           | 0.107752 |</span><br><span class="line">| End of update loop     | 0.000014 |</span><br><span class="line">| Query end              | 0.000003 |</span><br><span class="line">| Commit                 | 0.000004 |</span><br><span class="line">| Closing tables         | 0.000003 |</span><br><span class="line">| Unlocking tables       | 0.000002 |</span><br><span class="line">| Closing tables         | 0.000008 |</span><br><span class="line">| Starting cleanup       | 0.000002 |</span><br><span class="line">| Freeing items          | 0.000006 |</span><br><span class="line">| Updating status        | 0.000017 |</span><br><span class="line">| Reset for next command | 0.000002 |</span><br><span class="line">+------------------------+----------+</span><br></pre></td></tr></table></figure>
<h3 id="二进制日志binary-log"><a href="#二进制日志binary-log" class="headerlink" title="二进制日志binary log"></a>二进制日志binary log</h3><ul>
<li>二进制日志：<br>记录导致数据改变或潜在导致数据改变的SQL语句<br>记录已提交的日志<br>不依赖于存储引擎类型<br>功能：通过“重放”日志文件中的事件来生成数据副本 </li>
<li>中继日志：<strong>relay log</strong><br>主从复制架构中，从服务器用于保存从主服务器的二进制日志中读取的事件<blockquote>
<p>注意：强烈建议开启，建议二进制日志和数据文件分开存放</p>
</blockquote>
</li>
</ul>
<h4 id="二进制日志记录格式"><a href="#二进制日志记录格式" class="headerlink" title="二进制日志记录格式"></a>二进制日志记录格式</h4><ul>
<li>二进制日志记录三种格式</li>
</ul>
<ol>
<li>基于“语句”记录：statement，记录语句</li>
<li>基于“行”记录：row，记录数据，日志量较大，<strong>建议使用此格式</strong> </li>
<li>混合模式：mixed, 让系统自行判定该基于哪种方式进行  <blockquote>
<p>格式配置<br>show variables like ‘binlog_format’;</p>
</blockquote>
</li>
</ol>
<ul>
<li>二进制日志文件的构成<br>有两类文件<br><strong>日志文件</strong>：mysql|mariadb-bin.文件名后缀，二进制格式<br>如： mariadb-bin.000001<br><strong>索引文件</strong>：mysql|mariadb-bin.index，文本格式  </li>
</ul>
<h4 id="二进制日志相关的服务器变量："><a href="#二进制日志相关的服务器变量：" class="headerlink" title="二进制日志相关的服务器变量："></a>二进制日志相关的服务器变量：</h4><p><strong>建议启用并将二进制日志和数据库文件分开存放</strong><br><strong>指定日志记录格式为row行记录</strong>  </p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>sql_log_bin</strong></td>
<td>是否记录二进制日志，默认ON</td>
</tr>
<tr>
<td><strong>log_bin</strong></td>
<td>指定文件位置；默认OFF，表示不启用二进制日志功能，上述两项都开启才可以启用</td>
</tr>
<tr>
<td><strong>binlog_format</strong></td>
<td>STATEMENT\</td>
<td>ROW\</td>
<td>MIXED，二进制日志记录的格式</td>
</tr>
<tr>
<td>max_binlog_size</td>
<td>单个二进制日志文件的最大体积，到达最大值会自动滚动，默认为1G</td>
</tr>
<tr>
<td>sync_binlog</td>
<td>设定是否启动二进制日志即时同步磁盘功能，默认0，由操作系统负责同步日志到磁盘</td>
</tr>
<tr>
<td>expire_logs_days</td>
<td>二进制日志可以自动删除的天数。默认为0，即不自动删除</td>
</tr>
</tbody>
</table>
<blockquote>
<p>set sql_log_bin=off;<br>可以在导入大量数据或者还原数据时临时禁用，以免产生大量日志内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件启用二进制并指定记录格式</span><br><span class="line">1、创建单独的文件夹存放二进制日志</span><br><span class="line">mkdir /data/mysql/binlog</span><br><span class="line">2、注意修改文件夹的权限</span><br><span class="line">chown mysql.mysql /data/mysql/binlog/</span><br><span class="line">3、修改配置文件</span><br><span class="line">[mysqld]</span><br><span class="line">log_bin=/data/mysql/binlog/mysql  #=后面要填写路径并且写明二进制文件的前缀为mysql或mariadb</span><br><span class="line">binlog_format=row  #指定记录格式为row</span><br><span class="line">4、重启服务</span><br><span class="line">systemctl restart mariadb</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="二进制日志相关配置"><a href="#二进制日志相关配置" class="headerlink" title="二进制日志相关配置"></a>二进制日志相关配置</h4><p>查看mariadb自行管理使用中的二进制日志文件列表，及大小<br><code>SHOW {BINARY | MASTER} LOGS;</code><br>查看使用中的二进制日志文件<br><code>SHOW MASTER STATUS;</code><br>查看二进制文件中的指定内容<br>SHOW BINLOG EVENTS [IN ‘log_name’] [FROM pos] [LIMIT [offset,] row_count]<br>查看日志从POS 6516开始跳过后面2个查看下面的3个记录<br><code>show binlog events in &#39;mysql-bin.000001&#39; from 6516 limit 2,3;</code></p>
<h4 id="mysqlbinlog：二进制日志的客户端命令工具"><a href="#mysqlbinlog：二进制日志的客户端命令工具" class="headerlink" title="mysqlbinlog：二进制日志的客户端命令工具"></a>mysqlbinlog：二进制日志的客户端命令工具</h4><p>命令格式：<br>mysqlbinlog [OPTIONS] log_file…<br>–start-position=# 指定开始位置<br>–stop-position=#<br>–start-datetime=<br>–stop-datetime=<br>时间格式：<br>YYYY-MM-DD hh:mm:ss<br>详细输出格式：<br>–base64-output[=name]<br>-v -vvv<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">#规定起始点和结束点的查询</span><br><span class="line">mysqlbinlog --start-position=6787 --stop-position=7527 /var/lib/mysql/mariadb-bin.000003 -v</span><br><span class="line">#按照时间短查看</span><br><span class="line">mysqlbinlog --start-datetime=&quot;2018-12-7 11:10:10&quot; --stop-datetime=&quot;2018-12-7 11:35:22&quot;  /data/mysql/binlog/mysql.000002  -vvv</span><br></pre></td></tr></table></figure></p>
<h4 id="管理日志"><a href="#管理日志" class="headerlink" title="管理日志"></a>管理日志</h4><ul>
<li><p>清除指定二进制日志：<br>PURGE { BINARY | MASTER } LOGS { TO ‘log_name’ | BEFORE datetime_expr }    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">PURGE BINARY LOGS TO &apos;-bin.000003&apos;; #删除编号3之前的日志</span><br><span class="line">PURGE BINARY LOGS BEFORE &apos;2017-01-23&apos;; #删除指定日期之前的日志</span><br><span class="line">PURGE BINARY LOGS BEFORE &apos;2017-03-22 09:25:30&apos;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除所有二进制日志，index文件重新记数<br><code>RESET MASTER [TO #];</code><br>删除所有二进制日志文件，并重新生成日志文件，文件名从#开始记数，默认从1开始，一般是master主机第一次启动时执行，MariaDB10.1.6开始支持TO #   </p>
</li>
<li>切换日志文件：<br><code>FLUSH LOGS;</code></li>
</ul>
<h1 id="备份还原"><a href="#备份还原" class="headerlink" title="备份还原"></a>备份还原</h1><p>完全备份：整个数据集<br>增量备份：仅备份最近一次完全备份或增量备份（如果存在增量）以来变化的数据，备份较快，还原复杂<br>差异备份：仅备份<strong>最近一次完全备份</strong>以来变化的数据，备份较慢，还原简单   </p>
<blockquote>
<p>注意：二进制日志文件不应该与数据文件放在同一磁盘</p>
</blockquote>
<p>冷、温、热备份<br>冷备：读写操作均不可进行<br>温备：读操作可执行；但写操作不可执行 #通过读锁实现<br>热备：读写操作均可执行<br>MyISAM：温备，不支持热备<br>InnoDB：都支持   </p>
<h2 id="mysqldump工具"><a href="#mysqldump工具" class="headerlink" title="mysqldump工具"></a>mysqldump工具</h2><p>Schema和数据存储在一起、巨大的SQL语句、单个巨大的备份文件<br>mysqldump工具：客户端命令，通过mysql协议连接至mysql服务器进行备份<br><code>mysqldump [OPTIONS] database [tables]</code>  #每次单独备份一个<br><code>mysqldump [OPTIONS] –B DB1 [DB2 DB3...]</code><br><code>mysqldump [OPTIONS] –A [OPTIONS]</code>  #完整备份所有数据库 -A=–all-databases<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">第一种方式：不推荐使用</span><br><span class="line">mysqldump heloodb &gt; hellodb_bak.sql #利用重定向备份所有的sql语句，不包含数据库只包含表内容</span><br><span class="line">mysql -e &apos;create database hellodb&apos;  #创建相同结构的数据</span><br><span class="line">mysql hellodb &lt; hellodb_bak.sql     #指定要还原到哪个数据库</span><br><span class="line"></span><br><span class="line">第二种方式：备份指定的数据文件</span><br><span class="line">mysqldump -B hellodb &gt; hello_bak_B.sql   #包含数据库结构和数据表内容</span><br><span class="line">mysql &lt; hellodb_bak_B.sql                #直接还原数据库及内容</span><br><span class="line"></span><br><span class="line">mysqldump -B hellodb | xz &gt; hellodb_bak.sql.xz  #直接备份压缩数据</span><br><span class="line"></span><br><span class="line">第三种方式： 生产环境常用方式</span><br><span class="line">mysqldump -A &gt; hellodb_bak.sql   #备份所有数据库及内容（包含存储过程，触发器等）</span><br><span class="line"></span><br><span class="line">使用主从复制使用--master-data=1</span><br><span class="line">mysqldump -A --master-data=1 &gt; hellodb_bak.sql  #标记备份时间点的二进制文件起始点</span><br><span class="line">不使用主从复制使用--master-data=2</span><br><span class="line">mysqldump -A --master-data=2 &gt; hellodb_bak.sql  #标记备份时间点的二进制文件起始点，但加上注释，默认不启用</span><br><span class="line"></span><br><span class="line">mysqldump -A --master-data=1 -F &gt; hellodb_bak.sql   #刷新二进制文件，保持二进制和备份数据的同步分离，可以很方便的找到备份日期之后的二进制文件，以便还原和查询</span><br></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>-A</strong>， –all-databases</td>
<td>备份所有数据库，含create database</td>
</tr>
<tr>
<td><strong>-B</strong> , –databases db_name</td>
<td>指定备份的数据库，包括create database语句</td>
</tr>
<tr>
<td>-E, –events</td>
<td>备份相关的所有event scheduler</td>
</tr>
<tr>
<td>-R, –routines</td>
<td>备份所有存储过程和自定义函数</td>
</tr>
<tr>
<td>–triggers</td>
<td>备份表相关触发器，默认启用,用–skip-triggers，不备份触发</td>
</tr>
<tr>
<td><strong>–default-character-set=utf8</strong></td>
<td>指定字符集，备份前注意确认字符集</td>
</tr>
<tr>
<td><strong>–master-data[=#]</strong></td>
<td>此选项须启用二进制日志，1：所备份的数据之前加一条记录为CHANGE MASTER TO语句，非注释，不指定#，默认为1；2：记录为注释的CHANGE MASTER TO语句</td>
</tr>
<tr>
<td><strong>-F</strong>, –flush-logs</td>
<td>备份前滚动日志，锁定表完成后，执行flush logs命令,生成新的二进制日志文件，配合-A 或 -B 选项时，会导致刷新多次数据库。建议在同一时刻执行转储和日志刷新，可通过和–single-transaction或-x，–master-data 一起使用实现，此时只刷新一次日志</td>
</tr>
<tr>
<td>–compact</td>
<td>去掉注释，适合调试，生产不使用</td>
</tr>
<tr>
<td>-d, –no-data</td>
<td>只备份表结构</td>
</tr>
<tr>
<td>-t, –no-create-info</td>
<td>只备份数据,不备份create table</td>
</tr>
<tr>
<td>-n,–no-create-db</td>
<td>不备份create database，可被-A或-B覆盖</td>
</tr>
<tr>
<td>–flush-privileges</td>
<td>备份mysql或相关时需要使用</td>
</tr>
<tr>
<td>-f, –force</td>
<td>忽略SQL错误，继续执行</td>
</tr>
<tr>
<td>–hex-blob</td>
<td>使用十六进制符号转储二进制列，当有包括BINARY，VARBINARY，BLOB，BIT的数据类型的列时使用，避免乱码</td>
</tr>
<tr>
<td>-q, –quick</td>
<td>不缓存查询，直接输出，加快备份速度</td>
</tr>
</tbody>
</table>
<blockquote>
<p>备份时要指定默认字符集，mysqldump默认为utf8<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">利用for循环实现分库备份</span><br><span class="line">for db in `mysql -e &apos;show databases&apos; | grep -Ev &apos;^(Database|information_schema|performance_schema)$&apos;`;do mysqldump -B $db | gzip &gt; $db`date +%F`.sql.gz;done</span><br><span class="line"></span><br><span class="line">利用管道实现分库备份</span><br><span class="line">mysql -e &apos;show databases&apos; | grep -Ev &apos;^(Database|information_schema|performance_schema)$&apos; | sed -r &apos;s@(.*)@mysqldump -B \1 | gzip &gt; \/data\/\1`date +%F`.sql.gz@&apos; | bash</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="MyISAM备份"><a href="#MyISAM备份" class="headerlink" title="MyISAM备份"></a>MyISAM备份</h2><p>支持温备；不支持热备，所以必须先锁定要备份的库，而后启动备份操作<br>锁定方法如下：<br>-x,–lock-all-tables：<strong>加全局读锁</strong>，锁定所有库的所有表，同时加–singletransaction或–lock-tables选项会关闭此选项功能<br>注意：数据量大时，可能会导致长时间无法并发访问数据库<br>-l,–lock-tables：对于需要备份的每个数据库，在启动备份之前<strong>分别锁定</strong>其所有表，默认为on,–skip-lock-tables选项可禁用,对备份MyISAM的多个库,可能会造成数据不一致</p>
<blockquote>
<p> myisam 推荐使用-x  -A</p>
</blockquote>
<h2 id="InnoDB备份"><a href="#InnoDB备份" class="headerlink" title="InnoDB备份"></a>InnoDB备份</h2><p>支持热备，可用温备但不建议用<br><strong>–single-transaction</strong><br>此选项Innodb中推荐使用，不适用MyISAM，此选项会开始备份前，先执行START TRANSACTION指令开启事务  </p>
<p>此选项通过在单个事务中转储所有表来创建一致的快照。 仅适用于存储在支持多版本控制的存储引擎中的表（目前只有InnoDB可以）; 转储不保证与其他存储引擎保持一致。<br>在进行单事务转储时，要确保有效的转储文件（正确的<br>表内容和二进制日志位置），没有其他连接应该使用以下语句：<code>ALTER TABLE，DROP TABLE，RENAME TABLE，TRUNCATE TABLE</code><br>此选项和–lock-tables（此选项隐含提交挂起的事务）选项是相互排斥    </p>
<blockquote>
<p>备份大型表时，建议将–single-transaction选项和–quick结合一起使用</p>
</blockquote>
<h1 id="生产环境实战备份策略"><a href="#生产环境实战备份策略" class="headerlink" title="生产环境实战备份策略"></a>生产环境实战备份策略</h1><h3 id="InnoDB建议备份策略"><a href="#InnoDB建议备份策略" class="headerlink" title="InnoDB建议备份策略"></a>InnoDB建议备份策略</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump –uroot –A –F --single-transaction --master-data=2 --default-character-set=utf8 --hex-blob &gt; $BACKUP/fullbak_$BACKUP_`data +%F`.sql</span><br></pre></td></tr></table></figure>
<h3 id="MyISAM建议备份策略"><a href="#MyISAM建议备份策略" class="headerlink" title="MyISAM建议备份策略"></a>MyISAM建议备份策略</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump –uroot –A –F –x --master-data=2 --default-character-set=utf8 --hex-blob &gt; $BACKUP/fullbak_$BACKUP_`data +%F`.sql</span><br></pre></td></tr></table></figure>
<h3 id="恢复数据库示例："><a href="#恢复数据库示例：" class="headerlink" title="恢复数据库示例："></a>恢复数据库示例：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">保证数据库文件和二进制日志文件分开存放</span><br><span class="line">确认数据库字符集和存储引擎</span><br><span class="line">mysql -plinux -e &apos;show create database hellodb&apos;</span><br><span class="line">mysql -plinux -e &quot;show variables like &apos;character%&apos;&quot;</span><br><span class="line">mysql -plinux -e &apos;show table status from hellodb&apos;</span><br><span class="line"></span><br><span class="line">1、备份原有数据库</span><br><span class="line">mysqldump -plinux -A --single-transaction -F --master-data=2 | gzip &gt; /data/all_bak_`date +%F`.sql.gz</span><br><span class="line">2、模拟误删除</span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line">3、使用防火墙禁止用户连接数据库</span><br><span class="line">4、重启数据库</span><br><span class="line">5、临时禁用二进制日志</span><br><span class="line">set sql_log_bin=off;</span><br><span class="line">show variables like &apos;sql_log_bin&apos;;</span><br><span class="line">6、保持当前mysql会话，导入完整备份</span><br><span class="line">source /data/all_bak2018-12-08.sql</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers;</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line">| TID | Name         | Age | Gender |</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line">|   4 | Lin Chaoying |  93 | F      |</span><br><span class="line">|   7 | aaav         | 223 | NULL   |</span><br><span class="line">|   8 | aadv         | 223 | NULL   |</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line"></span><br><span class="line">7、另开一SSH窗口，查看完整备份，查找二进制日志起始点还原</span><br><span class="line">cat /data/all_bak2018-12-08.sql |less</span><br><span class="line">--CHANGE MASTER TO MASTER_LOG_FILE=&apos;mysql.000013&apos;, MASTER_LOG_POS=377;</span><br><span class="line">8、另开一SSH窗口，确认二进制日志的位置，并且将后续所有日志导入到增量sql文件</span><br><span class="line">mysqlbinlog /data/mysql/binlog/mysql.000013 --start-position=377 &gt; incr.sql</span><br><span class="line">mysqlbinlog /data/mysql/binlog/mysql.000014 &gt;&gt; incr.sql</span><br><span class="line">9、回到保持打开的mysql会员，还原二进制日志</span><br><span class="line">MariaDB [hellodb]&gt; source /root/incr.sql;</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers;</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line">| TID | Name         | Age | Gender |</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line">|   4 | Lin Chaoying |  93 | F      |</span><br><span class="line">|   7 | aaav         | 223 | NULL   |</span><br><span class="line">|   8 | aadv         | 223 | NULL   |</span><br><span class="line">|   9 | aagq         |  67 | NULL   |</span><br><span class="line">|  10 | jk           |  67 | NULL   |</span><br><span class="line">+-----+--------------+-----+--------+</span><br><span class="line">10、开启二进制日志，还原防火墙，允许用户访问</span><br><span class="line">set sql_log_bin=on;</span><br></pre></td></tr></table></figure>
<h1 id="xtrabackup"><a href="#xtrabackup" class="headerlink" title="xtrabackup"></a>xtrabackup</h1><p>percona提供的mysql数据库备份工具，惟一开源的能够对innodb和xtradb数据库进行热备的工具<br>特点：<br>备份还原过程快速、可靠<br>备份过程不会打断正在执行的事务<br>能够基于压缩等功能节约磁盘空间和流量<br>自动实现备份检验<br>开源，免费   </p>
<p>xtrabackup安装：<br>yum install percona-xtrabackup 在EPEL源中<br>最新版本下载安装：<br><a href="https://www.percona.com/downloads/XtraBackup/LATEST/" target="_blank" rel="noopener">https://www.percona.com/downloads/XtraBackup/LATEST/</a></p>
<h2 id="xtrabackup用法"><a href="#xtrabackup用法" class="headerlink" title="xtrabackup用法"></a>xtrabackup用法</h2><h3 id="备份：innobackupex-option-BACKUP-ROOT-DIR"><a href="#备份：innobackupex-option-BACKUP-ROOT-DIR" class="headerlink" title="备份：innobackupex [option] BACKUP-ROOT-DIR"></a>备份：innobackupex [option] BACKUP-ROOT-DIR</h3><p>选项说明：<a href="https://www.percona.com/doc/percona-xtrabackup/LATEST/genindex.html" target="_blank" rel="noopener">https://www.percona.com/doc/percona-xtrabackup/LATEST/genindex.html</a></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>–user</td>
<td>备份账号</td>
</tr>
<tr>
<td>–password</td>
<td>备份的密码</td>
</tr>
<tr>
<td>–host</td>
<td>数据库的地址</td>
</tr>
<tr>
<td>–databases</td>
<td>数据库名，如果要指定多个数据库，彼此间需要以<strong>空格隔开</strong>；如：”xtra_test dba_test”，同时，在指定某数据库时，也可以只指定其中的某张表。如：”mydatabase.mytable”。该选项对innodb引擎表无效，还是会备份所有innodb表</td>
</tr>
<tr>
<td>–defaults-file</td>
<td>从哪个文件读取MySQL配置，必须放在命令行第一个选项位置</td>
</tr>
<tr>
<td>–incremental</td>
<td>创建一个增量备份，需要指定–incremental-basedir</td>
</tr>
<tr>
<td>–incremental-basedir</td>
<td><strong>指定为前一次全备份或增量备份的目录</strong>，与–incremental同时使用</td>
</tr>
<tr>
<td>–incremental-dir</td>
<td>还原时增量备份的目录</td>
</tr>
<tr>
<td>–include=name</td>
<td>表名，格式：databasename.tablename</td>
</tr>
</tbody>
</table>
<h3 id="整理Prepare：innobackupex-–apply-log-option-BACKUP-DIR"><a href="#整理Prepare：innobackupex-–apply-log-option-BACKUP-DIR" class="headerlink" title="整理Prepare：innobackupex –apply-log [option] BACKUP-DIR"></a>整理Prepare：innobackupex –apply-log [option] BACKUP-DIR</h3><table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>–apply-log</strong></td>
<td>一般情况下,在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处理不一致状态。此选项作用是<strong>通过回滚未提交的事务及同步已经提交的事务至数据文件使数据文件处于一致性状态</strong></td>
</tr>
<tr>
<td>–use-memory</td>
<td>和–apply-log选项一起使用，当prepare 备份时，做crash recovery分配的内存大小，单位字节，也可1MB,1M,1G,1GB等，推荐1G</td>
</tr>
<tr>
<td>–export</td>
<td>表示开启可导出单独的表之后再导入其他Mysql中</td>
</tr>
<tr>
<td><strong>–redo-only</strong></td>
<td>一般写在增量文件还原中， 写在非最后一个备份文件的选项，<strong>不回滚未完成的事务或查询操作</strong>，避免出现数据破坏 </td>
</tr>
</tbody>
</table>
<h3 id="还原：innobackupex-–copy-back-选项-BACKUP-DIR"><a href="#还原：innobackupex-–copy-back-选项-BACKUP-DIR" class="headerlink" title="还原：innobackupex –copy-back [选项] BACKUP-DIR"></a>还原：innobackupex –copy-back [选项] BACKUP-DIR</h3><p>innobackupex –move-back [选项] [–defaults-group=GROUP-NAME]<br>BACKUP-DIR<br>选项 | 说明<br>—|—<br>–copy-back | 做数据恢复时将备份数据文件拷贝到MySQL服务器的datadir<br>–move-back | 这个选项与–copy-back相似，唯一的区别是它不拷贝文件，而是移动文件到目的地。这个选项移除backup文件，用时候必须小心。使用场景：没有足够的磁盘空间同事保留数据文件和Backup副本</p>
<h4 id="还原注意事项"><a href="#还原注意事项" class="headerlink" title="还原注意事项"></a>还原注意事项</h4><ol>
<li>datadir <strong>目录必须为空</strong>。除非指定innobackupex –force-non-emptydirectorires选项指定，否则–copy-backup选项不会覆盖</li>
<li>在restore之前,<strong>必须shutdown MySQL实例</strong>，不能将一个运行中的实例<br>restore到datadir目录中</li>
<li>由于文件属性会被保留，大部分情况下需要在启动实例之前将文件的<strong>属主改为mysql</strong>，这些文件将属于创建备份的用户<br><code>chown -R mysql:mysql /data/mysql</code><br>以上需要在用户调用innobackupex之前完成<br>–force-non-empty-directories：指定该参数时候，使得innobackupex –copy-back或–move-back选项转移文件到非空目录，已存在的文件不会被覆盖。<br>如果–copy-back和–move-back文件需要从备份目录拷贝一个在datadir已经存在的文件，会报错失败</li>
</ol>
<h2 id="备份生成的相关文件"><a href="#备份生成的相关文件" class="headerlink" title="备份生成的相关文件"></a>备份生成的相关文件</h2><ol>
<li>xtrabackup_info：innobackupex工具执行时的相关信息，包括版本，备份选项，备份时长，备份LSN(log sequence number日志序列号)，BINLOG的位置</li>
<li>xtrabackup_checkpoints：备份类型（如完全或增量）、备份状态（如是否已经为prepared状态）和LSN范围信息,每个InnoDB页(通常为16k大小)都会包含一个日志序列号LSN。<strong>LSN是整个数据库系统的系统版本号，每个页面相关的LSN能够表明此页面最近是如何发生改变的</strong></li>
<li>xtrabackup_binlog_info：MySQL服务器当前正在使用的二进制日志文件及至备份这一刻为止二进制日志事件的位置，可利用实现基于binlog的恢复</li>
<li>backup-my.cnf：备份命令用到的配置选项信息</li>
<li>xtrabackup_logfile：备份生成的日志文件</li>
</ol>
<h2 id="备份还原示例"><a href="#备份还原示例" class="headerlink" title="备份还原示例"></a>备份还原示例</h2><h4 id="新版xtrabackup完整备份还原"><a href="#新版xtrabackup完整备份还原" class="headerlink" title="新版xtrabackup完整备份还原"></a>新版xtrabackup完整备份还原</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1、在数据库服务器完整备份</span><br><span class="line">xtrabackup --backup --target-dir=/data/db_backup</span><br><span class="line">2、将备份下来的目录拷贝到需要还原的主机</span><br><span class="line">scp -r /data/db_backup/ 192.168.34.7:/data</span><br><span class="line">3、预准备：确保数据一致，提交完成的事务，回滚未完成的事务</span><br><span class="line">xtrabackup --prepare --target-dir=/data/db_backup</span><br><span class="line">4、复制到数据库目录</span><br><span class="line"> 注意：数据库目录必须为空，MySQL服务不能启动</span><br><span class="line"> xtrabackup --copy-back --target-dir=/data/db_backup</span><br><span class="line">5、确保备份文件属性</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql</span><br><span class="line">6、启动服务验证</span><br><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure>
<h4 id="新版xtrabackup完全，增量备份及还原"><a href="#新版xtrabackup完全，增量备份及还原" class="headerlink" title="新版xtrabackup完全，增量备份及还原"></a>新版xtrabackup完全，增量备份及还原</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1 备份过程</span><br><span class="line"> 1）完全备份：xtrabackup --backup --target-dir=/data/db_backup/base/</span><br><span class="line"> 2）第一次修改数据</span><br><span class="line"> 3）第一次增量备份到完整备份目录</span><br><span class="line"> xtrabackup --backup --target-dir=/data/db_backup/inc1/ --incremental-basedir=/data/db_backup/base</span><br><span class="line"> 4）第二次修改数据</span><br><span class="line"> 5）第二次增量备份到第一次增量备份目录</span><br><span class="line"> xtrabackup --backup --target-dir=/data/db_backup/inc2/ --incremental-basedir=/data/db_backup/inc1</span><br><span class="line"> 6）scp -r /data/db_backup/ 192.168.34.7:/data/</span><br><span class="line">2还原过程</span><br><span class="line">1）预准备完成备份，此选项--apply-log-only 阻止回滚未完成的事务</span><br><span class="line">xtrabackup --prepare --apply-log-only --target-dir=/data/db_backup/base</span><br><span class="line">2）合并第1次增量备份到完全备份</span><br><span class="line">xtrabackup --prepare --apply-log-only --target-dir=/data/db_backup/base --incremental-dir=/data/db_backup/inc1</span><br><span class="line">3）合并第2次增量备份到完全备份：最后一次还原不需要加选项--apply-log-only</span><br><span class="line">xtrabackup --prepare --target-dir=/data/db_backup/base --incremental-dir=/data/db_backup/inc2</span><br><span class="line">4）复制到数据库目录，注意数据库目录必须为空，MySQL服务不能启动</span><br><span class="line">xtrabackup --copy-back --target-dir=/data/db_backup/base</span><br><span class="line">5）还原属性：chown -R mysql.mysql /var/lib/mysql</span><br><span class="line">6）启动服务：systemctl start mariadb</span><br></pre></td></tr></table></figure>
<h4 id="旧版xtrabackup完全，增量备份及还原"><a href="#旧版xtrabackup完全，增量备份及还原" class="headerlink" title="旧版xtrabackup完全，增量备份及还原"></a>旧版xtrabackup完全，增量备份及还原</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1 在原主机</span><br><span class="line">innobackupex /backups</span><br><span class="line">mkdir /backups/inc&#123;1,2&#125;</span><br><span class="line">修改数据库内容</span><br><span class="line">innobackupex --incremental /backups/inc1 --incrementalbasedir=/backups/2018-02-23_14-21-42（完全备份生成的路径）</span><br><span class="line">再次修改数据库内容</span><br><span class="line">innobackupex --incremental /backups/inc2 --incrementalbasedir=/backups/inc1/2018-02-23_14-26-17</span><br><span class="line">（上次增量备份生成的路径）</span><br><span class="line">scp -r /backups/* 目标主机:/data/</span><br><span class="line">2 在目标主机</span><br><span class="line">不启动mariadb</span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line">innobackupex --apply-log --redo-only   /data/2018-02-23_14-21-42/  #--redo-only阻止回滚事务</span><br><span class="line">innobackupex --apply-log --redo-only /data/2018-02-23_14-21-42/ --incremental-dir=/data/inc1/2018-02-23_14-26-17</span><br><span class="line">innobackupex --apply-log /data/2018-02-23_14-21-42/ --incrementaldir=/data/inc2/2018-02-23_14-28-29/</span><br><span class="line">ls /var/lib/mysql/  #最后一次不需加--redo-only</span><br><span class="line">innobackupex --copy-back /data/2018-02-23_14-21-42/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql/</span><br><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure>
<h1 id="MySQL复制"><a href="#MySQL复制" class="headerlink" title="MySQL复制"></a>MySQL复制</h1><p>扩展方式： Scale Up（纵向扩展） ，Scale Out（横向扩展）   </p>
<ul>
<li>MySQL的扩展<br>读写分离<br>复制：每个节点都有相同的数据集<br>向外扩展<br><strong>二进制日志</strong><br>单向   </li>
<li>复制的功用：<br>数据分布<br>负载均衡读<br>备份<br>高可用和故障切换<br>MySQL升级测试   </li>
</ul>
<h1 id="MySQL复制-1"><a href="#MySQL复制-1" class="headerlink" title="MySQL复制"></a>MySQL复制</h1><p>主从复制线程：      </p>
<ul>
<li>主节点：<br>dump Thread：为每个Slave的I/O<br>Thread启动一个dump线程，用于向其发送binary log events  </li>
<li>从节点：<br>I/O Thread：向Master请求二进制日志事件，并保存于中继日志中<br>SQL Thread：从中继日志中读取日志事件，在本地完成重放</li>
<li>跟复制功能相关的文件：<br>master.info：用于保存slave连接至master时的相关信息，例如账号、密码、服务器地址等<br>relay-log.info：保存在当前slave节点上已经复制的当前二进制日志和本地replay log日志的对应关系      <blockquote>
<p>主从配置过程：参看官网<br><a href="https://mariadb.com/kb/en/library/setting-up-replication/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/setting-up-replication/</a><br><a href="https://dev.mysql.com/doc/refman/5.5/en/replication-configuration.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.5/en/replication-configuration.html</a>   </p>
</blockquote>
</li>
</ul>
<h2 id="主从复制配置"><a href="#主从复制配置" class="headerlink" title="主从复制配置"></a>主从复制配置</h2><h3 id="主节点"><a href="#主节点" class="headerlink" title="主节点"></a>主节点</h3><p>主节点配置：   </p>
<ol>
<li>启用二进制日志<br>[mysqld]<br><code>log_bin</code>   </li>
<li>为当前节点设置一个全局惟一的ID号<br>[mysqld]<br><code>server_id=#</code>   </li>
<li>创建有复制权限的用户账号<br><code>GRANT REPLICATION SLAVE ON *.* TO &#39;repluser&#39;@&#39;HOST&#39; IDENTIFIED BY
&#39;replpass&#39;;</code><h3 id="从节点"><a href="#从节点" class="headerlink" title="从节点"></a>从节点</h3>从节点配置：   </li>
<li><p>启动中继日志 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]     </span><br><span class="line">server_id=#  #为当前节点设置一个全局惟的ID号   </span><br><span class="line">read_only=ON #设置数据库只读</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用有复制权限的用户账号连接至主服务器，并启动复制线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO MASTER_HOST=&apos;host&apos;,                       #主节点IP</span><br><span class="line">       MASTER_USER=&apos;repluser&apos;, </span><br><span class="line">       MASTER_PASSWORD=&apos;replpass&apos;,                                #连接主节点用户和密码</span><br><span class="line">       MASTER_LOG_FILE=&apos; mariadb-bin.xxxxxx&apos;, </span><br><span class="line">       MASTER_LOG_POS=#;                                          #指定要同步的二进制文件和起始点</span><br><span class="line">mysql&gt; START SLAVE [IO_THREAD|SQL_THREAD];                        #开启从服务线程</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="一主一从示例："><a href="#一主一从示例：" class="headerlink" title="一主一从示例："></a>一主一从示例：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">主节点:</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=/data/binlog/mysql</span><br><span class="line">binlog_format=row</span><br><span class="line">创建授权用户</span><br><span class="line">MariaDB [(none)]&gt; grant replication slave on *.* to repuser@&apos;192.168.34.%&apos; identified by &apos;linux&apos;;</span><br><span class="line"></span><br><span class="line">从节点：</span><br><span class="line">修改配置文件:</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">read-only=on</span><br><span class="line">设置mysql slave服务</span><br><span class="line">help change master to; #通过帮助查看slave系统命令</span><br><span class="line">  CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=&apos;192.168.34.8&apos;,      #主服务IP</span><br><span class="line">  MASTER_USER=&apos;repuser&apos;,           #同步授权账户</span><br><span class="line">  MASTER_PASSWORD=&apos;linux&apos;,         #账户密码</span><br><span class="line">  MASTER_PORT=3306,                #mariadb端口</span><br><span class="line">  MASTER_LOG_FILE=&apos;mysql.000001&apos;,  #想使用的二进制文件</span><br><span class="line">  MASTER_LOG_POS=245;              #此二进制文件同步的起始点</span><br><span class="line"></span><br><span class="line">启动slave进程</span><br><span class="line">start slave</span><br><span class="line">查看slave进程状态</span><br><span class="line">show slave status\G</span><br></pre></td></tr></table></figure>
<h4 id="扩展已有的主节点，到新增的从节点"><a href="#扩展已有的主节点，到新增的从节点" class="headerlink" title="扩展已有的主节点，到新增的从节点"></a>扩展已有的主节点，到新增的从节点</h4><p>如果主节点已经运行了一段时间，且有大量数据时，如何配置并启动slave节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1、通过备份主节点的数据还原到新增的从节点主机</span><br><span class="line">mysqldump -A -F --single-transaction --master-data=1 &gt; /data/all_bak`date +%F`.sql</span><br><span class="line">2、将备份文件拷贝到新从节点</span><br><span class="line">scp /data/all_bak2018-12-09.sql 192.168.34.9:/data/</span><br><span class="line">3、修改编辑备份文件，将主从配置写入</span><br><span class="line">利用原有--master-data生成的内容，添加以下内容</span><br><span class="line">vim /data/all_bak2018-12-09.sql</span><br><span class="line">  CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=&apos;192.168.34.8&apos;,</span><br><span class="line">  MASTER_USER=&apos;repuser&apos;,</span><br><span class="line">  MASTER_PASSWORD=&apos;linux&apos;,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=&apos;mysql.000002&apos;, MASTER_LOG_POS=245;  </span><br><span class="line">4、导入数据库文件</span><br><span class="line">mysql &lt; /data/all_bak2018-12-09.sql</span><br><span class="line">5、开启slave进程，验证同步</span><br><span class="line">MariaDB [(none)]&gt; start slave;</span><br></pre></td></tr></table></figure></p>
<h4 id="手动提升从节点，切换主从复制"><a href="#手动提升从节点，切换主从复制" class="headerlink" title="手动提升从节点，切换主从复制"></a>手动提升从节点，切换主从复制</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">当主节点服务器发生故障，需要临时切换一个从节点为主节点</span><br><span class="line">1、清楚原有的从节点信息</span><br><span class="line">MariaDB [(none)]&gt; stop slave;         #需要先停止slave进程</span><br><span class="line">MariaDB [(none)]&gt; reset slave all;    #清楚原有slave信息</span><br><span class="line">2、修改要提升的从服务器mysql配置文件</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">#read-only=on          #禁用只读</span><br><span class="line">binlog_format=row      #采用行存储二进制 </span><br><span class="line">log-bin                #启用二进制日志</span><br><span class="line">重启服务</span><br><span class="line">systemctl restart mariadb</span><br><span class="line">3、在其它从节点上配置新的主节点信息</span><br><span class="line">1）清理原有的slave信息</span><br><span class="line">MariaDB [(none)]&gt; stop slave;         #需要先停止slave进程</span><br><span class="line">MariaDB [(none)]&gt; reset slave all;    #清楚原有slave信息</span><br><span class="line">2）在新的主节点上查看二进制日志信息，确定要同步的起始点</span><br><span class="line">MariaDB [(none)]&gt; show master logs;</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| Log_name           | File_size |</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">| mariadb-bin.000001 |       264 |</span><br><span class="line">| mariadb-bin.000002 |       245 |</span><br><span class="line">+--------------------+-----------+</span><br><span class="line">3）添加主节点配置信息</span><br><span class="line">CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=&apos;192.168.34.7&apos;,</span><br><span class="line">  MASTER_USER=&apos;repuser&apos;,</span><br><span class="line">  MASTER_PASSWORD=&apos;linux&apos;,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=&apos;mariadb-bin.000002&apos;,</span><br><span class="line">  MASTER_LOG_POS=245;</span><br><span class="line">4）启动slave进程</span><br><span class="line">MariaDB [(none)]&gt; start slave;</span><br><span class="line">4、验证同步情况</span><br><span class="line">注意新主节点的防火墙配置</span><br></pre></td></tr></table></figure>
<h4 id="启用级联复制节点"><a href="#启用级联复制节点" class="headerlink" title="启用级联复制节点"></a>启用级联复制节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1、主节点配置不需更改</span><br><span class="line">2、修改中间节点配置</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">log-bin            #启用二进制</span><br><span class="line">read-only          #从节点建议启用                                                          </span><br><span class="line">log-slave-updates  #中间节点必须启动此选项</span><br><span class="line">3、次级联节点配置</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=3</span><br><span class="line">read-only</span><br><span class="line">需要将主节点信息指向中间节点</span><br><span class="line">CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=&apos;192.168.34.9&apos;,            #中间节点IP</span><br><span class="line">  MASTER_USER=&apos;repuser&apos;,</span><br><span class="line">  MASTER_PASSWORD=&apos;linux&apos;,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=&apos;mariadb-bin.000001&apos;,  #中间节点的二进制日志</span><br><span class="line">  MASTER_LOG_POS=245;                    #中间节点的二进制起始点</span><br><span class="line">start slave;</span><br><span class="line">4、验证同步情况</span><br></pre></td></tr></table></figure>
<h4 id="主从复制中的错误排查"><a href="#主从复制中的错误排查" class="headerlink" title="主从复制中的错误排查"></a>主从复制中的错误排查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.34.7</span><br><span class="line">                  Master_User: repuser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mariadb-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 488                          #查看已读到的主节点二进制日志信息</span><br><span class="line">               Relay_Log_File: mariadb-relay-bin.000007</span><br><span class="line">                Relay_Log_Pos: 531</span><br><span class="line">        Relay_Master_Log_File: mariadb-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 407                          #目前执行的二进制信息</span><br><span class="line">              Relay_Log_Space: 908</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 4462                         #与主节点同步的时间间隔</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 2</span><br><span class="line"></span><br><span class="line">以上3点是查看同步情况是否成功的主要信息</span><br><span class="line">如遇到错误，可以使用</span><br><span class="line">sql_slave_skip_counter = N #N代表想要跳过的错误数量</span><br></pre></td></tr></table></figure>
<h3 id="复制架构中应该注意的问题："><a href="#复制架构中应该注意的问题：" class="headerlink" title="复制架构中应该注意的问题："></a>复制架构中应该注意的问题：</h3><ol>
<li><strong>限制从服务器为只读</strong><br>在从服务器上设置read_only=ON<blockquote>
<p>注意：此限制对拥有SUPER权限的用户均无效</p>
</blockquote>
</li>
<li>RESET SLAVE<br>在从服务器清除master.info ，relay-log.info, relay log ，开始新的relaylog <blockquote>
<p>注意：需要先STOP SLAVE</p>
</blockquote>
</li>
<li><strong>RESET SLAVE ALL</strong> 清除所有从服务器上设置的主服务器同步信息如：<br>PORT, HOST, USER和 PASSWORD 等</li>
<li><strong>sql_slave_skip_counter = N</strong> 从服务器忽略几个主服务器的复制事件，<br>global变量<blockquote>
<p>修改中间节点的数据与主服务器冲突会影响后续的同步，启用此选项可以忽略某几项冲突</p>
</blockquote>
</li>
<li>如何保证主从复制的事务安全<br>参看<a href="https://mariadb.com/kb/en/library/server-system-variables/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/server-system-variables/</a>   </li>
</ol>
<ul>
<li>在master节点启用参数：<br><code>sync_binlog=1</code> 每次写后立即同步二进制日志到磁盘，性能差<br>如果用到的为InnoDB存储引擎：<br><code>innodb_flush_log_at_trx_commit=1</code> 每次事务提交立即同步日志写磁盘<br><code>innodb_support_xa=ON</code> 默认值，分布式事务MariaDB10.3.0废除<br><code>sync_master_info=#</code> #次事件后master.info同步到磁盘  #启用之后可以集中同步推送</li>
<li>在slave节点启用服务器选项：<br><code>skip_slave_start=ON</code> #不自动启动slave   #默认为false  除第一次手动启动外，后续自动启动</li>
<li>在slave节点启用参数：<br><code>sync_relay_log=#</code> #次写后同步relay log到磁盘<br><code>sync_relay_log_info=#</code> #次事务后同步relay-log.info到磁盘   </li>
</ul>
<h2 id="主主复制"><a href="#主主复制" class="headerlink" title="主主复制"></a>主主复制</h2><p>主主复制：互为主从<br>考虑要点：自动增长id  </p>
<ul>
<li>配置一个节点使用奇数id<br>auto_increment_offset=1   #开始点<br>auto_increment_increment=2 #增长幅度  </li>
<li>另一个节点使用偶数id<br>auto_increment_offset=2<br>auto_increment_increment=2  <blockquote>
<p>容易产生的问题：数据不一致；因此慎用 </p>
</blockquote>
</li>
<li>主主复制的配置步骤：<br>(1) 各节点使用一个惟一server_id<br>(2) 都启动binary log和relay log<br>(3) 创建拥有复制权限的用户账号<br>(4) 定义自动增长id字段的数值范围各为奇偶<br>(5) 均把对方指定为主节点，并启动复制线程  </li>
</ul>
<h2 id="半同步复制"><a href="#半同步复制" class="headerlink" title="半同步复制"></a>半同步复制</h2><p>半同步复制实现：<br>默认情况下，MySQL的复制功能是异步的，异步复制可以提供最佳的性能，主库把binlog日志发送给从库即结束，并不验证从库是否接收完毕。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">主节点：</span><br><span class="line">1、安装半同步插件</span><br><span class="line">INSTALL PLUGIN rpl_semi_sync_master SONAME &apos;semisync_master.so&apos;;</span><br><span class="line">2、修改配置文件启用插件</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=/data/binlog/mysql</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl_semi_sync_master_enabled</span><br><span class="line">rpl_semi_sync_master_timeout = 2000  #超时时长2s</span><br><span class="line">3、验证插件开启情况</span><br><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL VARIABLES LIKE &apos;%semi%&apos;;</span><br><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE &apos;%semi%&apos;;</span><br><span class="line"></span><br><span class="line">从节点：</span><br><span class="line">1、安装插件</span><br><span class="line">INSTALL PLUGIN rpl_semi_sync_slave SONAME &apos;semisync_slave.so&apos;;</span><br><span class="line">2、修改配置文件，启用插件</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">read-only=on</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl_semi_sync_slave_enabled </span><br><span class="line">3、验证插件开启情况</span><br><span class="line">MariaDB [(none)]&gt; select @@rpl_semi_sync_slave_enabled;</span><br><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL VARIABLES LIKE &apos;%semi%&apos;;</span><br><span class="line">4、重启slave线程</span><br><span class="line">MariaDB [(none)]&gt; stop slave;</span><br><span class="line">MariaDB [(none)]&gt; start slave;</span><br><span class="line"></span><br><span class="line">验证同步</span><br><span class="line">只要有一个从节点同步成功，就返回成功</span><br><span class="line">如果所有从节点都出现故障，会利用rpl_semi_sync_master_timeout来判断超时。</span><br></pre></td></tr></table></figure></p>
<h2 id="复制过滤器"><a href="#复制过滤器" class="headerlink" title="复制过滤器"></a>复制过滤器</h2><p>从服务器SQL_THREAD在replay中继日志中的事件时，仅读取与特定数据库(特定表)相关的事件并应用于本地  </p>
<blockquote>
<p>问题：会造成网络及磁盘IO浪费   </p>
</blockquote>
<p>从服务器上的复制过滤器相关变量<br>replicate_do_db= 指定复制库的白名单<br>replicate_ignore_db= 指定复制库黑名单<br>replicate_do_table= 指定复制表的白名单<br>replicate_ignore_table= 指定复制表的黑名单<br>replicate_wild_do_table= foo%.bar% 支持通配符<br>replicate_wild_ignore_table=<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">利用过滤器来指定数据库同步</span><br><span class="line">修改从节点配置文件</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">read-only=on</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl-semi-sync-slave-enabled</span><br><span class="line">replicate_do_db=hellodb   #指定要同步的数据库白名单</span><br><span class="line">重启服务</span><br><span class="line">systemctl restart mariadb</span><br><span class="line"></span><br><span class="line">验证只有hellodb内容可以同步，其它数据库不同步</span><br></pre></td></tr></table></figure></p>
<h1 id="MySQL复制加密"><a href="#MySQL复制加密" class="headerlink" title="MySQL复制加密"></a>MySQL复制加密</h1><p>基于SSL复制：<br>在默认的主从复制过程或远程连接到MySQL/MariaDB所有的链接通信中的数据都是明文的，外网里访问数据或则复制，存在安全隐患。通过SSL/TLS加密的<br>方式进行复制的方法，来进一步提高数据的安全性</p>
<ul>
<li>配置实现：<br>参看：<a href="https://mariadb.com/kb/en/library/replication-with-secureconnections/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/replication-with-secureconnections/</a></li>
</ul>
<ol>
<li>主服务器开启SSL：[mysqld] 加一行ssl<br>主服务器配置证书和私钥；并且创建一个要求必须使用SSL连接的复制账号</li>
<li>从服务器使用CHANGER MASTER TO 命令时指明ssl相关选项<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">创建必要证书文件</span><br><span class="line">1、创建ssl相关文件存放的文件夹</span><br><span class="line">mkdir /etc/my.cnf.d/ssl</span><br><span class="line">2、生成主节点的私钥</span><br><span class="line">(umask 066;openssl genrsa 2048 &gt; cakey.pem)</span><br><span class="line">3、利用私钥生成CA证书</span><br><span class="line">openssl req -new -x509 -key cakey.pem -out cacert.pem -days 3650</span><br><span class="line">4、利用CA证书申请主节点私钥及证书申请文件 </span><br><span class="line">openssl req -newkey rsa:2048 -days 365 -nodes -keyout master.key &gt; master.csr  #nodes生成私钥不加密</span><br><span class="line">5、利用CA证书申请从节点私钥及证书申请文件</span><br><span class="line">openssl req -newkey rsa:2048 -days 365 -nodes -keyout slave.key &gt; slave.csr</span><br><span class="line">6、利用CA证书签名主节点证书</span><br><span class="line">openssl x509 -req -in master.csr -CA cacert.pem -CAkey cakey.pem -set_serial 01 &gt; master.crt  #-set_serial指定序列号</span><br><span class="line">利用CA证书签名从节点证书</span><br><span class="line">openssl x509 -req -in slave.csr -CA cacert.pem -CAkey cakey.pem -set_serial 02 &gt; slave.crt</span><br><span class="line">7、将CA证书、从节点私钥及证书拷贝到从节点主机</span><br><span class="line">scp cacert.pem slave.crt slave.key 192.168.34.7:/etc/my.cnf.d/ssl/</span><br><span class="line">scp cacert.pem slave.crt slave.key 192.168.34.9:/etc/my.cnf.d/ssl/</span><br><span class="line"></span><br><span class="line">配置主从节点加密</span><br><span class="line">1、修改主节点配置文件</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=/data/binlog/mysql</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl_semi_sync_master_enabled</span><br><span class="line">rpl_semi_sync_master_timeout = 2000</span><br><span class="line">ssl-ca=/etc/my.cnf.d/ssl/cacert.pem     #指向CA证书</span><br><span class="line">ssl-cert=/etc/my.cnf.d/ssl/master.crt   #指向主节点证书</span><br><span class="line">ssl-key=/etc/my.cnf.d/ssl/master.key    #指向主节点私钥</span><br><span class="line">验证ssl启用状态</span><br><span class="line">MariaDB [test]&gt; show variables like &apos;%ssl%&apos;;</span><br><span class="line">2、授权只能用于ssl登录的账户</span><br><span class="line">grant replication slave on *.* to rplssl@&apos;192.168.34.%&apos; identified by &apos;linux&apos; require ssl;</span><br><span class="line">3、修改从节点slave配置信息</span><br><span class="line">清楚原有slave配置信息</span><br><span class="line">MariaDB [(none)]&gt; stop slave;</span><br><span class="line">MariaDB [(none)]&gt; start slave;</span><br><span class="line">CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=&apos;192.168.34.8&apos;,</span><br><span class="line">  MASTER_USER=&apos;repuser&apos;,</span><br><span class="line">  MASTER_PASSWORD=&apos;linux&apos;,</span><br><span class="line">  MASTER_PORT=3306,</span><br><span class="line">  MASTER_LOG_FILE=&apos;mysql.000008&apos;,                   #需要在主节点确认最新的二进制文件</span><br><span class="line">  MASTER_LOG_POS=501,                               #在主节点二进制文件的起始点</span><br><span class="line">  MASTER_SSL=1,                                     #启用ssl</span><br><span class="line">  MASTER_SSL_CA = &apos;/etc/my.cnf.d/ssl/cacert.pem&apos;,   #指定本地的CA证书</span><br><span class="line">  MASTER_SSL_CERT = &apos;/etc/my.cnf.d/ssl/slave.crt&apos;,  #指定本地slave节点证书</span><br><span class="line">  MASTER_SSL_KEY = &apos;/etc/my.cnf.d/ssl/slave.key&apos;;   #指定本地slave私钥</span><br><span class="line">4、启动slave线程</span><br><span class="line">start slave；</span><br><span class="line"></span><br><span class="line">验证主从同步</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="主从同步的监控和维护"><a href="#主从同步的监控和维护" class="headerlink" title="主从同步的监控和维护"></a>主从同步的监控和维护</h2><ol>
<li>日志文件<br>清理到5之前的日志文件<br><code>purge master logs to &#39;mysql.000005&#39;;</code><br>清理所有二进制文件，重头开始<br><code>reset master;</code><br>清理slave线程的状态，重新开始同步<br><code>reset slave;</code></li>
<li>复制监控<br>查看二进制日志的最近一个使用情况<br><code>SHOW MASTER STATUS;</code><br>查看二进制日志的详细内容<br><code>SHOW BINLOG EVENTS;</code><br>查看所有二进制文件<br><code>SHOW MASTER LOGS;</code><br>查看从节点同步状态<br><code>SHOW SLAVE STATUS\G</code><br>查看mysql进程信息<br><code>SHOW PROCESSLIST;</code></li>
<li>从服务器是否落后于主服务<br><code>Seconds_Behind_Master: 0</code></li>
<li>如何确定主从节点数据是否一致<br>percona-tools   </li>
<li>数据不一致如何修复<br>删除从数据库，重新复制 </li>
</ol>
<h1 id="MySQL读写分离"><a href="#MySQL读写分离" class="headerlink" title="MySQL读写分离"></a>MySQL读写分离</h1><p>读写分离应用：<br>mysql-proxy：Oracle，<a href="https://downloads.mysql.com/archives/proxy/" target="_blank" rel="noopener">https://downloads.mysql.com/archives/proxy/</a><br>Atlas：Qihoo，<a href="https://github.com/Qihoo360/Atlas/blob/master/README_ZH.md" target="_blank" rel="noopener">https://github.com/Qihoo360/Atlas/blob/master/README_ZH.md</a><br>dbproxy：美团，<a href="https://github.com/Meituan-Dianping/DBProxy" target="_blank" rel="noopener">https://github.com/Meituan-Dianping/DBProxy</a><br>Cetus：网易乐得，<a href="https://github.com/Lede-Inc/cetus" target="_blank" rel="noopener">https://github.com/Lede-Inc/cetus</a><br>Amoeba：<a href="https://sourceforge.net/projects/amoeba/" target="_blank" rel="noopener">https://sourceforge.net/projects/amoeba/</a><br>Cobar：阿里巴巴，Amoeba的升级版<br>Mycat：基于Cobar， <a href="http://www.mycat.io/" target="_blank" rel="noopener">http://www.mycat.io/</a><br>ProxySQL：<a href="https://proxysql.com/" target="_blank" rel="noopener">https://proxysql.com/</a>   </p>
<h2 id="ProxySQL"><a href="#ProxySQL" class="headerlink" title="ProxySQL"></a>ProxySQL</h2><p>ProxySQL组成<br>服务脚本：/etc/init.d/proxysql<br>配置文件：/etc/proxysql.cnf<br>主程序：/usr/bin/proxysql<br><strong>准备：实现读写分离前，先实现主从复制</strong>   </p>
<blockquote>
<p>注意：slave节点需要设置read_only=1</p>
</blockquote>
<h3 id="安装proxysql服务器"><a href="#安装proxysql服务器" class="headerlink" title="安装proxysql服务器"></a>安装proxysql服务器</h3><ol>
<li><p>基于YUM仓库安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | tee /etc/yum.repos.d/proxysql.repo</span><br><span class="line">[proxysql_repo]</span><br><span class="line">name= ProxySQL YUM repository</span><br><span class="line">baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/\$releasever</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key</span><br><span class="line">EOF</span><br><span class="line">重新生成仓库列表中的内容</span><br><span class="line">yum repolist</span><br><span class="line">利用yum安装</span><br><span class="line">yum install proxysql</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务<br>启动ProxySQL：systemctl proxysql start<br>启动后会监听两个默认端口<br>6032：ProxySQL的管理端口<br>6033：ProxySQL对外提供服务的端口   </p>
<h3 id="配置proxysql"><a href="#配置proxysql" class="headerlink" title="配置proxysql"></a>配置proxysql</h3><p>使用管理端口连接<br>使用mysql客户端连接到ProxySQL的管理接口6032，默认管理员用户和密码都是admin：<br><code>mysql -uadmin -padmin -P6032 -h127.0.0.1</code></p>
<blockquote>
<p>说明：在main和monitor数据库中的表， runtime_开头的是运行时的配置，不能修改，只能修改非runtime_表，修改后必须执行LOAD … TO RUNTIME才能加载到RUNTIME生效，执行save … to disk将配置持久化保存到磁盘</p>
</blockquote>
<h4 id="添加主从mysql节点"><a href="#添加主从mysql节点" class="headerlink" title="添加主从mysql节点"></a>添加主从mysql节点</h4></li>
<li><p>添加现有mysql服务器到mysql_servers表中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main]&gt; insert into mysql_servers(hostgroup_id,hostname,port) values(10,&apos;192.168.34.8&apos;,3306);</span><br><span class="line">MySQL [main]&gt; insert into mysql_servers(hostgroup_id,hostname,port) values(10,&apos;192.168.34.7&apos;,3306);</span><br><span class="line">MySQL [main]&gt; insert into mysql_servers(hostgroup_id,hostname,port) values(10,&apos;192.168.34.9&apos;,3306);</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看表中添加的状态<br><code>MySQL [main]&gt; select * from main.mysql_servers;</code>  </p>
</li>
<li>将mysql_servers表中的内容添加到runtime表中<br><code>MySQL [main]&gt; load mysql servers to runtime;</code>   </li>
<li>将mysql_servers表中的内容写入到磁盘<br><code>MySQL [main]&gt; save mysql servers to disk;</code><h4 id="配置监控账户"><a href="#配置监控账户" class="headerlink" title="配置监控账户"></a>配置监控账户</h4></li>
<li>在mysql主节点上授权创建监控账户<br><code>grant replication client on *.* to monitor@&#39;192.168.34.%&#39; identified by &#39;linux&#39;;</code>  </li>
<li>回到proxysql服务器中添加账户到系统中<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main]&gt; set mysql-monitor_username=&apos;monitor&apos;;</span><br><span class="line">MySQL [main]&gt; set mysql-monitor_password=&apos;linux&apos;;</span><br><span class="line">MySQL [main]&gt; load mysql variables to runtime;</span><br><span class="line">MySQL [main]&gt; save mysql variables to disk;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="查看已配置的节点是否正常"><a href="#查看已配置的节点是否正常" class="headerlink" title="查看已配置的节点是否正常"></a>查看已配置的节点是否正常</h4><p>监控模块的指标保存在monitor库的log表中   </p>
<ol>
<li>查看监控连接是否正常的(对connect指标的监控)：(如果connect_error的结果为NULL则表示正常)<br><code>MySQL [main]&gt; select * from mysql_server_connect_log;</code>  </li>
<li>查看监控心跳信息 (对ping指标的监控)：<br><code>MySQL [main]&gt; select * from mysql_server_ping_log;</code>  </li>
<li>查看read_only和replication_lag的监控日志<br><code>MySQL [main]&gt; select * from mysql_server_read_only_log;</code><br><code>MySQL [main]&gt; select * from mysql_server_replication_lag_log;</code><h4 id="设置proxysql分组信息"><a href="#设置proxysql分组信息" class="headerlink" title="设置proxysql分组信息"></a>设置proxysql分组信息</h4>需要修改的是main库中的mysql_replication_hostgroups表，该表有3个字段：<br>writer_hostgroup，reader_hostgroup，comment<br>指定写组的id为10，读组的id为20   </li>
<li><p>创建新的分组信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main]&gt; insert into mysql_replication_hostgroups values(10,20,&apos;web_mysql&apos;);</span><br><span class="line"></span><br><span class="line">MySQL [main]&gt; select * from mysql_replication_hostgroups;</span><br><span class="line">+------------------+------------------+-----------+</span><br><span class="line">| writer_hostgroup | reader_hostgroup | comment   |</span><br><span class="line">+------------------+------------------+-----------+</span><br><span class="line">| 10               | 20               | web_mysql |</span><br><span class="line">+------------------+------------------+-----------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>将分组信息写入RUNTIME生效<br><code>load mysql servers to runtime;</code>   </p>
</li>
<li>将分组信息表中的写入到磁盘<br><code>save mysql servers to disk;</code>   </li>
<li>Monitor模块监控后端的read_only值，按照read_only的值将节点自动移动到读/写组<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main]&gt; select hostgroup_id,hostname,port,status,weight from mysql_servers; </span><br><span class="line">+--------------+--------------+------+--------+--------+</span><br><span class="line">| hostgroup_id | hostname     | port | status | weight |</span><br><span class="line">+--------------+--------------+------+--------+--------+</span><br><span class="line">| 10           | 192.168.34.8 | 3306 | ONLINE | 1      |</span><br><span class="line">| 20           | 192.168.34.9 | 3306 | ONLINE | 1      |</span><br><span class="line">| 20           | 192.168.34.7 | 3306 | ONLINE | 1      |</span><br><span class="line">+--------------+--------------+------+--------+--------+</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="创建在集群中发送SQL语句的用户"><a href="#创建在集群中发送SQL语句的用户" class="headerlink" title="创建在集群中发送SQL语句的用户"></a>创建在集群中发送SQL语句的用户</h4><ol>
<li>在主节点上创建访问用户<br><code>grant all on *.* to sqluser@&#39;192.168.34.%&#39; identified by &#39;linux&#39;;</code></li>
<li>返回proxysql服务器将此用户加入到mysql_users表中<br><code>insert into mysql_users(username,password,default_hostgroup) values(&#39;sqluser&#39;,&#39;linux&#39;,10);</code></li>
<li>将用户表的修改写入RUNTIME生效<br><code>load mysql users to runtime;</code>  </li>
<li>将用户表中的内容写入到磁盘<br><code>save mysql users to disk;</code></li>
<li>验证用户是否可以读写  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;select @@server_id&apos;</span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           1 |</span><br><span class="line">+-------------+</span><br><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;create database db7&apos;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="配置proxysql路由规则，实现读写分离"><a href="#配置proxysql路由规则，实现读写分离" class="headerlink" title="配置proxysql路由规则，实现读写分离"></a>配置proxysql路由规则，实现读写分离</h4><p>与规则有关的表：mysql_query_rules和mysql_query_rules_fast_routing，后者是前者的扩展表，1.4.7之后支持   </p>
<ol>
<li>插入路由规则：将select语句分离到20的读组，select语句中有一个特殊语句SELECT…FOR UPDATE它会申请写锁，应路由到10的写组<br><code>insert into mysql_query_rules (rule_id,active,match_digest,destination_hostgroup,apply) VALUES(1,1,&#39;^SELECT.*FOR UPDATE$&#39;,10,1),(2,1,&#39;^SELECT&#39;,20,1);</code><blockquote>
<p>注意：因ProxySQL根据rule_id顺序进行规则匹配，select … for update规则的<br>rule_id必须要小于普通的select规则的rule_id,此处规则ID为1</p>
</blockquote>
</li>
<li>将规则表的修改写入RUNTIME生效<br><code>load mysql query rules to runtime;</code>   </li>
<li>将规则表中的内容写入到磁盘<br><code>save mysql query rules to disk;</code>   <h3 id="测试读写分离"><a href="#测试读写分离" class="headerlink" title="测试读写分离"></a>测试读写分离</h3>在proxysql服务器执行测试<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">测试查询是否分离并负载均衡</span><br><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;select @@server_id&apos;</span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           2 |</span><br><span class="line">+-------------+</span><br><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;select @@server_id&apos;</span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           3 |</span><br><span class="line">+-------------+</span><br><span class="line"></span><br><span class="line">测试写入数据库</span><br><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;create table db7.t1(id int,name char(10))&apos;</span><br><span class="line">[root@7 ~]# mysql -usqluser -plinux -P6033 -h127.0.0.1 -e &apos;insert db7.t1 (id,name)values(1,&quot;one&quot;)&apos;</span><br><span class="line">路由的信息：查询stats库中的stats_mysql_query_digest表</span><br><span class="line">MySQL [main]&gt; SELECT hostgroup hg,sum_time, count_star, digest_text FROM</span><br><span class="line">    -&gt; stats_mysql_query_digest ORDER BY sum_time DESC;  #利用查询时间来降序排列</span><br><span class="line">+----+----------+------------+------------------------------------------+</span><br><span class="line">| hg | sum_time | count_star | digest_text                              |</span><br><span class="line">+----+----------+------------+------------------------------------------+</span><br><span class="line">| 20 | 10005    | 11         | select @@server_id                       |</span><br><span class="line">| 10 | 7630     | 1          | create table db7.t1(id int,name char(?)) |</span><br><span class="line">| 10 | 4661     | 8          | select @@server_id                       |</span><br><span class="line">| 10 | 3388     | 5          | begin                                    |</span><br><span class="line">| 10 | 2520     | 1          | insert db7.t1 (id,name)values(?,?)       |</span><br><span class="line">| 10 | 1696     | 5          | commit                                   |</span><br><span class="line">| 10 | 1096     | 1          | create database db7                      |</span><br><span class="line">| 10 | 911      | 1          | show databases                           |</span><br><span class="line">| 10 | 856      | 1          | insert db7.t1 (id,name)values(?,one)     |</span><br><span class="line">| 10 | 831      | 1          | show tables                              |</span><br><span class="line">+----+----------+------------+------------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="MySQL高可用MHA"><a href="#MySQL高可用MHA" class="headerlink" title="MySQL高可用MHA"></a>MySQL高可用MHA</h1><p>MHA工作原理</p>
<ol>
<li>从宕机崩溃的master保存二进制日志事件（binlog events）</li>
<li>识别含有最新更新的slave</li>
<li>应用差异的中继日志（relay log）到其他的slave</li>
<li>应用从master保存的二进制日志事件（binlog events）</li>
<li>提升一个slave为新的master</li>
<li>使其他的slave连接新的master进行复制</li>
</ol>
<p>MHA软件由两部分组成，Manager工具包和Node工具包<br>Manager工具包主要包括以下几个工具：   </p>
<ul>
<li>masterha_check_ssh 检查MHA的SSH配置状况</li>
<li>masterha_check_repl 检查MySQL复制状况</li>
<li>masterha_manger 启动MHA</li>
<li>masterha_check_status 检测当前MHA运行状态</li>
<li>masterha_master_monitor 检测master是否宕机</li>
<li>masterha_master_switch 故障转移（自动或手动）</li>
<li>masterha_conf_host 添加或删除配置的server信息<blockquote>
<p>注意：为了尽可能的减少主库硬件损坏宕机造成的数据丢失，因此在配置MHA的同时建议MYSQL配置半同步复制</p>
</blockquote>
</li>
</ul>
<h2 id="配置MHA"><a href="#配置MHA" class="headerlink" title="配置MHA"></a>配置MHA</h2><h3 id="安装MHA相关软件包"><a href="#安装MHA相关软件包" class="headerlink" title="安装MHA相关软件包"></a>安装MHA相关软件包</h3><ol>
<li>在MHA管理服务器上安装Manager工具包和Node工具包<br>下载需要的安装包<br><code>wget https://github.com/linyue515/mysql-master-ha/raw/master/mha4mysql-manager-0.57-0.el7.noarch.rpm</code><br><code>wget https://github.com/linyue515/mysql-master-ha/raw/master/mha4mysql-node-0.57-0.el7.noarch.rpm</code><br>检查epel源的安装，安装manager包需要解决依赖关系<br><code>yum install epel-release</code><br>安装两个软件包<br><code>yum install -y mha4mysql*</code></li>
<li>在从节点上安装Node工具包<br>下载需要的安装包<br>wget <a href="https://github.com/linyue515/mysql-master-ha/raw/master/mha4mysql-node-0.57-0.el7.noarch.rpm" target="_blank" rel="noopener">https://github.com/linyue515/mysql-master-ha/raw/master/mha4mysql-node-0.57-0.el7.noarch.rpm</a><br>安装node包<br>yum install mha4mysql-node-0.57-0.el7.noarch.rpm   <h3 id="修改mysql主从节点的配置文件"><a href="#修改mysql主从节点的配置文件" class="headerlink" title="修改mysql主从节点的配置文件"></a>修改mysql主从节点的配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">主节点：</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=/data/binlog/mysql</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl_semi_sync_master_enabled</span><br><span class="line">rpl_semi_sync_master_timeout = 2000</span><br><span class="line">ssl-ca=/etc/my.cnf.d/ssl/cacert.pem</span><br><span class="line">ssl-cert=/etc/my.cnf.d/ssl/master.crt</span><br><span class="line">ssl-key=/etc/my.cnf.d/ssl/master.key</span><br><span class="line">skip-name-resolve   #添加禁止名称解析</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">从节点：</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">read-only=on</span><br><span class="line">binlog_format=row</span><br><span class="line">rpl-semi-sync-slave-enabled</span><br><span class="line">skip-name-resolve      #禁止名称解析</span><br><span class="line">relay-log-purge=off    #关闭中继日志清理</span><br></pre></td></tr></table></figure>
<h3 id="在主节点创建mha管理用户"><a href="#在主节点创建mha管理用户" class="headerlink" title="在主节点创建mha管理用户"></a>在主节点创建mha管理用户</h3><ol>
<li>确保mysql主从复制的账户存在，如果没有可以创建<br><code>grant replication slave on *.* to repuser@&#39;192.168.34.%&#39; identified by &#39;magedu&#39;;</code>  </li>
<li>创建mha管理账户<br><code>grant all on *.* to mhauser@&#39;192.168.34.%&#39; identified by &#39;linux&#39;;</code><h3 id="实现基于key认证的SSH连接"><a href="#实现基于key认证的SSH连接" class="headerlink" title="实现基于key认证的SSH连接"></a>实现基于key认证的SSH连接</h3>将所有节点实现基于key的SSH认证连接  </li>
<li>生成SSHkey<br><code>ssh-keygen</code>  </li>
<li>将生成的公钥拷贝到本机<br><code>ssh-copy-id 192.168.34.10</code></li>
<li>将本地的公私钥拷贝到所有的节点主机上<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp -rp /root/.ssh/ 192.168.34.8:/root/</span><br><span class="line">scp -rp /root/.ssh/ 192.168.34.7:/root/</span><br><span class="line">scp -rp /root/.ssh/ 192.168.34.9:/root/</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="在MHA管理服务器创建MHA配置文件"><a href="#在MHA管理服务器创建MHA配置文件" class="headerlink" title="在MHA管理服务器创建MHA配置文件"></a>在MHA管理服务器创建MHA配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[server default]</span><br><span class="line">user=mhauser                                    #mha管理账户    </span><br><span class="line">password=linux                                  #管理账户密码</span><br><span class="line">manager_workdir=/data/mastermha/DB1/            #本地自动创建的管理文件夹</span><br><span class="line">manager_log=/data/mastermha/DB1/manager.log     #本地自动创建的日志</span><br><span class="line">remote_workdir=/data/mastermha/DB1/             #在远程节点自动创建的目录</span><br><span class="line">master_binlog_dir=/data/binlog/                 #修改过mysql主节点二进制路径后需要指定</span><br><span class="line">ssh_user=root                                   #ssh用户</span><br><span class="line">repl_user=repuser                               #mysql主从复制用户</span><br><span class="line">repl_password=linux                             #mysql主从复制用户密码</span><br><span class="line">ping_interval=1                                 #测试间隔</span><br><span class="line">[server1]                                       #管理的主机组</span><br><span class="line">hostname=192.168.34.8</span><br><span class="line">candidate_master=1                              #允许成功主节点</span><br><span class="line">[server2]</span><br><span class="line">hostname=192.168.34.7</span><br><span class="line">candidate_master=1</span><br><span class="line">[server3]</span><br><span class="line">hostname=192.168.34.9</span><br><span class="line">candidate_master=1</span><br></pre></td></tr></table></figure>
<h3 id="检测配置文件是否正确"><a href="#检测配置文件是否正确" class="headerlink" title="检测配置文件是否正确"></a>检测配置文件是否正确</h3><ol>
<li>检测各个节点之间SSH通信<br><code>masterha_check_ssh --conf=/etc/mha/DB1.cnf</code></li>
<li>检测各个节点之间二进制拷贝通信<br><code>masterha_check_repl --conf=/etc/mha/DB1.cnf</code><h3 id="启动MHA监控程序"><a href="#启动MHA监控程序" class="headerlink" title="启动MHA监控程序"></a>启动MHA监控程序</h3>在实际生产环境建议在后台执行，利用screen或nohup<br><code>masterha_manager --conf=/etc/mastermha/app1.cnf</code><h3 id="测试MHA效果"><a href="#测试MHA效果" class="headerlink" title="测试MHA效果"></a>测试MHA效果</h3>故意在主节点拷贝大量数据时，关闭主机<br>查看MHA的manager日志来查看新的主节点切换过程  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat /data/mastermha/DB1/manager.log</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">The latest slave 192.168.34.7(192.168.34.7:3306) has all relay logs for recovery.</span><br><span class="line">Selected 192.168.34.7(192.168.34.7:3306) as a new master.</span><br><span class="line">192.168.34.7(192.168.34.7:3306): OK: Applying all logs succeeded.</span><br><span class="line">192.168.34.9(192.168.34.9:3306): This host has the latest relay log events.</span><br><span class="line">Generating relay diff files from the latest slave succeeded.</span><br><span class="line">192.168.34.9(192.168.34.9:3306): OK: Applying all logs succeeded. Slave started, replicating from 192.168.34.7(192.168.34.7:3306)</span><br><span class="line">192.168.34.7(192.168.34.7:3306): Resetting slave info succeeded.</span><br><span class="line">Master failover to 192.168.34.7(192.168.34.7:3306) completed successfully.</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="Galera-Cluster"><a href="#Galera-Cluster" class="headerlink" title="Galera Cluster"></a>Galera Cluster</h1><p>Galera Cluster：集成了Galera插件的MySQL集群，是一种新型的，数据不共享的，高度冗余的高可用方案，目前Galera Cluster有两个版本，分别是Percona Xtradb Cluster及MariaDB Cluster，Galera本身是具有多主特性的，即采用multi-master的集群架构，是一个既稳健，又在数据一致性、完整性及高性能方面有出色表现的高可用解决方案。</p>
<h2 id="Galera-Cluster特点"><a href="#Galera-Cluster特点" class="headerlink" title="Galera Cluster特点"></a>Galera Cluster特点</h2><ul>
<li>多主架构：真正的多点读写的集群，在任何时候读写数据，都是最新的</li>
<li>同步复制：集群不同节点之间数据同步，没有延迟，在数据库挂掉之后，数据不会丢失</li>
<li>并发复制：从节点APPLY数据时，支持并行执行，更好的性能</li>
<li>故障切换：在出现数据库故障时，因支持多点写入，切换容易</li>
<li>热插拔：在服务期间，如果数据库挂了，只要监控程序发现的够快，不可服务时间就会非常少。在节点故障期间，节点本身对集群的影响非常小</li>
<li>自动节点克隆：在新增节点，或者停机维护时，增量数据或者基础数据不需要人工手动备份提供，GaleraCluster会自动拉取在线节点数据，最终集群会变为一致</li>
<li>对应用透明：集群的维护，对应用程序是透明的</li>
</ul>
<h2 id="MariaDB-Galera-Cluster"><a href="#MariaDB-Galera-Cluster" class="headerlink" title="MariaDB Galera Cluster"></a>MariaDB Galera Cluster</h2><p>参考仓库：<a href="https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-5.5.62/yum/centos7-amd64/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-5.5.62/yum/centos7-amd64/</a></p>
<blockquote>
<p>注意：都至少需要三个节点，不能安装mariadb-server</p>
<ol>
<li>创建yum仓库安装<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/galera.repo</span><br><span class="line">[galera]</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-5.5.62/yum/centos7-amd64/</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<ol start="2">
<li><p>将repo文件拷贝给其他mysql服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/yum.repos.d/galera.repo 192.168.34.10:/etc/yum.repos.d/</span><br><span class="line">scp /etc/yum.repos.d/galera.repo 192.168.34.7:/etc/yum.repos.d/</span><br><span class="line">scp /etc/yum.repos.d/galera.repo 192.168.34.9:/etc/yum.repos.d/</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装MariaDB-Galera-server<br><code>yum install MariaDB-Galera-server</code></p>
</li>
<li><p>修改其中一台的服务器配置文件  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[galera]</span><br><span class="line"># Mandatory settings</span><br><span class="line">wsrep_provider=/usr/lib64/galera/libgalera_smm.so                  #Galera库文件路径           </span><br><span class="line">wsrep_cluster_address=&quot;gcomm://192.168.34.7,192.168.34.8,192.168.34.9,192.168.34.10&quot;   #集群的主机列表</span><br><span class="line">binlog_format=row                                                  #二进制格式基于行</span><br><span class="line">default_storage_engine=InnoDB                                      #存储引擎innodb</span><br><span class="line">innodb_autoinc_lock_mode=2                                         </span><br><span class="line">bind-address=0.0.0.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>将server.cnf配置文件拷贝到所有节点上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/my.cnf.d/server.cnf 192.168.34.10:/etc/my.cnf.d/server.cnf</span><br><span class="line">scp /etc/my.cnf.d/server.cnf 192.168.34.7:/etc/my.cnf.d/server.cnf</span><br><span class="line">scp /etc/my.cnf.d/server.cnf 192.168.34.9:/etc/my.cnf.d/server.cnf</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化集群<br><code>/etc/init.d/mysql start --wsrep-new-cluster</code></p>
</li>
<li>启动其它所有节点<br><code>service mysql start</code></li>
<li>查看集群的变量参数，验证同步<br><code>SHOW VARIABLES LIKE &#39;wsrep_c%&#39;;</code><br><code>SHOW STATUS LIKE &#39;wsrep_%&#39;;</code>   </li>
</ol>
<h1 id="复制的问题和解决方案"><a href="#复制的问题和解决方案" class="headerlink" title="复制的问题和解决方案"></a>复制的问题和解决方案</h1><ol>
<li>数据损坏或丢失<br>Master： MHA + semi repl半同步<br>Slave： 重新复制   </li>
<li>混合使用存储引擎<br>MyISAM：不支持事务<br>InnoDB： 支持事务   </li>
<li>不惟一的server id<br>重新复制   </li>
<li>复制延迟<br>需要额外的监控工具的辅助<br>一从多主:mariadb10版后支持<br>多线程复制：对多个数据库复制   </li>
</ol>
<h1 id="生产环境my-cnf配置示例"><a href="#生产环境my-cnf配置示例" class="headerlink" title="生产环境my.cnf配置示例"></a>生产环境my.cnf配置示例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">硬件：内存32G</span><br><span class="line">innodb_file_per_table = 1      #打开独立表空间</span><br><span class="line">max_connections = 8000         #MySQL 服务所允许的同时会话数的上限，经常出现Too Many Connections的错误提示，则需要增大此值</span><br><span class="line">back_log = 300                 #back_log 是操作系统在监听队列中所能保持的连接数</span><br><span class="line">max_connect_errors = 1000      #每个客户端连接最大的错误允许数量，当超过该次数，MYSQL服务器将禁止此主机的连接请求，直到MYSQL服务器重启或通过flush hosts命令清空此主机的相关信息</span><br><span class="line">open_files_limit = 10240       #所有线程所打开表的数量</span><br><span class="line">max_allowed_packet = 32M       #每个连接传输数据大小.最大1G，须是1024的倍数，一般设为最大的BLOB的值</span><br><span class="line">wait_timeout = 10              #指定一个请求的最大连接时间</span><br><span class="line">sort_buffer_size = 16M         #排序缓冲被用来处理类似ORDER BY以及GROUP BY队列所引起的排序</span><br><span class="line">join_buffer_size = 16M         #不带索引的全表扫描.使用的buffer的最小值</span><br><span class="line">query_cache_size = 128M        #查询缓冲大小</span><br><span class="line">query_cache_limit = 4M         #指定单个查询能够使用的缓冲区大小，缺省为1M</span><br><span class="line">transaction_isolation = REPEATABLE-READ  # 设定默认的事务隔离级别</span><br><span class="line">thread_stack = 512K            #线程使用的堆大小. 此值限制内存中能处理的存储过程的递归深度和SQL语句复杂性，此容量的内存在每次连接时被预留.</span><br><span class="line">log-bin                        #二进制日志功能</span><br><span class="line">binlog_format=row              #二进制日志格式</span><br><span class="line">innodb_buffer_pool_size = 24G #InnoDB使用一个缓冲池来保存索引和原始数据,可设置这个变量到服务器物理内存大小的80%</span><br><span class="line">innodb_file_io_threads = 4     #用来同步IO操作的IO线程的数量</span><br><span class="line">innodb_thread_concurrency = 16  #在InnoDb核心内的允许线程数量，建议的设置是CPU数量加上磁盘数量的两倍</span><br><span class="line">innodb_log_buffer_size = 16M    # 用来缓冲日志数据的缓冲区的大小</span><br><span class="line">innodb_log_file_size = 512M     #在日志组中每个日志文件的大小</span><br><span class="line">innodb_log_files_in_group = 3   # 在日志组中的文件总数</span><br><span class="line">innodb_lock_wait_timeout = 120  # SQL语句在被回滚前,InnoDB事务等待InnoDB行锁的时间</span><br><span class="line">long_query_time = 2             #慢查询时长</span><br><span class="line">log-queries-not-using-indexes   #将没有使用索引的查询也记录下来</span><br></pre></td></tr></table></figure>
<h1 id="MYSQL配置最佳实践"><a href="#MYSQL配置最佳实践" class="headerlink" title="MYSQL配置最佳实践"></a>MYSQL配置最佳实践</h1><p>高并发大数据的互联网业务，架构设计思路是“解放数据库CPU，将计算转移到服务层”，并发量大的情况下，这些功能很可能将数据库拖死，业务逻辑放到服务层具备更好的扩展性，能够轻易实现“增机器就加性能”<br>参考：<br>阿里巴巴Java开发手册<br>58到家数据库30条军规解读<br><a href="http://zhuanlan.51cto.com/art/201702/531364.htm" target="_blank" rel="noopener">http://zhuanlan.51cto.com/art/201702/531364.htm</a>  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.nextx.tk/2018/11/11/文本处理三剑客之AWK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nieW">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nieW learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/文本处理三剑客之AWK/" itemprop="url">文本处理三剑客之AWK</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-11T22:44:18+08:00">
                2018-11-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="awk基本用法："><a href="#awk基本用法：" class="headerlink" title="awk基本用法："></a>awk基本用法：</h1><p> gawk：模式扫描和处理语言 </p>
<p>awk [options] ‘program’ var=value file…<br>awk [options] -f programfile var=value file…<br>awk [options] ‘BEGIN{action;… }pattern{action;… }END{action;… }’ file …   </p>
<p>awk程序可由：<strong>BEGIN语句块、能够使用模式匹配的通用语句块、END语句块</strong>，共3部分组成<br><strong>program</strong> 通常是被放在单引号中<br>选项：<br><strong>-F</strong> “分隔符” 指明输入时用到的字段分隔符<br><strong>-v</strong> var=value 变量赋值   </p>
<h4 id="基本格式：awk-options-‘program’-file…-可处理多个文件"><a href="#基本格式：awk-options-‘program’-file…-可处理多个文件" class="headerlink" title="基本格式：awk [options] ‘program’ file… 可处理多个文件"></a>基本格式：awk [options] ‘program’ file… 可处理多个文件</h4><p>其中<strong>Program</strong>：包括<strong>pattern{action statements;..}</strong>   </p>
<p><strong>pattern和action</strong>   </p>
<ul>
<li><p>pattern部分决定动作语句何时触发及触发事件<br>BEGIN,END </p>
<blockquote>
<p>BEGIN 加表头<br>END 加统计汇总  </p>
</blockquote>
</li>
<li><p>action statements对数据进行处理，放在{}内指明<br>print, printf</p>
</li>
</ul>
<p>分割符、域和记录</p>
<ul>
<li>awk执行时，由分隔符分隔的字段（域）标记$1,$2…$n称为域标识。$0<br>为所有域，注意：此时和shell中变量$符含义不同</li>
<li>文件的每一行称为记录</li>
<li>省略action，则默认执行 print $0 显示整行的操作</li>
</ul>
<h2 id="awk工作原理"><a href="#awk工作原理" class="headerlink" title="awk工作原理"></a>awk工作原理</h2><p>第一步：执行BEGIN{action;… }语句块中的语句<br>第二步：从文件或标准输入(stdin)读取一行，然后执行pattern{ action;… }语句块，它逐行扫描文件，从第一行到最后一行重复这个过程，直到文件全部被读取完毕。<br>第三步：当读至输入流末尾时，执行END{action;…}语句块</p>
<p>BEGIN语句块在awk开始从输入流中读取行之前被执行，这是一个可选的语句块，比如变量初始化、打印输出表格的表头等语句通常可以写在BEGIN语句块中   </p>
<p>END语句块在awk从输入流中读取完所有的行之后即被执行，比如打印所有行的分析结果这类信息汇总都是在END语句块中完成，它也是一个可选语句块</p>
<p>pattern语句块中的通用命令是最重要的部分，也是可选的。如果没有提供pattern语句块，则默认执行{ print }，即打印每一个读取到的行，awk读取的每一行都会执行该语句块</p>
<h2 id="print格式"><a href="#print格式" class="headerlink" title="print格式"></a>print格式</h2><h5 id="print格式：print-item1-item2-…"><a href="#print格式：print-item1-item2-…" class="headerlink" title="print格式：print item1, item2, …"></a>print格式：print item1, item2, …</h5><p>要点：  </p>
<ul>
<li>逗号分隔符</li>
<li>输出item可以字符串，也可是数值；当前记录的字段、变量或awk的表达式</li>
<li>如省略item，相当于print $0<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">#BEGIN执行一次运算，不循环读入文件的内容</span><br><span class="line">[root@centos7 ~]#awk &apos;BEGIN&#123;print 1+2&#125;&apos; /etc/passwd </span><br><span class="line">3</span><br><span class="line">#BEGIN开头读入一次，中间print全部内容，END结束读入文件后执行一次</span><br><span class="line">[root@centos7 data]#awk &apos;BEGIN&#123;print &quot;start&quot;&#125;&#123;print $0&#125;END&#123;print &quot;byebye&quot;&#125;&apos; /data/http.log </span><br><span class="line">start</span><br><span class="line">AT 2018-11-03 13:54:43 httpd restarted</span><br><span class="line">AT 2018-11-03 13:55:29 httpd restarted</span><br><span class="line">AT 2018-11-03 14:02:00 httpd restarted</span><br><span class="line">byebye</span><br><span class="line"></span><br><span class="line">awk &apos;&#123;print &quot;hello,awk&quot;&#125;&apos;</span><br><span class="line">awk -F: &apos;&#123;print&#125;&apos; /etc/passwd  #-F: 是以:为分隔符切割字段</span><br><span class="line">awk -F: &apos;&#123;print &quot;wang&quot;&#125;&apos; /etc/passwd</span><br><span class="line">awk -F: &apos;&#123;print $1&#125;&apos; /etc/passwd</span><br><span class="line">awk -F: &apos;&#123;print $0&#125;&apos; /etc/passwd</span><br><span class="line">awk -F: &apos;&#123;print $1&quot;\t&quot;$3&#125;&apos; /etc/passwd  #\t把切割出的字段中增加一个tab，注意&quot;&quot;引号</span><br><span class="line">grep &quot;^UUID&quot;/etc/fstab | awk &apos;&#123;print $2,$4&#125;&apos;</span><br><span class="line"></span><br><span class="line">磁盘空间打印</span><br><span class="line">df|awk &apos;&#123;print $1,$5&#125;&apos;   </span><br><span class="line"></span><br><span class="line">打印用户名和UID</span><br><span class="line">awk -F: &apos;&#123;print $1,$3&#125;&apos; /etc/passwd </span><br><span class="line">awk -F: &apos;&#123;print $1&quot;:&quot;$3&#125;&apos; /etc/passwd #打印出结果中间增加:</span><br><span class="line"></span><br><span class="line">有一文件如下格式，请提取”.sina.com.cn”前面的主机名部分并写入到回到该文件中</span><br><span class="line">bash$cat ip_list.txt</span><br><span class="line">1 test.sina.com.cn</span><br><span class="line">2 www.sina.com.cn</span><br><span class="line">…</span><br><span class="line">999 z.sina.com.cn</span><br><span class="line"></span><br><span class="line">取空格和.为字符分隔符，打印第二个字段，重定向到原文件</span><br><span class="line">awk -F &quot; .&quot; &apos;&#123;print $2&#125;&apos;  ip_list.txt &gt;&gt; ip_list.txt</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>变量不用加$ 和引号，字符串需要加” “<br>数学运算不用加引号，可直接运算，加引号变为字符串  </p>
</blockquote>
<h1 id="awk变量"><a href="#awk变量" class="headerlink" title="awk变量"></a>awk变量</h1><p>变量：内置和自定义变量<br>系统变量|解释<br>:–|:–<br>$0      |当前记录（这个变量中存放着整个行的内容）<br>$1~$n   |当前记录的第n个字段，字段间由FS分隔<br>FS      |输入字段分隔符 默认是空格或Tab<br>NF      |当前记录中的字段个数，就是有多少列<br>NR      |已经读出的记录数，就是行号，从1开始，如果有多个文件话，这个值也是不断累加中。<br>FNR     |当前记录数，与NR不同的是，这个值会是各个文件自己的行号<br>RS      |输入的记录分隔符， 默认为换行符<br>OFS     |输出字段分隔符， 默认也是空格<br>ORS     |输出的记录分隔符，默认为换行符<br>FILENAME |当前输入文件的名字<br>ARGC    |命令行参数的个数<br>ARGV    |数组，保存的是命令行所给定的各参数</p>
<p><img src="https://github.com/moonstar27/learn-linux/blob/master/awk.jpg?raw=true" alt="awk"></p>
<h5 id="自定义变量-区分字符大小写"><a href="#自定义变量-区分字符大小写" class="headerlink" title="自定义变量(区分字符大小写)"></a>自定义变量(区分字符大小写)</h5><ul>
<li>-v var=value  </li>
<li>在program中直接定义 <blockquote>
<p>先定义变量再引用</p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">-V 变量赋值</span><br><span class="line"></span><br><span class="line">FS输入字段分隔符:</span><br><span class="line">awk -v FS=&quot;:&quot; &apos;&#123;print $1,$3&#125;&apos; /etc/passwd</span><br><span class="line">引用FS变量 </span><br><span class="line">awk -v FS=&quot;:&quot; &apos;&#123;print $1FS$3&#125;&apos; /etc/passwd</span><br><span class="line"></span><br><span class="line">引用shell变量</span><br><span class="line">fs=:</span><br><span class="line">awk -v FS=$fs &apos;&#123;print $1FS$3&#125;&apos; /etc/passwd #变量方式调用</span><br><span class="line">awk -F$fs &apos;&#123;print $1FS$3&#125;&apos; /etc/passwd  #选项方式调用</span><br><span class="line"></span><br><span class="line">OFS输出字段分隔符:</span><br><span class="line">awk -v FS=&quot;:&quot; -v OFS=&quot;+&quot; &apos;&#123;print $1,$3&#125;&apos; /etc/passwd</span><br><span class="line"></span><br><span class="line">调用shell变量</span><br><span class="line">fs=:;awk -v FS=$fs -v OFS=$fs &apos;&#123;print $1,$3&#125;&apos; /etc/passwd</span><br><span class="line"></span><br><span class="line">RS输入的记录分隔符:</span><br><span class="line">awk -v RS=&quot;:&quot; &apos;&#123;print $0&#125;&apos; /etc/passwd #不指定FS 默认空格为字段分隔符</span><br><span class="line"></span><br><span class="line">ORS输出的记录分隔符:</span><br><span class="line">awk -v RS=&quot;:&quot; -v ORS=&quot;++&quot; &apos;&#123;print $0&#125;&apos; /etc/passwd</span><br><span class="line"></span><br><span class="line">NF当前记录中的字段个数:</span><br><span class="line">awk -F:  &apos;&#123;print NF&#125;&apos; /etc/passwd</span><br><span class="line">打印最后一行</span><br><span class="line">awk -F:  &apos;&#123;print $NF&#125;&apos; /etc/passwd</span><br><span class="line">打印倒数第二行</span><br><span class="line">awk -F:  &apos;&#123;print $(NF-1)&#125;&apos; /etc/passwd</span><br><span class="line">取光盘中rpm安装包的类型统计</span><br><span class="line">`ls /mnt/Packages/*.rpm | awk -F. &apos;&#123;print $(NF-1)&#125;&apos;|sort |uniq -c`</span><br><span class="line"></span><br><span class="line">NR已经读出的记录数:</span><br><span class="line">awk -v RS=&quot;:&quot; &apos;&#123;print NR,$0&#125;&apos; /etc/passwd</span><br><span class="line">awk -F:  &apos;&#123;print NR,$1&#125;&apos; /etc/passwd /etc/group</span><br><span class="line"></span><br><span class="line">FNR当前记录数:</span><br><span class="line">awk -F: &apos;&#123;print FNR,$1&#125;&apos; /etc/passwd</span><br><span class="line"></span><br><span class="line">FILENAME文件名:</span><br><span class="line">awk -F: &apos;&#123;print FNR,FILENAME,$1&#125;&apos; /etc/passwd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ARGC命令行参数的个数:</span><br><span class="line">参数为3个，指的是这个命令本身的参数个数，不是结果输出的个数</span><br><span class="line">awk -F:  &apos;&#123;print ARGC&#125;&apos; /etc/passwd /etc/group</span><br><span class="line"></span><br><span class="line">ARGV数组，保存的是命令行所给定的各参数:</span><br><span class="line">awk:第0个数组</span><br><span class="line">/etc/passwd:第1个数组</span><br><span class="line">/etc/group:第2个数组</span><br><span class="line">awk -F: &apos;&#123;print ARGV[1]&#125;&apos; /etc/passwd /etc/group  </span><br><span class="line"></span><br><span class="line">自定义变量:</span><br><span class="line">awk -v test=&apos;hello gawk&apos; &apos;&#123;print test&#125;&apos; /etc/fstab</span><br><span class="line">awk -v test=&apos;hello gawk&apos; &apos;BEGIN&#123;print test&#125;&apos;</span><br><span class="line">awk &apos;BEGIN&#123;test=&quot;hello,gawk&quot;;print test&#125;&apos; </span><br><span class="line">利用-f调用文件打印username和UID</span><br><span class="line">cat awkscript</span><br><span class="line">&#123;print script,$1,$3&#125;</span><br><span class="line">awk -F: -f awkscript  /etc/passwd</span><br><span class="line"></span><br><span class="line">取日志中的时间</span><br><span class="line">分隔符为一个[或者一个空格</span><br><span class="line">awk -F &quot;[\[ ]&quot; &apos;&#123;print $5&#125;&apos; /var/log/httpd/access_log</span><br><span class="line"></span><br><span class="line">取磁盘空间利用率，利用扩展正则表达式  </span><br><span class="line">df | awk -F &quot;[[:space:]]+|%&quot; &apos;&#123;print $5&#125;&apos;</span><br><span class="line"></span><br><span class="line">变量赋值  </span><br><span class="line">awk -F: &apos;&#123;name=&quot;nie&quot;;print $1,name&#125;&apos; /etc/passwd</span><br></pre></td></tr></table></figure>
<blockquote>
<p>引用变量时，变量前不需加$</p>
</blockquote>
<h1 id="printf命令"><a href="#printf命令" class="headerlink" title="printf命令"></a>printf命令</h1><h5 id="格式化输出：printf-“FORMAT”-item1-item2-…"><a href="#格式化输出：printf-“FORMAT”-item1-item2-…" class="headerlink" title="格式化输出：printf “FORMAT”, item1, item2, …"></a>格式化输出：printf “FORMAT”, item1, item2, …</h5><ul>
<li>必须指定FORMAT格式符  </li>
<li>不会自动换行，需要显式给出换行控制符，\n  </li>
<li>FORMAT中需要分别为后面每个item指定格式符  </li>
</ul>
<p><strong>格式符</strong>：与item一一对应</p>
<table>
<thead>
<tr>
<th>格式符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>%c</td>
<td>显示字符的ASCII码</td>
</tr>
<tr>
<td>%d、%i</td>
<td>显示十进制整数</td>
</tr>
<tr>
<td>%e、%E</td>
<td>显示科学计数法数值</td>
</tr>
<tr>
<td>%f</td>
<td>显示为浮点数</td>
</tr>
<tr>
<td>%g、%G</td>
<td>以科学计数法或浮点形式显示数值</td>
</tr>
<tr>
<td>%s</td>
<td>显示字符串</td>
</tr>
<tr>
<td>%u</td>
<td>无符号整数</td>
</tr>
<tr>
<td>%%</td>
<td>显示%自身</td>
</tr>
</tbody>
</table>
<p><strong>修饰符</strong></p>
<table>
<thead>
<tr>
<th>修饰符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>#[.#]</td>
<td>第一个数字控制显示的宽度；第二个#表示小数点后精度。例如 %3.1f</td>
</tr>
<tr>
<td>-</td>
<td>左对齐（默认右对齐）例如 %-15s</td>
</tr>
<tr>
<td>+</td>
<td>显示数值的正负符号 例如 %+d</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">定义$1格式为字符串，注意\n换行</span><br><span class="line">awk -F: &apos;&#123;printf &quot;%s\n&quot;,$1&#125;&apos; /etc/passwd</span><br><span class="line">root</span><br><span class="line">bin</span><br><span class="line">daemon</span><br><span class="line"></span><br><span class="line">打印时$1按照左对齐并以字符串显示，$3以右对齐并以数字格式显示</span><br><span class="line">awk -F: &apos;&#123;printf &quot;%-20s %10d\n&quot;,$1,$3&#125;&apos; /etc/passwd</span><br><span class="line">root                          0</span><br><span class="line">bin                           1</span><br><span class="line">daemon                        2</span><br><span class="line"></span><br><span class="line">增加Username:为字符串打印$1</span><br><span class="line">awk -F: &apos;&#123;printf &quot;Username:%s\n&quot;,$1&#125;&apos; /etc/passwd</span><br><span class="line">Username:root</span><br><span class="line">Username:bin</span><br><span class="line">Username:daemon</span><br><span class="line"></span><br><span class="line">增加Username:为字符串打印$1，增加UID:为数字打印$3</span><br><span class="line">awk -F: &apos;&#123;printf &quot;Username:%s,UID:%d\n&quot;,$1,$3&#125;&apos; /etc/passwd</span><br><span class="line">Username:root,UID:0</span><br><span class="line">Username:bin,UID:1</span><br><span class="line">Username:daemon,UID:2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">增加Username:为字符串打印$1，增加UID:为数字打印$3,$1默认右对齐</span><br><span class="line">awk -F: &apos;&#123;printf &quot;Username:%15s,UID:%d\n&quot;,$1,$3&#125;&apos; /etc/passwd</span><br><span class="line">Username:           root,UID:0</span><br><span class="line">Username:            bin,UID:1</span><br><span class="line">Username:         daemon,UID:2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">增加Username:为字符串打印$1，增加UID:为数字打印$3,$1左对齐</span><br><span class="line">awk -F: &apos;&#123;printf &quot;Username:%-15s,UID:%d\n&quot;,$1,$3&#125;&apos; /etc/passwd</span><br><span class="line">Username:root           ,UID:0</span><br><span class="line">Username:bin            ,UID:1</span><br><span class="line">Username:daemon         ,UID:2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">将结果修饰成为表格样式</span><br><span class="line">awk -F: &apos;BEGIN&#123;print &quot;|username|           |uid|\n----------------------------&quot;&#125;&#123;printf &quot;%-20s |%-5d|\n----------------------------\n&quot;, $1,$3&#125;&apos; /etc/passwd</span><br><span class="line">|username|           |uid|</span><br><span class="line">----------------------------</span><br><span class="line">root                 |0    |</span><br><span class="line">----------------------------</span><br><span class="line">bin                  |1    |</span><br><span class="line">----------------------------</span><br></pre></td></tr></table></figure>
<h1 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h1><table>
<thead>
<tr>
<th>操作符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>算数操作符</strong></td>
<td></td>
</tr>
<tr>
<td>x+y</td>
<td>加法</td>
</tr>
<tr>
<td>x-y</td>
<td>减法</td>
</tr>
<tr>
<td>x*y</td>
<td>乘法</td>
</tr>
<tr>
<td>x/y</td>
<td>除法</td>
</tr>
<tr>
<td>x^y</td>
<td>乘方</td>
</tr>
<tr>
<td>x%y</td>
<td>取模余数</td>
</tr>
<tr>
<td>-x</td>
<td>转换为负数</td>
</tr>
<tr>
<td>+x</td>
<td>将字符串转换为数值</td>
</tr>
<tr>
<td><strong>赋值操作符</strong></td>
<td></td>
</tr>
<tr>
<td>=</td>
<td>等于</td>
</tr>
<tr>
<td>+=</td>
<td>x=x+y</td>
</tr>
<tr>
<td>-=</td>
<td>x=x-y</td>
</tr>
<tr>
<td>*=</td>
<td>x=x*y</td>
</tr>
<tr>
<td>/=</td>
<td>x=x/y</td>
</tr>
<tr>
<td>%=</td>
<td>x=x%y</td>
</tr>
<tr>
<td>^=</td>
<td>x=x^y</td>
</tr>
<tr>
<td>++</td>
<td>自增运算 ++i是先计算，再操作、i++是先操作，再计算</td>
</tr>
<tr>
<td>–</td>
<td>自减运算 –i是先计算，再操作、i–是先操作，再计算</td>
</tr>
<tr>
<td><strong>比较操作符</strong></td>
<td></td>
</tr>
<tr>
<td>&lt;</td>
<td>小于</td>
</tr>
<tr>
<td>></td>
<td>大于</td>
</tr>
<tr>
<td>&lt;=</td>
<td>小于或等于</td>
</tr>
<tr>
<td>>=</td>
<td>大于或等于</td>
</tr>
<tr>
<td>==</td>
<td>相等</td>
</tr>
<tr>
<td>!=</td>
<td>不相等</td>
</tr>
<tr>
<td>~</td>
<td>匹配</td>
</tr>
<tr>
<td>!~</td>
<td>不匹配</td>
</tr>
<tr>
<td><strong>模式匹配符</strong></td>
<td></td>
</tr>
<tr>
<td>~</td>
<td>左边是否和右边匹配，包含</td>
</tr>
<tr>
<td>!~</td>
<td>是否不匹配</td>
</tr>
<tr>
<td><strong>逻辑操作符</strong></td>
<td></td>
</tr>
<tr>
<td>&amp;&amp;</td>
<td>与</td>
</tr>
<tr>
<td>\</td>
<td>\</td>
<td></td>
<td>或</td>
</tr>
<tr>
<td>!</td>
<td>非</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">赋值运算符示例：</span><br><span class="line"></span><br><span class="line">下面两语句有何不同  </span><br><span class="line">先运算后打印  </span><br><span class="line">awk &apos;BEGIN&#123;i=0;print \++i,i&#125;&apos;  </span><br><span class="line">1 1  </span><br><span class="line">先打印后运算  </span><br><span class="line">awk &apos;BEGIN&#123;i=0;print i++,i&#125;&apos;  </span><br><span class="line">0 1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">模式匹配符示例：</span><br><span class="line"></span><br><span class="line">匹配全文包括root字符的内容，包含也会匹配到</span><br><span class="line">awk -F: &apos;$0 ~ /root/&#123;print $1&#125;&apos; /etc/passwd</span><br><span class="line">root</span><br><span class="line">operator</span><br><span class="line"></span><br><span class="line">匹配开头为root的整行文件，默认为空格分隔符</span><br><span class="line">awk &apos;$0 ~ &quot;^root&quot;&apos; /etc/passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line"></span><br><span class="line">匹配不包含root的行，默认为空格分隔符</span><br><span class="line">awk &apos;$0 !~ /root/&apos; /etc/passwd</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line"></span><br><span class="line">匹配以:分隔符取出的UID是否为0的行</span><br><span class="line">awk -F: &apos;$3==0&apos; /etc/passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">逻辑操作符示例：</span><br><span class="line"></span><br><span class="line">利用:分割的第三段UID条件判断打印UID大于0和UID小于1000的username和UID</span><br><span class="line">awk -F: &apos;$3&gt;=0 &amp;&amp; $3&lt;1000&#123;print $1,$3&#125;&apos; /etc/passwd  </span><br><span class="line">root 0</span><br><span class="line">bin 1</span><br><span class="line">daemon 2</span><br><span class="line"></span><br><span class="line">利用:分割的第三段UID条件判断打印UID等于0或者UID大于1000的username和UID</span><br><span class="line">awk -F: &apos;$3==0 || $3&gt;1000&#123;print $1,$3&#125;&apos; /etc/passwd</span><br><span class="line">root 0</span><br><span class="line">nfsnobody 65534</span><br><span class="line">li 1001</span><br><span class="line"></span><br><span class="line">利用:分割的第三段UID条件判断打印UID不等于0的username和UID（除root以为）</span><br><span class="line">awk -F: &apos;!($3==0)&#123;print $1,$3&#125;&apos; /etc/passwd</span><br><span class="line">bin 1</span><br><span class="line">daemon 2</span><br><span class="line">adm 3</span><br><span class="line"></span><br><span class="line">利用:分割的第三段UID条件判断打印UID不大于等于500的username和UID</span><br><span class="line">awk -F: &apos;!($3&gt;=500)&#123;print $1,$3&#125;&apos; /etc/passwd</span><br><span class="line">root 0</span><br><span class="line">bin 1</span><br><span class="line">daemon 2</span><br></pre></td></tr></table></figure>
<p>条件表达式（三目表达式）<br>selector?if-true-expression:if-false-expression<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">利用:分割的第三段UID条件判断是否大于等于1000，如果是就利用变量usertype打印为Common User，如果不是打印为SysUser，并且使用printf打印左对齐的格式输出username和usertype</span><br><span class="line">awk -F: &apos;&#123;$3&gt;=1000?usertype=&quot;Common User&quot;:usertype=&quot;SysUser&quot;;&#123;printf &quot;%-15s %-s\n&quot;,$1,usertype&#125;&#125;&apos; /etc/passwd</span><br><span class="line">root            SysUser</span><br><span class="line">bin             SysUser</span><br><span class="line">daemon          SysUser</span><br></pre></td></tr></table></figure></p>
<h1 id="awk-PATTERN条件判断"><a href="#awk-PATTERN条件判断" class="headerlink" title="awk PATTERN条件判断"></a>awk PATTERN条件判断</h1><p>PATTERN:根据pattern条件，过滤匹配的行，再做处理</p>
<ul>
<li>如果未指定：空模式，匹配每一行</li>
<li>/regular expression/：仅处理能够<strong>正则表达式</strong>匹配到的行，需要用/ /括起来  </li>
<li>relational expression:   关系表达式，结果为“真”才会被处理<br>真：结果为非0值，非空字符串<br>假：结果为空字符串或0值</li>
<li>line ranges：行范围<br>startline,endline：/pat1/,/pat2/  不支持直接给出数字格式   </li>
<li>BEGIN/END模式<br>BEGIN{}：仅在<strong>开始处理文件中的文本之前</strong>执行一次<br>END{}：仅在<strong>文本处理完成之后</strong>执行一次  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">取UUID开头的行，默认空格为分隔符</span><br><span class="line">awk &apos;/^UUID/&#123;print $1,$2&#125;&apos; /etc/fstab </span><br><span class="line">UUID=d9c353b1-9e80-4937-b538-6088f983df78 /</span><br><span class="line">UUID=f168a437-14bc-4eff-8704-9c3f1a3b2857 /boot</span><br><span class="line">UUID=01cad516-0d81-4490-b986-0c2abdba2c43 swap</span><br><span class="line">UUID=9d6576fe-6ef3-4e4a-bec8-0634480a0344 /usr</span><br><span class="line"></span><br><span class="line">取不是以UUID开头的行，默认空格为分隔符</span><br><span class="line">awk &apos;!/^UUID/&#123;print $0&#125;&apos; /etc/fstab </span><br><span class="line">#</span><br><span class="line"># /etc/fstab</span><br><span class="line"></span><br><span class="line">取以root开头到sync结尾的行范围，打印以:分割的第一段字符</span><br><span class="line">awk -F: &apos;/^root/,/^sync/&#123;print $1&#125;&apos; /etc/passwd</span><br><span class="line">root</span><br><span class="line">bin</span><br><span class="line">daemon</span><br><span class="line">adm</span><br><span class="line">lp</span><br><span class="line">sync</span><br><span class="line"></span><br><span class="line">取判断NR行号大于等于10到小于等于20之间的，以:分割的行号和第一段字符</span><br><span class="line">awk -F: &apos;(NR&gt;=10 &amp;&amp; NR&lt;=20)&#123;print NR,$1&#125;&apos; /etc/passwd</span><br><span class="line">10 operator</span><br><span class="line">11 games</span><br><span class="line">12 ftp</span><br><span class="line">13 nobody</span><br><span class="line"></span><br><span class="line">取0的反结果为真，所以打印文件内容，取1的反为假，不打印文件内容</span><br><span class="line">awk &apos;!0&apos; /etc/passwd ; awk &apos;!1&apos; /etc/passwd</span><br><span class="line"></span><br><span class="line">利用:分割的第三段UID条件判断打印UID大于1000的username和UID</span><br><span class="line">awk -F: &apos;$3&gt;=1000&#123;print $1,$3&#125;&apos; /etc/passwd</span><br><span class="line">nfsnobody 65534</span><br><span class="line">nie 1000</span><br><span class="line">li 1001</span><br><span class="line"></span><br><span class="line">利用:分割的最后一段字符包含/bin/bash条件判断打印username和/bin/bash</span><br><span class="line">awk -F: &apos;$NF==&quot;/bin/bash&quot;&#123;print $1,$NF&#125;&apos; /etc/passwd</span><br><span class="line">root /bin/bash</span><br><span class="line">nie /bin/bash</span><br><span class="line">li /bin/bash</span><br><span class="line"></span><br><span class="line">利用:分割的最后一段字符包含以bash结尾的条件判断打印username和/bin/bash</span><br><span class="line">awk -F: &apos;$NF ~ /bash$/&#123;print $1,$NF&#125;&apos; /etc/passwd</span><br><span class="line"></span><br><span class="line">磁盘空间利用率</span><br><span class="line">df | awk -F &quot;[[:space:]]+|%&quot; &apos;/^\/dev\/sd/&#123;print $1,$5&#125;&apos;</span><br><span class="line"></span><br><span class="line">两种取远程连接IP地址的方法</span><br><span class="line">ss -nt | awk -F&quot;[[:space:]]+|:&quot; &apos;/ESTAB/&#123;print $6&#125;&apos;</span><br><span class="line">从后取IP</span><br><span class="line">ss -nt | awk -F&quot;[[:space:]]+|:&quot; &apos;/ESTAB/&#123;print $(NF-2)&#125;&apos;</span><br><span class="line"></span><br><span class="line">取远程连接IP大于等于3的IP地址</span><br><span class="line">ss -nt | awk -F&quot;[[:space:]]+|:&quot; &apos;/ESTAB/&#123;print $(NF-2)&#125;&apos;|sort|uniq -c|awk &apos;$1&gt;=3&#123;print $2&#125;&apos;</span><br><span class="line"></span><br><span class="line">开始i为空，取反结果为真，第一行打印；第二行i不为空，取反结果为假，第二行不打印；以此类推</span><br><span class="line">[root@centos7 ~]# seq 10 |awk &apos;i=!i&apos;</span><br><span class="line">1</span><br><span class="line">3</span><br><span class="line">5</span><br><span class="line">7</span><br><span class="line">9</span><br><span class="line"></span><br><span class="line">取上个结果的反，结果为偶数</span><br><span class="line">[root@centos7 ~]# seq 10 |awk &apos;!(i=!i)&apos;</span><br><span class="line">2</span><br><span class="line">4</span><br><span class="line">6</span><br><span class="line">8</span><br><span class="line">10</span><br><span class="line"></span><br><span class="line">开始i为真，取反结果为假，第一行不打印；第二行i为空，取反结果为真，第二行打印；以此类推</span><br><span class="line">seq 10 |awk -v i=1 &apos;i=!i&apos;</span><br><span class="line">2</span><br><span class="line">4</span><br><span class="line">6</span><br><span class="line">8</span><br><span class="line">10</span><br></pre></td></tr></table></figure>
<h1 id="awk-action动作"><a href="#awk-action动作" class="headerlink" title="awk action动作"></a>awk action动作</h1><p>常用的action分类</p>
<ul>
<li>Expressions：算术，比较表达式等</li>
<li>Control statements：if, while等</li>
<li>Compound statements：组合语句</li>
<li>input statements</li>
<li>output statements：print等</li>
</ul>
<h1 id="awk控制语句"><a href="#awk控制语句" class="headerlink" title="awk控制语句"></a>awk控制语句</h1><p>{ statements;… } 组合语句<br>if(condition) {statements;…}<br>if(condition) {statements;…} else {statements;…}<br>while(conditon) {statments;…}<br>do {statements;…} while(condition)<br>for(expr1;expr2;expr3) {statements;…}<br>break<br>continue<br>delete array[index]<br>delete array<br>exit   </p>
<h2 id="awk控制语句if-else"><a href="#awk控制语句if-else" class="headerlink" title="awk控制语句if-else"></a>awk控制语句if-else</h2><p>语法：</p>
<ul>
<li>if(condition){statement;…}[else statement]   </li>
<li><strong>if</strong>(condition1){statement1}<strong>else if</strong>(condition2){statement2}<strong>else</strong>{statement3} </li>
</ul>
<p>使用场景：对awk取得的整行或某个字段做条件判断</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">多条件判断，与shell类似</span><br><span class="line">awk -v score=66 &apos;BEGIN&#123;if(score &lt;60)&#123;print&quot;not good&quot;&#125;else if(score &lt;=80)&#123;print &quot;soso&quot;&#125;else&#123;print &quot;good&quot;&#125;&#125;&apos;</span><br><span class="line">soso</span><br><span class="line">awk -v score=36 &apos;BEGIN&#123;if(score &lt;60)&#123;print&quot;not good&quot;&#125;else if(score &lt;=80)&#123;print &quot;soso&quot;&#125;else&#123;print &quot;good&quot;&#125;&#125;&apos;</span><br><span class="line">not good</span><br><span class="line">awk -v score=87 &apos;BEGIN&#123;if(score &lt;60)&#123;print&quot;not good&quot;&#125;else if(score &lt;=80)&#123;print &quot;soso&quot;&#125;else&#123;print &quot;good&quot;&#125;&#125;&apos;</span><br><span class="line">good</span><br><span class="line"></span><br><span class="line">判断UID大于等于1000</span><br><span class="line">awk -F: &apos;&#123;if($3&gt;=1000)print $1,$3&#125;&apos; /etc/passwd</span><br><span class="line">nfsnobody 65534</span><br><span class="line">nie 1000</span><br><span class="line">li 1001</span><br><span class="line"></span><br><span class="line">判断最后一个字段是否等于/bin/bash,打印匹配的username</span><br><span class="line">awk -F: &apos;&#123;if($NF==&quot;/bin/bash&quot;)print $1&#125;&apos; /etc/passwd</span><br><span class="line">root</span><br><span class="line">nie</span><br><span class="line">li</span><br><span class="line"></span><br><span class="line">判断文件内容字段数量(列号)大于8，打印这些内容</span><br><span class="line">awk &apos;&#123;if(NF&gt;8)print $0&#125;&apos;  /etc/fstab </span><br><span class="line"># Created by anaconda on Sat Sep 22 10:06:19 2018</span><br><span class="line"></span><br><span class="line">判断如果UID大于等于1000就打印common user，如果不是就打印root or sysuser</span><br><span class="line">awk -F: &apos;&#123;if($3&gt;=1000)&#123;printf &quot;common user:%s\n&quot;,$1&#125;else&#123;printf &quot;root or sysuser:%s\n&quot;,$1&#125;&#125;&apos; /etc/passwd</span><br><span class="line">root or sysuser:root</span><br><span class="line">root or sysuser:bin</span><br><span class="line">root or sysuser:daemon</span><br><span class="line"></span><br><span class="line">取磁盘空间超过75的硬盘名称</span><br><span class="line">df -h | awk -F% &apos;/^\/dev/&#123;print $1&#125;&apos; | awk &apos;$NF &gt;=75&#123;print $1,$5&#125;&apos;</span><br><span class="line">/dev/sda2 78</span><br><span class="line"></span><br><span class="line">多条件判断变量值对应不同结果</span><br><span class="line">awk &apos;BEGIN&#123;test=100;if(test &gt;90)&#123;print &quot;very good&quot;&#125;else if(test &gt;60)&#123;print &quot;good&quot;&#125;else&#123;print &quot;no pass&quot;&#125;&#125;&apos;</span><br><span class="line">very good</span><br></pre></td></tr></table></figure>
<h2 id="awk控制语句while循环"><a href="#awk控制语句while循环" class="headerlink" title="awk控制语句while循环"></a>awk控制语句while循环</h2><p>语法：while(condition){statement;…}<br>条件“真”，进入循环；条件“假”，退出循环<br>使用场景：<br>对一行内的多个字段逐一类似处理时使用<br>对数组中的各元素逐一处理时使用  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">以第一行的NF字段值为循环，依次统计每个字段的长度</span><br><span class="line">awk -F: &apos;NR==1&#123;i=1;while(i&lt;=NF)&#123;print $i,length($i);i++&#125;&#125;&apos; /etc/passwd</span><br><span class="line">root 4</span><br><span class="line">x 1</span><br><span class="line">0 1</span><br><span class="line">0 1</span><br><span class="line">root 4</span><br><span class="line">/root 5</span><br><span class="line">/bin/bash 9</span><br><span class="line"></span><br><span class="line">以任意个空格开头的linux16行的NF字段值为循环，依次统计每个字段的长度</span><br><span class="line">awk &apos;/^[[:space:]]*linux16/&#123;i=1;while(i&lt;=NF)&#123;print $i,length($i);i++&#125;&#125;&apos; /etc/grub2.cfg </span><br><span class="line">linux16 7</span><br><span class="line">/vmlinuz-3.10.0-862.el7.x86_64 30</span><br><span class="line"></span><br><span class="line">以任意个空格开头的linux16行的NF字段值为循环，依次统计长度大于等于10个字符的字段的长度</span><br><span class="line">awk &apos;/^[[:space:]]*linux16/&#123;i=1;while(i&lt;=NF)&#123;if(length($i)&gt;=10)&#123;print $i,length($i)&#125;;i++&#125;&#125;&apos; /etc/grub2.cfg </span><br><span class="line">/vmlinuz-3.10.0-862.el7.x86_64 30</span><br><span class="line">root=UUID=d9c353b1-9e80-4937-b538-6088f983df78 46</span><br><span class="line"></span><br><span class="line">生成1000个随机数重定向到f1.txt</span><br><span class="line">for i in &#123;1..1000&#125;;do if [ $i -eq 1 ];then echo -e &quot;$RANDOM\c&quot; &gt;&gt;f1.txt;else echo -e &quot;,$RANDOM\c&quot; &gt;&gt;f1.txt;fi;done</span><br><span class="line"></span><br><span class="line">给i赋值2,第一个数字作为初始值，即当最大值也当最小值，使用while循环，如果后面的值大于前一个就替换MAX值，如果后面的值小于前一个就替换MIN值，循环结束后输出</span><br><span class="line">awk -F, &apos;&#123;i=2;max=$1;min=$1;while(i&lt;=NF)&#123;if($i &gt; max)&#123;max=$i&#125;else if($i &lt; min)&#123;min=$i&#125;;i++&#125;&#125;END&#123;print &quot;max=&quot;max,&quot;min=&quot;min&#125;&apos; f1.txt </span><br><span class="line">max=32750 min=35</span><br></pre></td></tr></table></figure>
<h2 id="awk控制语句do-while循环"><a href="#awk控制语句do-while循环" class="headerlink" title="awk控制语句do while循环"></a>awk控制语句do while循环</h2><h5 id="语法：do-statement-…-while-condition"><a href="#语法：do-statement-…-while-condition" class="headerlink" title="语法：do {statement;…}while(condition)"></a>语法：do {statement;…}while(condition)</h5><p>意义：无论真假，至少执行一次循环体，再判断后面的条件是否为真，为真继续执行，为假停止</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">初始值为0的sum，先进行一次循环自加，判断小于等于100，直到加到100才停止循环</span><br><span class="line">awk &apos;BEGIN&#123;sum=0;i=0;do&#123;sum+=i;i++&#125;while(i&lt;=100)print sum&#125;&apos;</span><br><span class="line">5050</span><br></pre></td></tr></table></figure>
<h2 id="awk控制语句for循环"><a href="#awk控制语句for循环" class="headerlink" title="awk控制语句for循环"></a>awk控制语句for循环</h2><h5 id="语法：for-expr1-expr2-expr3-statement-…"><a href="#语法：for-expr1-expr2-expr3-statement-…" class="headerlink" title="语法：for(expr1;expr2;expr3) {statement;…}"></a>语法：for(expr1;expr2;expr3) {statement;…}</h5><p>常见用法：<br>for(variable assignment;condition;iteration process)<br>{for-body} </p>
<p>特殊用法：能够遍历数组中的元素<br>语法：for(var in array) {for-body}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">使用for循环计算加到100的值</span><br><span class="line">awk &apos;BEGIN&#123;for(i=1;i&lt;=100;i++)total+=i;print total&#125;&apos;</span><br><span class="line">5050</span><br><span class="line"></span><br><span class="line">利用for循环来统计每字段的长度</span><br><span class="line">awk &apos;/^[[:space:]]*linux16/&#123;for(i=1;i&lt;=NF;i++)&#123;print $i,length($i)&#125;&#125;&apos; /etc/grub2.cfg </span><br><span class="line">linux16 7</span><br><span class="line">/vmlinuz-3.10.0-862.el7.x86_64 30</span><br><span class="line">root=UUID=d9c353b1-9e80-4937-b538-6088f983df78 46</span><br></pre></td></tr></table></figure></p>
<h2 id="awk控制语句switch语句"><a href="#awk控制语句switch语句" class="headerlink" title="awk控制语句switch语句"></a>awk控制语句switch语句</h2><h5 id="语法：switch-expression-case-VALUE1-or-REGEXP-statement1-case-VALUE2-or-REGEXP2-statement2-…-default-statementn"><a href="#语法：switch-expression-case-VALUE1-or-REGEXP-statement1-case-VALUE2-or-REGEXP2-statement2-…-default-statementn" class="headerlink" title="语法：switch(expression) {case VALUE1 or /REGEXP/: statement1; case VALUE2 or /REGEXP2/: statement2; …; default: statementn}"></a>语法：switch(expression) {case VALUE1 or /REGEXP/: statement1; case VALUE2 or /REGEXP2/: statement2; …; default: statementn}</h5><p>可以支持正则表达式  </p>
<p><strong>break和continue</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">判断i=50，continue跳过当次循环，继续后面的循环</span><br><span class="line">awk &apos;BEGIN&#123;total=0;for(i=1;i&lt;=100;i++)&#123;if(i==50)continue;total+=i&#125;;print total&#125;&apos;</span><br><span class="line">5000</span><br><span class="line"></span><br><span class="line">判断i=50，break结束后面的循环</span><br><span class="line">awk &apos;BEGIN&#123;total=0;for(i=1;i&lt;=100;i++)&#123;if(i==50)break;total+=i&#125;;print total&#125;&apos;</span><br><span class="line">1225</span><br><span class="line"></span><br><span class="line">判断i的值是否可以整除2，可以的话就跳过当次循环，相当于取1--100的奇数之和</span><br><span class="line">awk &apos;BEGIN&#123;sum=0;for(i=1;i&lt;=100;i++)&#123;if(i%2==0)continue;sum+=i&#125;print sum&#125;&apos;</span><br><span class="line">2500</span><br></pre></td></tr></table></figure></p>
<p><strong>next</strong>:<br>提前结束对本行处理而直接进入下一行处理（awk自身循环）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">判断行号是否可以整除2，如果可以就跳过当次，打印其它行，相当于打印奇数行</span><br><span class="line">awk -F: &apos;&#123;if(NR%2==0)next;print NR,$0&#125;&apos; /etc/passwd</span><br><span class="line">1 root:x:0:0:root:/root:/bin/bash</span><br><span class="line">3 daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">5 lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br><span class="line"></span><br><span class="line">不同写法等同于上面的结果</span><br><span class="line">awk -F: &apos;NR%2==1&#123;print NR,$0&#125;&apos; /etc/passwd</span><br><span class="line"></span><br><span class="line">判断行号是否不可以整除2，如果不可以就跳过当次，打印其它行，相当于打印偶数行</span><br><span class="line">awk -F: &apos;&#123;if($3%2!=0)next;print $1,$3&#125;&apos; /etc/passwd</span><br><span class="line">root 0</span><br><span class="line">daemon 2</span><br><span class="line">lp 4</span><br></pre></td></tr></table></figure>
<h1 id="awk数组"><a href="#awk数组" class="headerlink" title="awk数组"></a>awk数组</h1><h5 id="关联数组：array-index-expression"><a href="#关联数组：array-index-expression" class="headerlink" title="关联数组：array[index-expression]"></a>关联数组：array[index-expression]</h5><p>index-expression:</p>
<ul>
<li>可使用任意字符串；字符串要使用双引号括起来</li>
<li>如果某数组元素事先不存在，在引用时，awk会自动创建此元素，并将其值初始化为“空串”</li>
<li>若要判断数组中是否存在某元素，要使用“index in array”格式进行遍历</li>
</ul>
<p><strong>若要遍历数组中的每个元素，要使用for循环</strong><br>for(var in array) {for-body}<br>注意：var会遍历array的每个索引   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">利用数组方式打印</span><br><span class="line">awk &apos;BEGIN&#123;weekdays[&quot;mon&quot;]=&quot;Monday&quot;;weekdays[&quot;tue&quot;]=&quot;Tuesday&quot;;print weekdays[&quot;mon&quot;]&#125;&apos;</span><br><span class="line">Monday</span><br><span class="line"></span><br><span class="line">[root@centos7 data]#cat f1</span><br><span class="line">aaa</span><br><span class="line">aaa</span><br><span class="line">abc</span><br><span class="line">ddd</span><br><span class="line">ddd</span><br><span class="line">zcd</span><br><span class="line">bgd</span><br><span class="line">zcd</span><br><span class="line">[root@centos7 data]#awk &apos;!link[$0]++&apos; f1</span><br><span class="line">aaa</span><br><span class="line">abc</span><br><span class="line">ddd</span><br><span class="line">zcd</span><br><span class="line">bgd</span><br><span class="line">第一次读入的行没有赋值，所以为空，取反后为真，所以打印第一行内容，之后与同一行同样的内容已有值，取反后为假，所以不打印同内容行。</span><br><span class="line">达到去重的效果</span><br><span class="line"></span><br><span class="line">[root@centos7 data]#awk &apos;&#123;!link[$0]++;print $0,link[$0]&#125;&apos; f1</span><br><span class="line">aaa 1</span><br><span class="line">aaa 2</span><br><span class="line">abc 1</span><br><span class="line">ddd 1</span><br><span class="line">ddd 2</span><br><span class="line">zcd 1</span><br><span class="line">bgd 1</span><br><span class="line">zcd 2</span><br><span class="line">同样内容的行会自加运算，所以可以去重</span><br><span class="line"></span><br><span class="line">利用for循环打印weekdays的数组元素</span><br><span class="line">awk &apos;BEGIN&#123;weekdays[&quot;mon&quot;]=&quot;Monday&quot;;weekdays[&quot;tue&quot;]=&quot;Tuesday&quot;;for(i in weekdays)&#123;print weekdays[i]&#125;&#125;&apos;</span><br><span class="line">Tuesday</span><br><span class="line">Monday</span><br><span class="line"></span><br><span class="line">利用数组for循环统计链接状态信息</span><br><span class="line">netstat -tan | awk &apos;/^tcp/&#123;state[$NF]++&#125;END&#123;for(i in state)&#123;print i,state[i]&#125;&#125;&apos;</span><br><span class="line">LISTEN 9</span><br><span class="line">ESTABLISHED 2</span><br><span class="line"></span><br><span class="line">利用数组for循环统计http访问次数</span><br><span class="line">awk &apos;&#123;ip[$1]++&#125;END&#123;for(i in ip)&#123;print i,ip[i]&#125;&#125;&apos; /var/log/httpd/access_log</span><br><span class="line"></span><br><span class="line">利用数组for循环统计远程访问地址次数</span><br><span class="line">ss -nt | awk -F&quot;[[:space:]]+|:&quot; &apos;/ESTAB/&#123;ip[$(NF-2)]++&#125;END&#123;for(i in ip)&#123;print i,ip[i]&#125;&#125;&apos;</span><br><span class="line">192.168.34.1 2</span><br><span class="line"></span><br><span class="line">利用数组for循环统计文件系统格式</span><br><span class="line">awk &apos;/^UUID/&#123;file[$3]++&#125;END&#123;for(i in file)&#123;print i,file[i]&#125;&#125;&apos; /etc/fstab </span><br><span class="line">swap 1</span><br><span class="line">xfs 3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat score </span><br><span class="line">name  sex score</span><br><span class="line">a     m    90</span><br><span class="line">b	  f    80</span><br><span class="line">c     f    99</span><br><span class="line">d     m    88</span><br><span class="line">利用数组for循环统计男女生平均分</span><br><span class="line">awk &apos;NR&gt;1&#123;score[$2]+=$3;num[$2]++&#125;END&#123;for(i in score)&#123;print i,score[i]/num[i]&#125;&#125;&apos; score </span><br><span class="line">m 89</span><br><span class="line">f 89.5</span><br></pre></td></tr></table></figure>
<h1 id="awk函数"><a href="#awk函数" class="headerlink" title="awk函数"></a>awk函数</h1><h4 id="数值处理："><a href="#数值处理：" class="headerlink" title="数值处理："></a>数值处理：</h4><p>rand()：返回0和1之间一个随机数   </p>
<p>#默认初始值固定0.237788<br>需配合种子参数srand()生成真正的随机数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">生成0-100随机数</span><br><span class="line">awk &apos;BEGIN&#123;srand();print int(rand()*100)&#125;&apos;</span><br><span class="line"></span><br><span class="line">生成10个随机整数</span><br><span class="line">awk &apos;BEGIN&#123;srand(); for (i=1;i&lt;=10;i++)print int(rand()*100) &#125;&apos;</span><br></pre></td></tr></table></figure></p>
<h4 id="字符串处理："><a href="#字符串处理：" class="headerlink" title="字符串处理："></a>字符串处理：</h4><ul>
<li>length([s])：返回指定字符串的长度</li>
<li>sub(r,s,[t])：对t字符串搜索r表示模式匹配的内容，并将<strong>第一个匹配</strong>内容替换为s<br><code>echo &quot;2008:09:05 06:01:03&quot; | awk &#39;sub(&quot;:&quot;,&quot;-&quot;,$1)&#39;
2008-09:05 06:01:03</code></li>
<li>gsub(r,s,[t])：对t字符串进行搜索r表示的模式匹配的内容，并<strong>全部替换</strong>为s所表示的内容<br><code>echo &quot;2008:09:05 06:01:03&quot; | awk &#39;gsub(/:/,“-&quot;,$1)&#39; 2008-09-05 06:01:03</code></li>
<li>split(s,array,[r])：以r为分隔符，切割字符串s，并将切割后的结果保存至array所表示的数组中，第一个索引值为1,第二个索引值为2,…   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">以:为分隔符，切分字段，利用数组循环打印每段内容（注意打印顺序不按数字大小排列）</span><br><span class="line">echo &quot;2008:09:05 06:01:03&quot; | awk &apos;&#123;split($0,str,&quot;:&quot;)&#125;END&#123;for(i in str)&#123;print i,str[i]&#125;&#125;&apos;</span><br><span class="line">4 01</span><br><span class="line">5 03</span><br><span class="line">1 2008</span><br><span class="line">2 09</span><br><span class="line">3 05 06</span><br><span class="line"></span><br><span class="line">利用两组数组来统计远程链接IP,ip数组[1]取值为IP地址，ip[2]为端口号段</span><br><span class="line">netstat -tn | awk &apos;/^tcp/&#123;split($5,ip,&quot;:&quot;);count[ip[1]]++&#125;END&#123;for(i in count)&#123;print i,count[i]&#125;&#125;&apos;</span><br><span class="line">192.168.34.1 1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="自定义函数格式"><a href="#自定义函数格式" class="headerlink" title="自定义函数格式"></a>自定义函数格式</h2><p>定义函数的时候，()中的参数为形参，调用赋值的时候为实参<br>function name (parameter, parameter, …) {<br> statements<br> return expression<br>}  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">利用函数文件实现参数大小对比</span><br><span class="line">函数意义:判断x是否大于y，如果是var等于x，不是var等于y，返回var的值</span><br><span class="line"></span><br><span class="line">[root@centos7 data]#cat fun.awk</span><br><span class="line">function max(x,y)&#123;</span><br><span class="line">	x&gt;y?var=x:var=y</span><br><span class="line">	return var</span><br><span class="line">&#125;</span><br><span class="line">BEGIN&#123;print max(a,b)&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 data]#awk -v a=&quot;32&quot; -v b=&quot;24&quot; -f fun.awk</span><br><span class="line">32</span><br></pre></td></tr></table></figure>
<h2 id="awk中system命令调用shell命令"><a href="#awk中system命令调用shell命令" class="headerlink" title="awk中system命令调用shell命令"></a>awk中system命令调用shell命令</h2><p>空格是awk中的字符串连接符，如果system中需要使用awk中的变量可以使用空格分隔，或者说除了awk的变量外其他一律用””引用起来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">awk利用system调用hostname命令</span><br><span class="line">awk &apos;BEGIN&#123;system(&quot;hostname&quot;)&#125;&apos;</span><br><span class="line">centos7.localdomain</span><br><span class="line"></span><br><span class="line">awk利用system调用echo命令打印</span><br><span class="line">awk &apos;BEGIN&#123;score=100;system(&quot;echo your score is &quot; score)&#125;&apos;</span><br><span class="line">your score is 100</span><br><span class="line"></span><br><span class="line">awk利用system调用ls命令显示一个变量，注意引号中的ls后的空格，需要与平时在shell中执行一样的格式，否则报错</span><br><span class="line">awk &apos;BEGIN&#123;dir=&quot;/boot&quot;;system(&quot;ls &quot; dir)&#125;&apos;</span><br><span class="line">config-3.10.0-862.el7.x86_64				 </span><br><span class="line">grub2</span><br></pre></td></tr></table></figure>
<h2 id="awk脚本"><a href="#awk脚本" class="headerlink" title="awk脚本"></a>awk脚本</h2><p>将awk程序写成脚本，直接调用或执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">打印UID大于1000的username和UID</span><br><span class="line">cat &gt; f1.awk &lt;&lt;EOF</span><br><span class="line">&#123;if($3&gt;=1000)print $1,$3&#125;</span><br><span class="line">EOF</span><br><span class="line">awk -F: -f f1.awk /etc/passwd</span><br><span class="line"></span><br><span class="line">利用awk脚本,赋予执行权限后，直接执行</span><br><span class="line">[root@centos7 data]#cat f2.awk</span><br><span class="line">#!/bin/awk -f</span><br><span class="line">#this is awk script</span><br><span class="line">&#123;if($3&gt;=1000)&#123;print $1,$3&#125;&#125;</span><br><span class="line">[root@centos7 data]#chmod +x f2.awk</span><br><span class="line">[root@centos7 data]#./f2.awk -F: /etc/passwd</span><br><span class="line">nfsnobody 65534</span><br><span class="line">nie 1000</span><br><span class="line">li 1001</span><br></pre></td></tr></table></figure>
<h2 id="向awk脚本传递参数"><a href="#向awk脚本传递参数" class="headerlink" title="向awk脚本传递参数"></a>向awk脚本传递参数</h2><p><strong>格式</strong>：<br>awkfile var=value var2=value2… Inputfile  </p>
<p>注意：<strong>在BEGIN过程中不可用</strong>。直到首行输入完成以后，变量才可用。可以通过-v参数，让awk在执行BEGIN之前得到变量的值。命令行中每一个指定的变量都需要一个-v参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">可以不使用-v定义变量</span><br><span class="line">[root@centos7 data]#cat f2.awk</span><br><span class="line">#!/bin/awk -f</span><br><span class="line">#this is awk script</span><br><span class="line">&#123;if($3&gt;=num)&#123;print $1,$3&#125;&#125;</span><br><span class="line">[root@centos7 data]#./f2.awk -F: num=1000 /etc/passwd</span><br><span class="line">nfsnobody 65534</span><br><span class="line">nie 1000</span><br><span class="line">li 1001</span><br><span class="line"></span><br><span class="line">cat test.awk</span><br><span class="line">#!/bin/awk –f</span><br><span class="line">&#123;if($3 &gt;=min &amp;&amp; $3&lt;=max)print $1,$3&#125;</span><br><span class="line">chmod +x test.awk</span><br><span class="line">test.awk -F: min=100 max=200 /etc/passwd</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.nextx.tk/2018/11/11/系统启动和grub管理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nieW">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nieW learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/系统启动和grub管理/" itemprop="url">系统启动和grub管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-11T22:43:58+08:00">
                2018-11-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Linux组成"><a href="#Linux组成" class="headerlink" title="Linux组成"></a>Linux组成</h1><p>单内核:linux 所有功能集成在同一程序<br>微内核:windows 每种功能使用一个单独子系统  </p>
<h2 id="内核"><a href="#内核" class="headerlink" title="内核"></a>内核</h2><p>模块化: .ko（内核对象）<br>动态装载和卸载<br>例如：/lib/modules/3.10.0-862.14.4.el7.x86_64/kernel/fs/</p>
<p>核心文件：/boot/vmlinuz-VERSION-release<br>ramdisk：辅助的伪根系统<br>CentOS 5: /boot/initrd-VERSION-release.img<br>CentOS 6,7: /boot/initramfs-VERSION-release.img<br>模块文件：/lib/modules/VERSION-release  </p>
<h2 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h2><ol>
<li>post<br>Power-On-Self-Test，加电自检，是BIOS功能的一个主要部分。</li>
<li>ROM<br>BIOS，Basic Input and Output System，保存着有关计算机系统最重要<br>的基本输入输出程序，系统信息设置、开机加电自检程序和系统启动自举程序等</li>
<li>RAM<br>CMOS互补金属氧化物半导体，保存各项参数的设定   </li>
<li>bootloader<br>引导加载器，引导程序<br>windows: ntloader，仅是启动OS<br>Linux：功能丰富，提供菜单，允许用户选择要启动系统或不同的内核版本；把用户选定的内核装载到内存中的特定空间中，解压、展开，并把系统控制权移交给内核<br>LILO：LInux LOader<br>GRUB: GRand Unified Bootloader<br>GRUB 0.X: GRUB Legacy， GRUB2    </li>
</ol>
<ul>
<li>MBR：第一扇区<br>前446字节 bootloader<br>中间64字节 分区表<br>最后2字节 55AA  </li>
<li>GRUB<br>1.5阶段  寻找磁盘固定位置的二进制数据<br>2阶段 寻找磁盘分区文件  /boot/grub</li>
</ul>
<ol start="5">
<li>加载内核/boot/vmlinuz…<br>通过/initramfs….img加载文件系统驱动<br>加载硬件驱动程序（借助于ramdisk加载驱动）<br>以只读方式挂载根文件系统<br>运行用户空间的第一个应用程序：/sbin/init</li>
</ol>
<blockquote>
<p>ramdisk：内核中的特性之一：使用缓冲和缓存来加速对磁盘上的文件访问，并加载相应的硬件驱动<br>ramdisk –&gt; ramfs 提高速度<br>CentOS 5: initrd<br>工具程序：mkinitrd<br>CentOS 6，7: initramfs<br>工具程序：mkinitrd, dracut  </p>
</blockquote>
<hr>
<p><strong>系统初始化</strong>：<br>POST –&gt; BootSequence (BIOS) –&gt; Bootloader(MBR) –&gt;<br>kernel(ramdisk) –&gt; rootfs(只读) –&gt; init（systemd）</p>
<h3 id="ramdisk管理"><a href="#ramdisk管理" class="headerlink" title="ramdisk管理"></a>ramdisk管理</h3><p>ramdisk文件的制作：  </p>
<ul>
<li>mkinitrd命令<br>为当前正在使用的内核重新制作ramdisk文件<br>#<strong>uname -r生产内核版本号以便制作此文件</strong><br><code>mkinitrd /boot/initramfs-$(uname -r).img $(uname -r)</code>  </li>
<li>dracut命令<br>为当前正在使用的内核重新制作ramdisk文件<br><code>dracut /boot/initramfs-$(uname -r).img $(uname -r)</code>  </li>
</ul>
<hr>
<p>实验：误删除initramfs文件恢复(centos6)  </p>
<ol>
<li>系统重启后故障画面<br><img src="https://note.youdao.com/yws/api/personal/file/0CD7FC55A5994D949AD0892648AC784C?method=download&amp;shareKey=c20a90f2e62b9c2458e6c4b7f719c0bf" alt="init"></li>
<li>使用系统版本对应的光盘进入救援模式</li>
<li>切根后输入<code>mkinitrd /boot/initramfs-$(uname -r).img $(uname -r)</code>重新恢复文件<br><img src="https://note.youdao.com/yws/api/personal/file/1CDA0129FFD5489BA9A276F087F8D772?method=download&amp;shareKey=69d9d9e9211be19612fe609be3a7964c" alt="init"></li>
</ol>
<blockquote>
<p>修复后注意sync写入磁盘，避免出现故障  </p>
</blockquote>
<h3 id="init初始化"><a href="#init初始化" class="headerlink" title="init初始化"></a>init初始化</h3><p>init读取其初始化文件：/etc/inittab<br>初始运行级别(RUN LEVEL)<br>系统初始化脚本<br>对应运行级别的脚本目录<br>捕获某个关键字顺序<br>定义UPS电源终端/恢复脚本<br>在虚拟控制台生成getty<br>在运行级别5初始化X  </p>
<ul>
<li>启动配置文件<br><strong>centos6</strong> init程序:Upstart<br>/etc/inittab<br>/etc/init/*.conf<br><strong>centos7</strong>: systemd<br>/usr/lib/systemd/system<br>/etc/systemd/system  <blockquote>
<p>设置开机启动模式systemctl set-default runlevel3.target</p>
</blockquote>
</li>
</ul>
<p>runlevel就是各个服务的集合<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">运行级别：为系统运行或维护等目的而设定；0-6：7个级别</span><br><span class="line">0：关机</span><br><span class="line">1：单用户模式(root自动登录), single, 维护模式（无网络维护模式）可破解root口令</span><br><span class="line">2: 多用户模式，启动网络功能，但不会启动NFS；维护模式</span><br><span class="line">3：多用户模式，正常模式；文本界面</span><br><span class="line">4：预留级别；可同3级别</span><br><span class="line">5：多用户模式，正常模式；图形界面</span><br><span class="line">6：重启</span><br><span class="line">默认级别：3, 5</span><br><span class="line">切换级别：init #</span><br><span class="line">查看级别：runlevel ; who -r</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>修复init设置错误<br>1、在系统倒计时时按任意键<br>2、进入内核选择界面，选择 “a” 编辑内核文件<br>3、在文件结尾添加想要进入的运行模式，比如3（文件为/etc/boot/grub.conf),临时进入系统跳过系统设置的错误值</p>
</blockquote>
<ul>
<li><p>系统初始化脚本<br>/etc/rc.d/rc.sysinit: 系统初始化脚本<br>1、设置主机名<br>2、设置欢迎信息<br>3、激活udev和selinux<br>4、挂载/etc/fstab文件中定义的文件系统<br>5、检测根文件系统，并以读写方式重新挂载根文件系统<br>6、设置系统时钟<br>7、激活swap设备<br>8、根据/etc/sysctl.conf文件设置内核参数<br>9、激活lvm及software raid设备<br>10、加载额外设备的驱动程序<br>11、清理操作  </p>
</li>
<li><p>按照设定的runlevel运行相对应的脚本<br><strong>说明：rc N –&gt; 意味着读取/etc/rc.d/rcN.d/</strong><br>K<em>: K##</em>：##运行次序；数字越小，越先运行；数字越小的服务，通常为<br>依赖到别的服务<br>S<em>: S##</em>：##运行次序；数字越小，越先运行；数字越小的服务，通常为<br>被依赖到的服务  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">for srv in /etc/rc.d/rcN.d/K*; do</span><br><span class="line">    $srv stop</span><br><span class="line">done</span><br><span class="line">for srv in /etc/rc.d/rcN.d/S*; do</span><br><span class="line">    $srv start</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>/etc/rc.d/rcN.d/中的文件都是软链接文件，对应/etc/init.d/中的文件<br>切换各runlevel会运行脚本停止或启动各个服务</p>
</blockquote>
<h2 id="chkconfig配置命令"><a href="#chkconfig配置命令" class="headerlink" title="chkconfig配置命令"></a>chkconfig配置命令</h2><ul>
<li><p>ntsysv设置开机启动的服务 每次只能修改一种运行级别的服务<br>ntsysv –level </p>
</li>
<li><p>chkconfig  </p>
</li>
</ul>
<p>查看服务在所有级别的启动或关闭设定情形：<br>chkconfig [–list] [name]<br>添加：chkconfig –add name<br>删除：chkconfig –del name<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --level 35 atd on  #修改atd在runlevel 3和5的启动  </span><br><span class="line">chkconfig --list atd  </span><br><span class="line"></span><br><span class="line">常用的方式</span><br><span class="line">chkconfig atd on 默认设置2345模式下的开机启动</span><br></pre></td></tr></table></figure></p>
<p><strong>service命令调用的/etc/init.d/中的命令来管理服务</strong></p>
<blockquote>
<p>自定义的启动脚本服务建议放置在S开头靠后的位置<br>/etc/init.d/rc*.<strong>d目录下的文件时由文件开头的字符排序得到</strong>，不是数字排序  </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#简单启动脚本示例</span><br><span class="line">#chkconfig: 35 98 03 #想要开机运行的runlevel S开头的排序号 K开头的排序号</span><br><span class="line">#description: test services</span><br><span class="line"></span><br><span class="line">. /etc/init.d/functions #引用系统函数</span><br><span class="line">case $1 in</span><br><span class="line"></span><br><span class="line">start)</span><br><span class="line">        touch /var/lock/subsys/testsrv #如果是运行命令，就创建文件并打印启动服务</span><br><span class="line">        action &quot;Starting testsrv&quot; true</span><br><span class="line">        ;;</span><br><span class="line">stop)</span><br><span class="line">        rm -f /var/lock/subsys/testsrv #如果是停止命令，就删除文件并打印停止服务</span><br><span class="line">        action &quot;Stopping testsrv&quot; true</span><br><span class="line">        ;;</span><br><span class="line">restart)</span><br><span class="line">        action &quot;Stopping testsrv&quot; true</span><br><span class="line">        action &quot;Starting testsrv&quot; true</span><br><span class="line">        ;;</span><br><span class="line">status)</span><br><span class="line">        if [ -f /var/lock/subsys/testsrv ];then #判断启动模式，通过运行命令创建的文件是否存在得知</span><br><span class="line">                echo testsrv is running...</span><br><span class="line">        else</span><br><span class="line">                echo testsrv is stopped</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">*)</span><br><span class="line">        echo Usage: /etc/init.d/testsrv &#123;start|stop|restart|status&#125; #打印服务管理命令</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">运行效果：</span><br><span class="line">[root@Centos6 init.d]# ./testsrv start</span><br><span class="line">Starting testsrv                       [  OK  ]</span><br><span class="line">[root@Centos6 init.d]# ./testsrv status</span><br><span class="line">testsrv is running...</span><br><span class="line">[root@Centos6 init.d]# ./testsrv stop</span><br><span class="line">Stopping testsrv                       [  OK  ]</span><br><span class="line">[root@Centos6 init.d]# ./testsrv status</span><br><span class="line">testsrv is stopped</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">通过chkconfig --add testsrv   就可以添加到管理列表中，并会在设置的runlevel3和5中创建相应的软链接文件</span><br><span class="line">![chkconfig](https://note.youdao.com/yws/api/personal/file/6A199844416C49E6B278F811636AA0E9?method=download&amp;shareKey=d7d41f383404c1e8f5e5bee2adc566fd)                 </span><br><span class="line"></span><br><span class="line">可以使用chkconfig --del testsrv删除服务列表  </span><br><span class="line">对应的操作：删除了/etc/rc*.d/中的软链接文件  </span><br><span class="line"></span><br><span class="line">## xinetd</span><br><span class="line"></span><br><span class="line">瞬态(Transient)服务被xinetd进程所管理  </span><br><span class="line">进入的请求首先被xinetd代理   </span><br><span class="line">配置文件：  </span><br><span class="line">/etc/xinetd.conf  </span><br><span class="line">/etc/xinetd.d/&lt;service&gt;   </span><br><span class="line">与libwrap.so文件链接   </span><br><span class="line">用chkconfig控制的服务：   </span><br><span class="line">示例：chkconfig tftp on  </span><br><span class="line"></span><br><span class="line">超级守护进程centos6</span><br><span class="line"></span><br><span class="line">&gt; xinted代理人 负责唤醒其它服务   </span><br><span class="line">非独立服务、适合不经常启动的服务、开机不启动  </span><br><span class="line"></span><br><span class="line">启动xinetd服务即可管理受控服务，会自动唤醒被管理的服务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">S99local **/etc/rc.d/rc/local** 可以接管所有不想写启动脚本的服务   </span><br><span class="line">默认可以启动脚本内的服务，**但不能通过service管理**，只能通过kill关闭  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">CentOS 6启动流程：</span><br><span class="line">POST</span><br></pre></td></tr></table></figure>
<p>Boot Sequence(BIOS) –&gt; Boot Loader –&gt; Kernel(ramdisk) –&gt;rootfs –&gt; switchroot –&gt; /sbin/init –&gt;(/etc/inittab,/etc/init/*.conf) –&gt; 设定默认运<br>行级别 –&gt; 系统初始化脚本rc.sysinit –&gt; 关闭或启动对应级别的服务 –&gt; 启动终端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">![boot](http://s4.51cto.com/wyfs02/M02/87/20/wKiom1fVBELjXsvaAAUkuL83t2Q304.jpg)</span><br><span class="line"># grub</span><br><span class="line"></span><br><span class="line">grub: GRand Unified Bootloader   </span><br><span class="line">grub 0.97: grub legacy  #老版本 centos6   </span><br><span class="line">grub 2.x: grub2 #新版本 centos7   </span><br><span class="line">grub legacy:   </span><br><span class="line">stage1: mbr   </span><br><span class="line">stage1_5: mbr之后的扇区，让stage1中的bootloader能识别stage2所在</span><br><span class="line">的分区上的文件系统   </span><br><span class="line">stage2：磁盘分区(/boot/grub/)   </span><br><span class="line"></span><br><span class="line">实验：   </span><br><span class="line">1.5阶段的MBR启动分区被破坏的修复   </span><br><span class="line">1、启动分区的MBR前446字节被破坏</span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/B2A4879AABCF4E9693BF818DE53BAB04?method=download&amp;shareKey=94e10b7f39acf2a892f159365f9be860)   </span><br><span class="line">2、重启之后直接会进入光盘界面，等待被修复  </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/C40BDABCC8E6483591B9F9949593CE08?method=download&amp;shareKey=af1d56b45fd76a65fe46719dc69f2dc1)   </span><br><span class="line">修复方法一：    </span><br><span class="line">3、进入修复界面切换根目录chroot /mnt/sysimage运行 grub-install /dev/sda   </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/938A5C0206EC449792DA5AC99FC287AF?method=download&amp;shareKey=9e551d61078dbfe3994926a48ed5da88)  </span><br><span class="line">&gt; 也可以使用grub-install命令在没有重启的情况下修复，而且不依赖/etc/grub中的文件，更为通用</span><br><span class="line"></span><br><span class="line">修复方法二：</span><br><span class="line">在没有重启的情况下，可以直接修复</span><br><span class="line">使用grub命令进入交互式  </span><br><span class="line">grub&gt; root (hd#,#)    #boot所在的磁盘、分区序号    </span><br><span class="line">grub&gt; setup (hd#) #MBR写入的硬盘序列号  </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/7C303012D3364865AB817AA355ACDBF2?method=download&amp;shareKey=e993d64c0643904a6691d8b5b804842d)  </span><br><span class="line">&gt; 此修复方法依赖/etc/grub中的文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 修复过的扇区文件和初始安装的状态并不一样，初始安装的512之后的删除都是空白扇区</span><br><span class="line"></span><br><span class="line">- /boot/grub中的文件除grub.conf外是硬盘分区时段的备份文件</span><br><span class="line"></span><br><span class="line">- 使用grub-install修复过的硬盘如果再次破坏/etc/grub中的文件，将导致不能引导   </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/A4670032045945A9AA3FD8F25A0F1F76?method=download&amp;shareKey=426a1841bbbf45835d3bdb926f7184a8)</span><br><span class="line"></span><br><span class="line">- rhgb 图形界面启动画面  建议修改为字符界面 修改/boot/gurb/grub.conf(centos6) 删除rhbg字符</span><br><span class="line"></span><br><span class="line">## grub legacy</span><br><span class="line"></span><br><span class="line">配置文件：/boot/grub/grub.conf &lt;--/etc/grub.conf  </span><br><span class="line">stage2及内核等通常放置于一个基本磁盘分区  </span><br><span class="line">功用：</span><br><span class="line">- 提供启动菜单、并提供交互式接口</span><br><span class="line">a：内核参数</span><br><span class="line">e: 编辑模式，用于编辑菜单</span><br><span class="line">c: 命令模式，交互式接口</span><br><span class="line">- 加载用户选择的内核或操作系统</span><br><span class="line">允许传递参数给内核</span><br><span class="line">可隐藏启动菜单</span><br><span class="line">- 为菜单提供了保护机制</span><br><span class="line">为编辑启动菜单进行认证</span><br><span class="line">为启用内核或操作系统进行认证</span><br><span class="line"></span><br><span class="line">&gt; 识别硬盘设备(hd#,#)  </span><br><span class="line">hd#: 磁盘编号，用数字表示；从0开始编号  </span><br><span class="line">#: 分区编号，用数字表示; 从0开始编号  </span><br><span class="line">(hd0,0) 第一块硬盘，第一个分区</span><br></pre></td></tr></table></figure></p>
<p>手动在grub命令行接口启动系统<br>grub&gt; root (hd#,#) #MBR所在磁盘和分区<br>grub&gt; kernel /vmlinuz-VERSION-RELEASE ro root=/dev/DEVICE #内核的文件路径<br>grub&gt; initrd /initramfs-VERSION-RELEASE.img<br>grub&gt; boot #文件系统驱动路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### grub legacy配置文件</span><br><span class="line"></span><br><span class="line">配置文件：/boot/grub/grub.conf  </span><br><span class="line">**default**=#: 设定默认启动的菜单项；落单项(title)编号从0开始   </span><br><span class="line">**timeout**=#：指定菜单项等待选项选择的时长   </span><br><span class="line">splashimage=(hd#,#)/PATH/XPM_FILE：菜单背景图片文件路径   </span><br><span class="line">password [--md5] STRING: 启动菜单编辑认证   </span><br><span class="line">hiddenmenu：隐藏菜单   </span><br><span class="line">**title** TITLE：定义菜单项“标题”, 可出现多次   </span><br><span class="line">**root** (hd#,#)：查找stage2及kernel文件所在设备分区；为grub的根   </span><br><span class="line">**kernel** /PATH/TO/VMLINUZ_FILE [PARAMETERS]：启动的内核   </span><br><span class="line">**initrd** /PATH/TO/INITRAMFS_FILE: 内核匹配的ramfs文件   </span><br><span class="line">password [--md5|--encrypted ] STRING: 启动选定的内核或操作系统时进行认证   </span><br><span class="line"></span><br><span class="line">&gt; 注意配置文件的顺序，initrd和kernel必须是kernel在前，否则不能启动  </span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">**实验**：配置文件顺序开机错误</span><br><span class="line"></span><br><span class="line">1. 配置文件顺序错误后的报错画面   </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/E6B9626CF445464FA22B7670A685EC99?method=download&amp;shareKey=6b42af323e9b7a8f929c0b47fbec5582)  </span><br><span class="line">修复方法：  </span><br><span class="line">1. 进入内核选择界面，按“e”，编辑启动文件   </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/72F87AB9BB4149CD99D0E6C4D29CA2F7?method=download&amp;shareKey=dbf59d5cba671c6b9696ee1b2e2c847c)  </span><br><span class="line">2. 看到错误顺序的启动文件，选中顺序错误的inird行，按“d”删除   </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/7D42E4FE0219487B9EB838E393476468?method=download&amp;shareKey=f20706c9bfe1d6de19627c2d61eb9fac)  </span><br><span class="line">3. 按“o”--“e”，重新编辑一行initrd   </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/68B51ECEE14549D3A9645C783F0CBAC9?method=download&amp;shareKey=5c537e8f3b8b51b7f6c1f7ce903c68ec)  </span><br><span class="line">4. 按“b”重启即可   </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/64BF10FA4F95476AACFBDA2E730699B7?method=download&amp;shareKey=b90098a9032ef033117d2f6d5f5dd97c)  </span><br><span class="line">5. 进入系统记得修改错误的/etc/grub.conf文件</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">## grub加密</span><br><span class="line"></span><br><span class="line">生成grub口令</span><br><span class="line">- grub-md5-crypt</span><br><span class="line">- grub-crypt  </span><br><span class="line"></span><br><span class="line">在/etc/grub.conf中添加密码行  </span><br><span class="line">password --md5 生成的密码  </span><br><span class="line">password --encrypted 生成的密码  </span><br><span class="line"></span><br><span class="line">破解root口令：  </span><br><span class="line">启动系统时，设置其运行级别1</span><br><span class="line">进入单用户模式：</span><br><span class="line">- 编辑grub菜单(选定要编辑的title，而后使用a 或 e 命令)</span><br><span class="line">- 在选定的kernel后附加</span><br><span class="line">1, s, S，single 都可以</span><br><span class="line">- 在kernel所在行，键入“b”命令</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">**实验**：误删boot目录后恢复</span><br><span class="line">1. 重启后直接进入grub编辑界面，由于找不到配置文件引起的错误   </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/E08C46E12F744A5AB9A5E0051549A2B2?method=download&amp;shareKey=a5db3a9c2f91a9f45f7774920f8030e6)  </span><br><span class="line">2. 光盘重启进入救援模式，使用rpm -ivh /mnt/cdrom/Packages/kerner-2.6.*** --root=/mnt/sysimage/ --force重新安装内核文件，chroot /mnt/sysimage后使用grub-install /dev/sda命令生成grub文件  </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/2809E213C7E7494DA271939462793816?method=download&amp;shareKey=16727eb21caf61d8d185c371500130d7)   </span><br><span class="line">3. 进入/boot/grub/ 重新编辑grub文件，内核和initrd文件过长，可以使用r!ls /boot/vm... /boot/init...调用，避免出错。  </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/5B8259E5E66A4F369284AAB192A815DD?method=download&amp;shareKey=a744532040f63ca69c764d4751b634c7)  </span><br><span class="line"></span><br><span class="line">&gt; 最后最好再检查一下/etc/selinux/config中的运行状态是disabled。</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">实验：fstab文件和/boot目录被破坏，恢复 错误代码15  </span><br><span class="line">1. blkid查看分区和UUID   </span><br><span class="line">2. fdisk -l查看分区大小，mkdir /mnt/rootfs，使用mount挂载后查看有可能的分区 </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/B195491CBB99413199FA16D97EB88931?method=download&amp;shareKey=bb04c0f8879f9ed890c084c17f7d0b42)  </span><br><span class="line">3. 修复fstab文件   </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/96B803C6BECB43E88B02AAF02E2CFE68?method=download&amp;shareKey=54f893a80f1394e727241d7b1e4f47f4)  </span><br><span class="line">4. 重新光盘启动，即可发现系统分区   </span><br><span class="line">5. 重新安装kernel、grub-install   </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/2809E213C7E7494DA271939462793816?method=download&amp;shareKey=16727eb21caf61d8d185c371500130d7)    </span><br><span class="line">6. 重新配置grub.conf文件   </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/5B8259E5E66A4F369284AAB192A815DD?method=download&amp;shareKey=a744532040f63ca69c764d4751b634c7)  </span><br><span class="line"></span><br><span class="line">&gt; 最后最好再检查一下/etc/selinux/config中的运行状态是disabled  </span><br><span class="line">如果提前chroot切根后，使用 rpm -ivh /mnt/cdrom/kernel-... --force强行安装内核</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">实验：lv逻辑卷分区fstab文件和/boot目录破坏，恢复   </span><br><span class="line">1. lvs查看现有逻辑卷的分区、lvdisplay查看逻辑卷状态   </span><br><span class="line">2. 不能使用mount挂载，逻辑卷组被禁用状态  </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/D25B195394F640F3ABA8BE18DE8A5A7B?method=download&amp;shareKey=e790fe9d597c3dc4a19957d37dd97494)  </span><br><span class="line">3. 首先需要vgchage -ay激活逻辑卷  </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/B1F4A0ABEAA04A3D9F1AB263A3E1A25C?method=download&amp;shareKey=83a34cba0bb5b20c36e9d05092d40a79)  </span><br><span class="line">4. mkdir /mnt/rootfs  mount挂载分区  </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/F776A2636CD24B2EB8BB72D7D0862F0E?method=download&amp;shareKey=6a59e083e06e193173817e615c341cde)   </span><br><span class="line">5. 重写fstab文件  </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/AF66100F829D4A84B57CA1F88EE91055?method=download&amp;shareKey=b17aab7d323cdc25cc628b88345c6b3e)  </span><br><span class="line">6. 光盘重启，进入常规修复 </span><br><span class="line">7. 重新安装kernel、grub-install </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/AE219E055193453EBACA5B612745B1A9?method=download&amp;shareKey=48be84cd2f79549e1d5eba511875dd59)</span><br><span class="line">8. 重新配置grub.conf文件  </span><br><span class="line">![MBR](https://note.youdao.com/yws/api/personal/file/0B91B27A84FD41F8852A0FB956EDBF78?method=download&amp;shareKey=d49501fa22958f26f4a0586ebdf2426f)  </span><br><span class="line">&gt; 注意grub.conf中逻辑卷的root目录写法  </span><br><span class="line"></span><br><span class="line"># /proc目录</span><br><span class="line"></span><br><span class="line">内核把自己内部状态信息及统计信息，以及可配置参数通过proc伪文件系统加以输出  </span><br><span class="line"></span><br><span class="line">/proc/sys</span><br><span class="line">- sysctl命令用于查看或设定此目录中诸多参数  </span><br><span class="line">sysctl -w path.to.parameter=VALUE  </span><br><span class="line">sysctl -w kernel.hostname=mail.magedu.com  </span><br><span class="line">- echo命令通过重定向方式也可以修改大多数参数的值  </span><br><span class="line">echo &quot;VALUE&quot; &gt; /proc/sys/path/to/parameter  </span><br><span class="line">echo “websrv” &gt; /proc/sys/kernel/hostname  </span><br><span class="line"></span><br><span class="line">sysctl命令：  </span><br><span class="line">默认配置文件：**/etc/sysctl.conf**（centos6）  </span><br><span class="line">- 设置某参数  </span><br><span class="line">**sysctl -w** parameter=VALUE  </span><br><span class="line">- 通过读取配置文件设置参数(一些修改过的值需重启才可生效)   </span><br><span class="line">**sysctl -p** [/path/to/conf_file]  </span><br><span class="line">- 查看所有生效参数  </span><br><span class="line">**sysctl -a**  </span><br><span class="line"></span><br><span class="line">常用的几个参数：默认0为关闭或忽略  1为启用  </span><br><span class="line">#内核路由转发功能  </span><br><span class="line">net.ipv4.ip_forward   </span><br><span class="line">#内核忽略ICMP响应  </span><br><span class="line">net.ipv4.icmp_echo_ignore_all   </span><br><span class="line">#清理内核缓存  </span><br><span class="line">vm.drop_caches </span><br><span class="line"></span><br><span class="line"># /sys目录</span><br><span class="line"></span><br><span class="line">- sysfs：为用户使用的伪文件系统，输出内核识别出的各硬件设备的相关属性信息，也有内核对硬件特性的设定信息；有些参数是可以修改的，用于调整硬件。</span><br><span class="line"></span><br><span class="line">工作特性</span><br><span class="line">- udev通过此路径下输出的信息动态为各设备创建所需要设备文件，udev是运行用户空间程序。</span><br><span class="line"></span><br><span class="line">专用工具：udevadmin, hotplug</span><br><span class="line">- udev为设备创建设备文件时，会读取其事先定义好的规则文件，一般在`/etc/udev/rules.d`及`/usr/lib/udev/rules.d`目录下</span><br><span class="line"></span><br><span class="line"># 内核编译  </span><br><span class="line"></span><br><span class="line">单内核体系设计、但充分借鉴了微内核设计体系的优点，为内核引入模块化机制</span><br><span class="line"></span><br><span class="line">内核组成部分：  </span><br><span class="line"></span><br><span class="line">- kernel：内核核心，一般为bzImage，通常在/boot目录下，名称为 vmlinuz-VERSION-RELEASE  </span><br><span class="line">只集成必要的常用模块</span><br><span class="line"></span><br><span class="line">- kernel object：内核对象，一般放置于</span><br><span class="line">**/lib/modules/VERSION-RELEASE/**  </span><br><span class="line">非必要的模块，按需启动，例如大量的驱动程序  </span><br><span class="line">[ ]: N 不启用  </span><br><span class="line">[M]: M 存放在/lib/modules中  </span><br><span class="line">[*]: Y 启用到kernel中</span><br><span class="line"></span><br><span class="line">- 辅助文件：ramdisk initrd initramfs</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">**查看内核信息**</span><br><span class="line">uname | 说明</span><br><span class="line">---|---</span><br><span class="line">-n | 显示节点名称</span><br><span class="line">-r | 显示VERSION-RELEASE</span><br><span class="line">-a | 显示所有信息</span><br><span class="line"> |</span><br><span class="line">lsmod | 显示由核心已经装载的内核模块</span><br><span class="line">--- | 显示的内容来自于/proc/modules文件 </span><br><span class="line">|</span><br><span class="line">modinfo | 显示模块的详细描述信息</span><br><span class="line">-n | 只显示模块文件路径</span><br><span class="line">-p | 显示模块参数</span><br><span class="line">-a | 作者</span><br><span class="line">-d | 描述 </span><br><span class="line"></span><br><span class="line">## 内核模块管理</span><br><span class="line"></span><br><span class="line">硬件模块的信息，不常修改  </span><br><span class="line"></span><br><span class="line">- modprobe命令：装载或卸载内核模块，自动解决依赖性    </span><br><span class="line">modprobe [ -C config-file ] [ modulename ] [ module parame-ters... ]  </span><br><span class="line">modprobe [ -r ] modulename…  </span><br><span class="line">配置文件：/etc/modprobe.conf, /etc/modprobe.d/*.conf</span><br><span class="line"></span><br><span class="line">- depmod命令：内核模块依赖关系文件及系统信息映射文件的生成工具  </span><br><span class="line"></span><br><span class="line">- insmod命令 指定模块文件，不自动解决依赖模块</span><br><span class="line">insmod [ filename ] [ module options... ]  </span><br><span class="line">insmod `modinfo –n exportfs`  </span><br><span class="line">lnsmod `modinfo –n xfs`  </span><br><span class="line">- rmmod命令：卸载模块  </span><br><span class="line">rmmod [ modulename ]  </span><br><span class="line">rmmod xfs  </span><br><span class="line">rmmod exportfs  </span><br><span class="line"></span><br><span class="line">## 编译内核</span><br><span class="line"></span><br><span class="line">前提：  </span><br><span class="line">1. 准备好开发环境  </span><br><span class="line">2. 获取目标主机上硬件设备的相关信息  </span><br><span class="line">3. 获取目标主机系统功能的相关信息  </span><br><span class="line"> 例如:需要启用相应的文件系统  </span><br><span class="line">4. 获取内核源代码包  </span><br><span class="line"> www.kernel.org</span><br><span class="line">&gt; 使用lscpu、lsblk等可以方便的查看硬件信息</span><br><span class="line"></span><br><span class="line">编译流程：</span><br><span class="line">- 安装开发包组 #yum groupinstall &quot;development tools&quot;</span><br><span class="line">- 下载源码文件</span><br><span class="line">- .config：准备文本配置文件  </span><br><span class="line">可以参考现有系统的配置文件，将/boot下的.config文件cp到准备编译的目录下</span><br><span class="line">- make menuconfig：图形化配置内核选项</span><br><span class="line">- make [-j #] #指定线程数提高效率</span><br><span class="line">- make modules_install：安装模块</span><br><span class="line">- make install ：安装内核相关文件  </span><br><span class="line">安装bzImage为/boot/vmlinuz-VERSION-RELEASE  </span><br><span class="line">生成initramfs文件  </span><br><span class="line">编辑grub的配置文件</span><br></pre></td></tr></table></figure></p>
<p>示例<br>tar xf linux-3.10.67.tar.xz -C /usr/src<br>cd /usr/src<br>ln -sv linux-3.10.67 linux<br>cd /usr/src/linux<br>cp /boot/config-$(uname -r) ./.config<br>make help<br>make menuconfig #图形化配置<br>make -j 2 #指定线程数提高效率<br>make modules_install<br>make install<br>reboot<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line">- 配置内核选项  </span><br><span class="line">支持“更新”模式进行配置：make help  </span><br><span class="line">(a) make config：基于命令行以遍历的方式配置内核中可配置的每个选项   </span><br><span class="line">(b) make menuconfig：基于curses的文本窗口界面  </span><br><span class="line">(c) make gconfig：基于GTK (GNOME）环境窗口界面  </span><br><span class="line">(d) make xconfig：基于QT(KDE)环境的窗口界面  </span><br><span class="line">支持“全新配置”模式进行配置   </span><br><span class="line">(a) make defconfig：基于内核为目标平台提供的“默认”配置进行配置  </span><br><span class="line">(b) make allyesconfig: 所有选项均回答为“yes“    </span><br><span class="line">(c) make allnoconfig: 所有选项均回答为“no“  </span><br><span class="line"></span><br><span class="line">- 编译  </span><br><span class="line">全编译:make [-j #]   </span><br><span class="line">编译内核的一部分功能：   </span><br><span class="line">(a) 只编译某子目录中的相关代码   </span><br><span class="line">cd /usr/src/linux   </span><br><span class="line">make dir/   </span><br><span class="line">(b) 只编译一个特定的模块   </span><br><span class="line">cd /usr/src/linux   </span><br><span class="line">make dir/file.ko   </span><br><span class="line">示例：只为e1000编译驱动：写出准确的编译路径   </span><br><span class="line">make drivers/net/ethernet/intel/e1000/e1000.ko</span><br><span class="line"></span><br><span class="line">- 如何交叉编译内核：  </span><br><span class="line">编译的目标平台与当前平台不相同  </span><br><span class="line">make ARCH=arch_name  </span><br><span class="line">要获取特定目标平台的使用帮助  </span><br><span class="line">make ARCH=arch_name help  </span><br><span class="line">示例：  </span><br><span class="line">make ARCH=arm help  </span><br><span class="line"></span><br><span class="line">### 清理编译文件</span><br><span class="line"></span><br><span class="line">在已经执行过编译操作的内核源码树做重新编译</span><br><span class="line"></span><br><span class="line">需要事先清理操作：  </span><br><span class="line">**make clean**：清理大多数编译生成的文件，但会保留config文件等   </span><br><span class="line">**make mrproper**: 清理所有编译生成的文件、config及某些备份文件  </span><br><span class="line">**make distclean**：mrproper、清理patches以及编辑器备份文件   </span><br><span class="line"></span><br><span class="line">### 卸载内核</span><br><span class="line">删除/lib/modules/目录下不需要的内核库文件  </span><br><span class="line">删除/usr/src/linux/目录下不需要的内核源码  </span><br><span class="line">删除/boot目录下启动的内核和内核映像文件  </span><br><span class="line">更改grub的配置文件，删除不需要的内核启动列表  </span><br><span class="line"></span><br><span class="line"># Centos7 systemd</span><br><span class="line"></span><br><span class="line">开机流程  </span><br><span class="line">`POST --&gt; Boot Sequence --&gt; Bootloader --&gt; kernel + initramfs(initrd) --&gt; rootfs --&gt; /sbin/init`  </span><br><span class="line">init: 各版本区别   </span><br><span class="line">CentOS 5 SysV init  </span><br><span class="line">CentOS 6 Upstart  </span><br><span class="line">CentOS 7 Systemd  </span><br><span class="line"></span><br><span class="line">Systemd：系统启动和服务器守护进程管理器，负责在系统启动或运行时，激活系统资源，服务器进程和其它进程</span><br><span class="line"></span><br><span class="line">Systemd新特性  </span><br><span class="line">- 系统引导时实现服务并行启动  </span><br><span class="line">- 按需启动守护进程  </span><br><span class="line">- 自动化的服务依赖关系管理  </span><br><span class="line">- 同时采用socket式与D-Bus总线式激活服务  </span><br><span class="line">- 系统状态快照  </span><br><span class="line">&gt; 并行启动服务大幅提高启动速度，利用socket解决服务依赖性</span><br><span class="line"></span><br><span class="line">- 核心概念：**unit**  </span><br><span class="line">unit表示不同类型的systemd对象，通过配置文件进行标识和配置；文件中主要包含了系统服务、监听socket、保存的系统快照以及其它与init相关的信息  </span><br><span class="line">- 配置文件  </span><br><span class="line">**/usr/lib/systemd/system**:每个服务最主要的启动脚本设置，类似于之前的/etc/init.d/  </span><br><span class="line">**/run/systemd/system**：系统执行过程中所产生的服务脚本，比上面目录优先运行  </span><br><span class="line">**/etc/systemd/system**：管理员建立的执行脚本，类似于/etc/rcN.d/Sxx的功能，比上面目录优先运行</span><br><span class="line"></span><br><span class="line">## Unit类型</span><br><span class="line"></span><br><span class="line">systemctl -t help 查看unit类型</span><br><span class="line">- **service** unit: 文件扩展名为.service, 用于定义系统服务</span><br><span class="line">- **Target** unit:文件扩展名为.target，用于模拟实现运行级别</span><br><span class="line">- Device unit: .device, 用于定义内核识别的设备</span><br><span class="line">- Mount unit: .mount, 定义文件系统挂载点</span><br><span class="line">- **Socket** unit: .socket, 用于标识进程间通信用的socket文件，也可在系统启动时，延迟启动服务，**实现按需启动**</span><br><span class="line">- Snapshot unit: .snapshot, 管理系统快照</span><br><span class="line">- Swap unit: .swap, 用于标识swap设备</span><br><span class="line">- Automount unit:.automount，文件系统的自动挂载点</span><br><span class="line">- Path unit: .path，用于定义文件系统中的一个文件或目录使用,常用于当文件系统变化时，延迟激活服务，如：spool 目录</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">- 关键特性：  </span><br><span class="line">基于socket的激活机制：socket与服务程序分离  </span><br><span class="line">基于d-bus的激活机制：   </span><br><span class="line">基于device的激活机制：   </span><br><span class="line">基于path的激活机制：    </span><br><span class="line">系统快照：保存各unit的当前状态信息于持久存储设备中    </span><br><span class="line">向后兼容sysv init脚本   </span><br><span class="line">- 不兼容：  </span><br><span class="line">systemctl命令固定不变，不可扩展  </span><br><span class="line">不是由systemd启动的服务，systemctl无法与之通信和控制</span><br><span class="line"></span><br><span class="line">## 管理服务</span><br><span class="line"></span><br><span class="line">**管理系统服务**：   </span><br><span class="line">CentOS 7: service unit</span><br><span class="line">注意：能兼容早期的服务脚本  </span><br><span class="line"></span><br><span class="line">命令：systemctl COMMAND name.service   </span><br><span class="line">- 启动：service name start ==&gt; systemctl start name.service  </span><br><span class="line">- 停止：service name stop ==&gt; systemctl stop name.service  </span><br><span class="line">- 重启：service name restart ==&gt; systemctl restart name.service  </span><br><span class="line">- 状态：service name status ==&gt; systemctl status name.service  </span><br><span class="line"></span><br><span class="line">&gt; 与service不同的是命令的所在位置，使用systemctl 可以同时启动或停止多个命令  </span><br><span class="line"></span><br><span class="line">- 禁止自动和手动启动：  </span><br><span class="line">systemctl mask name.service  </span><br><span class="line">- 取消禁止：  </span><br><span class="line">systemctl unmask name.service  </span><br><span class="line">&gt; 创建一个软链接到/dev/null，临时禁用服务  </span><br><span class="line"></span><br><span class="line">**服务查看**</span><br><span class="line"></span><br><span class="line">- 查看某服务当前激活与否的状态：  </span><br><span class="line">systemctl is-active name.service</span><br><span class="line">- 查看所有已经激活的服务：  </span><br><span class="line">systemctl list-units --type|-t service</span><br><span class="line">- 查看所有服务：  </span><br><span class="line">systemctl list-units --type service --all|-a</span><br><span class="line"></span><br><span class="line">chkconfig命令的对应关系：</span><br><span class="line"></span><br><span class="line">- 设定某服务开机自启：  </span><br><span class="line">chkconfig name on ==&gt; **systemctl enable name.service**</span><br><span class="line">- 设定某服务开机禁止启动：  </span><br><span class="line">chkconfig name off ==&gt; **systemctl disable name.service**  </span><br><span class="line">- 查看所有服务的开机自启状态：  </span><br><span class="line">chkconfig --list ==&gt; **systemctl list-unit-files** --type service</span><br><span class="line">- 用来列出该服务在哪些运行级别下启用和禁用：  </span><br><span class="line">chkconfig sshd –list ==&gt;</span><br><span class="line"> ls /etc/systemd/system/*.wants/sshd.service</span><br><span class="line">- 查看服务是否开机自启：  </span><br><span class="line">**systemctl is-enabled** name.service</span><br><span class="line">- 其它命令：</span><br><span class="line">查看服务的依赖关系：  </span><br><span class="line">systemctl list-dependencies name.service</span><br><span class="line">- 杀掉进程：  </span><br><span class="line">**systemctl kill** unitname</span><br><span class="line"></span><br><span class="line">**服务状态**  </span><br><span class="line"></span><br><span class="line">systemctl list-unit-files --type service --all显示状态</span><br><span class="line">- loaded Unit配置文件已处理</span><br><span class="line">- active(running) 一次或多次持续处理的运行</span><br><span class="line">- active(exited) 成功完成一次性的配置</span><br><span class="line">- active(waiting) 运行中，等待一个事件</span><br><span class="line">- inactive 不运行</span><br><span class="line">- enabled 开机启动</span><br><span class="line">- disabled 开机不启动</span><br><span class="line">- static 开机不启动，但可被另一个启用的服务激活</span><br><span class="line"></span><br><span class="line">## service unit文件格式</span><br><span class="line"></span><br><span class="line">/etc/systemd/system：系统管理员和用户使用  </span><br><span class="line">/usr/lib/systemd/system：发行版打包者使用  </span><br><span class="line">以&quot;#&quot;开头的行后面的内容会被认为是注释。   </span><br><span class="line">相关布尔值，1、yes、on、true都是开启，0、no、off、false 都是关闭。   </span><br><span class="line">时间单位默认是秒，所以要用毫秒（ms）分钟（m）等须显式说明。  </span><br><span class="line"></span><br><span class="line">service unit file文件通常由三部分组成：  </span><br><span class="line">- **[Unit]**：定义与Unit类型无关的通用选项；用于提供unit的描述信息、unit行</span><br><span class="line">为及依赖关系等</span><br><span class="line">- **[Service]**：与特定类型相关的专用选项；此处为Service类型</span><br><span class="line">- **[Install]**：定义由“systemctl enable”以及&quot;systemctl disable“命令在</span><br><span class="line">实现服务启用或禁用时用到的一些选项</span><br><span class="line"></span><br><span class="line">**[Unit]**段的常用选项：   </span><br><span class="line">- Description：描述信息  </span><br><span class="line">- After：定义unit的启动次序，表示当前unit应该晚于哪些unit启动，其功能与Before相反  </span><br><span class="line">- Requires：依赖到的其它units，强依赖，被依赖的units无法激活时，当前unit也无法激活  </span><br><span class="line">- Wants：依赖到的其它units，弱依赖  </span><br><span class="line">- Conflicts：定义units间的冲突关系   </span><br><span class="line"></span><br><span class="line">**[Service]**段的常用选项：</span><br><span class="line">- Type：定义影响ExecStart及相关参数的功能的unit进程启动类型</span><br><span class="line">- simple：默认值，这个daemon主要由ExecStart接的指令串来启动，启动后常驻于内存中</span><br><span class="line">- forking：由ExecStart启动的程序透过spawns延伸出其他子程序来作为此</span><br><span class="line">daemon的主要服务。原生父程序在启动结束后就会终止</span><br><span class="line">- oneshot：与simple类似，不过这个程序在工作完毕后就结束了，不会常驻在内存中</span><br><span class="line">- dbus：与simple类似，但这个daemon必须要在取得一个D-Bus的名称后，才会继续运作.因此通常也要同时设定BusNname= 才行</span><br><span class="line">- notify：在启动完成后会发送一个通知消息。还需要配合 NotifyAccess 来让Systemd 接收消息</span><br><span class="line">- idle：与simple类似，要执行这个daemon必须要所有的工作都顺利执行完毕后才会执行。这类的daemon通常是开机到最后才执行即可的服务</span><br><span class="line">- EnvironmentFile：环境配置文件</span><br><span class="line">- ExecStart：指明启动unit要运行命令或脚本的绝对路径</span><br><span class="line">- ExecStartPre： ExecStart前运行</span><br><span class="line">- ExecStartPost： ExecStart后运行</span><br><span class="line">- ExecStop：指明停止unit要运行的命令或脚本</span><br><span class="line">- Restart：当设定Restart=1 时，则当次daemon服务意外终止后，会再次自动</span><br><span class="line">启动此服务</span><br><span class="line"></span><br><span class="line">**[Install]**段的常用选项：</span><br><span class="line">- Alias：别名，可使用systemctl command Alias.service</span><br><span class="line">- RequiredBy：被哪些units所依赖，强依赖</span><br><span class="line">- WantedBy：被哪些units所依赖，弱依赖</span><br><span class="line">- Also：安装本服务的时候还要安装别的相关服务</span><br><span class="line"></span><br><span class="line">&gt; 注意：对于新创建的unit文件，或者修改了的unit文件，要通知systemd重载此配置文件,而后可以选择重启   </span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure></p>
<p>备份服务Unit示例<br>vim /etc/systemd/system/bak.service<br>[Unit]<br>Description=backup /etc<br>Requires=atd.service<br>[Service]<br>Type=simple #单次执行<br>ExecStart=/bin/bash -c “echo /testdir/bak.sh|at now” #激活后立即执行备份<br>[Install]<br>WantedBy=multi-user.target #运行在runlevel3</p>
<p>systemctl daemon-reload<br>systemctl start bak<br><code>`</code></p>
<h2 id="运行级别"><a href="#运行级别" class="headerlink" title="运行级别"></a>运行级别</h2><p><strong>target units</strong>：<br>unit配置文件：.target<br>ls /usr/lib/systemd/system/*.target<br>systemctl list-unit-files –type target –all   </p>
<p><strong>运行级别</strong>：<br>0 ==&gt; runlevel0.target, poweroff.target<br>1 ==&gt; runlevel1.target, rescue.target<br>2 ==&gt; runlevel2.target, multi-user.target<br>3 ==&gt; runlevel3.target, multi-user.target<br>4 ==&gt; runlevel4.target, multi-user.target<br>5 ==&gt; runlevel5.target, graphical.target<br>6 ==&gt; runlevel6.target, reboot.target  </p>
<p><strong>查看依赖性</strong>：<br>systemctl list-dependencies graphical.target</p>
<p><strong>级别切换</strong>：<br>init N ==&gt; systemctl isolate name.target<br>例如：systemctl isolate multi-user.target<br>注：只有/lib/systemd/system/*.target文件中AllowIsolate=yes 才能切换   </p>
<blockquote>
<p>修改文件需执行systemctl daemon-reload才能生效</p>
</blockquote>
<p><strong>查看target</strong>：<br>runlevel ;who -r<br>systemctl list-units –type target  </p>
<p><strong>获取默认运行级别</strong>：<br>/etc/inittab ==&gt; systemctl get-default</p>
<p><strong>修改默认级别</strong>：<br>/etc/inittab ==&gt; systemctl set-default name.target<br>例如：<br>systemctl set-default multi-user.target<br>ls –l /etc/systemd/system/default.target   </p>
<h2 id="其它命令"><a href="#其它命令" class="headerlink" title="其它命令"></a>其它命令</h2><ul>
<li>切换至紧急救援模式：<br>systemctl rescue  </li>
<li>切换至emergency模式：<br>systemctl emergency  </li>
<li>其它常用命令：<br>传统命令init，poweroff，halt，reboot都成为<br>systemctl的软链接<br>关机：systemctl halt、systemctl poweroff<br>重启：systemctl reboot<br>挂起：systemctl suspend<br>休眠：systemctl hibernate<br>休眠并挂起：systemctl hybrid-sleep  </li>
</ul>
<h1 id="Centos7引导顺序"><a href="#Centos7引导顺序" class="headerlink" title="Centos7引导顺序"></a>Centos7引导顺序</h1><ol>
<li>UEFi或BIOS初始化，运行POST开机自检</li>
<li>选择启动设备</li>
<li>引导装载程序, centos7是grub2</li>
<li>加载装载程序的配置文件：<br>/etc/grub.d/<br>/etc/default/grub<br>/boot/grub2/grub.cfg #不需要手工编辑</li>
<li>加载initramfs驱动模块</li>
<li>加载内核选项</li>
<li>内核初始化，centos7使用systemd代替init</li>
<li>执行initrd.target所有单元，包括挂载/etc/fstab</li>
<li>从initramfs根文件系统切换到磁盘根目录</li>
<li>systemd执行默认target配置，配置文件/etc/systemd/system/default.target</li>
<li>systemd执行sysinit.target初始化系统及basic.target准备操作系统</li>
<li>systemd启动multi-user.target下的本机与服务器服务</li>
<li>systemd执行multi-user.target下的/etc/rc.d/rc.local</li>
<li>Systemd执行multi-user.target下的getty.target及登录服务</li>
<li>systemd执行graphical需要的服务</li>
</ol>
<blockquote>
<p>systemd-analyze plot  查看详细的启动流程和时间花费<br>systemd-analyze plot &gt;boot.html 重定向可以方便的使用网页查看</p>
</blockquote>
<p>设置内核参数，只影响当次启动</p>
<ul>
<li>启动时，在linux16行后添加systemd.unit=multi-user.target #指定运行在字符界面</li>
<li>systemd.unit=emergency.target #急救模式</li>
<li>systemd.unit=rescue.target  #维护模式 类似runlevel 1</li>
<li>rescue.target 比emergency支持更多的功能，例如日志等</li>
<li>systemctl default 进入默认target</li>
</ul>
<blockquote>
<p>在启动界面修改运行级别时使用ctrl+x重启</p>
</blockquote>
<h2 id="启动排错"><a href="#启动排错" class="headerlink" title="启动排错"></a>启动排错</h2><ul>
<li>文件系统损坏<br>先尝试自动修复，失败则进入emergency shell，提示用户修复</li>
<li>在/etc/fstab不存在对应的设备和UUID<br>等一段时间，如不可用，进入emergency shell</li>
<li>在/etc/fstab不存在对应挂载点<br>systemd 尝试创建挂载点，否则提示进入emergency shell.</li>
<li>在/etc/fstab不正确的挂载选项<br>提示进入emergency shell</li>
</ul>
<p>进入emergency shell后</p>
<ol>
<li>输入root密码</li>
<li>重新修改错误的/etc/fstab</li>
<li>进行其它的排错  </li>
</ol>
<hr>
<p>实验：破解centos7口令方法一</p>
<ol>
<li>启动时任意键暂停启动</li>
<li>按e键进入编辑模式</li>
<li>将光标移动linux16开始的行，添加内核参数rd.break，按ctrl-x启动<br><img src="https://note.youdao.com/yws/api/personal/file/DA739FDF9E9B43EDA33725D294597BBC?method=download&amp;shareKey=156437265744ec1f8469721c9e801d53" alt="grub">  </li>
<li>mount –o remount,rw /sysroot</li>
<li>chroot /sysroot<br><img src="https://note.youdao.com/yws/api/personal/file/49B4F43525CF4C71B90206024F394B78?method=download&amp;shareKey=b99e7af27353de5750e1b409bf339af0" alt="grub">    </li>
<li>passwd root</li>
<li>touch /.autorelabel #如果selinux开启需执行</li>
<li>exit</li>
<li>reboot</li>
</ol>
<hr>
<p>实验：破解centos7口令方法二</p>
<ol>
<li>启动时任意键暂停启动</li>
<li>按e键进入编辑模式</li>
<li>将光标移动linux16开始的行，改为rw init=/sysroot/bin/sh，按ctrl-x启动<br><img src="https://note.youdao.com/yws/api/personal/file/EED58C583CFF4853A6E34B3A6C0F1018?method=download&amp;shareKey=445e770c01196284d1f50b8ebb93a255" alt="grub">  </li>
<li>chroot /sysroot</li>
<li>passwd root</li>
<li>touch /.autorelabel</li>
<li>exit</li>
<li>reboot</li>
</ol>
<blockquote>
<p>如果selinux开启，需touch /.autorelable</p>
</blockquote>
<hr>
<p>实验：修复GRUB2<br>GRUB“the Grand Unified Bootloader”<br>引导提示时可以使用命令行界面<br>可从文件系统引导<br>主要配置文件 /boot/grub2/grub.cfg</p>
<p>修复配置文件<br>grub2-mkconfig -o /boot/grub2/grub.cfg</p>
<p>修复grub<br>grub2-install /dev/sda BIOS环境<br>grub2-install UEFI环境</p>
<p>调整默认启动内核<br>vim /etc/default/grub<br>GRUB_DEFAULT=0</p>
<ol>
<li>/boot下的grub文件被破坏<br><img src="https://note.youdao.com/yws/api/personal/file/D83C6433B5204592A567FB1690D6F7DE?method=download&amp;shareKey=3a2251b22f4c8f4db54e4fc5d2cca40a" alt="grub">  </li>
<li>进入光盘恢复模式</li>
<li>chroot /mnt/sysimage</li>
<li>grub2-install /dev/sda<br><img src="https://note.youdao.com/yws/api/personal/file/16087F504E3147AC9A3930BC9B1EA3BA?method=download&amp;shareKey=36cbea592b6a5d81fd752e8c243e2a24" alt="grub">  </li>
<li>grub2-mkconfig -o /boot/grub2/grub.cfg<br><img src="https://note.youdao.com/yws/api/personal/file/3FACB6C698404BBF8E9F183738E7A0C0?method=download&amp;shareKey=3c505fbb9fc7ac321bf475e6cba74caa" alt="grub">  </li>
<li>exit </li>
<li>reboot</li>
</ol>
<blockquote>
<p>grub2-setpassword 配置grub启动密码  </p>
</blockquote>
<hr>
<p>实验：误删/boot/文件，恢复 </p>
<ol>
<li>光盘进入救援模式</li>
<li>chroot /mnt/sysimage</li>
<li>mount /dev/sr0 /mnt</li>
<li>rpm -ivh /mnt/Packages/kernel-3.10… –force<br><img src="https://note.youdao.com/yws/api/personal/file/B94EAD135CB54F47811F06CD26C610D0?method=download&amp;shareKey=f693ef2238883bbfbb067bc88ab046a4" alt="grub">  </li>
<li>grub2-install /dev/sda<br><img src="https://note.youdao.com/yws/api/personal/file/16087F504E3147AC9A3930BC9B1EA3BA?method=download&amp;shareKey=36cbea592b6a5d81fd752e8c243e2a24" alt="grub">  </li>
<li>grub2-mkconfig -o /boot/grub2/grub.cfg<br><img src="https://note.youdao.com/yws/api/personal/file/3FACB6C698404BBF8E9F183738E7A0C0?method=download&amp;shareKey=3c505fbb9fc7ac321bf475e6cba74caa" alt="grub">  </li>
<li>exit </li>
<li>reboot</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.nextx.tk/2018/10/28/网络协议和管理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nieW">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nieW learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/28/网络协议和管理/" itemprop="url">网络协议和管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-28T13:47:05+08:00">
                2018-10-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="OSI网络模型"><a href="#OSI网络模型" class="headerlink" title="OSI网络模型"></a>OSI网络模型</h1><h2 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h2><p>二进制传输</p>
<h2 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h2><p>frame 帧  通过MAC物理地址定义发送位置<br>访问介质<br>支持检查错误<br>定义如何格式化数据以便传输以及如何控制对网络的访问</p>
<h2 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h2><p>package包<br>路由数据传输<br>支持逻辑寻址的路径选择   </p>
<h2 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h2><p>错误检测和恢复<br>传输问题<br>端对端的通信<br>确保数据可靠性传输 </p>
<h2 id="会话层"><a href="#会话层" class="headerlink" title="会话层"></a>会话层</h2><p>session<br>主机间通信  </p>
<h2 id="表示层"><a href="#表示层" class="headerlink" title="表示层"></a>表示层</h2><p>数据表示<br>加密、解密、压缩  </p>
<h2 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h2><p>网络进程访问<br>提供身份验证<br><img src="http://www.grabsun.com/uploads/images/2015/54/wKiom1QGdPbQJBUpAAGiZLsJq8c657.jpg" alt="OSI"></p>
<h3 id="网络传输协议"><a href="#网络传输协议" class="headerlink" title="网络传输协议"></a>网络传输协议</h3><blockquote>
<p>七层网络协议特点<br>all people seem to need process data<br>下层协议要为上层协议服务<br>下层有上层的标记位  </p>
</blockquote>
<h3 id="pdu"><a href="#pdu" class="headerlink" title="pdu"></a>pdu</h3><p>PDU: Protocol Data Unit,协议数据单元是指对等层次之间传递的数据单位  </p>
<ul>
<li>单播 目标明确 为一个设备</li>
<li>广播 目标不明确 为多个设备 范围明确</li>
<li>组播 目标为一部分设备 范围明确  </li>
</ul>
<p>lan  基于广播机制通讯<br>wan  基于点对点机制通讯  </p>
<p>基带  数字信号<br>宽带  模拟信号 </p>
<p>双绞线有利于避免电磁干扰<br>光纤不受电磁干扰  </p>
<p>100MB 用到 1白橙 2橙 3白绿 6绿   12发送数据 36接收数据<br>1000MB会用到8根线  </p>
<p>单工  单向传输 100MB传输   喇叭  电视<br>半双工  同一时间只能单向传输  对讲机<br>全双工  同时双向传输  电话</p>
<blockquote>
<p>tcpdump linux抓包工具<br>wireshark  windows抓包工具 抓获60-1514位 </p>
</blockquote>
<p><img src="https://note.youdao.com/yws/api/personal/file/C98B24137A85443F85B85C8E4D0A5B91?method=download&amp;shareKey=c79988dbf88615a0b818e7a9adb1ae2a" alt="frame"><br><img src="https://note.youdao.com/yws/api/personal/file/26E98CC0545546368474ABC4ACC700D0?method=download&amp;shareKey=5e6b697061327a0b9584ddbcc9998cf2" alt="frame"></p>
<p>交换机MAC表不记录广播地址<br>交换机不能阻断广播域  </p>
<p>路由器分隔广播域  多播、广播都不能通过<br>网卡工作在数据链路层  </p>
<h3 id="vlan"><a href="#vlan" class="headerlink" title="vlan"></a>vlan</h3><p>分隔广播域、安全、灵活管理<br>管理vlan还需要路由器，带路由功能的三层交换机也可管理</p>
<p>trunk 802.1q 干道路由协议  多vlan通讯协议<br>在通过trunk时添加vlan标识信息，以便其余交换机识别特定vlan通讯  </p>
<p>为避免广播风暴出现回环   可以使用stp生成树协议  </p>
<h2 id="TCP-IP协议栈"><a href="#TCP-IP协议栈" class="headerlink" title="TCP/IP协议栈"></a>TCP/IP协议栈</h2><p>网络访问层–Internet层–传输层–应用层<br><img src="https://note.youdao.com/yws/api/personal/file/C7F0820C92BE496D93ED7DD829DE5629?method=download&amp;shareKey=413ca19909998fc8fb5534227e402fff" alt="TCP/IP"></p>
<h3 id="TCP-UDP"><a href="#TCP-UDP" class="headerlink" title="TCP/UDP"></a>TCP/UDP</h3><table>
<thead>
<tr>
<th>TCP</th>
<th>UDP</th>
</tr>
</thead>
<tbody>
<tr>
<td>面向对象</td>
<td>非面向对象</td>
</tr>
<tr>
<td>次序性</td>
<td>非次序性 </td>
</tr>
<tr>
<td>邮件、下载、共享文件</td>
<td>视频、语音 </td>
</tr>
</tbody>
</table>
<p><strong>TCP包头</strong>  标准20字节<br><img src="https://note.youdao.com/yws/api/personal/file/751046B9A0C44C5585097D9766427203?method=download&amp;shareKey=23f0d6cac7eb8215d4623811c2a60b7b" alt="TCP包头"></p>
<p>端口号区分上层协议的唯一标示<br>服务器端协议端口固定，便于客户端申请访问  </p>
<table>
<thead>
<tr>
<th>TCP端口</th>
<th>服务</th>
</tr>
</thead>
<tbody>
<tr>
<td>21</td>
<td>FTP 文件传输协议</td>
</tr>
<tr>
<td>22</td>
<td>SSH 安全登录、文件传送(SCP)和端口重定向</td>
</tr>
<tr>
<td>23</td>
<td>Telnet 不安全的文本传送</td>
</tr>
<tr>
<td>69</td>
<td>SMTP Simple Mail Transfer Protocol (E-mail)</td>
</tr>
<tr>
<td>79</td>
<td>finger Finger</td>
</tr>
<tr>
<td>80</td>
<td>HTTP 超文本传送协议 (WWW)</td>
</tr>
<tr>
<td>88</td>
<td>Kerberos Authenticating agent</td>
</tr>
<tr>
<td>110</td>
<td>POP3 Post Office Protocol (E-mail)</td>
</tr>
<tr>
<td>443</td>
<td>HTTPS used for securely transferring web pages </td>
</tr>
<tr>
<td>smb</td>
<td>445</td>
</tr>
<tr>
<td>3306</td>
<td>mysql</td>
</tr>
<tr>
<td>1521</td>
<td>oracle</td>
</tr>
<tr>
<td>1433</td>
<td>sql server </td>
</tr>
</tbody>
</table>
<h4 id="TCP三次握手"><a href="#TCP三次握手" class="headerlink" title="TCP三次握手"></a>TCP三次握手</h4><p><img src="http://images2015.cnblogs.com/blog/824490/201512/824490-20151209134608480-1590076700.jpg" alt="TCP三次握手"><br><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1540282372463&amp;di=8fb0519b421c63b4ce81ab64bbfbbac8&amp;imgtype=0&amp;src=http%3A%2F%2Fimage.bubuko.com%2Finfo%2F201801%2F20180123121700226188.png" alt="TCP四次挥手"></p>
<p>ack确认号比第一次序列号+1<br>ACK三次握手确认数   </p>
<p><strong>窗口大小</strong>=Window size value * Window size scaling factor  </p>
<blockquote>
<p>窗口值Window size value是可变的，取决于当前负载情况协商而定  </p>
</blockquote>
<p>抓取网络链接状态种类<br>ss -nt |sed -rn ‘1!s/^([^ ]+).*/\1/p’ |sort |uniq -c</p>
<blockquote>
<p>cat /etc/services查看系统常见协议端口号<br>cat /proc/sys/net/ipv4/ip_local_port_range 查看客户端端口范围<br>cat /proc/sys/net/ipv4/tcp_max_syn_backlog  查看半连接队列数值<br>cat /proc/sys/net/core/somaxconn 查看全连接队列数量<br>cat /proc/sys/net/ipv4/tcp_max_orphans 内核能接管的孤儿连接数目<br>cat /proc/sys/net/ipv4/tcp_fin_timeout 孤儿连接在内核中生存的时间<br>/proc/sys/net/ipv4/tcp_congestion_control  当前所使用的拥塞控制算法   </p>
</blockquote>
<h4 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h4><p>无状态、不可靠的网络访问、传输性能高 </p>
<h4 id="Internet层"><a href="#Internet层" class="headerlink" title="Internet层"></a>Internet层</h4><h5 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a>ICMP</h5><p>Internet Control Message Protocol  </p>
<p>ICMP基于Internet层<br>type8 请求报文  type0 响应报文  </p>
<p>ddos 分布式拒绝访问攻击<br>ping -s 65507 -f IP  -f尽最大能力ping -s指定包大小   </p>
<blockquote>
<p>cat /proc/sys/net/ipv4/icmp_echo_ignore_all<br>是否忽略icmp响应 0不忽略 1忽略   </p>
</blockquote>
<h5 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h5><p>地址解析协议<br>Address Resolution Protocol</p>
<p>ARP通过广播询问<br>开机状态时 系统会通过ARP广播确认IP地址是否冲突 </p>
<p><strong>源主机必须配置网关地址</strong><br>跨路由的ARP广播通过写临近的网关接口MAC地址，逐层查找目标主机<br>IP不变 MAC地址每跨一次路由都变更为网关口，直到找打目标主机MAC  </p>
<p><img src="https://note.youdao.com/yws/api/personal/file/45B68B56034A4A8E9D133A38F4B32B63?method=download&amp;shareKey=3ae635e5b2dc52f4723a3c7d32082f99" alt="ARP广播"></p>
<blockquote>
<p>ARP没有校验功能 APR攻击 网关造假<br>手工绑定主机MAC和网关MAC可以避免APR欺骗</p>
</blockquote>
<h5 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h5><p>运行于 OSI 网络层<br>面向无连接的协议<br>独立处理数据包<br>分层编址<br>尽力而为传输<br>无数据恢复功能  </p>
<p>IP PDU报头<br>最少20字节<br>IPV4地址长度2^32<br><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1540409996992&amp;di=7e2f12e9420a3a55843a4ac6eab769ce&amp;imgtype=0&amp;src=http%3A%2F%2Fseo-1255598498.file.myqcloud.com%2Ffull%2F47306c0a3fc889b5767e970986fd6b46800713f8.jpg" alt="IP"></p>
<p>IP PDU报头  每次数据MTU不足1500，需切片传送<br><img src="https://note.youdao.com/yws/api/personal/file/639EE0E5B91549F4A999B4B0AA6149D4?method=download&amp;shareKey=9d44b3051fb4f945892e076d0a41db6a" alt="IP"></p>
<blockquote>
<p>cat /proc/sys/net/ipv4/ip_default_ttl<br>TTL生命期查看  可以经过的路由器数量<br>cat /etc/protocols 查看系统默认协议类型 </p>
</blockquote>
<p>访问网站的步骤需了解  </p>
<blockquote>
<p>可以将IP地址转换成10进制，也可以ping通<br>127开头的lo回环地址都可以ping通  </p>
</blockquote>
<p><strong>IP地址分类</strong>：</p>
<p>A类地址：1-126.X.Y.Z   1600万个数<br>0xxxxxxx.X.Y.Z <strong>前一位不可变</strong><br>00000000  0<br>01111111 127<br>网络ID位为高8位，主机ID位为24<br>主机ID数：2^24-2=1600万<br>网络ID位：2^7-2=126  </p>
<p>B类地址：128-191.X.Y.Z<br>10xxxxxx.X.Y.Z <strong>前两位不可变</strong><br>10000000  128<br>10111111  191<br>网络ID位为高16位，主机ID位为16<br>主机ID数：2^16-2=65534<br>网络ID位：2^14-2=16382   </p>
<p>C类地址：192-223.X.Y.Z<br>110xxxxx.X.Y.Z <strong>前三位不可变</strong><br>11000000  192<br>11011111  223<br>网络ID位为高24位，主机ID位为8<br>主机ID数：2^8-2=254<br>网络ID位：2^21-2=2097150  </p>
<p>D类地址：多播地址 110xxxx.X.Y.Z<br>E类地址：11110xxx.X.Y.Z</p>
<blockquote>
<p>公式：<br>1、一个网络中主机位最大=2\^主机ID数-2=2^(32-网络ID位数)-2<br>2、网络ID数(网段)=2\^可变网络ID位<br>3、CIDR表示法：IP/网络ID位数<br>4、网络ID值=IP与子网掩码运算,其余位写0  0与1=0 0与0=0 1与0=0 1与1=1<br>5、划分子网：一个大网划成多个小网，网络ID位变多，主机ID位才变小，网络ID向主机ID借位N，分成2^N个小网 2^N&gt;=划分子网数<br>6、合并超网：多个小网合并成一个大网，主机ID向网络ID借位</p>
</blockquote>
<p>无类域间路由CIDR：网络ID位数不确定<br>netmask子网掩码：32bit二进制，<strong>高位对应于网络ID位为1，地位对应于主机ID位为0</strong>   </p>
<p><strong>可能的子网掩码表现形式</strong>  </p>
<table>
<thead>
<tr>
<th>二进制</th>
<th>十进制</th>
<th>子网掩码</th>
<th>主机ID位数(32位中0的个数)</th>
<th>网络ID位数(32位中1的个数)</th>
<th>CIDR表示法</th>
</tr>
</thead>
<tbody>
<tr>
<td>00000000</td>
<td>0</td>
<td>255.255.0.0</td>
<td>2^(8+8)-2=65534</td>
<td>32-16=16</td>
<td>IP/16</td>
</tr>
<tr>
<td>10000000</td>
<td>128</td>
<td>255.255.128.0</td>
<td>2^(7+8)-2=32766</td>
<td>32-15=17</td>
<td>IP/17</td>
</tr>
<tr>
<td>11000000</td>
<td>192</td>
<td>255.255.192.0</td>
<td>2^(6+8)-2=16382</td>
<td>32-14=18</td>
<td>IP/18</td>
</tr>
<tr>
<td>11100000</td>
<td>224</td>
<td>255.255.224.0</td>
<td>2^(5+8)-2=8190</td>
<td>32-13=19</td>
<td>IP/19</td>
</tr>
<tr>
<td>11110000</td>
<td>240</td>
<td>255.255.240.0</td>
<td>2^(4+8)-2=4094</td>
<td>32-12=20</td>
<td>IP/20</td>
</tr>
<tr>
<td>11111000</td>
<td>248</td>
<td>255.255.248.0</td>
<td>2^(3+8)-2=2046</td>
<td>32-11=21</td>
<td>IP/21</td>
</tr>
<tr>
<td>11111100</td>
<td>252</td>
<td>255.255.252.0</td>
<td>2^(2+8)-2=1022</td>
<td>32-10=22</td>
<td>IP/22</td>
</tr>
<tr>
<td>11111110</td>
<td>254</td>
<td>255.255.254.0</td>
<td>2^(1+8)-2=510</td>
<td>32-9=23</td>
<td>IP/23</td>
</tr>
<tr>
<td>11111111</td>
<td>255</td>
<td>255.255.255.0</td>
<td>2^(0+8)-2=254</td>
<td>32-8=24</td>
<td>IP/24</td>
</tr>
</tbody>
</table>
<blockquote>
<p>判断两个IP是不是同一网段看网络ID，IP地址与子网掩码与运算确定<br>注意判断的方式：使用自己的子网掩码与自己和对方IP地址进行与运算，得到的结果才可以判断自己是否与对方在同一网络<br>例如：A与B互相访问需用自己的掩码与对方与运算<br>A 172.18.0.100 255.0.0.0  172.18.0.0/16<br>B 172.18.0.123 255.255.255.0 172.18.0.0/24<br>子网掩码和IP的与运算结果与网关处在同一网段即可通讯</p>
</blockquote>
<p><strong>计算网段中最小IP和最大IP的方法</strong>：<br>首先需要计算出网络ID值也就是网段的值。</p>
<p>例如100.123.192.0/20  </p>
<ol>
<li>将IP和子网掩码转换成二进制 255.255.248.0<br>01100100.01111011.11000000.00000000<br>11111111.11111111.11110000.00000000   </li>
<li>由于前20位的网络ID位不可变，所以取到前20位的二进制数固定不变<br>100.123.1100 0000.00000000   </li>
<li>最小IP地址的表示形式可以是(在可变位数的范围内最小值，但不可以是预留地址)<br>二进制为 100.123.1100 0000.00000001<br>十进制为 100.123.192.1   </li>
<li>最大IP地址的表示形式可以是(在可变位数的范围内最大值，但不可以是广播地址)<br>二进制为 100.123.1100 1111.11111110<br>十进制为 100.123.207.254   </li>
</ol>
<p><strong>划分子网方法</strong>：<br>例如：<br>10.0.0.0/8划分成两个网络的话，网络位向主机位借一位，可变位为一个，有两种可能性。<br>10.0 0000000.0.0 10.0.0.0/9<br>10.1 0000000.0.0 10.128.0.0/9   </p>
<p>10.0.0.0/8划分成四个网络的话，网络位向主机位借两位，可变位为两个个，有四种可能性。<br>10.00 000000.0.0 10.0.0.0/10<br>10.01 000000.0.0 10.64.0.0/10<br>10.10 000000.0.0 10.128.0.0/10<br>10.11 000000.0.0 10.192.0.0/10   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.0/8 给32省份划分各自子网  </span><br><span class="line">借5位  </span><br><span class="line">1. 子网子网掩码  255.248.0.0 </span><br><span class="line">2. 最小子网，最大子网的网络ID  </span><br><span class="line">10.00000  000.0.0  10.0.0.0/13  </span><br><span class="line">10.11111  000.0.0  10.248.0.0/13</span><br><span class="line">3. 每个子网主机数？2^19-2</span><br><span class="line">4. 第20个子网分给河南使用，最小IP10.152.0.1，最大IP范围10.159.255.254</span><br><span class="line">&gt; 计算第20个子网，就是推算出从0到第19的二进制数即为第20个子网。  </span><br><span class="line">10.10011  000.0.1      </span><br><span class="line">10.10011  111.255.254</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">河南省10.152.0.0/13 给87个区县，划分各自子网 </span><br><span class="line">借7位  </span><br><span class="line">1 子网子网掩码  255.255.240.0</span><br><span class="line">2 最小子网，最大子网的网络ID</span><br><span class="line">10.10011 000.0000 0000.0 10.152.0.0/20</span><br><span class="line">10.10011 111.1111 0000.0 10.159.240.0/20</span><br><span class="line">3 每个子网主机数？ 2^12-2=4094</span><br><span class="line">4 最大子网的最小IP，最大IP范围</span><br><span class="line">10.10011 111.1111 0000.1  10.159.240.1/20</span><br><span class="line">10.10011 111.1111 1111.254 10.159.255.254/20</span><br></pre></td></tr></table></figure>
<p><strong>超网合并</strong><br>寻找多个路由网段的相同点合并，不同点作为新的主机ID位<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">220.78.168.0   220.78.10101 000.0</span><br><span class="line">220.78.169.0   220.78.10101 001.0</span><br><span class="line">|         |    |              |</span><br><span class="line">220.78.175.0   220.78.10101 111.0</span><br><span class="line">第三个网段的前五位相同，这样就可以作为新的网络主机位，后8位作为新的主机位。</span><br><span class="line">得到结果为：</span><br><span class="line">220.78.168.0/21</span><br></pre></td></tr></table></figure></p>
<p>常用二进制数字<br>00000001 1<br>00000010 2<br>00000100 4<br>00001000 8<br>00010000 16<br>00100000 32<br>01000000 64<br>10000000 128  </p>
<h5 id="常见IP地址"><a href="#常见IP地址" class="headerlink" title="常见IP地址"></a>常见IP地址</h5><table>
<thead>
<tr>
<th>类</th>
<th>公有IP地址范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>1.0.0.0–9.255.255.255 11.0.0.0–126.255.255.255</td>
</tr>
<tr>
<td>B</td>
<td>128.0.0.0–172.15.255.255 172.32.0.0–191.255.255.255</td>
</tr>
<tr>
<td>C</td>
<td>192.0.0.0–192.167.255.255 192.169.0.0–223.255.255.255</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>类</th>
<th>私有地址范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>10.0.0.0 到10.255.255.255</td>
</tr>
<tr>
<td>B</td>
<td>172.16.0.0 到172.31.255.255</td>
</tr>
<tr>
<td>C</td>
<td>192.168.0.0 到192.168.255.255</td>
</tr>
</tbody>
</table>
<blockquote>
<p>0.0.0.0 不是一个真正意义上的IP地址。它表示所有不清楚的主机和目的网络。<br>255.255.255.255 限制广播地址。对本机来说，这个地址指本网段内(同一广播域)的所有主机。<br>127.0.0.1～127.255.255.254 本机回环地址，主要用于测试。在传输介质上永远不应该出现目的地址为“127.0.0.1”的数据包。<br>224.0.0.0到239.255.255.255 组播地址，224.0.0.1特指所有主机，224.0.0.2特指所有路由器。224.0.0.5指OSPF 路由器，地址多用于一些特定的程序以及多媒体程序。<br>169.254.x.x 如果Windows主机使用了DHCP自动分配IP地址，而又无法从DHCP服务器获取地址，系统会为主机分配这样地址。   </p>
</blockquote>
<h3 id="路由表"><a href="#路由表" class="headerlink" title="路由表"></a>路由表</h3><p>linux查看路由表 route -n<br>路由分类：主机路由 网络路由 默认路由<br>优先级：精度越高，优先级越高   </p>
<p><strong>目标网络ID</strong>：目标IP所在网络ID<br><strong>接口</strong>：本设备要发送数据包到目标，从本设备哪个接口发送出来，才能到达<br><strong>网关</strong>：到达目标网络，需要将数据交给下一个路由哪个接口的对应IP  </p>
<p>路由器单向接收，只负责将数据交给下一个路由。<br><strong>主机路由</strong>：精确描述路由到一个主机的路径<br><strong>网络路由</strong>：描述网段路由信息<br><strong>默认路由</strong>：0.0.0.0/0，边界路由，单个出口。 不描述到特定网段的路由。<strong>由配置默认网关生产</strong> </p>
<p>企业内部：可以在边界路由增加一条默认路由，接口指向出口IP，网关填写下一跳运营商接口。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/9E69606415354B20A85637D1B867F387?method=download&amp;shareKey=4a3efb0944976678740a20d9ffcafd0c" alt="router"></p>
<h3 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h3><p><strong>Centos7采用传统命名方式</strong>  </p>
<ol>
<li>编辑/etc/default/grub配置文件<br>GRUB_CMDLINE_LINUX=”rhgb quiet net.ifnames=0”</li>
<li>为grub2生成其配置文件grub2-mkconfig -o /etc/grub2.cfg </li>
<li>重启系统</li>
</ol>
<p>DHCP通过UDP通讯<br>服务器端：67  客户端：68</p>
<p>hosts文件 /etc/hosts<br><strong>修改系统解析优先级</strong>:/etc/nsswitch.conf<br><strong>DNS解析</strong>：/etc/resolv.conf<br>getent hosts  查看/etc/hosts 内容 </p>
<blockquote>
<p>QQ内置了腾讯服务器IP，不依赖DNS解析  </p>
</blockquote>
<ul>
<li>centos6 主机名 配置文件：/etc/sysconfig/network<br>exec bash可以不重启更换主机名  </li>
<li>centos7 主机名 /etc/hostname<br>hostnamectl set-hostname ……<br>exec bash   </li>
</ul>
<blockquote>
<p>更改主机名后建议修改/etc/hosts 添加到127.0.0.1行尾   </p>
</blockquote>
<p>避免问题可以将网站外网IP和域名  写到hosts文件中  </p>
<p>centos6修改网卡名称：/etc/udev/rules.d/70-persistent-net.rules<br>ethtool -i eth*  查看指定网卡的硬件信息<br>dmesg |grep –i eth  查看指定网卡的硬件信息<br>lsmod 查看系统加载的模块<br>modprobe -r e1000  卸载相应网卡的驱动文件<br>rmmod e1000 卸载相应网卡的驱动文件  </p>
<h4 id="网络配置文件"><a href="#网络配置文件" class="headerlink" title="网络配置文件"></a>网络配置文件</h4><p>IP、MASK、GW、DNS相关配置文件：/etc/sysconfig/networkscripts/ifcfg-IFACE  </p>
<blockquote>
<p>BOOTPROTO：激活此设备时使用的地址配置协议，常用的dhcp, static,<br>none, bootp<br>ONBOOT：在系统引导时是否激活此设备<br>IPADDR：指明IP地址<br>NETMASK：子网掩码<br>PREFIX：CIDR掩码写法<br>GATEWAY: 默认网关</p>
</blockquote>
<p>示例：<br>DHCP方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DEVICE=ethX</span><br><span class="line">HWADDR=0:02:8A:A6:30:45</span><br><span class="line">BOOTPROTO=dhcp</span><br><span class="line">ONBOOT=yes</span><br><span class="line">Type=Ethernet</span><br></pre></td></tr></table></figure></p>
<p>静态方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DEVICE=ethX</span><br><span class="line">HWADDR=0:02:8A:A6:30:45</span><br><span class="line">IPADDR=192.168.0.123</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.0.254</span><br><span class="line">ONBOOT=yes</span><br><span class="line">Type=Ethernet</span><br></pre></td></tr></table></figure></p>
<p>新格式方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(1) TARGET via GW</span><br><span class="line">如：10.0.0.0/8 via 172.16.0.1</span><br><span class="line">(2) 每三行定义一条路由</span><br><span class="line">ADDRESS#=TARGET</span><br><span class="line">NETMASK#=mask</span><br><span class="line">GATEWAY#=GW</span><br></pre></td></tr></table></figure></p>
<h4 id="网络配置-1"><a href="#网络配置-1" class="headerlink" title="网络配置"></a>网络配置</h4><p>arpping -I eth* IP  查看网络IP是否冲突  </p>
<p>旧工具：ifconfig、route、netstat<br>新工具：ip<br>图形化配置：system-config-network-tui，setup<br>配置文件  </p>
<blockquote>
<p>注意NetworkManager服务可能会引起network服务出现问题，可以关闭或者出现问题时重启服务</p>
</blockquote>
<h5 id="ifconfig"><a href="#ifconfig" class="headerlink" title="ifconfig"></a>ifconfig</h5><p>ifconfig eth<em> up|down  启用禁用网络接口 链路层禁用<br>ifup|ifdown eth</em>  系统层面禁用网卡IP功能    </p>
<p>ifconfig eth<em> IP/netmask  临时配置IP地址<br>ifconfig eth</em>:1..2..3 IP/netmask 配置临时网卡别名<br>IP别名只能手工指定</p>
<blockquote>
<p>例如：<br>ifconfig eth0:0 192.168.1.100/24 up<br>ifconfig eth0:0 down</p>
</blockquote>
<h5 id="route"><a href="#route" class="headerlink" title="route"></a>route</h5><p>route -n 以数字模式显示路由表<br>route add -host IP gw IP dev eth<em>  新增主机路由<br>route add -net IP/netmask gw IP dev eth</em> 新增网络路由  </p>
<blockquote>
<p>通讯之前先查询路由表，再决定是否ARP广播，同网段删除本网段路由表项，表现为无法到达目标主机。单向无法回复ARP广播。  </p>
</blockquote>
<p>route add defaults gw IP metric N 添加默认路由并且指定费用优先级  </p>
<p>centos6 可以service networkmange stop停掉图形化配置服务，避免影响network服务  </p>
<p>mtr 目标IP 查看路由详细数据<br>tracerroute 查看路由详细数据</p>
<p>回环地址属于内核级的通讯，只要数据通过路由到达即可转发  </p>
<blockquote>
<p>linux开启ipv4转发 修改/proc/sys/net/ipv4/ip_forward为1<br>route add default dev eth* 添加指定出口的默认路由<br>ping -I IP IP 可以指定IP去ping</p>
</blockquote>
<h5 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h5><table>
<thead>
<tr>
<th>netstat</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-t</td>
<td>tcp协议相关</td>
</tr>
<tr>
<td>-u</td>
<td>udp协议相关</td>
</tr>
<tr>
<td>-w</td>
<td>raw socket相关</td>
</tr>
<tr>
<td>-l</td>
<td>处于监听状态</td>
</tr>
<tr>
<td>-a</td>
<td>所有状态</td>
</tr>
<tr>
<td>-n</td>
<td>以数字显示IP和端口</td>
</tr>
<tr>
<td>-e</td>
<td>扩展格式</td>
</tr>
<tr>
<td>-p</td>
<td>显示相关进程及PID</td>
</tr>
<tr>
<td>-nr</td>
<td>以数字格式显示内核路由表</td>
</tr>
<tr>
<td>-i</td>
<td>显示接口统计数据</td>
</tr>
</tbody>
</table>
<p><strong>常用组合</strong>：<br>-tan, -uan, -tnl, -unl</p>
<blockquote>
<p>取链接状态并统计(两种方法)<br>1、netstat -ntua | sed -nr ‘1,2!s/.<em> ([[:alpha:]+])/\1/p’|sort |uniq -c<br>2、netstat -ntau | sed -nr ‘/^tcp/s/.</em> ([^ ]+) ?/\1/p’</p>
</blockquote>
<h5 id="IP-1"><a href="#IP-1" class="headerlink" title="IP"></a>IP</h5><p>使用语法：ip [ OPTIONS ] OBJECT { COMMAND | help }<br>OBJECT := { link | addr | route }  </p>
<ol>
<li>IP link set  设置网卡链路状态    </li>
<li>IP addr<br>IP addr add IP/netmask dev eth<em> 设置网卡IP地址 IP addr add IP/netmask dev eth</em> label eth*:1…  新增网卡IP别名地址 </li>
</ol>
<blockquote>
<p>例如：<br>ip addr add 172.16.100.100/16 dev eth0 label eth0:0<br>ip addr add 172.16.1.1/16 dev eth0 label eth0:0<br>ip addr add 172.16.1.2/16 dev eth0 label eth0:0<br>ip addr flush dev eth0 label eth0:0 清空网卡所有的设置</p>
</blockquote>
<ol start="3">
<li>ip route<br>ip route add TARGET via GW dev IFACE src SOURCE_IP<blockquote>
<p>例如：<br>ip route add 192.168.0.0/24 via 172.16.0.1<br>ip route add 192.168.1.13 via 172.16.0.1<br>ip route add default via 172.16.0.1 添加网关</p>
</blockquote>
</li>
</ol>
<p><strong>删除路由</strong>：ip route del TARGET<br><strong>显示路由</strong>：ip route show|list<br><strong>清空路由表</strong>：ip route flush dev eth0</p>
<h5 id="SS"><a href="#SS" class="headerlink" title="SS"></a>SS</h5><p>性能较netstat更好</p>
<table>
<thead>
<tr>
<th>ss</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-t</td>
<td>tcp协议相关</td>
</tr>
<tr>
<td>-u</td>
<td>udp协议相关</td>
</tr>
<tr>
<td>-w</td>
<td>裸套接字相关</td>
</tr>
<tr>
<td>-x</td>
<td>unix sock相关</td>
</tr>
<tr>
<td>-l</td>
<td>listen状态的连接</td>
</tr>
<tr>
<td>-a</td>
<td>所有</td>
</tr>
<tr>
<td>-n</td>
<td>数字格式</td>
</tr>
<tr>
<td>-p</td>
<td>相关的程序及PID</td>
</tr>
<tr>
<td>-e</td>
<td>扩展的信息</td>
</tr>
<tr>
<td>-m</td>
<td>内存用量</td>
</tr>
<tr>
<td>-o</td>
<td>计时器信息</td>
</tr>
</tbody>
</table>
<p><strong>常用组合</strong>：-tan, -tanl, -tanlp, -uan</p>
<blockquote>
<p>常见用法：<br>ss -l 显示本地打开的所有端口<br>ss -pl 显示每个进程具体打开的socket<br>ss -t -a 显示所有tcp socket<br>ss -u -a 显示所有的UDP Socekt<br>ss -o state established ‘( dport = :ssh or sport = :ssh )’ 显示所有已建立的ssh连接<br>ss -o state established ‘( dport = :http or sport = :http )’ 显示所有已建立的HTTP连接<br>ss -s 列出当前socket详细信息<br>ss -o stat establishd 查看已经链接的状态  </p>
</blockquote>
<h5 id="Bonding"><a href="#Bonding" class="headerlink" title="Bonding"></a>Bonding</h5><p>将多块网卡绑定同一IP地址对外服务，可以实现高可用或者负载均衡。</p>
<ol>
<li>Mode 0 (balance-rr)<br>轮转（Round-robin）策略：从头到尾顺序的在每一个slave接口上面发送数据包。本模式提供负载均衡和容错的能力。</li>
<li>Mode 1 (active-backup)<br>活动-备份（主备）策略：只有一个slave被激活，当且仅当活动的slave接口失败时才会激活其他slave.为了避免交换机发生混乱此时绑定的MAC地址只有一个外部端口上可见。</li>
<li>Mode 3 (broadcast)<br>广播策略：在所有的slave接口上传送所有的报文,提供容错能力。</li>
</ol>
<blockquote>
<p>active-backup、balance-tlb 和 balance-alb 模式不需要交换机的任何特<br>殊配置。其他绑定模式需要配置交换机以便整合链接。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">示例：  </span><br><span class="line">1. 创建bonding设备的配置文件</span><br><span class="line">/etc/sysconfig/network-scripts/ifcfg-bond0</span><br><span class="line">DEVICE=bond0</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">BONDING_OPTS= “miimon=100 mode=0”</span><br><span class="line">1. /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line">DEVICE=eth0</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">MASTER=bond0</span><br><span class="line">SLAVE=yes</span><br><span class="line">USERCTL=no</span><br></pre></td></tr></table></figure>
<p><strong>查看bond0状态</strong>：/proc/net/bonding/bond0<br><strong>删除bond0</strong>：ifconfig bond0 down、rmmod bonding</p>
<blockquote>
<p>miimon是用来进行链路监测的。如果miimon=100，那么系统每100ms 监测一次链路连接状态，如果有一条线路不通就转入另一条线路。</p>
</blockquote>
<h5 id="nmcli"><a href="#nmcli" class="headerlink" title="nmcli"></a>nmcli</h5><p>centos7新命令  </p>
<p>nmcli [ OPTIONS ] OBJECT { COMMAND | help }</p>
<p><strong>修改IP地址等属性</strong><br>nmcli connection modify IFACE [+|-]setting.property value<br>setting.property:<br>ipv4.addresses、ipv4.gateway、<br>ipv4.dns1、ipv4.method manual | auto</p>
<blockquote>
<p>例如：<br>1、显示网络接口属性<br>nmcli dev show eth0<br>2、创建新连接default，IP自动通过dhcp获取<br>nmcli con add con-name default type Ethernet ifname eth0<br>3、删除连接<br>nmcli con del default<br>4、创建新连接static ，指定静态IP，不自动连接<br>nmcti con add con-name static ifname eth0 autoconnect no type Ethernet ipv4.addresses 172.25.X.10/24 ipv4.gateway 172.25.X.254</p>
</blockquote>
<table>
<thead>
<tr>
<th>nmcli con mod</th>
<th>ifcfg-* 文件</th>
</tr>
</thead>
<tbody>
<tr>
<td>ipv4.method manual</td>
<td>BOOTPROTO=none</td>
</tr>
<tr>
<td>ipv4.method auto</td>
<td>BOOTPROTO=dhcp</td>
</tr>
<tr>
<td>ipv4.addresses “192.0.2.1/24 192.0.2.254”</td>
<td>IPADDR0=192.0.2.1 PREFIX0=24 GATEWAY0=192.0.2.254 </td>
</tr>
<tr>
<td>ipv4.dns 8.8.8.8</td>
<td>DNS0=8.8.8.8</td>
</tr>
<tr>
<td>ipv4.dns-search example.com</td>
<td>DOMAIN=example.com</td>
</tr>
<tr>
<td>ipv4.ignore-auto-dns true</td>
<td>PEERDNS=no</td>
</tr>
<tr>
<td>connection.autoconnect yes</td>
<td>ONBOOT=yes</td>
</tr>
<tr>
<td>connection.id eth0</td>
<td>NAME=eth0</td>
</tr>
<tr>
<td>connection.interface-name</td>
<td>eth0 DEVICE=eth0 </td>
</tr>
<tr>
<td>802-3-ethernet.mac-address…</td>
<td>HWADDR=…</td>
</tr>
</tbody>
</table>
<blockquote>
<p>修改连接配置后，需要重新加载配置<br>nmcli con reload<br>nmcli con down “system eth0” 可被自动激活<br>nmcli con up “system eth0”<br>nmcli dev dis eth0 禁用网卡，访止被自动激活</p>
</blockquote>
<h5 id="网络测试工具"><a href="#网络测试工具" class="headerlink" title="网络测试工具"></a>网络测试工具</h5><ul>
<li>在命令行下测试网络的连通性</li>
<li>显示主机名<br>hostname</li>
<li>测试网络连通性<br>ping</li>
<li>显示正确的路由表<br>ip route</li>
<li>跟踪路由<br>traceroute<br>tracepath<br>mtr  </li>
<li>确定名称服务器使用<br>nslookup<br>host<br>dig</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.nextx.tk/2018/10/21/磁盘和文件系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nieW">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nieW learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/21/磁盘和文件系统/" itemprop="url">磁盘和文件系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-21T22:19:00+08:00">
                2018-10-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="磁盘系统"><a href="#磁盘系统" class="headerlink" title="磁盘系统"></a>磁盘系统</h1><h2 id="设备文件"><a href="#设备文件" class="headerlink" title="设备文件"></a>设备文件</h2><p>设备类型：<br>块设备：block，存取单位“块”，磁盘<br>字符设备：char，存取单位“字符”，键盘<br>块设备有缓存、一般是随机的、一般是物理的硬盘等</p>
<p>主设备号：major number, 标识设备类型<br>次设备号：minor number,标识同一类型下的不同设备  </p>
<p>硬盘存储术语<br>CHS<br>head：磁头  8bit  255<br>track：磁道  10bit  2^10=1024<br>cylinder: 柱面=512bytes*sector/track*head数 8MB<br>sector: 扇区，512bytes  6bit大小 最多扇区数63  </p>
<p>LBA（logical block addressing）<br>LBA是一个整数，通过转换成CHS格式完成磁盘具体寻址。 2002年ATA-6规范采用48位LBA，同样以每扇区512位组计算容量上限可达128 Petabytes。</p>
<blockquote>
<p>由于CHS寻址方式的寻址空间在大概8GB以内，所以在磁盘容量小于大概8GB<br>时，可以使用CHS寻址方式或是LBA寻址方式；在磁盘容量大于大概8GB时，则<br>只能使用LBA寻址方式</p>
</blockquote>
<p>ZBR<br>里外扇区数量不同，外圈更多，内圈少<br>外圈更快，磁道数更大。  </p>
<p>盘面=磁头数  </p>
<h3 id="MBR："><a href="#MBR：" class="headerlink" title="MBR："></a>MBR：</h3><p>使用32位表示扇区数，分区不超过2T。<br>按柱面分区 </p>
<p>512bytes=446bytes: boot loader+64bytes：分区表，其中每16bytes标识一个分区+2bytes: 55AA结束分区  </p>
<p>主分区：1-4<br>扩展分区：最多1  扩展+主分区 &lt;=4<br>逻辑分区：N个  </p>
<p>MBR支持最大2TB分区<br>2^32*512=2048GB  </p>
<p>DPT分区表64字节<br>每16字节代表一个分区的信息<br>第一个分区80代表活动分区、00代表不活动分区 </p>
<p><strong>备份MBR分区表二进制文件</strong>   </p>
<p>dd if=/dev/sda of=dpt bs=1 count=64 skip=446<br>hexdump -C dpt 可以查看内容<br>hexdump -C /dev/sda -n 512查看sda二进制分区信息<br>if 源路径  of  目标路径  skip 源路径操作  seek  目标路径操作<br>一定将分区表备份文件拷贝到异地<br>scp dpt 192.168.xx.xxx:/data<br>恢复分区表<br>在救援模式下首先需要配置ip地址<br>ifconfig ens33 192.168.xxx.xxx<br>将备份的文件拷贝到需要救援的机器本地目录<br>scp 192.168.xxx.xxx:/data/dpt .<br>dd if=dpt of=/dev/sda bs=1 count=64 seek=446  </p>
<h3 id="GPT"><a href="#GPT" class="headerlink" title="GPT"></a>GPT</h3><p>支持128个分区<br>使用128位UUID(Universally Unique Identifier) 表示磁盘和分区 GPT分区表<br>自动备份在头和尾两份，并有CRC校验位<br>UEFI (统一扩展固件接口)硬件支持GPT  </p>
<h2 id="分区工具"><a href="#分区工具" class="headerlink" title="分区工具"></a>分区工具</h2><h3 id="fdisk"><a href="#fdisk" class="headerlink" title="fdisk"></a>fdisk</h3><p>fdisk /dev/sdb 管理分区<br>fdisk -l [-u] [device…] 查看分区<br>子命令：  </p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>p</strong></td>
<td>分区列表</td>
</tr>
<tr>
<td><strong>t</strong></td>
<td>更改分区类型</td>
</tr>
<tr>
<td><strong>n</strong></td>
<td>创建新分区</td>
</tr>
<tr>
<td><strong>d</strong></td>
<td>删除分区</td>
</tr>
<tr>
<td>v</td>
<td>校验分区</td>
</tr>
<tr>
<td>u</td>
<td>转换单位 </td>
</tr>
<tr>
<td><strong>w</strong></td>
<td>保存并退出</td>
</tr>
<tr>
<td>q</td>
<td>不保存并退出</td>
</tr>
</tbody>
</table>
<blockquote>
<p>删除前面的分区，后面的分区会自动往前变更编号</p>
</blockquote>
<p><strong>查看内核是否已经识别新的分区</strong><br>lsblk<br>cat /proc/partations<br>fdisk -l /dev/sd*  </p>
<blockquote>
<p>centos7 同步分区表变化 partprobe<br>centos6 partprobe不起作用<br>partx -a 同步分布变化到内存<br>partx -d –nr x /dev/sd* X代表被删除的分区编号</p>
</blockquote>
<h3 id="parted"><a href="#parted" class="headerlink" title="parted"></a>parted</h3><p><strong>parted的操作都是实时生效的，小心使用</strong><br>parted /dev/sdb mklabel gpt|msdos<br>设置磁盘分区格式为GPT或者MBR<br>设置主分区1 默认的大小后缀为MB<br>parted /dev/sdb mkpart primary 1 200 （默认M）<br>删除分区<br>parted /dev/sdb rm 1</p>
<h3 id="GPT-1"><a href="#GPT-1" class="headerlink" title="GPT"></a>GPT</h3><p>选项基本与fdisk相同  </p>
<h2 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h2><p>文件系统是操作系统用于明确存储设备或分区上的文件的方法和数据结构；即在存储设备上组织文件的方法。操作系统中负责管理和存储文件信息的软件结构称为文件管理系统，简称文件系统。  </p>
<p>查看系统当前的文件系统：<br>cat /proc/filesystems</p>
<blockquote>
<p>日志系统修改优先于系统数据</p>
</blockquote>
<h3 id="创建文件系统"><a href="#创建文件系统" class="headerlink" title="创建文件系统"></a>创建文件系统</h3><table>
<thead>
<tr>
<th>mkfs</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>.ext4/.xfs /dev/sd*</td>
<td>创建相应格式的文件系统</td>
</tr>
<tr>
<td>-b {1024\</td>
<td>2048\</td>
<td>4096}</td>
<td>指定块大小</td>
</tr>
<tr>
<td>-L ‘LABEL’</td>
<td>设置卷标</td>
</tr>
<tr>
<td>-m</td>
<td>默认5%,为管理人员预留空间占总空间的百分比</td>
</tr>
</tbody>
</table>
<p><strong>blkid</strong>: 块设备属性信息查看<br>-U UUID 根据指定的UUID来查找对应的设备   </p>
<blockquote>
<p>blkid -U <code>sed -nr &#39;s@^UUID=(.*) / .*@\1@p&#39; /etc/fstab</code>  </p>
</blockquote>
<p>-L LABEL 根据指定的LABEL来查找对应的设备  </p>
<p><strong>e2lable</strong>: 设置ext系列的磁盘卷标  </p>
<table>
<thead>
<tr>
<th>tune2fs</th>
<th>说明ext系列</th>
</tr>
</thead>
<tbody>
<tr>
<td>-l</td>
<td>查看指定文件系统超级块信息</td>
</tr>
<tr>
<td>-L ‘LABEL’</td>
<td>修改卷标</td>
</tr>
<tr>
<td>-m</td>
<td>修预留给管理员的空间百分比 </td>
</tr>
<tr>
<td>-o</td>
<td>调整文件系统的默认挂载选项，–o ^acl</td>
</tr>
<tr>
<td>-U UUID</td>
<td>修改UUID号</td>
</tr>
</tbody>
</table>
<blockquote>
<p>在centos6之前的版本手动创建分区，是不带ACL选项的。自动创建的分区包括。   </p>
</blockquote>
<p><strong>dumpe2fs</strong> 查看块分组 -h查看超级块信息</p>
<p><strong>文件系统检测修复</strong><br><strong>修复前要取消挂载</strong><br>fsck(ext4)<br>e2fsck<br>xfs_repair(xfs)</p>
<h3 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h3><p><strong>mount</strong>  </p>
<blockquote>
<p>一个设备可以同时挂载到多个目录，目录必须事先存在<br>一个目录只可挂载一个设备，新挂载设备会断开之前的挂载关系，umount之后可以看到之前挂载的文件  </p>
</blockquote>
<p>挂载方法：mount DEVICE MOUNT_POINT<br>mount：通过查看/etc/mtab文件显示当前已挂载的所有设备<br>device：指明要挂载的设备；<br>(1) 设备文件：例如/dev/sda5<br>(2) 卷标：-L ‘LABEL’, 例如 -L ‘MYDATA’<br>(3) UUID, -U ‘UUID’：例如 -U  ‘0c50523c-43f1-45e7-85c0-a126711d406e’<br>(4) 伪文件系统名称：proc, sysfs, devtmpfs, configfs<br>dir：挂载点<br>事先存在；建议使用空目录<br>进程正在使用中的设备无法被卸载  </p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-r</td>
<td>readonly，只读挂载</td>
</tr>
<tr>
<td>-w</td>
<td>read and write, 读写挂载</td>
</tr>
<tr>
<td>-n</td>
<td>不更新/etc/mtab，mount不可见</td>
</tr>
<tr>
<td>-a</td>
<td>自动挂载所有支持自动挂载的设备(定义在了/etc/fstab文件中，且挂载选项中有auto功能)</td>
</tr>
<tr>
<td>-B, –bind</td>
<td>绑定目录到另一个目录上</td>
</tr>
<tr>
<td>-L ‘LABEL’</td>
<td>以卷标指定挂载设备</td>
</tr>
<tr>
<td>-U ‘UUID’</td>
<td>以UUID指定要挂载的设备</td>
</tr>
<tr>
<td><strong>-o</strong></td>
<td><strong>挂载文件系统的选项，多个选项使用逗号分隔</strong></td>
</tr>
<tr>
<td>async/sync</td>
<td>异步模式/同步模式</td>
</tr>
<tr>
<td>atime/noatime</td>
<td>包含目录和文件 </td>
</tr>
<tr>
<td>diratime/nodiratime</td>
<td>目录的访问时间戳</td>
</tr>
<tr>
<td>auto/noauto</td>
<td>是否支持自动挂载,是否支持-a选项</td>
</tr>
<tr>
<td>exec/noexec</td>
<td>是否支持将文件系统上运行应用程序</td>
</tr>
<tr>
<td>dev/nodev</td>
<td>是否支持在此文件系统上使用设备文件</td>
</tr>
<tr>
<td>suid/nosuid</td>
<td>是否支持suid和sgid权限</td>
</tr>
<tr>
<td>remount</td>
<td>重新挂载</td>
</tr>
<tr>
<td>ro</td>
<td>只读</td>
</tr>
<tr>
<td>rw</td>
<td>读写</td>
</tr>
<tr>
<td>user/nouser</td>
<td>是否允许普通用户挂载此设备，/etc/fstab使用</td>
</tr>
<tr>
<td>acl</td>
<td>启用此文件系统上的acl功能</td>
</tr>
<tr>
<td>loop</td>
<td>losetup可管理 允许文件挂载到分区，创建的文件类似于USB设备，可以拷贝到任意机器挂载</td>
</tr>
</tbody>
</table>
<blockquote>
<p>defaults：相当于rw, suid, dev, exec, auto, nouser, async</p>
</blockquote>
<blockquote>
<p>cat /proc/mounts 查看内核追踪到的已挂载的所有设备</p>
</blockquote>
<p><strong>卸载命令</strong><br>查看挂载情况<br>findmnt MOUNT_POINT|device   </p>
<p>查看正在访问指定文件系统的进程<br>lsof MOUNT_POINT<br>fuser -v MOUNT_POINT  </p>
<p>终止所有在正访问指定的文件系统的进程<br>fuser -km MOUNT_POINT  </p>
<p>卸载<br>umount DEVICE<br>umount MOUNT_POINT  </p>
<p><strong>挂载点和/etc/fstab</strong></p>
<p>配置文件系统体系<br>被mount、fsck和其它程序使用<br>系统重启时保留文件系统体系<br>可以在设备栏使用文件系统卷标<br>使用mount -a 命令挂载/etc/fstab中的所有文件系统  </p>
<blockquote>
<p>cat /var/log/boot.log查看开机启动错误</p>
</blockquote>
<p><strong>交换空间swap</strong>  </p>
<p>创建硬盘空间的需要单独修改分区类型t==82<br>mkswap 创建swap分区<br>需要写入/etc/fstab文件挂载swap分区<br><code>UUID=.....  swap  swap  defaults  0 0</code><br><strong>swapon -a</strong> 挂载分区<br><strong>swapon -s</strong> 查看分区挂载情况<br>swapoff 取消挂载swap分区<br>可以修改/etc/fstab文件修改swap分区的优先级<br>磁盘外圈的分区速度更快，可以考虑调高优先级<br><code>UUID=.....  swap  swap  pri=1  0 0</code><br>默认值为-1  </p>
<blockquote>
<p>优化性能：分布存放，高性能磁盘存放    </p>
</blockquote>
<p>案例1：<br>使用文件创建swap分区 </p>
<ol>
<li>dd if=/dev/zero of=/data/swapfile bs=2G count=1 创建需要大小的swap文件 </li>
<li>mkswap /data/swapfile 格式化文件  </li>
<li><code>/data/swapfile                              swap swap  defaults  0 0</code> 修改/etc/fstab文件  </li>
<li>chmod 600 /data/swapfile  系统建议修改600权限 </li>
<li>swapon -a挂载文件  </li>
<li>如需迁移swap文件 需要先取消挂载swapoff </li>
<li>修改/etc/fstab新的挂载点路径  </li>
<li>swapon -a  </li>
</ol>
<p>如果不在需要swap文件和新增分区<br>先取消挂载swapoff<br>修改/etc/fstab文件<br>rm -rf /tmp/swapfile<br>fdisk /dev/sdd<br>最后删除文件和分区</p>
<p>案例2：<br>迁移非独立分区到独立分区 </p>
<ol>
<li>fdisk /dev/sdc 创建新分区作为转移的目标  </li>
<li>mkfs.xfs /dev/sdc1 创建文件系统  </li>
<li>mkdir /mnt/home 新建目录作为挂载点  </li>
<li>mount /dev/sdc1 /mnt/home/ 将新建分区挂载到新建目录中  </li>
<li>cp -av /home/. /mnt/home/ 拷贝原目录所有内容到新的分区中  </li>
<li>编辑/etc/fstab文件sdc1添加挂载点  <code>UUID=....  /home xfs  defaults 0 0</code></li>
<li>mount -a 挂载分区 </li>
</ol>
<blockquote>
<p>vim /etc/fstab时可使用r!blkid /dev/sd**来获取分区UUID以便挂载 </p>
</blockquote>
<p><strong>挂载移动设备</strong><br>光盘挂载  mount /dev/cdrom /mnt/<br>eject命令卸载或弹出磁盘<br>USB挂载 lsusb  </p>
<p><strong>常见命令</strong><br>df -h 文件系统空间占用<br>du -sh 查看某目录总体空间<br>dd  </p>
<table>
<thead>
<tr>
<th>dd</th>
<th>dd if=/PATH/FROM/SRC of=/PATH/TO/DESTe</th>
</tr>
</thead>
<tbody>
<tr>
<td>if=file</td>
<td>从所命名文件读取而不是从标准输入</td>
</tr>
<tr>
<td>of=file</td>
<td>写到所命名的文件而不是到标准输出</td>
</tr>
<tr>
<td>bs=size</td>
<td>指定块大小 </td>
</tr>
<tr>
<td>skip=blocks</td>
<td>从开头忽略blocks个ibs大小的块 </td>
</tr>
<tr>
<td>seek=blocks</td>
<td>从开头忽略blocks个obs大小的块 </td>
</tr>
<tr>
<td>count=n</td>
<td>只拷贝n个记录 </td>
</tr>
<tr>
<td><strong>conv=</strong></td>
<td>用指定的参数转换文件</td>
</tr>
<tr>
<td>lcase</td>
<td>大写字符转换为小写字符</td>
</tr>
<tr>
<td>ucase</td>
<td>小写字符转换为大写字符</td>
</tr>
<tr>
<td>nocreat</td>
<td>不创建输出文件</td>
</tr>
<tr>
<td>notrunc</td>
<td>不截短输出文件 </td>
</tr>
</tbody>
</table>
<ul>
<li>备份MBR dd if=/dev/sda of=/tmp/mbr.bak bs=512 count=1  </li>
<li>备份硬盘空间 dd if=/dev/sdx of=/dev/sdy  </li>
<li>备份/dev/sdx全盘数据，并利用gzip压缩，保存到指定路径 dd if=/dev/sdx | gzip &gt;/path/to/image.gz  </li>
<li>将备份文件恢复到指定盘 dd if=/path/to/image of=/dev/sdx</li>
<li>将压缩的备份文件恢复到指定盘 gzip -dc /path/to/image.gz | dd of=/dev/sdx</li>
<li>销毁磁盘数据 dd if=/dev/urandom of=/dev/sda1</li>
<li>测试硬盘写速度 dd if=/dev/zero of=/root/1Gb.file bs=1024 count=1000000</li>
<li>测试硬盘读速度 dd if=/root/1Gb.file bs=64k | dd of=/dev/null </li>
<li>修复硬盘 dd if=/dev/sda of=/dev/sda</li>
</ul>
<h3 id="RAID"><a href="#RAID" class="headerlink" title="RAID"></a>RAID</h3><p>mdadm 为软RAID提供管理界面<br>RAID设备可命名为/dev/md0、/dev/md1…</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>mdadm -C</td>
<td>创建</td>
</tr>
<tr>
<td>-n #</td>
<td>使用#个块设备来创建此RAID</td>
</tr>
<tr>
<td>-l #</td>
<td>指明要创建的RAID的级别</td>
</tr>
<tr>
<td>-a {yes</td>
<td>no}</td>
<td>自动创建目标RAID设备的设备文件</td>
</tr>
<tr>
<td>-c</td>
<td>指明块大小,单位k </td>
</tr>
<tr>
<td>-x</td>
<td>指明空闲盘的个数 </td>
</tr>
<tr>
<td>mdadm -D</td>
<td>显示raid的详细信息</td>
</tr>
<tr>
<td>-f</td>
<td>标记指定磁盘为损坏 </td>
</tr>
<tr>
<td>-a</td>
<td>添加磁盘 </td>
</tr>
<tr>
<td>-r</td>
<td>移除磁盘 </td>
</tr>
</tbody>
</table>
<blockquote>
<p>观察md的状态 cat /proc/mdstat</p>
</blockquote>
<p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">使用mdadm创建并定义RAID设备</span><br><span class="line">mdadm -C /dev/md0 -a yes -l 5 -n 3 -x 1 /dev/sd&#123;b,c,d,e&#125;1</span><br><span class="line">用文件系统对每个RAID设备进行格式化</span><br><span class="line">mkfs.xfs /dev/md0</span><br><span class="line">测试RAID设备</span><br><span class="line">使用mdadm检查RAID设备的状况</span><br><span class="line">mdadm --detail|D /dev/md0</span><br><span class="line">增加新的成员</span><br><span class="line">mdadm –G /dev/md0 –n4 -a /dev/sdf1</span><br></pre></td></tr></table></figure></p>
<p><strong>软RAID管理</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">生成配置文件：mdadm –D –s &gt;&gt; /etc/mdadm.conf</span><br><span class="line">停止设备：mdadm –S /dev/md0</span><br><span class="line">激活设备：mdadm –A –s /dev/md0 激活</span><br><span class="line">强制启动：mdadm –R /dev/md0</span><br><span class="line">删除raid信息：mdadm --zero-superblock /dev/sdb1</span><br></pre></td></tr></table></figure></p>
<h3 id="LVM逻辑卷管理器"><a href="#LVM逻辑卷管理器" class="headerlink" title="LVM逻辑卷管理器"></a>LVM逻辑卷管理器</h3><p>逻辑卷的创建过程 </p>
<ol>
<li>将设备指定为物理卷</li>
<li>用一个或者多个物理卷来创建一个卷组</li>
<li>物理卷是用固定大小的物理区域（Physical Extent，PE）来定义的</li>
<li>在物理卷上创建的逻辑卷是由物理区域（PE）组成</li>
<li>可以在逻辑卷上创建文件系统</li>
</ol>
<p><strong>pv物理卷管理工具</strong>  </p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>pvs、pvdisplay</td>
<td>显示pv信息</td>
</tr>
<tr>
<td>pvcreate /dev/DEVICE</td>
<td>创建pv</td>
</tr>
<tr>
<td>pvremove /dev/DEVICE</td>
<td>删除pv  </td>
</tr>
</tbody>
</table>
<p><strong>vg卷组管理工具</strong>  </p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>vgs、vgdisplay</td>
<td>显示卷组信息</td>
</tr>
<tr>
<td>vgcreate VolumeGroupName PhysicalDevicePath</td>
<td>创建卷组</td>
</tr>
<tr>
<td>vgextend、vgreduce VolumeGroupName PhysicalDevicePath</td>
<td>管理卷组</td>
</tr>
<tr>
<td>先做pvmove，再做vgremove</td>
<td>删除卷组 </td>
</tr>
</tbody>
</table>
<p><strong>lv管理工具</strong> </p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>lvs、Lvdisplay</td>
<td>显示逻辑卷</td>
</tr>
<tr>
<td>lvcreate -l 60%VG/100%FREE -n NAME VolumeGroup</td>
<td>创建逻辑卷</td>
</tr>
<tr>
<td>lvremove /dev/VG_NAME/LV_NAME</td>
<td>删除逻辑卷</td>
</tr>
<tr>
<td>fsadm、resize2fs、xfs_growfs</td>
<td>重设文件系统大小</td>
</tr>
</tbody>
</table>
<p><strong>扩展和缩减逻辑卷</strong><br>扩展逻辑卷：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lvextend -L [+]#[mMgGtT] /dev/VG_NAME/LV_NAME</span><br><span class="line">resize2fs /dev/VG_NAME/LV_NAME</span><br><span class="line">lvresize -r -l +100%FREE /dev/VG_NAME/LV_NAME</span><br></pre></td></tr></table></figure></p>
<p>缩减逻辑卷：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">umount /dev/VG_NAME/LV_NAME</span><br><span class="line">e2fsck -f /dev/VG_NAME/LV_NAME</span><br><span class="line">resize2fs /dev/VG_NAME/LV_NAME #[mMgGtT]</span><br><span class="line">lvreduce -L [-]#[mMgGtT] /dev/VG_NAME/LV_NAME</span><br><span class="line">mount</span><br></pre></td></tr></table></figure></p>
<p>创建逻辑卷示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">创建物理卷</span><br><span class="line">pvcreate /dev/sda3</span><br><span class="line">为卷组分配物理卷</span><br><span class="line">vgcreate vg0 /dev/sda3</span><br><span class="line">从卷组创建逻辑卷</span><br><span class="line">lvcreate -L 256M -n data vg0</span><br><span class="line">mkfs.xfs -j /dev/vg0/data</span><br><span class="line">挂载</span><br><span class="line">mount /dev/vg0/data /mnt/data</span><br></pre></td></tr></table></figure></p>
<p>跨主机迁移卷组<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">源计算机上</span><br><span class="line">1 在旧系统中，umount所有卷组上的逻辑卷</span><br><span class="line">2 禁用卷组</span><br><span class="line">vgchange –a n vg0</span><br><span class="line">lvdisplay</span><br><span class="line">3 导出卷组</span><br><span class="line">vgexport vg0</span><br><span class="line">pvscan</span><br><span class="line">vgdisplay</span><br><span class="line">拆下旧硬盘</span><br><span class="line">在目标计算机上</span><br><span class="line">4 在新系统中安装旧硬盘，并导入卷组：vgimport vg0</span><br><span class="line">5 vgchange –ay vg0 启用</span><br><span class="line">6 mount所有卷组上的逻辑卷</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>XFS可以扩展，不能缩减<br><strong>lvextend -r 不考虑文件系统格式直接扩展容量</strong><br>centos7 xfs文件系统<br>mount -o nouuid，ro挂载快照需要特殊选项 不检查uuid  只读 </p>
</blockquote>
<p>快照可临时用于备份，不影响用户的写入操作  </p>
<p><strong>快照用完谨记用后删除</strong>，会影响服务器性能  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.nextx.tk/2018/10/14/Shell脚本/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nieW">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nieW learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/14/Shell脚本/" itemprop="url">shell脚本</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-14T22:20:00+08:00">
                2018-10-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="shell脚本"><a href="#shell脚本" class="headerlink" title="shell脚本"></a>shell脚本</h1><h2 id="编程基础"><a href="#编程基础" class="headerlink" title="编程基础"></a>编程基础</h2><p>bash ***.sh运行脚本<br>算法+数据结构<br>过程式<br>对象式 大型项目</p>
<ul>
<li>编程逻辑处理方式<br>顺序执行<br>循环执行<br>选择执行  </li>
<li><p><strong>远程执行脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">将脚本scp xxx.sh ip:/var/www/html/拷贝到一台主机的网页目录下</span><br><span class="line">访问这台主机的页面下载脚本 service httpd start </span><br><span class="line">ip/xxx.sh</span><br><span class="line">在需要执行脚本的主机上运行</span><br><span class="line">curl http://ip/xxx.sh|bash</span><br><span class="line">这样就直接远程执行脚本</span><br></pre></td></tr></table></figure>
</li>
<li><p>shell:过程式、解释执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">格式要求：首行shebang机制</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># ------------------------------------------</span></span><br><span class="line"><span class="comment"># Filename: hello.sh</span></span><br><span class="line"><span class="comment"># Revision: 1.1</span></span><br><span class="line"><span class="comment"># Date: 2017/06/01</span></span><br><span class="line"><span class="comment"># Author: wang</span></span><br><span class="line"><span class="comment"># Email: wang@gmail.com</span></span><br><span class="line"><span class="comment"># Website: www.magedu.com</span></span><br><span class="line"><span class="comment"># Description: This is the first script</span></span><br><span class="line"><span class="comment"># ------------------------------------------</span></span><br><span class="line"><span class="comment"># Copyright: 2017 wang</span></span><br><span class="line"><span class="comment"># License: GPL</span></span><br><span class="line"><span class="built_in">echo</span> “hello world”</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>bash -n 检查错误<br>bash -x 跟踪脚本执行过程</p>
<p><strong>脚本中不支持别名</strong></p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>shell支持整数变量<br>强类型  java、c#、Python<br>弱类型  bash    </p>
<ol>
<li>不能使程序中的保留字：例如if, for   </li>
<li>只能使用数字、字母及下划线，且不能以数字开头（不能使用-）  </li>
<li>见名知义  </li>
<li>驼峰法命名：变量名每单词首字母大写  </li>
</ol>
<h2 id="变量种类"><a href="#变量种类" class="headerlink" title="变量种类"></a>变量种类</h2><ul>
<li>局部变量：生效范围为当前shell进程；对当前shell之外的其它shell进程，<br>包括当前shell的子shell进程均无效  </li>
<li>环境（全局）变量：生效范围为当前shell进程及其子进程  </li>
<li>本地变量：生效范围为当前shell进程中某代码片断，通常指函数  </li>
<li>位置变量：$1, $2,…来表示，用于让脚本在脚本代码中调用通过命令行传递给它的参数  </li>
<li>特殊变量：$?, $0, $*, $@, $#,$$</li>
</ul>
<p>cmd=hostname<br>$cmd 可以调用命令 实现别名的效果<br>定期删除内存变量 避免内存泄漏  </p>
<p>删除变量 <strong>unset</strong> name</p>
<p><strong>man bash</strong> 查询系统变量  </p>
<p>显示当前进程号<br>echo $$<br>(echo $BASHPID)小括号子进程中和$$不同(更准确)    </p>
<p><strong>普通变量只对当前进程有效果</strong>  </p>
<p>export 设置环境变量 不受父子进程影响  </p>
<p>(umask 026;touch /data/f1.log);touch /data/f2.log<br>640 644<br><strong>()会开启子shell,不影响默认shell设置</strong><br>name=m34;(echo $name;name=net34;echo $name);echo $name<br>m34 net34 m34<br>name=m34;{ echo $name;name=net34;echo $name };echo $name  <strong>注意空格</strong><br>m34 net34 net34<br>{}不开启子进程</p>
<p><strong>开启脚本后会运行在上一进程的子进程</strong><br>SHLVL shell的嵌套层数<br>$_ 上一个命令的最后一个字符串  </p>
<ul>
<li>只读变量<br>readonly</li>
<li>位置变量<br>$1 $2 $3…<strong>${10}</strong>作为一整需要{}表示<br>系统默认变量<br>ip.sh eth0  eth1 $1=eth0 $2=eth1  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">test_arg.sh &#123;1..10&#125; </span><br><span class="line">echo &quot;1st arg is $1&quot;</span><br><span class="line">echo &quot;2st arg is $2&quot;</span><br><span class="line">echo &quot;10st arg is $&#123;10&#125;&quot;</span><br><span class="line">echo &quot;all arg are $*&quot;</span><br><span class="line">echo &quot;all arg are $@&quot;</span><br><span class="line">echo &quot;the arg number is $#&quot;</span><br><span class="line">echo &quot;the scriptname is `basename $0`&quot;</span><br></pre></td></tr></table></figure>
<p><code>$*</code> 多脚本调用时会出现不能准确取出特定参数的情况，会认为前面的结果为一个整体参数<br><code>$@</code>多脚本调用时,每个参数独立可用<br><code>$@ $*</code> <strong>只在被双引号包起来的时候才会有差异</strong><br><code>$?</code>只保存最后一个命令的结果<br>返回0 表示成功 其它数字失败 1-255<br><code>ping -c1 -w1 IP</code> c次数 w时间  </p>
<h2 id="算数运算"><a href="#算数运算" class="headerlink" title="算数运算"></a>算数运算</h2><p>+, -, *, /, %取模(取余), **(乘方)</p>
<ul>
<li><p>let 功能强大</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(1) let var=算术表达式</span><br><span class="line">(2) var=$[算术表达式]</span><br><span class="line">(3) var=$((算术表达式))</span><br><span class="line">(4) var=$(expr arg1 arg2 arg3 ...)</span><br><span class="line">(5) declare –i var = 数值</span><br><span class="line">(6) echo ‘算术表达式’ | bc</span><br></pre></td></tr></table></figure>
</li>
<li><p>++i先运算  i++后运算  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">i=10;let j=i++;echo j=$j先赋值</span><br><span class="line">j=10</span><br><span class="line">i=10;let j=++i;echo j=$j先+再赋值</span><br><span class="line">j=11</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">- echo $[RANDOM%63+1]从1开始取到63  </span><br><span class="line"></span><br><span class="line">## 逻辑运算</span><br><span class="line">- 与 或</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>true 1, false 0<br>与:<br>1 与 1 = 1<br>1 与 0 = 0<br>0 与 1 = 0<br>0 与 0 = 0</p>
<p>或:<br>1 或 1 = 1<br>1 或 0 = 1<br>0 或 1 = 1<br>0 或 0 = 0</p>
<p>echo $[12&amp;24] 与 8<br>echo $[12|24] 或 28 </p>
<p>非:!<br>! 1 = 0 ! true<br>! 0 = 1 ! false</p>
<p>异或:^<br>异或的两个值,相同为假0,不同为真1</p>
<p>A=10;B=20;A=$[A^B];B=$[A^B];A=$[A^B];echo A=$A B=$B<br>A=20 B=10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 短路与 短路或</span><br></pre></td></tr></table></figure>
<p>cmd1 与 cmd2 &amp;<br>cmd1 为真 与 cmd2 结果 ？<br>cmd1 为假 或 cmd2 结果为假</p>
<p>cmd1 或 cmd2 |<br>cmd1 为真 或 cmd2 结果为真<br>cmd1  为假 或 cmd2 结果 ？</p>
<p>cmd1 短路与 cmd2 &amp;&amp;<br>如果cmd1 为真，执行cmd2<br>如果cmd1 为假，不执行cmd2</p>
<p>cmd1 短路或 cmd2  ||<br>如果cmd1 为真，不执行cmd2<br>如果cmd1 为假，执行cmd2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">## 条件测试</span><br></pre></td></tr></table></figure></p>
<p>test EXPRESSION<br>[ EXPRESSION ]<br>[[ EXPRESSION ]]<br>注意:EXPRESSION前后必须有空白字符</p>
<p>[ “$1” = “$2” ]中括号涉及到变量的时候注意两边空格和引号</p>
<p>username=user1;id $username &amp;&gt; /dev/null || useradd $username 判断是否user1存在，不存在创建用户</p>
<p>age=26; [ “$age” -gt 18 ] &amp;&amp; echo “too old” || echo “young” 判断age大于18，打印命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## Bash 测试方式</span><br><span class="line"></span><br><span class="line">测试种类 | 说明</span><br><span class="line">---|---</span><br><span class="line">文件测试 | 存在性</span><br><span class="line">**数值测试** | </span><br><span class="line">-gt | 是否大于</span><br><span class="line">-ge | 是否大于等于</span><br><span class="line">-eq | 是否等于</span><br><span class="line">-ne | 是否不等于</span><br><span class="line">-lt | 是否小于</span><br><span class="line">-le | 是否小于等于</span><br><span class="line">**字符测试** | </span><br><span class="line">= | 是否等于</span><br><span class="line">`&gt;` | ascii码是否大于ascii码</span><br><span class="line">`&lt;` | 是否小于</span><br><span class="line">！= | 是否不等于</span><br><span class="line">=～ | 左侧字符串是否能够被右侧的PATTERN所匹配。注意: 此表达式一般用于[[]]中;**扩展的正则表达式**</span><br><span class="line">-z | 字符串是否为空,空为真,不空为假</span><br><span class="line">-n | 字符串是否不空,不空为真,空为假</span><br><span class="line">**文件测试** | </span><br><span class="line">-a、-e | 文件存在性测试,存在为真,否则为假</span><br><span class="line">-b | 是否存在且为块设备文件</span><br><span class="line">-c | 是否存在且为字符设备文件</span><br><span class="line">-d | 是否存在且为目录文件</span><br><span class="line">-f | 是否存在且为普通文件</span><br><span class="line">-h | 是否存在且为符号链接文件</span><br><span class="line">-p | 是否存在且为命名管道文件</span><br><span class="line">-s | 是否存在且为套接字文件</span><br><span class="line">**文件权限测试** | </span><br><span class="line">-r | 是否存在且可读</span><br><span class="line">-w | 是否存在且可写</span><br><span class="line">-x | 是否存在且可执行</span><br><span class="line">-u | 是否存在且拥有suid权限</span><br><span class="line">-g | 是否存在且拥有sgid权限</span><br><span class="line">-k | 是否存在且拥有sticky权限</span><br><span class="line">**文件属性测试** | </span><br><span class="line">-s | 是否存在且非空</span><br><span class="line">-t | 文件描述符是否在某终端已经打开</span><br><span class="line">-N | 文件自从上一次被读取之后是否被修改过</span><br><span class="line">-O | 当前有效用户是否为文件属主</span><br><span class="line">-G | 当前有效用户是否为文件属组</span><br><span class="line">-ef | FILE1 -ef FILE2: FILE1是否是FILE2的硬链接</span><br><span class="line">-nt | FILE1 -ef FILE2: FILE1是否新于FILE2(mtime)</span><br><span class="line">-ot | FILE1 -ef FILE2: FILE1是否旧于FILE2(mtime)</span><br><span class="line">**组合测试条件** | </span><br><span class="line">&amp;&amp; | COMMAND1 &amp;&amp; COMMAND2 并且</span><br><span class="line">|\|\| | COMMAND1 \|\| COMMAND2 或者</span><br><span class="line">! | ! COMMAND 非</span><br><span class="line">例如 | [ -f “$FILE” ] &amp;&amp; [[ “$FILE”=~ .*\.sh$ ]]</span><br><span class="line">**==-a==** | EXPRESSION1 -a EXPRESSION2 并且</span><br><span class="line">**==-o==** | EXPRESSION1 -o EXPRESSION2 或者</span><br><span class="line">! | 取反 EXPRESSION </span><br><span class="line">**注意** | [[ ]] 双中括号不支持-a -o</span><br><span class="line">例如 | [ -z “$HOSTNAME” -o $HOSTNAME &quot;==&quot;localhost.localdomain&quot; ] \&amp;&amp; hostname www.server ==注意中括号的空格==</span><br><span class="line">例如 | [ -f /bin/cat -a -x /bin/cat ] &amp;&amp; cat /etc/fstab 是否是普通文件并且拥有执行权限，如果是就打开/etc/fstab</span><br><span class="line">**[[ == ]]  使用通配符和正则时使用**  </span><br><span class="line">**\==后面可用通配符（不需加引号）  =~后面可用正则表达式（不需加引号） 扩展正则表达式**  </span><br><span class="line">**()可以在子进程中执行命令**  </span><br><span class="line">**&#123;&#125;只在当前shell中执行命令**  </span><br><span class="line"></span><br><span class="line">## Read 提示输入命令</span><br><span class="line">使用read来把输入值分配给一个或多个shell变量  </span><br><span class="line">**建议每次一个变量**</span><br></pre></td></tr></table></figure></p>
<p>read name age<br>nie 20<br>echo $name = nie<br>echo $age = 20<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">read -p &quot;请输入姓名：&quot; name</span><br><span class="line">read -s -p &quot;请输入密码&quot; pass</span><br><span class="line">echo </span><br><span class="line">echo your name is $name</span><br><span class="line">echo your password is $pass</span><br></pre></td></tr></table></figure></p>
<p>-p:制定要现实的提示<br>-s：静默输入 密码等方式推荐使用<br>-n：自定义输入位数 read -3 name<br>-d:字符’ 输入结束符 read -d a name a作为结束符<br>-t：超时时间N秒 read -t 10 name 10s结束 </p>
<p><code>read i j k &lt;&lt; &quot;xx yy zz&quot;</code> 一次给多个变赋值  </p>
<p>read 从标准输入中读取值,给每个单词分配一个变量<br><strong>所有剩余单词都被分配给最后一个变量</strong></p>
<h2 id="Bash-命令执行优先级次序"><a href="#Bash-命令执行优先级次序" class="headerlink" title="Bash 命令执行优先级次序"></a>Bash 命令执行优先级次序</h2><ol>
<li>命令拆分单个命令词</li>
<li>展开别名</li>
<li>展开大括号声明（{}）</li>
<li>展开波浪符声明(~)</li>
<li>命令替换$() 和 <code></code>)</li>
<li>再次把命令行分成命令词</li>
<li>展开文件通配(*、?、[abc]等等)</li>
<li>准备I/0重导向(&lt;、&gt;)</li>
<li>运行命令</li>
</ol>
<h2 id="Bash配置文件"><a href="#Bash配置文件" class="headerlink" title="Bash配置文件"></a>Bash配置文件</h2><ul>
<li>全局配置:<br>/etc/profile<br>/etc/profile.d/*.sh<br>/etc/bashrc</li>
<li>个人配置:<br>~/.bash_profile<br>~/.bashrc</li>
</ul>
<table>
<thead>
<tr>
<th>登陆方式</th>
<th>说明</th>
<th>执行顺序</th>
<th>配置文件类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>交互式登录</td>
<td>直接通过终端输入账号密码登录</td>
<td>执行顺序:/etc/profile –&gt; /etc/profile.d/*.sh –&gt; <code>~/.bash_profile</code> –&gt;<code>~/.bashrc</code> –&gt; /etc/bashrc</td>
<td>profile类:全局 /etc/profile, /etc/profile.d/*.sh、 个人 ~/.bash_profile</td>
</tr>
<tr>
<td>非交互式登录</td>
<td>(1)su UserName、(2)图形界面下打开的终端、(3)执行脚本、(4)任何其它的。</td>
<td>执行顺序: /etc/profile.d/*.sh –&gt; /etc/bashrc –&gt;~/.bashrc</td>
<td>bashrc类:全局/etc/bashrc、个人~/.bashrc</td>
</tr>
</tbody>
</table>
<p>修改profile和bashrc文件后需生效<br>1重新启动shell进程<br>2 . 或source<br>例:<br>. ~/.bashrc</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.nextx.tk/2018/10/14/文本处理三剑客SED/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nieW">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nieW learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/14/文本处理三剑客SED/" itemprop="url">文本处理三剑客SED</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-14T22:20:00+08:00">
                2018-10-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="文本处理三剑客SED"><a href="#文本处理三剑客SED" class="headerlink" title="文本处理三剑客SED"></a>文本处理三剑客SED</h1><p>sed是一种流编辑器,它一次处理一行内容。处理时,把当前处理的行存储在临时<br>缓冲区中,称为“模式空间”(pattern space),接着用sed命令处理缓冲区中的<br>内容,处理完成后,把缓冲区的内容送往屏幕。然后读入下行,执行下一个循环。<br>主要用来自动编辑一个或多个文件,简化对文件的反复操作,编写转换程序等。</p>
<h2 id="sed用法"><a href="#sed用法" class="headerlink" title="sed用法"></a>sed用法</h2><p>sed [option]… ‘script’ inputfile…<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">常用选项:</span><br><span class="line">-n:不输出模式空间内容到屏幕,即不自动打印</span><br><span class="line">-e:多点编辑</span><br><span class="line">-f /PATH/SCRIPT_FILE:从指定文件中读取编辑脚本</span><br><span class="line">-r:支持使用扩展正则表达式</span><br><span class="line">-i.bak:备份文件并原处编辑</span><br><span class="line"></span><br><span class="line">script:&apos;地址命令&apos;</span><br></pre></td></tr></table></figure></p>
<h2 id="地址定界"><a href="#地址定界" class="headerlink" title="地址定界"></a>地址定界</h2><table>
<thead>
<tr>
<th>地址范围</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>不给地址</td>
<td>对全文进行处理</td>
</tr>
<tr>
<td>单地址</td>
<td>#:指定的行,$:最后一行</td>
</tr>
<tr>
<td>正则表达式</td>
<td>/pattern/:被此处模式所能够匹配到的每一行</td>
</tr>
<tr>
<td>地址范围</td>
<td>#,#、#,+#、/pat1/,/pat2/ <code>sed -n &#39;/^ftp/,/^sa/p&#39; /etc/passwd</code>、#,/pat1/</td>
</tr>
<tr>
<td>~步进</td>
<td><code>1~2 奇数行、2~2 偶数行</code> <code>sed -n &#39;1~2p&#39;</code></td>
</tr>
</tbody>
</table>
<h2 id="编辑命令"><a href="#编辑命令" class="headerlink" title="编辑命令"></a>编辑命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>d</td>
<td>删除模式空间匹配的行,并立即启用下一轮循环 <code>sed &#39;/^#/d&#39; f1</code></td>
</tr>
<tr>
<td>p</td>
<td>打印当前模式空间内容,追加到默认输出之后 <code>sed -n &#39;/^#/p&#39; f1</code></td>
</tr>
<tr>
<td>a []text</td>
<td>在指定行<em>后面</em>追加文本,支持使用\n实现多行追加 `seq 10</td>
<td>sed ‘2axxx\nyyy\nzzz’<code>、</code>sed ‘/^root/aadmin’ /etc/passwd `</td>
</tr>
<tr>
<td>i []text</td>
<td>在行<em>前面</em>插入文本 <code>sed &#39;/^root/i\  admin&#39; /etc/passwd</code></td>
</tr>
<tr>
<td>c []text</td>
<td>替换行为单行或多行文本 <code>sed &#39;/^Listen 80/cListen 8080&#39; /etc/httpd/conf/httpd.conf</code></td>
</tr>
<tr>
<td>w /path/file</td>
<td>保存模式匹配的行至指定文件 <code>sed -n &#39;/^UUID/w f1&#39; /etc/fstab</code></td>
</tr>
<tr>
<td>r /path/file</td>
<td>读取指定文件的文本至模式空间中匹配到的行后<code>sed &#39;/^UUID/r /etc/issue&#39; /etc/fstab</code></td>
</tr>
<tr>
<td>=</td>
<td>为模式空间中的行打印行号 <code>sed &#39;/^UUID/=&#39; /etc/fstab</code></td>
</tr>
<tr>
<td>!</td>
<td>模式空间中匹配行取反处理 <code>sed -n &#39;/^UUID/!p&#39; /etc/fstab</code></td>
</tr>
<tr>
<td>s///</td>
<td>查找替换,支持使用其它分隔符,s@@@,s###。<code>替换标记:g行内全局替换、p显示替换成功的行、w /PATH/FILE 将替换成功的行保存至文件中</code></td>
</tr>
<tr>
<td>例如</td>
<td><code>sed  &#39;s/UUID/uuid/&#39; /etc/fstab</code>、<code>sed  -n &#39;s/mapper/Mapper/gp&#39; /etc/fstab</code></td>
</tr>
</tbody>
</table>
<h3 id="sed扩展练习"><a href="#sed扩展练习" class="headerlink" title="sed扩展练习"></a>sed扩展练习</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">1. 修改selinux配置文件  </span><br><span class="line">`sed -i <span class="string">'/^SELINUX=/cSELINUX=disabled'</span> /etc/selinux/config`  </span><br><span class="line"></span><br><span class="line">2. IP地址获取  </span><br><span class="line">`ifconfig enp3s0 | sed -nr <span class="string">'s/.*inet (.*)  netmask.*/\1/p'</span>`</span><br><span class="line">`ifconfig ens33 | sed -n <span class="string">'2p'</span> | sed <span class="string">'s/.*inet //'</span>|sed <span class="string">'s/ net.*$//'</span>` </span><br><span class="line">通用写法</span><br><span class="line"> 2!d 对地址2以外的内容删除  </span><br><span class="line">`ifconfig ens33 | sed -r <span class="string">'2!d;s/.*inet (addr:)?//;s/ .*//'</span>` </span><br><span class="line"></span><br><span class="line">3. 获取基名和文件夹名</span><br><span class="line"><span class="built_in">echo</span> /etc/sysconfig/network-scripts/ |sed -r <span class="string">'s@(^.*/)([^/].*)/?@\2@'</span></span><br><span class="line"></span><br><span class="line">4. 替换文件内不为<span class="comment">#开头的行 增加#注释</span></span><br><span class="line">sed -r <span class="string">'s/^[^#]/#&amp;/'</span> /etc/fstab </span><br><span class="line"></span><br><span class="line">5. 替换文件内字母大小写</span><br><span class="line">sed -r <span class="string">'s/[[:alpha:]]/\u&amp;/g'</span> /etc/fstab 替换为大写</span><br><span class="line">sed -r <span class="string">'s/[[:alpha:]]/\l&amp;/g'</span> /etc/fstab 替换为小写</span><br><span class="line"></span><br><span class="line">6. 为特定行尾增加字段</span><br><span class="line">sed -nr <span class="string">'/.*CMDLINE.*/s/(.*)"/\1 net.ifnames=0"/p'</span> /etc/default/grub</span><br><span class="line"></span><br><span class="line">7. 判断系统版本后修改特定文件内容</span><br><span class="line">systemnum=`cat /etc/redhat-release |sed -nr <span class="string">'s/.* ([0-9]+)\..*/\1/'</span>`</span><br><span class="line">[ <span class="variable">$systemnum</span> -eg 7] &amp;&amp; sed -nr <span class="string">'/.*CMDLINE.*/s/(.*)"/\1 net.ifnames=0"/p'</span> /etc/default/grub</span><br><span class="line"></span><br><span class="line">8. sed中调用变量的写法</span><br><span class="line">str=abc</span><br><span class="line">sed -nr <span class="string">'/.*CMDLINE.*/s/(.*)"/\1 '</span><span class="string">''</span><span class="variable">$str</span><span class="string">''</span><span class="string">'"/p'</span> /etc/default/grub</span><br><span class="line"></span><br><span class="line">9. 删除文件中的注释行和空白行</span><br><span class="line">sed -r <span class="string">'/^#|^$/d'</span> /etc/httpd/conf/httpd.conf</span><br><span class="line"></span><br><span class="line">10. 显示行号并删除2-5行</span><br><span class="line">nl /etc/passwd | sed ‘2,5d’</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.nextx.tk/2018/10/14/文件查找及压缩/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nieW">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nieW learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/14/文件查找及压缩/" itemprop="url">文件查找和压缩</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-14T22:20:00+08:00">
                2018-10-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="文件查找和压缩"><a href="#文件查找和压缩" class="headerlink" title="文件查找和压缩"></a>文件查找和压缩</h1><h2 id="文件查找"><a href="#文件查找" class="headerlink" title="文件查找"></a>文件查找</h2><ul>
<li><p>locate<br><strong>非实时 updatedb更新数据库</strong><br>支持通配符 “”<br>-<strong>r</strong>:基础正则表达式<br>-<strong>regex</strong> :扩展正则表达式  </p>
</li>
<li><p>find<br>实时查找<br>需要有权限来搜索<br>默认递归搜索<br>-maxdepth 2 -mindepth 2 只搜索子目录   </p>
</li>
</ul>
<table>
<thead>
<tr>
<th>查找条件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>搜索层级</strong></td>
<td></td>
</tr>
<tr>
<td>-maxdepth 2</td>
<td>最大搜索目录深度,指定目录为第1级</td>
</tr>
<tr>
<td>-mindepth 2</td>
<td>最小搜索目录深度</td>
</tr>
<tr>
<td>-depth</td>
<td>先处理目录内的文件,再处理目录</td>
</tr>
<tr>
<td>-name</td>
<td>文件名称，支持通配符*, ?, [], [^]</td>
</tr>
<tr>
<td>-iname</td>
<td>文件名称，不区分大小写字母</td>
</tr>
<tr>
<td>-inum n</td>
<td>按inode号查找</td>
</tr>
<tr>
<td>-samefile name</td>
<td>相同inode号的文件。find /data -samefile /data/files 第一个为搜索路径，后为参考路径</td>
</tr>
<tr>
<td>-links n</td>
<td>链接数为n的文件</td>
</tr>
<tr>
<td>-regex “PATTERN”</td>
<td>以PATTERN匹配整个文件路径,而非文件名称。find /data/bin/ -regex “.*.sh$” <strong>注意匹配的路径写法</strong></td>
</tr>
<tr>
<td><strong>用户名和组</strong></td>
<td></td>
</tr>
<tr>
<td>-user USERNAME</td>
<td>查找属主为指定用户(UID)的文件 find /data -user root -ls -<strong>ls可列出详细信息</strong></td>
</tr>
<tr>
<td>-group GRPNAME</td>
<td>查找属组为指定组(GID)的文件</td>
</tr>
<tr>
<td>-uid UserID</td>
<td>查找属主为指定的UID号的文件</td>
</tr>
<tr>
<td>-gid GroupID</td>
<td>查找属组为指定的GID号的文件</td>
</tr>
<tr>
<td>-nouser</td>
<td>查找没有属主的文件 已删除用户的所建文件</td>
</tr>
<tr>
<td>-nogroup</td>
<td>查找没有属组的文件</td>
</tr>
<tr>
<td><strong>文件类型</strong></td>
<td></td>
</tr>
<tr>
<td>-type f</td>
<td>普通文件</td>
</tr>
<tr>
<td>-type d</td>
<td>目录文件</td>
</tr>
<tr>
<td>-type l</td>
<td>符号链接文件</td>
</tr>
<tr>
<td>-type b</td>
<td>块设备文件</td>
</tr>
<tr>
<td>-type c</td>
<td>字符设备文件</td>
</tr>
<tr>
<td>-type p</td>
<td>管道文件</td>
</tr>
<tr>
<td>-empty</td>
<td>find /app -type d -empty</td>
</tr>
<tr>
<td><strong>组合条件</strong></td>
<td></td>
</tr>
<tr>
<td>-a</td>
<td>与 find -name “*.sh” -a -user root -ls</td>
</tr>
<tr>
<td>-o</td>
<td>或 find ( -name “*.sh” -o -user root ) -ls 注意执行顺序优先级</td>
</tr>
<tr>
<td>-not 或！</td>
<td>非 find ！ -name “*.sh”</td>
</tr>
<tr>
<td><strong>德·摩根定律</strong></td>
<td></td>
</tr>
<tr>
<td>(非 A) 或 (非 B) = 非(A 且 B)</td>
<td>!A -o !B = !(A -a B)</td>
</tr>
<tr>
<td>非 A) 且 (非 B) = 非(A 或 B)</td>
<td>!A -a !B = !(A -o B)、find -not ( -user joe -o -user jane ) 不是joe并且不是jane的文件</td>
</tr>
<tr>
<td><strong>查找条件</strong></td>
<td></td>
</tr>
<tr>
<td>-prune</td>
<td>剪切不查找。查找/etc/下,除/etc/sane.d目录的其它所有.conf后缀的文件:find /etc -path ‘/etc/sane.d’ -a –prune -o -name “*.conf”</td>
</tr>
<tr>
<td>-size [+\</td>
<td>-]#UNIT</td>
<td>常用单位:k, M, G,c(byte) 1、#UNIT: (#-1, #]如:6k 表示(5k,6k]2、-#UNIT:[0,#-1]如:-6k 表示[0,5k]3、+#UNIT:(#, ∞ )如:+6k 表示(6k ,∞ ) find /data -size +5MB -size -10MB -ls</td>
</tr>
<tr>
<td>-atime、mtime、ctime [+\</td>
<td>-]#</td>
<td>默认“天”为单位。#: [#,#+1)、+#: [#+1, ∞ ]、-#: [0,#)</td>
</tr>
<tr>
<td>-mmin、amin、cmin</td>
<td>以“分钟”为单位</td>
</tr>
<tr>
<td>-perm MODE</td>
<td>MODE: 精确权限匹配 <strong>数字法</strong></td>
</tr>
<tr>
<td>-perm /MODE</td>
<td>任何一类(u,g,o)对象的权限中只要能<strong>一位</strong>匹配即可,或关系。find -perm /644 -ls <strong>644 需转换为二进制 1为检查 0为不关心 6为检查位</strong></td>
</tr>
<tr>
<td>-perm -MODE</td>
<td>每一类对象都必须同时拥有指定权限,与关系。</td>
</tr>
<tr>
<td>例如</td>
<td>1、只要当任意人有写权限时,find -perm +222就会匹配2、只有当其它人(other)有写权限时,find -perm -002才会匹配3、只有当每个人都有写权限时,find -perm -222才会匹配</td>
</tr>
</tbody>
</table>
<h2 id="处理动作"><a href="#处理动作" class="headerlink" title="处理动作"></a>处理动作</h2><ul>
<li>-print:默认的处理动作,显示至屏幕</li>
<li>-ls:类似于对查找到的文件执行“ls -l”命令</li>
<li>-delete:删除查找到的文件</li>
<li>-fls file:查找到的所有文件的长格式信息保存至指定文件中<br>两种用法<br><code>find -perm -644 -ls &gt; /data/find.log</code><br><code>find -perm -644 -fls  /data/find.log</code> </li>
<li>-ok COMMAND {} \; 对查找到的每个文件执行由COMMAND指定的命令,对于每个文件执行命令之前,都会交互式要求用户确认。<br>查找权限为可读并且后缀为.txt的文件，移动到/root目录下。<br><strong>{}代表前面搜索到的文件路径及文件名称，结尾必须为<code>\;</code></strong><br><code>find -perm -444 -name &quot;*.txt&quot; -ok mv {} /root \;</code> </li>
<li>-exec COMMAND {}\;对查找到的每个文件执行由COMMAND指定的命令。<br>查找大于10M的文件并移动到/tmp目录<br><code>find /data -size +10M -exec mv {} /tmp \;</code><br>批量复制文””件并且修改文件名<br><code>find -name &quot;*.txt&quot; -exec cp {} /data/{}.bak \;</code></li>
</ul>
<h2 id="参数替换xargs"><a href="#参数替换xargs" class="headerlink" title="参数替换xargs"></a>参数替换xargs</h2><p>由于很多命令不支持管道|来传递参数,而日常工作中有这个必要,所以就有了xargs命令</p>
<ul>
<li><p>xargs用于产生某个命令的参数,xargs可以读入标准输入的数据,并且以空格符或回车符将标准输入的数据分隔成为参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">示例:</span><br><span class="line">ls f* |xargs rm 查找f开头文件并删除</span><br><span class="line">find /sbin -perm +700 |ls -l 这个命令是错误的</span><br><span class="line">find /sbin -perm +7000 | xargs ls –l 查找特殊权限的文件 7=suid4+guid2+sticky1</span><br></pre></td></tr></table></figure>
</li>
<li><p>find和xargs格式:find | xargs COMMAND</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.备份配置文件,添加.orig这个扩展名</span><br><span class="line">find -name “*.conf” -exec cp &#123;&#125; &#123;&#125;.orig \;</span><br><span class="line">2.提示删除存在时间超过3天以上的joe的临时文件</span><br><span class="line">find /tmp -ctime +3 -user joe -ok rm &#123;&#125; \;</span><br><span class="line">3.在主目录中寻找可被其它用户写入的文件</span><br><span class="line">find ~ -perm -002 -exec chmod o-w &#123;&#125; \;</span><br><span class="line">4.查找/data下的权限为644,后缀为sh的普通文件,增加执行权限</span><br><span class="line">find /data –type f -perm 644 -name “*.sh” –exec chmod 755 &#123;&#125; \;</span><br><span class="line">5.查看/home的目录</span><br><span class="line">find /home –type d -ls</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="压缩、解压缩及归档工具"><a href="#压缩、解压缩及归档工具" class="headerlink" title="压缩、解压缩及归档工具"></a>压缩、解压缩及归档工具</h2><ul>
<li>gzip<br>gzip -c m.txt &gt; m.gz 保留原文件生产压缩文件<br>gzip -d m.gz 解压缩 压缩文件会丢失<br>gzip – -f1 -f2 -f3 压缩特殊带-文件<br>zcat  查看压缩文件内容</li>
<li>bzip2<br>bzip2 -k 保留原文件<br>bzip2 -d 解压缩<br>bzcat  查看压缩文件内容</li>
<li>xz<br>xz -k 保留原文件<br>xz -d 解压缩<br>xzcat  查看压缩文件内容</li>
<li>打包tar工具<br>c 归档 f 文件目录 v 过程 p 保留权限 t 预览打包内容 x解包 C指定解包目录<br>z …gz  打包并压缩成gz<br>j …bz2 打包并压缩成bz2<br>J …xz  打包并压缩成xz<br>tgz = tar.gz  </li>
<li><p>split 切割<br>split -b 2M -d  b:指定文件分割大小 -d:以数字命名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">分割大的 tar 文件为多份小文件</span><br><span class="line">split –b Size –d tar-file-name prefix-name</span><br><span class="line">split -b 1M –d mybackup.tgz mybackup-parts</span><br><span class="line">split -b 1M mybackup.tgz mybackup-parts</span><br><span class="line">合并:</span><br><span class="line">cat mybackup-parts* &gt; mybackup.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>cpio 打包工具（已被tar取代）</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.nextx.tk/2018/10/08/学习重点/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nieW">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nieW learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/08/学习重点/" itemprop="url">学习重点</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-08T21:25:32+08:00">
                2018-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学习难点"><a href="#学习难点" class="headerlink" title="学习难点"></a>学习难点</h1><h2 id="常用命令及常用选项"><a href="#常用命令及常用选项" class="headerlink" title="常用命令及常用选项"></a>常用命令及常用选项</h2><p>引用自网络</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>线上查询及帮助命令</strong></td>
<td><em>2个</em></td>
</tr>
<tr>
<td>man</td>
<td>查看命令帮助，命令的词典，更复杂的还有info，但不常用。</td>
</tr>
<tr>
<td>help</td>
<td>查看Linux内置命令的帮助，比如cd命令。</td>
</tr>
<tr>
<td><strong>文件和目录操作命令</strong></td>
<td><em>18个</em></td>
</tr>
<tr>
<td>ls</td>
<td>全拼 list，功能是列出目录的内容及其内容属性信息。</td>
</tr>
<tr>
<td>cd</td>
<td>全拼 change directory，功能是从当前工作目录切换到指定的工作目录。</td>
</tr>
<tr>
<td>cp</td>
<td>全拼 copy，其功能为复制文件或目录。</td>
</tr>
<tr>
<td>find</td>
<td>查找的意思，用于查找目录及目录下的文件。</td>
</tr>
<tr>
<td>mkdir</td>
<td>全拼 make directories，其功能是创建目录。</td>
</tr>
<tr>
<td>mv</td>
<td>全拼 move，其功能是移动或重命名文件。</td>
</tr>
<tr>
<td>pwd</td>
<td>全拼 print working directory，其功能是显示当前工作目录的绝对路径。</td>
</tr>
<tr>
<td>rename</td>
<td>用于重命名文件。</td>
</tr>
<tr>
<td>rm</td>
<td>全拼 remove，其功能是删除一个或多个文件或目录。</td>
</tr>
<tr>
<td>rmdir</td>
<td>全拼 remove empty directories，功能是删除空目录。</td>
</tr>
<tr>
<td>touch</td>
<td>创建新的空文件，改变已有文件的时间戳属性。</td>
</tr>
<tr>
<td>tree</td>
<td>功能是以树形结构显示目录下的内容。</td>
</tr>
<tr>
<td>basename</td>
<td>显示文件名或目录名。</td>
</tr>
<tr>
<td>dirname</td>
<td>显示文件或目录路径。</td>
</tr>
<tr>
<td>chattr</td>
<td>改变文件的扩展属性。</td>
</tr>
<tr>
<td>lsattr</td>
<td>查看文件扩展属性。</td>
</tr>
<tr>
<td>file</td>
<td>显示文件的类型。</td>
</tr>
<tr>
<td>md5sum</td>
<td>计算和校验文件的 MD5 值。</td>
</tr>
<tr>
<td><strong>查看文件及内容处理命令</strong></td>
<td><em>21个</em></td>
</tr>
<tr>
<td>cat</td>
<td>全拼 concatenate，功能是用于连接多个文件并且打印到屏幕输出或重定向到指定文件中。</td>
</tr>
<tr>
<td>tac</td>
<td>tac 是 cat 的反向拼写，因此命令的功能为反向显示文件内容。</td>
</tr>
<tr>
<td>more</td>
<td>分页显示文件内容。</td>
</tr>
<tr>
<td>less</td>
<td>分页显示文件内容，more 命令的相反用法。</td>
</tr>
<tr>
<td>head</td>
<td>显示文件内容的头部，默认前十行。</td>
</tr>
<tr>
<td>tail</td>
<td>显示文件内容的尾部，默认后十行。</td>
</tr>
<tr>
<td>cut</td>
<td>将文件的每一行按指定分隔符分割并输出。</td>
</tr>
<tr>
<td>split</td>
<td>分割文件为不同的小片段。</td>
</tr>
<tr>
<td>paste</td>
<td>按行合并文件内容。</td>
</tr>
<tr>
<td>sort</td>
<td>对文件的文本内容排序。</td>
</tr>
<tr>
<td>uniq</td>
<td>去除重复行。</td>
</tr>
<tr>
<td>wc</td>
<td>统计文件的行数、单词数或字节数。</td>
</tr>
<tr>
<td>iconv</td>
<td>转换文件的编码格式。</td>
</tr>
<tr>
<td>dos2unix</td>
<td>将 DOS 格式文件转换成 UNIX 格式。</td>
</tr>
<tr>
<td>diff</td>
<td>全拼 difference，比较文件的差异，常用于文本文件。</td>
</tr>
<tr>
<td>vimdiff</td>
<td>命令行可视化文件比较工具，常用于文本文件。</td>
</tr>
<tr>
<td>rev</td>
<td>反向输出文件内容。</td>
</tr>
<tr>
<td>grep/egrep</td>
<td>过滤字符串</td>
</tr>
<tr>
<td>join</td>
<td>按两个文件的相同字段合并。</td>
</tr>
<tr>
<td>tr</td>
<td>替换或删除字符。</td>
</tr>
<tr>
<td>vi/vim</td>
<td>命令行文本编辑器。</td>
</tr>
<tr>
<td><strong>文件压缩及解压缩命令</strong></td>
<td><em>4个</em></td>
</tr>
<tr>
<td>tar</td>
<td>打包压缩。</td>
</tr>
<tr>
<td>unzip</td>
<td>解压文件。</td>
</tr>
<tr>
<td>gzip</td>
<td>gzip压缩工具。</td>
</tr>
<tr>
<td>zip</td>
<td>压缩工具。</td>
</tr>
<tr>
<td><strong>信息显示命令</strong></td>
<td><em>11个</em></td>
</tr>
<tr>
<td>uname</td>
<td>显示操作系统相关信息的命令。</td>
</tr>
<tr>
<td>hostname</td>
<td>显示或者设置当前系统的主机名。</td>
</tr>
<tr>
<td>dmesg</td>
<td>显示开机信息，用于诊断系统故障。</td>
</tr>
<tr>
<td>uptime</td>
<td>显示系统运行时间及负载。</td>
</tr>
<tr>
<td>stat</td>
<td>显示文件或文件系统的状态。</td>
</tr>
<tr>
<td>du</td>
<td>计算磁盘空间使用情况。</td>
</tr>
<tr>
<td>df</td>
<td>报告文件系统磁盘空间的使用情况。</td>
</tr>
<tr>
<td>top</td>
<td>实时显示系统资源使用情况。</td>
</tr>
<tr>
<td>free</td>
<td>查看系统内存。</td>
</tr>
<tr>
<td>date</td>
<td>显示与设置系统时间。</td>
</tr>
<tr>
<td>cal</td>
<td>查看日历等时间信息。</td>
</tr>
<tr>
<td><strong>搜索文件命令</strong></td>
<td><em>4个</em></td>
</tr>
<tr>
<td>which</td>
<td>查找二进制命令，按环境变量 PATH 路径查找。</td>
</tr>
<tr>
<td>find</td>
<td>从磁盘遍历查找文件或目录。</td>
</tr>
<tr>
<td>whereis</td>
<td>查找二进制命令，按环境变量 PATH 路径查找。</td>
</tr>
<tr>
<td>locate</td>
<td>从数据库 (/var/lib/mlocate/mlocate.db) 查找命令，使用 updatedb 更新库。</td>
</tr>
<tr>
<td><strong>用户管理命令</strong></td>
<td><em>10个</em></td>
</tr>
<tr>
<td>useradd</td>
<td>添加用户。</td>
</tr>
<tr>
<td>usermod</td>
<td>修改系统已经存在的用户属性。</td>
</tr>
<tr>
<td>userdel</td>
<td>删除用户。</td>
</tr>
<tr>
<td>groupadd</td>
<td>添加用户组。</td>
</tr>
<tr>
<td>passwd</td>
<td>修改用户密码。</td>
</tr>
<tr>
<td>chage</td>
<td>修改用户密码有效期限。</td>
</tr>
<tr>
<td>id</td>
<td>查看用户的 uid,gid 及归属的用户组。</td>
</tr>
<tr>
<td>su</td>
<td>切换用户身份。</td>
</tr>
<tr>
<td>visudo</td>
<td>编辑 /etc/sudoers 文件的专属命令。</td>
</tr>
<tr>
<td>sudo</td>
<td>以另外一个用户身份（默认 root 用户）执行事先在 sudoers 文件允许的命令。</td>
</tr>
<tr>
<td><strong>基础网络操作命令</strong></td>
<td><em>11个</em></td>
</tr>
<tr>
<td>telnet</td>
<td>使用 TELNET 协议远程登录。</td>
</tr>
<tr>
<td>ssh</td>
<td>使用 SSH 加密协议远程登录。</td>
</tr>
<tr>
<td>scp</td>
<td>全拼 secure copy,用于不同主机之间复制文件。</td>
</tr>
<tr>
<td>wget</td>
<td>命令行下载文件。</td>
</tr>
<tr>
<td>ping</td>
<td>测试主机之间网络的连通性。</td>
</tr>
<tr>
<td>route</td>
<td>显示和设置 linux 系统的路由表。</td>
</tr>
<tr>
<td>ifconfig</td>
<td>查看、配置、启用或禁用网络接口的命令。</td>
</tr>
<tr>
<td>ifup</td>
<td>启动网卡。</td>
</tr>
<tr>
<td>ifdown</td>
<td>关闭网卡。</td>
</tr>
<tr>
<td>netstat</td>
<td>查看网络状态。</td>
</tr>
<tr>
<td>ss</td>
<td>查看网络状态。</td>
</tr>
<tr>
<td><strong>深入网络操作命令</strong></td>
<td><em>9个</em></td>
</tr>
<tr>
<td>nmap</td>
<td>网络扫描命令。</td>
</tr>
<tr>
<td>lsof</td>
<td>全名 list open files，也就是列举系统中已经被打开的文件。</td>
</tr>
<tr>
<td>mail</td>
<td>发送和接收邮件。</td>
</tr>
<tr>
<td>mutt</td>
<td>邮件管理命令。</td>
</tr>
<tr>
<td>nslookup</td>
<td>交互式查询互联网 DNS 服务器的命令。</td>
</tr>
<tr>
<td>dig</td>
<td>查找 DNS 解析过程。</td>
</tr>
<tr>
<td>host</td>
<td>查询 DNS 的命令。</td>
</tr>
<tr>
<td>traceroute</td>
<td>追踪数据传输路由状况。</td>
</tr>
<tr>
<td>tcpdump</td>
<td>命令行的抓包工具。</td>
</tr>
<tr>
<td><strong>有关磁盘与文件系统的命令</strong></td>
<td><em>16个</em></td>
</tr>
<tr>
<td>mount</td>
<td>挂载文件系统。</td>
</tr>
<tr>
<td>umount</td>
<td>卸载文件系统。</td>
</tr>
<tr>
<td>fsck</td>
<td>检查并修复 Linux 文件系统。</td>
</tr>
<tr>
<td>dd</td>
<td>转换或复制文件。</td>
</tr>
<tr>
<td>dumpe2fs</td>
<td>导出 ext2/ext3/ext4 文件系统信息。</td>
</tr>
<tr>
<td>dump</td>
<td>ext2/3/4 文件系统备份工具。</td>
</tr>
<tr>
<td>fdisk</td>
<td>磁盘分区命令，适用于 2TB 以下磁盘分区。</td>
</tr>
<tr>
<td>parted</td>
<td>磁盘分区命令，没有磁盘大小限制，常用于 2TB 以下磁盘分区。</td>
</tr>
<tr>
<td>mkfs</td>
<td>格式化创建 Linux 文件系统。</td>
</tr>
<tr>
<td>partprobe</td>
<td>更新内核的硬盘分区表信息。</td>
</tr>
<tr>
<td>e2fsck</td>
<td>检查 ext2/ext3/ext4 类型文件系统。</td>
</tr>
<tr>
<td>mkswap</td>
<td>创建 Linux 交换分区。</td>
</tr>
<tr>
<td>swapon</td>
<td>启用交换分区。</td>
</tr>
<tr>
<td>swapoff</td>
<td>关闭交换分区。</td>
</tr>
<tr>
<td>sync</td>
<td>将内存缓冲区内的数据写入磁盘。</td>
</tr>
<tr>
<td>resize2fs</td>
<td>调整 ext2/ext3/ext4 文件系统大小。</td>
</tr>
<tr>
<td><strong>系统权限及用户授权相关命令</strong></td>
<td><em>4个</em></td>
</tr>
<tr>
<td>chmod</td>
<td>改变文件或目录权限。</td>
</tr>
<tr>
<td>chown</td>
<td>改变文件或目录的属主和属组。</td>
</tr>
<tr>
<td>chgrp</td>
<td>更改文件用户组。</td>
</tr>
<tr>
<td>umask</td>
<td>显示或设置权限掩码。</td>
</tr>
<tr>
<td><strong>查看系统用户登陆信息的命令</strong></td>
<td><em>7个</em></td>
</tr>
<tr>
<td>whoami</td>
<td>显示当前有效的用户名称，相当于执行 id -un 命令。</td>
</tr>
<tr>
<td>who</td>
<td>显示目前登录系统的用户信息。</td>
</tr>
<tr>
<td>w</td>
<td>显示已经登陆系统的用户列表，并显示用户正在执行的指令。</td>
</tr>
<tr>
<td>last</td>
<td>显示登入系统的用户。</td>
</tr>
<tr>
<td>lastlog</td>
<td>显示系统中所有用户最近一次登录信息。</td>
</tr>
<tr>
<td>users</td>
<td>显示当前登录系统的所有用户的用户列表。</td>
</tr>
<tr>
<td>finger</td>
<td>查找并显示用户信息。</td>
</tr>
<tr>
<td><strong>内置命令及其它</strong></td>
<td><em>19个</em></td>
</tr>
<tr>
<td>echo</td>
<td>打印变量，或直接输出指定的字符串</td>
</tr>
<tr>
<td>printf</td>
<td>将结果格式化输出到标准输出。</td>
</tr>
<tr>
<td>rpm</td>
<td>管理 rpm 包的命令。</td>
</tr>
<tr>
<td>yum</td>
<td>自动化简单化地管理 rpm 包的命令。</td>
</tr>
<tr>
<td>watch</td>
<td>周期性的执行给定的命令，并将命令的输出以全屏方式显示。</td>
</tr>
<tr>
<td>alias</td>
<td>设置系统别名。</td>
</tr>
<tr>
<td>unalias</td>
<td>取消系统别名。</td>
</tr>
<tr>
<td>date</td>
<td>查看或设置系统时间。</td>
</tr>
<tr>
<td>clear</td>
<td>清除屏幕，简称清屏。</td>
</tr>
<tr>
<td>history</td>
<td>查看命令执行的历史纪录。</td>
</tr>
<tr>
<td>eject</td>
<td>弹出光驱。</td>
</tr>
<tr>
<td>time</td>
<td>计算命令执行时间。</td>
</tr>
<tr>
<td>nc</td>
<td>功能强大的网络工具。</td>
</tr>
<tr>
<td>xargs</td>
<td>将标准输入转换成命令行参数。</td>
</tr>
<tr>
<td>exec</td>
<td>调用并执行指令的命令。</td>
</tr>
<tr>
<td>export</td>
<td>设置或者显示环境变量。</td>
</tr>
<tr>
<td>unset</td>
<td>删除变量或函数。</td>
</tr>
<tr>
<td>type</td>
<td>用于判断另外一个命令是否是内置命令。</td>
</tr>
<tr>
<td>bc</td>
<td>命令行科学计算器</td>
</tr>
<tr>
<td><strong>系统管理与性能监视命令</strong></td>
<td><em>9个</em></td>
</tr>
<tr>
<td>chkconfig</td>
<td>管理 Linux 系统开机启动项。</td>
</tr>
<tr>
<td>vmstat</td>
<td>虚拟内存统计。</td>
</tr>
<tr>
<td>mpstat</td>
<td>显示各个可用 CPU 的状态统计。</td>
</tr>
<tr>
<td>iostat</td>
<td>统计系统IO。</td>
</tr>
<tr>
<td>sar</td>
<td>全面地获取系统的 CPU、运行队列、磁盘 I/O、分页（交换区）、内存、 CPU 中断和网络等性能数据。</td>
</tr>
<tr>
<td>ipcs</td>
<td>用于报告 Linux 中进程间通信设施的状态，显示的信息包括消息列表、共享内存和信号量的信息。</td>
</tr>
<tr>
<td>ipcrm</td>
<td>用来删除一个或更多的消息队列、信号量集或者共享内存标识。</td>
</tr>
<tr>
<td>strace</td>
<td>用于诊断、调试 Linux 用户空间跟踪器。我们用它来监控用户空间进程和内核的交互，比如系统调用、信号传递、进程状态变更等。</td>
</tr>
<tr>
<td>ltrace</td>
<td>命令会跟踪进程的库函数调用, 它会显现出哪个库函数被调用。</td>
</tr>
<tr>
<td><strong>关机 / 重启 / 注销和查看系统信息的命令</strong></td>
<td><em>6个</em></td>
</tr>
<tr>
<td>shutdown</td>
<td>关机。</td>
</tr>
<tr>
<td>halt</td>
<td>关机。</td>
</tr>
<tr>
<td>poweroff</td>
<td>关闭电源。</td>
</tr>
<tr>
<td>logout</td>
<td>退出当前登录的 Shell。</td>
</tr>
<tr>
<td>exit</td>
<td>退出当前登录的 Shell。</td>
</tr>
<tr>
<td>Ctrl+d</td>
<td>退出当前登录的 Shell 的快捷键。</td>
</tr>
<tr>
<td><strong>进程管理相关命令</strong></td>
<td><em>15个</em></td>
</tr>
<tr>
<td>bg</td>
<td>将一个在后台暂停的命令，变成继续执行  （在后台执行）。</td>
</tr>
<tr>
<td>fg</td>
<td>将后台中的命令调至前台继续运行。</td>
</tr>
<tr>
<td>jobs</td>
<td>查看当前有多少在后台运行的命令。</td>
</tr>
<tr>
<td>kill</td>
<td>终止进程。</td>
</tr>
<tr>
<td>killall</td>
<td>通过进程名终止进程。</td>
</tr>
<tr>
<td>pkill</td>
<td>通过进程名终止进程。</td>
</tr>
<tr>
<td>crontab</td>
<td>定时任务命令。</td>
</tr>
<tr>
<td>ps</td>
<td>显示进程的快照。</td>
</tr>
<tr>
<td>pstree</td>
<td>树形显示进程。</td>
</tr>
<tr>
<td>nice/renice</td>
<td>调整程序运行的优先级。</td>
</tr>
<tr>
<td>nohup</td>
<td>忽略挂起信号运行指定的命令。</td>
</tr>
<tr>
<td>pgrep</td>
<td>查找匹配条件的进程。</td>
</tr>
<tr>
<td>runlevel</td>
<td>查看系统当前运行级别。</td>
</tr>
<tr>
<td>init</td>
<td>切换运行级别。</td>
</tr>
<tr>
<td>service</td>
<td>启动、停止、重新启动和关闭系统服务，还可以显示所有系统服务的当前状态。</td>
</tr>
</tbody>
</table>
<h2 id="用户和组管理"><a href="#用户和组管理" class="headerlink" title="用户和组管理"></a>用户和组管理</h2><h2 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h2><h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.nextx.tk/2018/10/02/linux系统介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nieW">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nieW learn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/02/linux系统介绍/" itemprop="url">重新深入的认识和学习Linux系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-02T17:12:20+08:00">
                2018-10-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="重新深入的认识和学习Linux系统"><a href="#重新深入的认识和学习Linux系统" class="headerlink" title="重新深入的认识和学习Linux系统"></a>重新深入的认识和学习Linux系统</h1><hr>
<p>作为一个运维工作者<strong>Linux</strong>是一个必须需要熟练掌握的系统 —— Linux占据了绝大多数的企业运维环境中最重要的底层环境，现在系统的从头开始来学习并理解Linux相关的知识：</p>
<p><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1537629780293&amp;di=1d1e9c1cebf12459800ecd963626c44e&amp;imgtype=0&amp;src=http%3A%2F%2Fbpic.588ku.com%2Felement_origin_min_pic%2F16%2F12%2F28%2Fda530dbb798e3d7440539194a9f43d86.jpg" alt="Linux-logo"></p>
<p><strong>linux的官方网站</strong>：</p>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a><a href="https://www.linux.org" target="_blank" rel="noopener">Linux</a></h3><p><strong>Linux常用的发型版本官网网站</strong>：</p>
<h3 id="Redhat"><a href="#Redhat" class="headerlink" title="Redhat"></a><a href="https://www.redhat.com/" target="_blank" rel="noopener">Redhat</a></h3><h3 id="Centos"><a href="#Centos" class="headerlink" title="Centos"></a><a href="https://www.centos.org" target="_blank" rel="noopener">Centos</a></h3><h3 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a><a href="https://www.ubuntu.com" target="_blank" rel="noopener">Ubuntu</a></h3><h3 id="Debian"><a href="#Debian" class="headerlink" title="Debian"></a><a href="https://www.debian.org" target="_blank" rel="noopener">Debian</a></h3><p>等等…</p>
<blockquote>
<p>由于Centos在企业环境中的普遍采用，所以作为学习的版本选用。</p>
</blockquote>
<hr>
<h2 id="什么是-Linux"><a href="#什么是-Linux" class="headerlink" title="什么是 Linux"></a>什么是 Linux</h2><p>Linux是一套免费使用和自由传播的类<strong>Unix</strong>操作系统，是一个基于POSIX和UNIX的多用户、多任务、支持多线程和多CPU的操作系统。它能运行主要的<strong>UNIX</strong>工具软件、应用程序和网络协议。它支持32位和64位硬件。Linux继承了<strong>Unix</strong>以网络为核心的设计思想，是一个性能稳定的多用户网络操作系统。<br>Linux操作系统诞生于1991 年10 月5 日（这是第一次正式向外公布时间）。Linux存在着许多不同的Linux版本，但它们都使用了Linux内核。Linux可安装在各种计算机硬件设备中，比如手机、平板电脑、路由器、视频游戏控制台、台式计算机、大型机和超级计算机。<br>严格来讲，Linux这个词本身只表示Linux内核，但实际上人们已经习惯了用Linux来形容整个基于Linux内核，并且使用GNU 工程各种工具和数据库的操作系统。</p>
<p>##由于Linux的免费开源属性和优秀的性能及安全性，使得世界上绝大多数的服务器系统及各种设备采取它或它的变种系统来运行各种服务。</p>
<h3 id="1-Linux哲学思想"><a href="#1-Linux哲学思想" class="headerlink" title="1. Linux哲学思想"></a>1. Linux哲学思想</h3><ul>
<li>一切都是一个文件（包括硬件）</li>
<li>小型，单一用途的程序</li>
<li>链接程序，共同完成复杂的任务</li>
<li>避免令人困惑的用户界面</li>
<li>配置数据存储在文本中</li>
</ul>
<h3 id="2-操作系统的功能"><a href="#2-操作系统的功能" class="headerlink" title="2. 操作系统的功能"></a>2. 操作系统的功能</h3><ul>
<li>硬件驱动</li>
<li>进程管理</li>
<li>内存管理</li>
<li>网络管理</li>
<li>安全管理</li>
<li>文件管理<blockquote>
<p>分为：服务器操作系统、桌面操作系统、移动操作系统</p>
</blockquote>
</li>
</ul>
<h3 id="3-用户和内核空间"><a href="#3-用户和内核空间" class="headerlink" title="3. 用户和内核空间"></a>3. 用户和内核空间</h3><ul>
<li><strong>用户空间</strong>：User space<br>用户程序的运行空间。为了安全，它们是隔离的，即使用户的程序崩溃，内核也不受影响<br>只能执行简单的运算，不能直接调用系统资源，必须通过系统接口（ system call），才能<br>向内核发出指令</li>
<li><strong>内核空间</strong>：Kernel space<br>是 Linux 内核的运行空间<br>可以执行任意命令，调用系统的一切资源<br>示例：<br>str = “hello world” // 用户空间<br>x = x + 100 // 用户空间<br>file.write(str) // 切换到内核空间<br>y = x + 200 // 切换回用户空间<br>说明：第一行和第二行都是简单的赋值运算，在 User space 执行。第三行需要写入文件，就<br>要切换到 Kernel space，因为用户不能直接写文件，必须通过内核安排。第四行又是赋值运算，<br>就切换回 User space<br><img src="https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=4258514813,3599729641&amp;fm=26&amp;gp=0.jpg" alt="用户空间和内核空间"></li>
</ul>
<h3 id="4-Linux内核-内核版本"><a href="#4-Linux内核-内核版本" class="headerlink" title="4. Linux内核 内核版本"></a>4. Linux内核 <a href="https://www.kernel.org" target="_blank" rel="noopener">内核版本</a></h3><ul>
<li>Linux的内核版本由3部分组成<br>Kernel:3.10.0-693.el7</li>
<li>主版本号:3<br>次版本号:10<br>末版本号:0<br>打包版本号:693<br>厂商版本:el7</li>
</ul>
<h3 id="5-开源协议"><a href="#5-开源协议" class="headerlink" title="5. 开源协议"></a>5. 开源协议</h3><p><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1537634263356&amp;di=733bdac7b101907e436a4f789b3f6a63&amp;imgtype=0&amp;src=http%3A%2F%2Fwww.zhixing123.cn%2Fuploads%2Fallimg%2F151228%2F1_151228214756_1.JPG" alt="开源协议"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">nieW</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nieW</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
